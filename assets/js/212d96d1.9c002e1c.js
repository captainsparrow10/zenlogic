"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[490],{7953:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"integraciones/grpc","title":"gRPC - Comunicaci\xf3n Interna","description":"Integraci\xf3n con gRPC para comunicaci\xf3n s\xedncrona de baja latencia entre microservicios.","source":"@site/docs/04-integraciones/03-grpc.md","sourceDirName":"04-integraciones","slug":"/integraciones/grpc","permalink":"/zenlogic/integraciones/grpc","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/04-integraciones/03-grpc.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docs","previous":{"title":"Redis - Cache y Sesiones","permalink":"/zenlogic/integraciones/redis"},"next":{"title":"PostgreSQL - Base de Datos","permalink":"/zenlogic/integraciones/postgresql"}}');var t=r(4848),s=r(8453);const a={sidebar_position:4},o="gRPC - Comunicaci\xf3n Interna",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Proto Definitions",id:"proto-definitions",level:2},{value:"auth.proto",id:"authproto",level:3},{value:"Generaci\xf3n de C\xf3digo",id:"generaci\xf3n-de-c\xf3digo",level:2},{value:"gRPC Server (Auth Service)",id:"grpc-server-auth-service",level:2},{value:"Implementaci\xf3n",id:"implementaci\xf3n",level:3},{value:"Iniciar Servidor",id:"iniciar-servidor",level:3},{value:"gRPC Client (Catalog Service)",id:"grpc-client-catalog-service",level:2},{value:"Implementaci\xf3n",id:"implementaci\xf3n-1",level:3},{value:"Uso con Circuit Breaker",id:"uso-con-circuit-breaker",level:3},{value:"Interceptors",id:"interceptors",level:2},{value:"Logging Interceptor",id:"logging-interceptor",level:3},{value:"Health Check",id:"health-check",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"grpc---comunicaci\xf3n-interna",children:"gRPC - Comunicaci\xf3n Interna"})}),"\n",(0,t.jsx)(n.p,{children:"Integraci\xf3n con gRPC para comunicaci\xf3n s\xedncrona de baja latencia entre microservicios."}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"gRPC se utiliza para comunicaci\xf3n interna s\xedncrona cuando se requiere validaci\xf3n o consulta en tiempo real entre servicios."}),"\n",(0,t.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Catalog as Catalog Service\n    participant gRPC as gRPC Client\n    participant Auth as Auth Service\n\n    Catalog->>gRPC: ValidateLocal(user_id, org_id, local_id)\n    gRPC->>Auth: gRPC Request (port 50051)\n    Auth--\x3e>gRPC: ValidateLocalResponse(is_valid=true)\n    gRPC--\x3e>Catalog: Return response"}),"\n",(0,t.jsx)(n.h2,{id:"proto-definitions",children:"Proto Definitions"}),"\n",(0,t.jsx)(n.h3,{id:"authproto",children:"auth.proto"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-protobuf",children:'// protos/auth.proto\nsyntax = "proto3";\n\npackage auth;\n\nservice AuthService {\n    // Validar acceso a local\n    rpc ValidateLocal(ValidateLocalRequest) returns (ValidateLocalResponse);\n\n    // Verificar token JWT\n    rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse);\n\n    // Obtener permisos de usuario\n    rpc GetUserPermissions(GetUserPermissionsRequest) returns (GetUserPermissionsResponse);\n}\n\nmessage ValidateLocalRequest {\n    string user_id = 1;\n    string organization_id = 2;\n    string local_id = 3;\n}\n\nmessage ValidateLocalResponse {\n    bool is_valid = 1;\n    string local_name = 2;\n    string error_message = 3;\n}\n\nmessage VerifyTokenRequest {\n    string token = 1;\n}\n\nmessage VerifyTokenResponse {\n    bool is_valid = 1;\n    string user_id = 2;\n    string organization_id = 3;\n    repeated string permissions = 4;\n    string error_message = 5;\n}\n\nmessage GetUserPermissionsRequest {\n    string user_id = 1;\n}\n\nmessage GetUserPermissionsResponse {\n    repeated string permissions = 1;\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"generaci\xf3n-de-c\xf3digo",children:"Generaci\xf3n de C\xf3digo"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Script: scripts/generate_protos.sh\n#!/bin/bash\n\npython -m grpc_tools.protoc \\\n  --proto_path=./protos \\\n  --python_out=./app/grpc_generated \\\n  --grpc_python_out=./app/grpc_generated \\\n  ./protos/*.proto\n\necho "Proto files generated successfully"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"grpc-server-auth-service",children:"gRPC Server (Auth Service)"}),"\n",(0,t.jsx)(n.h3,{id:"implementaci\xf3n",children:"Implementaci\xf3n"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# app/grpc_server/auth_servicer.py\nimport grpc\nfrom app.grpc_generated import auth_pb2, auth_pb2_grpc\nfrom app.services.auth_service import AuthService\nfrom app.services.user_service import UserService\n\nclass AuthServicer(auth_pb2_grpc.AuthServiceServicer):\n    """Implementaci\xf3n del servicio gRPC de Auth."""\n\n    def __init__(self, auth_service: AuthService, user_service: UserService):\n        self.auth_service = auth_service\n        self.user_service = user_service\n\n    async def ValidateLocal(\n        self,\n        request: auth_pb2.ValidateLocalRequest,\n        context: grpc.aio.ServicerContext\n    ) -> auth_pb2.ValidateLocalResponse:\n        """Validar si usuario tiene acceso a un local."""\n\n        try:\n            is_valid, local_name = await self.user_service.validate_local(\n                user_id=request.user_id,\n                organization_id=request.organization_id,\n                local_id=request.local_id\n            )\n\n            return auth_pb2.ValidateLocalResponse(\n                is_valid=is_valid,\n                local_name=local_name or ""\n            )\n\n        except Exception as e:\n            logger.error(f"ValidateLocal error: {e}", exc_info=True)\n\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(str(e))\n\n            return auth_pb2.ValidateLocalResponse(\n                is_valid=False,\n                error_message=str(e)\n            )\n\n    async def VerifyToken(\n        self,\n        request: auth_pb2.VerifyTokenRequest,\n        context: grpc.aio.ServicerContext\n    ) -> auth_pb2.VerifyTokenResponse:\n        """Verificar token JWT."""\n\n        try:\n            payload = await self.auth_service.verify_token(request.token)\n\n            return auth_pb2.VerifyTokenResponse(\n                is_valid=True,\n                user_id=payload["user_id"],\n                organization_id=payload["organization_id"],\n                permissions=payload.get("permissions", [])\n            )\n\n        except Exception as e:\n            logger.error(f"VerifyToken error: {e}")\n\n            return auth_pb2.VerifyTokenResponse(\n                is_valid=False,\n                error_message=str(e)\n            )\n\n    async def GetUserPermissions(\n        self,\n        request: auth_pb2.GetUserPermissionsRequest,\n        context: grpc.aio.ServicerContext\n    ) -> auth_pb2.GetUserPermissionsResponse:\n        """Obtener permisos de usuario."""\n\n        try:\n            permissions = await self.user_service.get_permissions(request.user_id)\n\n            return auth_pb2.GetUserPermissionsResponse(\n                permissions=list(permissions)\n            )\n\n        except Exception as e:\n            logger.error(f"GetUserPermissions error: {e}")\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(str(e))\n            return auth_pb2.GetUserPermissionsResponse()\n'})}),"\n",(0,t.jsx)(n.h3,{id:"iniciar-servidor",children:"Iniciar Servidor"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# app/grpc_server/server.py\nimport grpc\nfrom app.grpc_generated import auth_pb2_grpc\nfrom app.grpc_server.auth_servicer import AuthServicer\nfrom app.config import settings\n\nasync def serve():\n    """Iniciar servidor gRPC."""\n\n    server = grpc.aio.server()\n\n    # Registrar servicer\n    auth_pb2_grpc.add_AuthServiceServicer_to_server(\n        AuthServicer(auth_service, user_service),\n        server\n    )\n\n    # Puerto\n    listen_addr = f"[::]:{settings.grpc_port}"\n    server.add_insecure_port(listen_addr)\n\n    # Iniciar\n    await server.start()\n    logger.info(f"gRPC server started on {listen_addr}")\n\n    # Mantener corriendo\n    await server.wait_for_termination()\n\n# app/main.py\nimport asyncio\n\n@app.on_event("startup")\nasync def startup():\n    # Iniciar gRPC server en background\n    asyncio.create_task(serve())\n'})}),"\n",(0,t.jsx)(n.h2,{id:"grpc-client-catalog-service",children:"gRPC Client (Catalog Service)"}),"\n",(0,t.jsx)(n.h3,{id:"implementaci\xf3n-1",children:"Implementaci\xf3n"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# app/clients/auth_client.py\nimport grpc\nfrom app.grpc_generated import auth_pb2, auth_pb2_grpc\nfrom app.config import settings\nfrom typing import Tuple\n\nclass AuthClient:\n    """Cliente gRPC para Auth Service."""\n\n    def __init__(self):\n        self.channel = None\n        self.stub = None\n\n    async def connect(self):\n        """Conectar a Auth Service gRPC."""\n\n        self.channel = grpc.aio.insecure_channel(\n            settings.auth_grpc_url,\n            options=[\n                (\'grpc.lb_policy_name\', \'round_robin\'),\n                (\'grpc.keepalive_time_ms\', 10000),\n                (\'grpc.keepalive_timeout_ms\', 5000),\n                (\'grpc.http2.max_pings_without_data\', 0),\n            ]\n        )\n\n        self.stub = auth_pb2_grpc.AuthServiceStub(self.channel)\n\n        logger.info(f"Connected to Auth gRPC: {settings.auth_grpc_url}")\n\n    async def validate_local(\n        self,\n        user_id: str,\n        organization_id: str,\n        local_id: str\n    ) -> Tuple[bool, str]:\n        """\n        Validar acceso a local.\n\n        Returns:\n            (is_valid, local_name)\n        """\n\n        request = auth_pb2.ValidateLocalRequest(\n            user_id=user_id,\n            organization_id=organization_id,\n            local_id=local_id\n        )\n\n        try:\n            response = await self.stub.ValidateLocal(\n                request,\n                timeout=5.0\n            )\n\n            # M\xe9tricas\n            grpc_request_duration.labels(\n                service="auth",\n                method="ValidateLocal"\n            ).observe(0.005)  # Ejemplo\n\n            return response.is_valid, response.local_name\n\n        except grpc.RpcError as e:\n            logger.error(\n                f"gRPC error: {e.code()} - {e.details()}",\n                extra={\n                    "user_id": user_id,\n                    "local_id": local_id\n                }\n            )\n\n            # M\xe9tricas de error\n            grpc_errors.labels(\n                service="auth",\n                method="ValidateLocal",\n                code=e.code().name\n            ).inc()\n\n            return False, ""\n\n    async def verify_token(self, token: str) -> dict:\n        """Verificar token JWT."""\n\n        request = auth_pb2.VerifyTokenRequest(token=token)\n\n        try:\n            response = await self.stub.VerifyToken(request, timeout=5.0)\n\n            if not response.is_valid:\n                raise ValueError(response.error_message)\n\n            return {\n                "user_id": response.user_id,\n                "organization_id": response.organization_id,\n                "permissions": list(response.permissions)\n            }\n\n        except grpc.RpcError as e:\n            logger.error(f"VerifyToken gRPC error: {e.code()}")\n            raise\n\n    async def close(self):\n        """Cerrar conexi\xf3n."""\n        if self.channel:\n            await self.channel.close()\n'})}),"\n",(0,t.jsx)(n.h3,{id:"uso-con-circuit-breaker",children:"Uso con Circuit Breaker"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# app/clients/auth_client_with_circuit_breaker.py\nfrom circuitbreaker import CircuitBreaker, CircuitBreakerError\nfrom app.clients.auth_rest_client import AuthRestClient\n\nclass AuthClientWithCircuitBreaker:\n    """Cliente Auth con circuit breaker y fallback."""\n\n    def __init__(self, grpc_client: AuthClient, rest_client: AuthRestClient):\n        self.grpc_client = grpc_client\n        self.rest_client = rest_client\n        self.circuit_breaker = CircuitBreaker(\n            failure_threshold=5,\n            recovery_timeout=60,\n            expected_exception=grpc.RpcError\n        )\n\n    async def validate_local(\n        self,\n        user_id: str,\n        org_id: str,\n        local_id: str\n    ) -> Tuple[bool, str]:\n        """Validar con fallback a REST."""\n\n        try:\n            return await self._validate_local_grpc(user_id, org_id, local_id)\n        except CircuitBreakerError:\n            logger.warning("gRPC circuit breaker open, falling back to REST")\n            return await self._validate_local_rest(user_id, org_id, local_id)\n\n    @CircuitBreaker(failure_threshold=5, recovery_timeout=60)\n    async def _validate_local_grpc(self, user_id, org_id, local_id):\n        """Intentar v\xeda gRPC."""\n        return await self.grpc_client.validate_local(user_id, org_id, local_id)\n\n    async def _validate_local_rest(self, user_id, org_id, local_id):\n        """Fallback v\xeda REST."""\n        response = await self.rest_client.get(\n            f"/api/v1/locals/{local_id}/validate",\n            params={"user_id": user_id, "organization_id": org_id}\n        )\n        data = response.json()\n        return data["is_valid"], data.get("local_name", "")\n'})}),"\n",(0,t.jsx)(n.h2,{id:"interceptors",children:"Interceptors"}),"\n",(0,t.jsx)(n.h3,{id:"logging-interceptor",children:"Logging Interceptor"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# app/grpc_server/interceptors.py\nimport grpc\nimport time\n\nclass LoggingInterceptor(grpc.aio.ServerInterceptor):\n    """Interceptor para logging de requests."""\n\n    async def intercept_service(self, continuation, handler_call_details):\n        method = handler_call_details.method\n        start_time = time.time()\n\n        logger.info(f"gRPC request: {method}")\n\n        # Continuar\n        response = await continuation(handler_call_details)\n\n        # Log duraci\xf3n\n        duration = time.time() - start_time\n        logger.info(f"gRPC request completed: {method} ({duration:.3f}s)")\n\n        return response\n'})}),"\n",(0,t.jsx)(n.h2,{id:"health-check",children:"Health Check"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'@router.get("/health/grpc")\nasync def grpc_health():\n    """Health check de gRPC server."""\n\n    try:\n        # Intentar conexi\xf3n\n        async with grpc.aio.insecure_channel(\n            f"localhost:{settings.grpc_port}",\n            options=[(\'grpc.keepalive_time_ms\', 10000)]\n        ) as channel:\n            # Esperar a que est\xe9 ready\n            await channel.channel_ready()\n\n            return {"status": "healthy"}\n\n    except Exception as e:\n        return JSONResponse(\n            {"status": "unhealthy", "error": str(e)},\n            status_code=503\n        )\n'})}),"\n",(0,t.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/adrs/adr-004-grpc-internal",children:"ADR-004: gRPC para Comunicaci\xf3n Interna"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/microservicios/catalog-service/auth-client-grpc",children:"Catalog Service - Auth Client gRPC"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/integraciones/postgresql",children:"PostgreSQL"})}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>o});var i=r(6540);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);