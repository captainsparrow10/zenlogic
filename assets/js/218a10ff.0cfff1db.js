"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[7158],{6884:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"microservicios/audit-service/arquitectura","title":"Arquitectura","description":"Dise\xf1o arquitect\xf3nico del Audit Service.","source":"@site/docs/02-microservicios/audit-service/02-arquitectura.md","sourceDirName":"02-microservicios/audit-service","slug":"/microservicios/audit-service/arquitectura","permalink":"/zenlogic/microservicios/audit-service/arquitectura","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/audit-service/02-arquitectura.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docs","previous":{"title":"Alcance","permalink":"/zenlogic/microservicios/audit-service/alcance"},"next":{"title":"Modelo de Datos","permalink":"/zenlogic/microservicios/audit-service/modelo-datos"}}');var r=i(4848),a=i(8453);const l={sidebar_position:3},d="Arquitectura",t={},c=[{value:"Diagrama de Componentes",id:"diagrama-de-componentes",level:2},{value:"Capas de la Arquitectura",id:"capas-de-la-arquitectura",level:2},{value:"1. Event Layer",id:"1-event-layer",level:3},{value:"2. Service Layer",id:"2-service-layer",level:3},{value:"3. Data Layer",id:"3-data-layer",level:3},{value:"4. API Layer",id:"4-api-layer",level:3},{value:"Flujo de Datos",id:"flujo-de-datos",level:2},{value:"Flujo de Ingesta (Write)",id:"flujo-de-ingesta-write",level:3},{value:"Flujo de Consulta (Read)",id:"flujo-de-consulta-read",level:3},{value:"Patrones de Dise\xf1o",id:"patrones-de-dise\xf1o",level:2},{value:"1. Event-Driven Architecture",id:"1-event-driven-architecture",level:3},{value:"2. CQRS (Command Query Responsibility Segregation)",id:"2-cqrs-command-query-responsibility-segregation",level:3},{value:"3. Repository Pattern",id:"3-repository-pattern",level:3},{value:"4. Dependency Injection",id:"4-dependency-injection",level:3},{value:"Escalabilidad",id:"escalabilidad",level:2},{value:"Escalado Horizontal",id:"escalado-horizontal",level:3},{value:"Escalado Vertical",id:"escalado-vertical",level:3},{value:"Resiliencia",id:"resiliencia",level:2},{value:"Manejo de Fallos",id:"manejo-de-fallos",level:3},{value:"Performance",id:"performance",level:2},{value:"Optimizaciones",id:"optimizaciones",level:3},{value:"Seguridad",id:"seguridad",level:2},{value:"Autenticaci\xf3n",id:"autenticaci\xf3n",level:3},{value:"Autorizaci\xf3n",id:"autorizaci\xf3n",level:3},{value:"Inmutabilidad",id:"inmutabilidad",level:3},{value:"Monitoreo",id:"monitoreo",level:2},{value:"M\xe9tricas Clave",id:"m\xe9tricas-clave",level:3},{value:"Logs Estructurados",id:"logs-estructurados",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"arquitectura",children:"Arquitectura"})}),"\n",(0,r.jsx)(n.p,{children:"Dise\xf1o arquitect\xf3nico del Audit Service."}),"\n",(0,r.jsx)(n.h2,{id:"diagrama-de-componentes",children:"Diagrama de Componentes"}),"\n",(0,r.jsx)(n.mermaid,{value:'graph TB\n    subgraph "Audit Service"\n        subgraph "Event Layer"\n            Consumer[Event Consumer]\n            Handler[Event Handler]\n        end\n\n        subgraph "Service Layer"\n            AuditService[Audit Service]\n            QueryService[Query Service]\n        end\n\n        subgraph "Data Layer"\n            Repo[Audit Repository]\n            DB[(PostgreSQL)]\n        end\n\n        subgraph "API Layer"\n            REST[FastAPI REST]\n        end\n\n        Consumer --\x3e|Consume| Handler\n        Handler --\x3e|Process| AuditService\n        AuditService --\x3e|Store| Repo\n        Repo --\x3e|Persist| DB\n\n        REST --\x3e|Query| QueryService\n        QueryService --\x3e|Read| Repo\n    end\n\n    RabbitMQ[RabbitMQ] --\x3e|Events| Consumer\n    Client[Client] --\x3e|HTTP| REST'}),"\n",(0,r.jsx)(n.h2,{id:"capas-de-la-arquitectura",children:"Capas de la Arquitectura"}),"\n",(0,r.jsx)(n.h3,{id:"1-event-layer",children:"1. Event Layer"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsabilidad"}),": Consumir eventos de RabbitMQ"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Componentes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Event Consumer"}),": Gestiona conexi\xf3n a RabbitMQ"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Event Handler"}),": Despacha eventos a procesadores espec\xedficos"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Tecnolog\xedas"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"aio_pika (RabbitMQ async client)"}),"\n",(0,r.jsx)(n.li,{children:"asyncio para concurrencia"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2-service-layer",children:"2. Service Layer"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsabilidad"}),": L\xf3gica de negocio"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Componentes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Audit Service"}),": Procesa y almacena eventos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Query Service"}),": L\xf3gica de consultas complejas"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Patrones"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Service Layer Pattern"}),"\n",(0,r.jsx)(n.li,{children:"Dependency Injection"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-data-layer",children:"3. Data Layer"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsabilidad"}),": Persistencia de datos"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Componentes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Audit Repository"}),": Abstracci\xf3n de acceso a datos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"PostgreSQL"}),": Base de datos"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Patrones"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Repository Pattern"}),"\n",(0,r.jsx)(n.li,{children:"Unit of Work"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"4-api-layer",children:"4. API Layer"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsabilidad"}),": Exposici\xf3n de endpoints REST"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Componentes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"FastAPI Router"}),": Endpoints HTTP"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pydantic Schemas"}),": Validaci\xf3n de I/O"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"flujo-de-datos",children:"Flujo de Datos"}),"\n",(0,r.jsx)(n.h3,{id:"flujo-de-ingesta-write",children:"Flujo de Ingesta (Write)"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant RabbitMQ\n    participant Consumer\n    participant Handler\n    participant Service\n    participant Repo\n    participant DB\n\n    RabbitMQ->>Consumer: Deliver message\n    Consumer->>Handler: Process event\n    Handler->>Handler: Validate event\n    Handler->>Service: store_event(event)\n    Service->>Service: Enrich metadata\n    Service->>Repo: create(audit_log)\n    Repo->>DB: INSERT\n    DB--\x3e>Repo: OK\n    Repo--\x3e>Service: Audit Log\n    Service--\x3e>Handler: Success\n    Handler->>RabbitMQ: ACK"}),"\n",(0,r.jsx)(n.h3,{id:"flujo-de-consulta-read",children:"Flujo de Consulta (Read)"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant API\n    participant QueryService\n    participant Repo\n    participant DB\n\n    Client->>API: GET /logs?filters\n    API->>QueryService: query_logs(filters)\n    QueryService->>QueryService: Build SQL query\n    QueryService->>Repo: find_by_filters(filters)\n    Repo->>DB: SELECT with indexes\n    DB--\x3e>Repo: Rows\n    Repo--\x3e>QueryService: Audit Logs\n    QueryService->>QueryService: Format response\n    QueryService--\x3e>API: Paginated result\n    API--\x3e>Client: 200 OK + logs"}),"\n",(0,r.jsx)(n.h2,{id:"patrones-de-dise\xf1o",children:"Patrones de Dise\xf1o"}),"\n",(0,r.jsx)(n.h3,{id:"1-event-driven-architecture",children:"1. Event-Driven Architecture"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Aplicaci\xf3n"}),": Todo el consumo de eventos"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Beneficios"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Desacoplamiento de servicios"}),"\n",(0,r.jsx)(n.li,{children:"Escalabilidad horizontal"}),"\n",(0,r.jsx)(n.li,{children:"Procesamiento as\xedncrono"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2-cqrs-command-query-responsibility-segregation",children:"2. CQRS (Command Query Responsibility Segregation)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Aplicaci\xf3n"}),": Separaci\xf3n de writes y reads"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Write Model"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Optimizado para ingesta r\xe1pida"}),"\n",(0,r.jsx)(n.li,{children:"Sin validaciones complejas"}),"\n",(0,r.jsx)(n.li,{children:"Solo inserts (inmutabilidad)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Read Model"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Optimizado para queries"}),"\n",(0,r.jsx)(n.li,{children:"M\xfaltiples \xedndices"}),"\n",(0,r.jsx)(n.li,{children:"Agregaciones"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-repository-pattern",children:"3. Repository Pattern"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Aplicaci\xf3n"}),": Capa de acceso a datos"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"class AuditRepository:\n    async def create(self, audit_log: AuditLog) -> AuditLog\n    async def find_by_id(self, log_id: str) -> Optional[AuditLog]\n    async def find_by_filters(self, filters: dict) -> List[AuditLog]\n    async def count_by_filters(self, filters: dict) -> int\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-dependency-injection",children:"4. Dependency Injection"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Aplicaci\xf3n"}),": Gesti\xf3n de dependencias"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'@router.get("/logs")\nasync def get_logs(\n    query_service: QueryService = Depends(get_query_service),\n    repo: AuditRepository = Depends(get_audit_repo)\n):\n    ...\n'})}),"\n",(0,r.jsx)(n.h2,{id:"escalabilidad",children:"Escalabilidad"}),"\n",(0,r.jsx)(n.h3,{id:"escalado-horizontal",children:"Escalado Horizontal"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Event Consumers"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"M\xfaltiples instancias del consumer"}),"\n",(0,r.jsx)(n.li,{children:"RabbitMQ distribuye mensajes (round-robin)"}),"\n",(0,r.jsx)(n.li,{children:"Prefetch count: 10"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"API Instances"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Load balancer delante"}),"\n",(0,r.jsx)(n.li,{children:"Stateless (sin sesi\xf3n)"}),"\n",(0,r.jsx)(n.li,{children:"Escalado autom\xe1tico por CPU"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"escalado-vertical",children:"Escalado Vertical"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"PostgreSQL"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Particionamiento por fecha"}),"\n",(0,r.jsx)(n.li,{children:"Read replicas para queries"}),"\n",(0,r.jsx)(n.li,{children:"Connection pooling"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"resiliencia",children:"Resiliencia"}),"\n",(0,r.jsx)(n.h3,{id:"manejo-de-fallos",children:"Manejo de Fallos"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Eventos Duplicados"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Idempotencia por event_id\nasync def store_event(event: dict):\n    if await repo.exists_by_event_id(event["event_id"]):\n        return  # Ya procesado, ignorar\n    await repo.create(event)\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fallos de DB"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# Retry con backoff exponencial\n@retry(stop=stop_after_attempt(3), wait=wait_exponential())\nasync def store_with_retry(event):\n    await repo.create(event)\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Dead Letter Queue"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Eventos que fallan 3 veces van a DLQ\nqueue_args = {\n    "x-dead-letter-exchange": "audit_dlq",\n    "x-message-ttl": 60000\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"performance",children:"Performance"}),"\n",(0,r.jsx)(n.h3,{id:"optimizaciones",children:"Optimizaciones"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Batch Inserts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# Acumular eventos y hacer insert batch cada 100ms\nasync def batch_insert(events: List[dict]):\n    await repo.bulk_create(events)\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\xcdndices Estrat\xe9gicos"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE INDEX idx_audit_org_time ON audit_logs(organization_id, created_at DESC);\nCREATE INDEX idx_audit_user_time ON audit_logs(user_id, created_at DESC);\nCREATE INDEX idx_audit_event_type ON audit_logs(event_type);\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Particionamiento"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Partici\xf3n por mes\nCREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs\n    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');\n"})}),"\n",(0,r.jsx)(n.h2,{id:"seguridad",children:"Seguridad"}),"\n",(0,r.jsx)(n.h3,{id:"autenticaci\xf3n",children:"Autenticaci\xf3n"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"JWT tokens (mismo que resto del sistema)"}),"\n",(0,r.jsx)(n.li,{children:"Solo admins pueden consultar logs"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"autorizaci\xf3n",children:"Autorizaci\xf3n"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Admin global: Todos los logs"}),"\n",(0,r.jsx)(n.li,{children:"Admin org: Solo logs de su organizaci\xf3n"}),"\n",(0,r.jsx)(n.li,{children:"User normal: No tiene acceso"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"inmutabilidad",children:"Inmutabilidad"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tabla sin UPDATE ni DELETE"}),"\n",(0,r.jsx)(n.li,{children:"Solo INSERT permitido"}),"\n",(0,r.jsx)(n.li,{children:"Triggers para prevenir modificaciones"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"monitoreo",children:"Monitoreo"}),"\n",(0,r.jsx)(n.h3,{id:"m\xe9tricas-clave",children:"M\xe9tricas Clave"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Prometheus\naudit_events_received = Counter("audit_events_received_total")\naudit_events_stored = Counter("audit_events_stored_total")\naudit_query_duration = Histogram("audit_query_duration_seconds")\naudit_db_lag = Gauge("audit_db_lag_seconds")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"logs-estructurados",children:"Logs Estructurados"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'logger.info(\n    "event_stored",\n    event_type=event["event_type"],\n    organization_id=event["payload"]["organization_id"],\n    duration_ms=duration\n)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/audit-service/modelo-datos",children:"Modelo de Datos"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/audit-service/event-consumer",children:"Event Consumer"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/audit-service/api-logs",children:"API Logs"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>d});var s=i(6540);const r={},a=s.createContext(r);function l(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);