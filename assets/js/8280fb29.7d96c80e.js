"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[2370],{1129:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>g,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"microservicios/catalog-service/grpc-server","title":"gRPC Server","description":"Servidor gRPC del Catalog Service para comunicaci\xf3n s\xedncrona con otros microservicios.","source":"@site/docs/02-microservicios/catalog-service/07-grpc-server.md","sourceDirName":"02-microservicios/catalog-service","slug":"/microservicios/catalog-service/grpc-server","permalink":"/zenlogic/microservicios/catalog-service/grpc-server","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/catalog-service/07-grpc-server.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7}}');var r=a(4848),i=a(8453);const o={sidebar_position:7},s="gRPC Server",c={},d=[{value:"Configuraci\xf3n",id:"configuraci\xf3n",level:2},{value:"Proto Definition",id:"proto-definition",level:2},{value:"Implementaci\xf3n Python",id:"implementaci\xf3n-python",level:2},{value:"Server Setup",id:"server-setup",level:3},{value:"Catalog Servicer",id:"catalog-servicer",level:3},{value:"Casos de Uso",id:"casos-de-uso",level:2},{value:"1. Inventory Service - Validar Variante",id:"1-inventory-service---validar-variante",level:3},{value:"2. Order Service - Obtener Detalles de Producto",id:"2-order-service---obtener-detalles-de-producto",level:3},{value:"3. Batch Validation",id:"3-batch-validation",level:3},{value:"gRPC Client (Consumidores)",id:"grpc-client-consumidores",level:2},{value:"Configuraci\xf3n del Cliente",id:"configuraci\xf3n-del-cliente",level:3},{value:"Configuraci\xf3n en Settings",id:"configuraci\xf3n-en-settings",level:3},{value:"Testing",id:"testing",level:2},{value:"Test del Servicer",id:"test-del-servicer",level:3},{value:"Manejo de Errores",id:"manejo-de-errores",level:2},{value:"Monitoreo y Logging",id:"monitoreo-y-logging",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Dockerfile",id:"dockerfile",level:3},{value:"Docker Compose",id:"docker-compose",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"grpc-server",children:"gRPC Server"})}),"\n",(0,r.jsx)(e.p,{children:"Servidor gRPC del Catalog Service para comunicaci\xf3n s\xedncrona con otros microservicios."}),"\n",(0,r.jsx)(e.h2,{id:"configuraci\xf3n",children:"Configuraci\xf3n"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Puerto gRPC"}),": ",(0,r.jsx)(e.code,{children:"50052"}),"\n",(0,r.jsx)(e.strong,{children:"Servicio"}),": ",(0,r.jsx)(e.code,{children:"CatalogService"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# config/settings.py\nGRPC_PORT = 50052\nGRPC_MAX_WORKERS = 10\nGRPC_REFLECTION = True  # Solo en desarrollo\n"})}),"\n",(0,r.jsx)(e.h2,{id:"proto-definition",children:"Proto Definition"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-protobuf",children:'syntax = "proto3";\n\npackage catalog;\n\nservice CatalogService {\n    // Validar disponibilidad de variante\n    rpc ValidateVariant(ValidateVariantRequest) returns (ValidateVariantResponse);\n\n    // Obtener detalles completos de producto\n    rpc GetProductDetails(GetProductDetailsRequest) returns (GetProductDetailsResponse);\n\n    // Obtener m\xfaltiples variantes (batch)\n    rpc GetVariantsBatch(GetVariantsBatchRequest) returns (GetVariantsBatchResponse);\n\n    // Validar m\xfaltiples variantes (batch)\n    rpc ValidateVariantsBatch(ValidateVariantsBatchRequest) returns (ValidateVariantsBatchResponse);\n}\n\n// ============================================================================\n// ValidateVariant - Usado por Inventory Service\n// ============================================================================\n\nmessage ValidateVariantRequest {\n    string organization_id = 1;\n    string variant_id = 2;\n}\n\nmessage ValidateVariantResponse {\n    bool exists = 1;\n    bool is_active = 2;\n    string variant_id = 3;\n    string product_id = 4;\n    string sku = 5;\n    string barcode = 6;\n    string warehouse_id = 7;\n    bool track_inventory = 8;\n    int32 default_min_stock = 9;\n    int32 default_max_stock = 10;\n    double price = 11;\n    string message = 12;\n}\n\n// ============================================================================\n// GetProductDetails - Usado por Order Service y otros\n// ============================================================================\n\nmessage GetProductDetailsRequest {\n    string organization_id = 1;\n    string product_id = 2;\n    bool include_variants = 3;  // default: true\n    bool include_images = 4;    // default: true\n}\n\nmessage GetProductDetailsResponse {\n    bool success = 1;\n    Product product = 2;\n    string message = 3;\n}\n\nmessage Product {\n    string product_id = 1;\n    string organization_id = 2;\n    string local_id = 3;\n    string title = 4;\n    string sku = 5;\n    string barcode = 6;\n    string description = 7;\n    string status = 8;\n    string product_type = 9;\n    string unit_of_measure = 10;\n    int32 alert_stock = 11;\n    Brand brand = 12;\n    repeated ProductImage images = 13;\n    repeated Variant variants = 14;\n    repeated Tag tags = 15;\n    repeated Collection collections = 16;\n}\n\nmessage Brand {\n    string brand_id = 1;\n    string name = 2;\n    string slug = 3;\n    string description = 4;\n}\n\nmessage ProductImage {\n    string image_id = 1;\n    string url = 2;\n    string alt = 3;\n    int32 position = 4;\n}\n\nmessage Variant {\n    string variant_id = 1;\n    string product_id = 2;\n    string sku = 3;\n    string barcode = 4;\n    double sale_price = 5;\n    double cost_price = 6;\n    double tax = 7;\n    double weight = 8;\n    Dimensions dimensions = 9;\n    string lot_number = 10;\n    int32 stock_total = 11;\n    int32 stock_available = 12;\n    int32 stock_reserved = 13;\n    string warehouse_id = 14;\n    string vendor = 15;\n    bool track_inventory = 16;\n    int32 default_min_stock = 17;\n    int32 default_max_stock = 18;\n    repeated VariantImage images = 19;\n}\n\nmessage Dimensions {\n    double length = 1;\n    double width = 2;\n    double height = 3;\n}\n\nmessage VariantImage {\n    string image_id = 1;\n    string url = 2;\n    string alt = 3;\n    int32 position = 4;\n}\n\nmessage Tag {\n    string tag_id = 1;\n    string name = 2;\n}\n\nmessage Collection {\n    string collection_id = 1;\n    string name = 2;\n    string slug = 3;\n}\n\n// ============================================================================\n// Batch Operations\n// ============================================================================\n\nmessage GetVariantsBatchRequest {\n    string organization_id = 1;\n    repeated string variant_ids = 2;\n}\n\nmessage GetVariantsBatchResponse {\n    bool success = 1;\n    repeated Variant variants = 2;\n    repeated string not_found_ids = 3;\n    string message = 4;\n}\n\nmessage ValidateVariantsBatchRequest {\n    string organization_id = 1;\n    repeated string variant_ids = 2;\n}\n\nmessage VariantValidation {\n    string variant_id = 1;\n    bool exists = 2;\n    bool is_active = 3;\n    string sku = 4;\n    string barcode = 5;\n    string warehouse_id = 6;\n    bool track_inventory = 7;\n    int32 default_min_stock = 8;\n    int32 default_max_stock = 9;\n}\n\nmessage ValidateVariantsBatchResponse {\n    bool success = 1;\n    repeated VariantValidation validations = 2;\n    string message = 3;\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"implementaci\xf3n-python",children:"Implementaci\xf3n Python"}),"\n",(0,r.jsx)(e.h3,{id:"server-setup",children:"Server Setup"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# app/grpc/server.py\nimport grpc\nfrom concurrent import futures\nimport logging\nfrom app.grpc import catalog_pb2_grpc\nfrom app.grpc.servicers.catalog_servicer import CatalogServicer\nfrom config.settings import settings\n\nlogger = logging.getLogger(__name__)\n\nasync def serve():\n    """Iniciar servidor gRPC."""\n    server = grpc.aio.server(\n        futures.ThreadPoolExecutor(max_workers=settings.grpc_max_workers)\n    )\n\n    # Registrar servicer\n    catalog_pb2_grpc.add_CatalogServiceServicer_to_server(\n        CatalogServicer(),\n        server\n    )\n\n    # Configurar puerto\n    server.add_insecure_port(f\'[::]:{settings.grpc_port}\')\n\n    # Habilitar reflection (solo desarrollo)\n    if settings.grpc_reflection:\n        from grpc_reflection.v1alpha import reflection\n        SERVICE_NAMES = (\n            catalog_pb2.DESCRIPTOR.services_by_name[\'CatalogService\'].full_name,\n            reflection.SERVICE_NAME,\n        )\n        reflection.enable_server_reflection(SERVICE_NAMES, server)\n\n    await server.start()\n    logger.info(f"gRPC Server started on port {settings.grpc_port}")\n\n    await server.wait_for_termination()\n'})}),"\n",(0,r.jsx)(e.h3,{id:"catalog-servicer",children:"Catalog Servicer"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# app/grpc/servicers/catalog_servicer.py\nimport grpc\nfrom typing import Optional\nfrom app.grpc import catalog_pb2, catalog_pb2_grpc\nfrom app.repositories.product_repository import ProductRepository\nfrom app.repositories.variant_repository import VariantRepository\nfrom app.database import get_db\nimport logging\n\nlogger = logging.getLogger(__name__)\n\nclass CatalogServicer(catalog_pb2_grpc.CatalogServiceServicer):\n    """Implementaci\xf3n del servicio gRPC Catalog."""\n\n    def __init__(self):\n        self.product_repo = ProductRepository()\n        self.variant_repo = VariantRepository()\n\n    async def ValidateVariant(\n        self,\n        request: catalog_pb2.ValidateVariantRequest,\n        context: grpc.aio.ServicerContext\n    ) -> catalog_pb2.ValidateVariantResponse:\n        """\n        Validar una variante de producto.\n\n        Usado principalmente por Inventory Service al inicializar stock\n        para una nueva variante.\n\n        Args:\n            request: Contiene organization_id y variant_id\n            context: Contexto gRPC\n\n        Returns:\n            ValidateVariantResponse con detalles de validaci\xf3n\n        """\n        try:\n            logger.info(\n                f"ValidateVariant called for variant_id={request.variant_id} "\n                f"org={request.organization_id}"\n            )\n\n            # Buscar variante\n            variant = await self.variant_repo.get_by_id(\n                variant_id=request.variant_id,\n                organization_id=request.organization_id\n            )\n\n            if not variant:\n                return catalog_pb2.ValidateVariantResponse(\n                    exists=False,\n                    is_active=False,\n                    message=f"Variant {request.variant_id} not found"\n                )\n\n            # Obtener producto para verificar estado\n            product = await self.product_repo.get_by_id(\n                product_id=variant.product_id,\n                organization_id=request.organization_id\n            )\n\n            is_active = (\n                variant.status == \'active\' and\n                product and\n                product.status == \'activa\'\n            )\n\n            return catalog_pb2.ValidateVariantResponse(\n                exists=True,\n                is_active=is_active,\n                variant_id=str(variant.id),\n                product_id=str(variant.product_id),\n                sku=variant.sku,\n                barcode=variant.barcode or "",\n                warehouse_id=variant.warehouse_id,\n                track_inventory=variant.track_inventory,\n                default_min_stock=variant.default_min_stock,\n                default_max_stock=variant.default_max_stock,\n                price=float(variant.sale_price),\n                message="Variant validated successfully"\n            )\n\n        except Exception as e:\n            logger.error(f"Error in ValidateVariant: {str(e)}", exc_info=True)\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(f"Internal error: {str(e)}")\n            return catalog_pb2.ValidateVariantResponse(\n                exists=False,\n                is_active=False,\n                message=f"Error: {str(e)}"\n            )\n\n    async def GetProductDetails(\n        self,\n        request: catalog_pb2.GetProductDetailsRequest,\n        context: grpc.aio.ServicerContext\n    ) -> catalog_pb2.GetProductDetailsResponse:\n        """\n        Obtener detalles completos de un producto.\n\n        Usado por Order Service, Reports, y otros servicios que necesitan\n        informaci\xf3n detallada del producto.\n\n        Args:\n            request: Contiene product_id y flags de inclusi\xf3n\n            context: Contexto gRPC\n\n        Returns:\n            GetProductDetailsResponse con producto completo\n        """\n        try:\n            logger.info(\n                f"GetProductDetails called for product_id={request.product_id} "\n                f"org={request.organization_id}"\n            )\n\n            # Obtener producto\n            product = await self.product_repo.get_by_id(\n                product_id=request.product_id,\n                organization_id=request.organization_id\n            )\n\n            if not product:\n                return catalog_pb2.GetProductDetailsResponse(\n                    success=False,\n                    message=f"Product {request.product_id} not found"\n                )\n\n            # Construir respuesta\n            product_proto = await self._build_product_proto(\n                product=product,\n                include_variants=request.include_variants,\n                include_images=request.include_images,\n                organization_id=request.organization_id\n            )\n\n            return catalog_pb2.GetProductDetailsResponse(\n                success=True,\n                product=product_proto,\n                message="Product retrieved successfully"\n            )\n\n        except Exception as e:\n            logger.error(f"Error in GetProductDetails: {str(e)}", exc_info=True)\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(f"Internal error: {str(e)}")\n            return catalog_pb2.GetProductDetailsResponse(\n                success=False,\n                message=f"Error: {str(e)}"\n            )\n\n    async def GetVariantsBatch(\n        self,\n        request: catalog_pb2.GetVariantsBatchRequest,\n        context: grpc.aio.ServicerContext\n    ) -> catalog_pb2.GetVariantsBatchResponse:\n        """Obtener m\xfaltiples variantes en una sola llamada."""\n        try:\n            logger.info(\n                f"GetVariantsBatch called for {len(request.variant_ids)} variants "\n                f"org={request.organization_id}"\n            )\n\n            variants = await self.variant_repo.get_by_ids(\n                variant_ids=list(request.variant_ids),\n                organization_id=request.organization_id\n            )\n\n            found_ids = {str(v.id) for v in variants}\n            not_found = [vid for vid in request.variant_ids if vid not in found_ids]\n\n            variant_protos = [\n                await self._build_variant_proto(v) for v in variants\n            ]\n\n            return catalog_pb2.GetVariantsBatchResponse(\n                success=True,\n                variants=variant_protos,\n                not_found_ids=not_found,\n                message=f"Retrieved {len(variants)} of {len(request.variant_ids)} variants"\n            )\n\n        except Exception as e:\n            logger.error(f"Error in GetVariantsBatch: {str(e)}", exc_info=True)\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(f"Internal error: {str(e)}")\n            return catalog_pb2.GetVariantsBatchResponse(\n                success=False,\n                message=f"Error: {str(e)}"\n            )\n\n    async def ValidateVariantsBatch(\n        self,\n        request: catalog_pb2.ValidateVariantsBatchRequest,\n        context: grpc.aio.ServicerContext\n    ) -> catalog_pb2.ValidateVariantsBatchResponse:\n        """Validar m\xfaltiples variantes en una sola llamada."""\n        try:\n            logger.info(\n                f"ValidateVariantsBatch called for {len(request.variant_ids)} variants "\n                f"org={request.organization_id}"\n            )\n\n            variants = await self.variant_repo.get_by_ids(\n                variant_ids=list(request.variant_ids),\n                organization_id=request.organization_id\n            )\n\n            # Crear mapa de validaciones\n            validations = []\n            found_ids = {str(v.id): v for v in variants}\n\n            for variant_id in request.variant_ids:\n                if variant_id in found_ids:\n                    v = found_ids[variant_id]\n                    product = await self.product_repo.get_by_id(\n                        product_id=v.product_id,\n                        organization_id=request.organization_id\n                    )\n                    is_active = (\n                        v.status == \'active\' and\n                        product and\n                        product.status == \'activa\'\n                    )\n\n                    validations.append(catalog_pb2.VariantValidation(\n                        variant_id=variant_id,\n                        exists=True,\n                        is_active=is_active,\n                        sku=v.sku,\n                        barcode=v.barcode or "",\n                        warehouse_id=v.warehouse_id,\n                        track_inventory=v.track_inventory,\n                        default_min_stock=v.default_min_stock,\n                        default_max_stock=v.default_max_stock\n                    ))\n                else:\n                    validations.append(catalog_pb2.VariantValidation(\n                        variant_id=variant_id,\n                        exists=False,\n                        is_active=False\n                    ))\n\n            return catalog_pb2.ValidateVariantsBatchResponse(\n                success=True,\n                validations=validations,\n                message=f"Validated {len(request.variant_ids)} variants"\n            )\n\n        except Exception as e:\n            logger.error(f"Error in ValidateVariantsBatch: {str(e)}", exc_info=True)\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(f"Internal error: {str(e)}")\n            return catalog_pb2.ValidateVariantsBatchResponse(\n                success=False,\n                message=f"Error: {str(e)}"\n            )\n\n    # ========================================================================\n    # Helper Methods\n    # ========================================================================\n\n    async def _build_product_proto(\n        self,\n        product,\n        include_variants: bool,\n        include_images: bool,\n        organization_id: str\n    ) -> catalog_pb2.Product:\n        """Construir mensaje Product proto desde modelo."""\n\n        # Brand\n        brand_proto = None\n        if product.brand:\n            brand_proto = catalog_pb2.Brand(\n                brand_id=str(product.brand.id),\n                name=product.brand.name,\n                slug=product.brand.slug,\n                description=product.brand.description or ""\n            )\n\n        # Images\n        images = []\n        if include_images and product.images:\n            images = [\n                catalog_pb2.ProductImage(\n                    image_id=str(img.id),\n                    url=img.url,\n                    alt=img.alt or "",\n                    position=img.position\n                )\n                for img in sorted(product.images, key=lambda x: x.position)\n            ]\n\n        # Variants\n        variants = []\n        if include_variants:\n            variants_data = await self.variant_repo.get_by_product(\n                product_id=str(product.id),\n                organization_id=organization_id\n            )\n            variants = [\n                await self._build_variant_proto(v) for v in variants_data\n            ]\n\n        # Tags\n        tags = []\n        if product.tags:\n            tags = [\n                catalog_pb2.Tag(\n                    tag_id=str(tag.id),\n                    name=tag.name\n                )\n                for tag in product.tags\n            ]\n\n        # Collections\n        collections = []\n        if product.collections:\n            collections = [\n                catalog_pb2.Collection(\n                    collection_id=str(col.id),\n                    name=col.name,\n                    slug=col.slug\n                )\n                for col in product.collections\n            ]\n\n        return catalog_pb2.Product(\n            product_id=str(product.id),\n            organization_id=product.organization_id,\n            local_id=product.local_id or "",\n            title=product.title,\n            sku=product.sku,\n            barcode=product.barcode or "",\n            description=product.description or "",\n            status=product.status,\n            product_type=product.product_type or "",\n            unit_of_measure=product.unit_of_measure,\n            alert_stock=product.alert_stock,\n            brand=brand_proto,\n            images=images,\n            variants=variants,\n            tags=tags,\n            collections=collections\n        )\n\n    async def _build_variant_proto(self, variant) -> catalog_pb2.Variant:\n        """Construir mensaje Variant proto desde modelo."""\n\n        # Dimensions\n        dimensions = catalog_pb2.Dimensions(\n            length=float(variant.dim_length or 0),\n            width=float(variant.dim_width or 0),\n            height=float(variant.dim_height or 0)\n        )\n\n        # Variant images\n        images = []\n        if variant.images:\n            images = [\n                catalog_pb2.VariantImage(\n                    image_id=str(img.id),\n                    url=img.url,\n                    alt=img.alt or "",\n                    position=img.position\n                )\n                for img in sorted(variant.images, key=lambda x: x.position)\n            ]\n\n        return catalog_pb2.Variant(\n            variant_id=str(variant.id),\n            product_id=str(variant.product_id),\n            sku=variant.sku,\n            barcode=variant.barcode or "",\n            sale_price=float(variant.sale_price),\n            cost_price=float(variant.cost_price or 0),\n            tax=float(variant.tax or 0),\n            weight=float(variant.weight or 0),\n            dimensions=dimensions,\n            lot_number=variant.lot_number or "",\n            stock_total=variant.stock_total,\n            stock_available=variant.stock_available,\n            stock_reserved=variant.stock_reserved,\n            warehouse_id=variant.warehouse_id,\n            vendor=variant.vendor or "",\n            track_inventory=variant.track_inventory,\n            default_min_stock=variant.default_min_stock,\n            default_max_stock=variant.default_max_stock,\n            images=images\n        )\n'})}),"\n",(0,r.jsx)(e.h2,{id:"casos-de-uso",children:"Casos de Uso"}),"\n",(0,r.jsx)(e.h3,{id:"1-inventory-service---validar-variante",children:"1. Inventory Service - Validar Variante"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Escenario"}),": Inventory Service necesita validar que una variante existe antes de crear stock."]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# inventory-service/app/services/stock_service.py\nfrom app.grpc.clients.catalog_client import CatalogClient\n\nasync def initialize_stock_for_variant(variant_id: str, organization_id: str):\n    """Inicializar stock para nueva variante."""\n\n    # Validar variante con Catalog Service\n    catalog_client = CatalogClient()\n    validation = await catalog_client.validate_variant(\n        variant_id=variant_id,\n        organization_id=organization_id\n    )\n\n    if not validation.exists:\n        raise ValueError(f"Variant {variant_id} does not exist")\n\n    if not validation.is_active:\n        raise ValueError(f"Variant {variant_id} is not active")\n\n    # Crear registro de stock con valores por defecto\n    stock = await stock_repo.create(\n        variant_id=variant_id,\n        warehouse_id=validation.warehouse_id,\n        organization_id=organization_id,\n        quantity=0,\n        min_stock=validation.default_min_stock,\n        max_stock=validation.default_max_stock,\n        track_inventory=validation.track_inventory\n    )\n\n    return stock\n'})}),"\n",(0,r.jsx)(e.h3,{id:"2-order-service---obtener-detalles-de-producto",children:"2. Order Service - Obtener Detalles de Producto"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Escenario"}),": Order Service necesita mostrar detalles del producto en el carrito."]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# order-service/app/services/cart_service.py\nfrom app.grpc.clients.catalog_client import CatalogClient\n\nasync def get_cart_item_details(product_id: str, organization_id: str):\n    """Obtener detalles de producto para item del carrito."""\n\n    catalog_client = CatalogClient()\n    response = await catalog_client.get_product_details(\n        product_id=product_id,\n        organization_id=organization_id,\n        include_variants=True,\n        include_images=True\n    )\n\n    if not response.success:\n        raise ValueError(f"Product {product_id} not found")\n\n    return {\n        "product_id": response.product.product_id,\n        "title": response.product.title,\n        "sku": response.product.sku,\n        "images": [img.url for img in response.product.images],\n        "variants": [\n            {\n                "variant_id": v.variant_id,\n                "sku": v.sku,\n                "price": v.sale_price,\n                "stock_available": v.stock_available\n            }\n            for v in response.product.variants\n        ]\n    }\n'})}),"\n",(0,r.jsx)(e.h3,{id:"3-batch-validation",children:"3. Batch Validation"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Escenario"}),": Validar m\xfaltiples variantes en una sola llamada (m\xe1s eficiente)."]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# inventory-service/app/services/bulk_import_service.py\nfrom app.grpc.clients.catalog_client import CatalogClient\n\nasync def validate_variants_for_import(\n    variant_ids: list[str],\n    organization_id: str\n):\n    """Validar lote de variantes antes de importar stock."""\n\n    catalog_client = CatalogClient()\n    response = await catalog_client.validate_variants_batch(\n        variant_ids=variant_ids,\n        organization_id=organization_id\n    )\n\n    # Separar v\xe1lidas de inv\xe1lidas\n    valid_variants = []\n    invalid_variants = []\n\n    for validation in response.validations:\n        if validation.exists and validation.is_active:\n            valid_variants.append({\n                "variant_id": validation.variant_id,\n                "sku": validation.sku,\n                "warehouse_id": validation.warehouse_id,\n                "min_stock": validation.default_min_stock,\n                "max_stock": validation.default_max_stock\n            })\n        else:\n            invalid_variants.append(validation.variant_id)\n\n    return valid_variants, invalid_variants\n'})}),"\n",(0,r.jsx)(e.h2,{id:"grpc-client-consumidores",children:"gRPC Client (Consumidores)"}),"\n",(0,r.jsx)(e.h3,{id:"configuraci\xf3n-del-cliente",children:"Configuraci\xf3n del Cliente"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# app/grpc/clients/catalog_client.py\nimport grpc\nfrom app.grpc import catalog_pb2, catalog_pb2_grpc\nfrom config.settings import settings\n\nclass CatalogClient:\n    """Cliente gRPC para Catalog Service."""\n\n    def __init__(self):\n        self.channel = grpc.aio.insecure_channel(\n            f\'{settings.catalog_grpc_host}:{settings.catalog_grpc_port}\'\n        )\n        self.stub = catalog_pb2_grpc.CatalogServiceStub(self.channel)\n\n    async def validate_variant(\n        self,\n        variant_id: str,\n        organization_id: str\n    ) -> catalog_pb2.ValidateVariantResponse:\n        """Validar una variante."""\n        request = catalog_pb2.ValidateVariantRequest(\n            organization_id=organization_id,\n            variant_id=variant_id\n        )\n        return await self.stub.ValidateVariant(request)\n\n    async def get_product_details(\n        self,\n        product_id: str,\n        organization_id: str,\n        include_variants: bool = True,\n        include_images: bool = True\n    ) -> catalog_pb2.GetProductDetailsResponse:\n        """Obtener detalles de producto."""\n        request = catalog_pb2.GetProductDetailsRequest(\n            organization_id=organization_id,\n            product_id=product_id,\n            include_variants=include_variants,\n            include_images=include_images\n        )\n        return await self.stub.GetProductDetails(request)\n\n    async def validate_variants_batch(\n        self,\n        variant_ids: list[str],\n        organization_id: str\n    ) -> catalog_pb2.ValidateVariantsBatchResponse:\n        """Validar m\xfaltiples variantes."""\n        request = catalog_pb2.ValidateVariantsBatchRequest(\n            organization_id=organization_id,\n            variant_ids=variant_ids\n        )\n        return await self.stub.ValidateVariantsBatch(request)\n\n    async def close(self):\n        """Cerrar canal."""\n        await self.channel.close()\n'})}),"\n",(0,r.jsx)(e.h3,{id:"configuraci\xf3n-en-settings",children:"Configuraci\xf3n en Settings"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# Otros servicios deben configurar el host del Catalog gRPC\nCATALOG_GRPC_HOST = os.getenv('CATALOG_GRPC_HOST', 'localhost')\nCATALOG_GRPC_PORT = int(os.getenv('CATALOG_GRPC_PORT', '50052'))\n"})}),"\n",(0,r.jsx)(e.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(e.h3,{id:"test-del-servicer",children:"Test del Servicer"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# tests/grpc/test_catalog_servicer.py\nimport pytest\nfrom app.grpc.servicers.catalog_servicer import CatalogServicer\nfrom app.grpc import catalog_pb2\nfrom unittest.mock import AsyncMock, MagicMock\n\n@pytest.mark.asyncio\nasync def test_validate_variant_success():\n    """Test validaci\xf3n exitosa de variante."""\n\n    # Mock repositories\n    servicer = CatalogServicer()\n    servicer.variant_repo = AsyncMock()\n    servicer.product_repo = AsyncMock()\n\n    # Mock variant\n    variant_mock = MagicMock()\n    variant_mock.id = "var_123"\n    variant_mock.product_id = "prod_456"\n    variant_mock.sku = "SKU-123"\n    variant_mock.barcode = "1234567890"\n    variant_mock.warehouse_id = "wh_01"\n    variant_mock.track_inventory = True\n    variant_mock.default_min_stock = 20\n    variant_mock.default_max_stock = 1000\n    variant_mock.sale_price = 29.99\n    variant_mock.status = \'active\'\n\n    # Mock product\n    product_mock = MagicMock()\n    product_mock.status = \'activa\'\n\n    servicer.variant_repo.get_by_id.return_value = variant_mock\n    servicer.product_repo.get_by_id.return_value = product_mock\n\n    # Request\n    request = catalog_pb2.ValidateVariantRequest(\n        organization_id="org_123",\n        variant_id="var_123"\n    )\n\n    context = MagicMock()\n\n    # Execute\n    response = await servicer.ValidateVariant(request, context)\n\n    # Assertions\n    assert response.exists is True\n    assert response.is_active is True\n    assert response.variant_id == "var_123"\n    assert response.sku == "SKU-123"\n    assert response.track_inventory is True\n    assert response.default_min_stock == 20\n\n@pytest.mark.asyncio\nasync def test_validate_variant_not_found():\n    """Test variante no encontrada."""\n\n    servicer = CatalogServicer()\n    servicer.variant_repo = AsyncMock()\n    servicer.variant_repo.get_by_id.return_value = None\n\n    request = catalog_pb2.ValidateVariantRequest(\n        organization_id="org_123",\n        variant_id="var_999"\n    )\n\n    context = MagicMock()\n\n    response = await servicer.ValidateVariant(request, context)\n\n    assert response.exists is False\n    assert response.is_active is False\n'})}),"\n",(0,r.jsx)(e.h2,{id:"manejo-de-errores",children:"Manejo de Errores"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# app/grpc/interceptors/error_interceptor.py\nimport grpc\nimport logging\n\nlogger = logging.getLogger(__name__)\n\nclass ErrorInterceptor(grpc.aio.ServerInterceptor):\n    """Interceptor para manejo centralizado de errores."""\n\n    async def intercept_service(self, continuation, handler_call_details):\n        try:\n            return await continuation(handler_call_details)\n        except ValueError as e:\n            logger.warning(f"Validation error: {str(e)}")\n            # Retornar error con c\xf3digo apropiado\n            raise grpc.RpcError(grpc.StatusCode.INVALID_ARGUMENT, str(e))\n        except Exception as e:\n            logger.error(f"Unexpected error: {str(e)}", exc_info=True)\n            raise grpc.RpcError(grpc.StatusCode.INTERNAL, "Internal server error")\n'})}),"\n",(0,r.jsx)(e.h2,{id:"monitoreo-y-logging",children:"Monitoreo y Logging"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:'# app/grpc/interceptors/logging_interceptor.py\nimport grpc\nimport time\nimport logging\n\nlogger = logging.getLogger(__name__)\n\nclass LoggingInterceptor(grpc.aio.ServerInterceptor):\n    """Interceptor para logging de llamadas gRPC."""\n\n    async def intercept_service(self, continuation, handler_call_details):\n        method = handler_call_details.method\n        start_time = time.time()\n\n        logger.info(f"gRPC call started: {method}")\n\n        try:\n            response = await continuation(handler_call_details)\n            duration = time.time() - start_time\n            logger.info(f"gRPC call completed: {method} ({duration:.3f}s)")\n            return response\n        except Exception as e:\n            duration = time.time() - start_time\n            logger.error(f"gRPC call failed: {method} ({duration:.3f}s) - {str(e)}")\n            raise\n'})}),"\n",(0,r.jsx)(e.h2,{id:"deployment",children:"Deployment"}),"\n",(0,r.jsx)(e.h3,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-dockerfile",children:"# Instalar grpcio-tools para generar c\xf3digo proto\nRUN pip install grpcio-tools\n\n# Generar c\xf3digo Python desde proto files\nRUN python -m grpc_tools.protoc \\\n    -I./protos \\\n    --python_out=./app/grpc \\\n    --grpc_python_out=./app/grpc \\\n    ./protos/catalog.proto\n"})}),"\n",(0,r.jsx)(e.h3,{id:"docker-compose",children:"Docker Compose"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'catalog-service:\n  image: catalog-service:latest\n  ports:\n    - "8002:8002"  # HTTP\n    - "50052:50052"  # gRPC\n  environment:\n    - GRPC_PORT=50052\n    - GRPC_MAX_WORKERS=10\n'})}),"\n",(0,r.jsx)(e.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"./eventos-consumidos",children:"Eventos Consumidos"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"./integraciones",children:"Integraciones"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"./api-products",children:"API REST"})}),"\n"]})]})}function g(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(l,{...n})}):l(n)}},8453:(n,e,a)=>{a.d(e,{R:()=>o,x:()=>s});var t=a(6540);const r={},i=t.createContext(r);function o(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:o(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);