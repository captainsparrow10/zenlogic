"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[9436],{7236:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>_,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"microservicios/inventory-service/modelo-datos","title":"Modelo de Datos","description":"Esquema completo de base de datos del Inventory Service con 6 entidades principales y soporte para multi-tenancy, lot tracking y serial tracking.","source":"@site/docs/02-microservicios/inventory-service/03-modelo-datos.md","sourceDirName":"02-microservicios/inventory-service","slug":"/microservicios/inventory-service/modelo-datos","permalink":"/zenlogic/microservicios/inventory-service/modelo-datos","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/inventory-service/03-modelo-datos.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docs","previous":{"title":"Arquitectura","permalink":"/zenlogic/microservicios/inventory-service/arquitectura"},"next":{"title":"Stock API","permalink":"/zenlogic/microservicios/inventory-service/api-stock"}}');var i=a(4848),s=a(8453);const r={sidebar_position:3},o="Modelo de Datos",d={},c=[{value:"Diagrama ER Completo",id:"diagrama-er-completo",level:2},{value:"Entidades Detalladas",id:"entidades-detalladas",level:2},{value:"1. Stock",id:"1-stock",level:3},{value:"2. StockMovement",id:"2-stockmovement",level:3},{value:"3. Warehouse",id:"3-warehouse",level:3},{value:"4. WarehouseLocation",id:"4-warehouselocation",level:3},{value:"5. StockTransfer",id:"5-stocktransfer",level:3},{value:"6. StockAdjustment",id:"6-stockadjustment",level:3},{value:"7. StockReservation",id:"7-stockreservation",level:3},{value:"Vistas \xdatiles",id:"vistas-\xfatiles",level:2},{value:"Vista de Stock Agregado por Variante",id:"vista-de-stock-agregado-por-variante",level:3},{value:"Vista de Alertas de Stock Bajo",id:"vista-de-alertas-de-stock-bajo",level:3},{value:"Triggers",id:"triggers",level:2},{value:"Actualizaci\xf3n Autom\xe1tica de Stock",id:"actualizaci\xf3n-autom\xe1tica-de-stock",level:3},{value:"Publicaci\xf3n de Eventos de Stock Bajo",id:"publicaci\xf3n-de-eventos-de-stock-bajo",level:3},{value:"Multi-Tenancy",id:"multi-tenancy",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"modelo-de-datos",children:"Modelo de Datos"})}),"\n",(0,i.jsx)(n.p,{children:"Esquema completo de base de datos del Inventory Service con 6 entidades principales y soporte para multi-tenancy, lot tracking y serial tracking."}),"\n",(0,i.jsx)(n.h2,{id:"diagrama-er-completo",children:"Diagrama ER Completo"}),"\n",(0,i.jsx)(n.mermaid,{value:'erDiagram\n    STOCK ||--o{ STOCK_MOVEMENT : has\n    STOCK }o--|| WAREHOUSE : stored_in\n    STOCK }o--|| WAREHOUSE_LOCATION : located_at\n    WAREHOUSE ||--o{ WAREHOUSE_LOCATION : contains\n    WAREHOUSE ||--o{ STOCK_TRANSFER : from_warehouse\n    WAREHOUSE ||--o{ STOCK_TRANSFER : to_warehouse\n    STOCK_TRANSFER ||--o{ STOCK_TRANSFER_ITEM : contains\n    STOCK ||--o{ STOCK_ADJUSTMENT : adjusts\n    STOCK ||--o{ STOCK_RESERVATION : reserves\n    STOCK_RESERVATION ||--o{ STOCK_RESERVATION_ITEM : contains\n\n    STOCK {\n        uuid stock_id PK\n        uuid organization_id FK\n        uuid variant_id FK "Catalog Service"\n        uuid warehouse_id FK\n        uuid location_id FK "nullable"\n        integer total_quantity\n        integer available_quantity\n        integer reserved_quantity\n        integer damaged_quantity\n        integer in_transit_quantity\n        integer min_stock\n        integer max_stock\n        integer reorder_point\n        string stock_strategy "FIFO,LIFO,FEFO"\n        integer version\n        boolean track_lots\n        boolean track_serial_numbers\n        timestamp last_movement_at\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    STOCK_MOVEMENT {\n        uuid movement_id PK\n        uuid organization_id FK\n        uuid stock_id FK\n        string type "in,out,transfer,adjustment"\n        integer quantity_before\n        integer quantity_after\n        integer quantity_change\n        string lot_number "nullable"\n        string serial_number "nullable"\n        date expiry_date "nullable"\n        string reason\n        uuid reference_id "nullable"\n        string reference_type "nullable"\n        uuid created_by FK\n        text notes "nullable"\n        timestamp created_at\n    }\n\n    WAREHOUSE {\n        uuid warehouse_id PK\n        uuid organization_id FK\n        uuid local_id FK "Auth Service"\n        string name\n        string code\n        string warehouse_type "main,branch,virtual"\n        boolean is_active\n        integer max_capacity "nullable"\n        integer current_capacity\n        json address\n        string contact_phone "nullable"\n        string contact_email "nullable"\n        json operating_hours "nullable"\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    WAREHOUSE_LOCATION {\n        uuid location_id PK\n        uuid organization_id FK\n        uuid warehouse_id FK\n        uuid parent_location_id FK "nullable"\n        string name\n        string code\n        string location_type "zone,aisle,rack,shelf,bin"\n        integer level\n        integer max_capacity "nullable"\n        integer current_capacity\n        boolean is_active\n        json metadata "nullable"\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    STOCK_TRANSFER {\n        uuid transfer_id PK\n        uuid organization_id FK\n        uuid from_warehouse_id FK\n        uuid to_warehouse_id FK\n        string status "pending,approved,in_transit,received,cancelled"\n        string transfer_type "regular,emergency,return"\n        date scheduled_date "nullable"\n        date shipped_date "nullable"\n        date received_date "nullable"\n        uuid requested_by FK\n        uuid approved_by FK "nullable"\n        uuid received_by FK "nullable"\n        string cancellation_reason "nullable"\n        text notes "nullable"\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    STOCK_TRANSFER_ITEM {\n        uuid transfer_item_id PK\n        uuid transfer_id FK\n        uuid variant_id FK\n        integer quantity_requested\n        integer quantity_sent\n        integer quantity_received\n        string lot_number "nullable"\n        string serial_number "nullable"\n        string condition "good,damaged"\n        text notes "nullable"\n    }\n\n    STOCK_ADJUSTMENT {\n        uuid adjustment_id PK\n        uuid organization_id FK\n        uuid stock_id FK\n        string adjustment_type "positive,negative"\n        integer quantity_before\n        integer quantity_after\n        integer quantity_change\n        string reason "damaged,expired,lost,found,audit,other"\n        string status "pending,approved,rejected,applied"\n        uuid created_by FK\n        uuid approved_by FK "nullable"\n        date approval_date "nullable"\n        text notes "nullable"\n        json metadata "nullable"\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    STOCK_RESERVATION {\n        uuid reservation_id PK\n        uuid organization_id FK\n        uuid order_id FK "Order Service"\n        string status "active,fulfilled,cancelled,expired"\n        timestamp expires_at\n        timestamp fulfilled_at "nullable"\n        timestamp created_at\n    }\n\n    STOCK_RESERVATION_ITEM {\n        uuid reservation_item_id PK\n        uuid reservation_id FK\n        uuid stock_id FK\n        uuid variant_id FK\n        uuid warehouse_id FK\n        integer quantity\n        integer stock_before\n        integer stock_after\n        timestamp created_at\n    }'}),"\n",(0,i.jsx)(n.h2,{id:"entidades-detalladas",children:"Entidades Detalladas"}),"\n",(0,i.jsx)(n.h3,{id:"1-stock",children:"1. Stock"}),"\n",(0,i.jsx)(n.p,{children:"Registro principal de inventario por variante, bodega y ubicaci\xf3n."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE stock (\n    stock_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    variant_id UUID NOT NULL,  -- FK a Catalog Service\n    warehouse_id UUID NOT NULL REFERENCES warehouses(warehouse_id),\n    location_id UUID REFERENCES warehouse_locations(location_id),\n\n    -- Cantidades\n    total_quantity INTEGER NOT NULL DEFAULT 0,\n    available_quantity INTEGER NOT NULL DEFAULT 0,\n    reserved_quantity INTEGER NOT NULL DEFAULT 0,\n    damaged_quantity INTEGER NOT NULL DEFAULT 0,\n    in_transit_quantity INTEGER NOT NULL DEFAULT 0,\n\n    -- Control de stock\n    min_stock INTEGER NOT NULL DEFAULT 0,\n    max_stock INTEGER NOT NULL DEFAULT 0,\n    reorder_point INTEGER NOT NULL DEFAULT 0,  -- Punto de reorden (cuando disparar compra autom\xe1tica)\n    stock_strategy VARCHAR(10) NOT NULL DEFAULT 'FIFO',\n\n    -- Optimistic locking\n    version INTEGER NOT NULL DEFAULT 1,  -- Para concurrencia optimista\n\n    -- Tracking configuraci\xf3n\n    track_lots BOOLEAN NOT NULL DEFAULT FALSE,  -- Si se rastrea por lotes\n    track_serial_numbers BOOLEAN NOT NULL DEFAULT FALSE,  -- Si se rastrea por serial numbers\n\n    -- Timestamps\n    last_movement_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    -- Constraints\n    CONSTRAINT stock_org_variant_warehouse_unique UNIQUE (organization_id, variant_id, warehouse_id),\n    CONSTRAINT stock_quantities_valid CHECK (total_quantity = available_quantity + reserved_quantity + damaged_quantity + in_transit_quantity),\n    CONSTRAINT stock_min_max_valid CHECK (min_stock <= max_stock),\n    CONSTRAINT stock_reorder_valid CHECK (reorder_point >= min_stock AND reorder_point <= max_stock)\n);\n\nCREATE INDEX idx_stock_organization ON stock(organization_id);\nCREATE INDEX idx_stock_variant ON stock(variant_id);\nCREATE INDEX idx_stock_warehouse ON stock(warehouse_id);\nCREATE INDEX idx_stock_location ON stock(location_id) WHERE location_id IS NOT NULL;\nCREATE INDEX idx_stock_low_stock ON stock(organization_id, available_quantity) WHERE available_quantity <= min_stock;\nCREATE INDEX idx_stock_reorder ON stock(organization_id, available_quantity) WHERE available_quantity <= reorder_point;\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Campos Clave:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reorder_point"}),": Cantidad que dispara una orden de compra autom\xe1tica (debe estar entre min_stock y max_stock)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"version"}),": Para optimistic locking (evitar race conditions en actualizaciones concurrentes)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"track_lots"}),": Si se debe rastrear n\xfameros de lote para este stock"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"track_serial_numbers"}),": Si se debe rastrear n\xfameros de serie individuales"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Campos Calculados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"total_quantity"})," = available + reserved + damaged + in_transit"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"stock_status"}),': "in_stock", "low_stock", "out_of_stock", "reorder_needed"']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"fill_rate"}),": available / max_stock"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Estrategias de Stock:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"FIFO"}),": First In, First Out (por defecto)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"LIFO"}),": Last In, First Out"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"FEFO"}),": First Expired, First Out (autom\xe1tico con expiry_date)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"2-stockmovement",children:"2. StockMovement"}),"\n",(0,i.jsx)(n.p,{children:"Historial completo de todos los movimientos de inventario."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE stock_movements (\n    movement_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    stock_id UUID NOT NULL REFERENCES stock(stock_id),\n\n    -- Tipo y cantidades\n    type VARCHAR(20) NOT NULL,  -- 'in', 'out', 'transfer', 'adjustment'\n    quantity_before INTEGER NOT NULL,\n    quantity_after INTEGER NOT NULL,\n    quantity_change INTEGER NOT NULL,\n\n    -- Tracking\n    lot_number VARCHAR(100),\n    serial_number VARCHAR(100),\n    expiry_date DATE,\n\n    -- Contexto\n    reason VARCHAR(100) NOT NULL,\n    reference_id UUID,  -- PO, SO, Transfer, Adjustment\n    reference_type VARCHAR(50),\n    created_by UUID NOT NULL,\n    notes TEXT,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT movement_type_valid CHECK (type IN ('in', 'out', 'transfer', 'adjustment')),\n    CONSTRAINT movement_quantity_change_valid CHECK (\n        (type IN ('in', 'transfer') AND quantity_change > 0) OR\n        (type IN ('out', 'adjustment') AND quantity_change < 0)\n    )\n);\n\nCREATE INDEX idx_movements_stock ON stock_movements(stock_id);\nCREATE INDEX idx_movements_organization ON stock_movements(organization_id);\nCREATE INDEX idx_movements_type ON stock_movements(type);\nCREATE INDEX idx_movements_created_at ON stock_movements(created_at DESC);\nCREATE INDEX idx_movements_lot ON stock_movements(lot_number) WHERE lot_number IS NOT NULL;\nCREATE INDEX idx_movements_serial ON stock_movements(serial_number) WHERE serial_number IS NOT NULL;\nCREATE INDEX idx_movements_reference ON stock_movements(reference_id, reference_type) WHERE reference_id IS NOT NULL;\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Tipos de Movimientos:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"in"}),": Entrada de mercanc\xeda (compra, devoluci\xf3n)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"out"}),": Salida de mercanc\xeda (venta, transferencia)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"transfer"}),": Movimiento entre ubicaciones/bodegas"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"adjustment"}),": Ajuste de inventario"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Motivos Comunes:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"MOVEMENT_REASONS = {\n    'in': ['purchase', 'return', 'production', 'found', 'adjustment'],\n    'out': ['sale', 'transfer', 'damage', 'loss', 'sample', 'donation'],\n    'transfer': ['restock', 'relocation', 'consolidation'],\n    'adjustment': ['audit', 'correction', 'damaged', 'expired']\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-warehouse",children:"3. Warehouse"}),"\n",(0,i.jsx)(n.p,{children:"Bodegas f\xedsicas o virtuales de la organizaci\xf3n."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE warehouses (\n    warehouse_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    local_id UUID NOT NULL,  -- FK a Auth Service\n\n    -- Identificaci\xf3n\n    name VARCHAR(200) NOT NULL,\n    code VARCHAR(50) NOT NULL,\n    warehouse_type VARCHAR(20) NOT NULL DEFAULT 'main',\n    is_active BOOLEAN NOT NULL DEFAULT true,\n\n    -- Capacidad\n    max_capacity INTEGER,\n    current_capacity INTEGER NOT NULL DEFAULT 0,\n\n    -- Informaci\xf3n de contacto\n    address JSONB NOT NULL,\n    contact_phone VARCHAR(20),\n    contact_email VARCHAR(255),\n    operating_hours JSONB,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT warehouse_org_code_unique UNIQUE (organization_id, code),\n    CONSTRAINT warehouse_type_valid CHECK (warehouse_type IN ('main', 'branch', 'virtual')),\n    CONSTRAINT warehouse_capacity_valid CHECK (current_capacity <= max_capacity OR max_capacity IS NULL)\n);\n\nCREATE INDEX idx_warehouse_organization ON warehouses(organization_id);\nCREATE INDEX idx_warehouse_local ON warehouses(local_id);\nCREATE INDEX idx_warehouse_active ON warehouses(organization_id, is_active);\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"warehouse_type:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"main"}),": Bodega principal"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"branch"}),": Bodega de sucursal"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"virtual"}),": Bodega virtual (dropshipping, consignaci\xf3n)"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"address JSON Schema:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "street": "Av. Principal 123",\n  "city": "Ciudad de Panam\xe1",\n  "state": "Panam\xe1",\n  "country": "PA",\n  "postal_code": "00001",\n  "coordinates": {\n    "lat": 8.983333,\n    "lng": -79.516667\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"operating_hours JSON Schema:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "monday": {"open": "08:00", "close": "18:00"},\n  "tuesday": {"open": "08:00", "close": "18:00"},\n  "saturday": {"open": "09:00", "close": "13:00"},\n  "sunday": null\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"4-warehouselocation",children:"4. WarehouseLocation"}),"\n",(0,i.jsx)(n.p,{children:"Ubicaciones f\xedsicas jer\xe1rquicas dentro de las bodegas."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE warehouse_locations (\n    location_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    warehouse_id UUID NOT NULL REFERENCES warehouses(warehouse_id),\n    parent_location_id UUID REFERENCES warehouse_locations(location_id),\n\n    -- Identificaci\xf3n\n    name VARCHAR(200) NOT NULL,\n    code VARCHAR(50) NOT NULL,\n    location_type VARCHAR(20) NOT NULL,\n    level INTEGER NOT NULL DEFAULT 0,\n\n    -- Capacidad\n    max_capacity INTEGER,\n    current_capacity INTEGER NOT NULL DEFAULT 0,\n    is_active BOOLEAN NOT NULL DEFAULT true,\n\n    -- Metadata adicional\n    metadata JSONB,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT location_warehouse_code_unique UNIQUE (warehouse_id, code),\n    CONSTRAINT location_type_valid CHECK (location_type IN ('zone', 'aisle', 'rack', 'shelf', 'bin')),\n    CONSTRAINT location_capacity_valid CHECK (current_capacity <= max_capacity OR max_capacity IS NULL)\n);\n\nCREATE INDEX idx_location_warehouse ON warehouse_locations(warehouse_id);\nCREATE INDEX idx_location_parent ON warehouse_locations(parent_location_id) WHERE parent_location_id IS NOT NULL;\nCREATE INDEX idx_location_type ON warehouse_locations(location_type);\nCREATE INDEX idx_location_active ON warehouse_locations(warehouse_id, is_active);\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Jerarqu\xeda de Ubicaciones:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Warehouse\n\u2514\u2500\u2500 Zone (Zona de almacenamiento)\n    \u2514\u2500\u2500 Aisle (Pasillo)\n        \u2514\u2500\u2500 Rack (Estanter\xeda)\n            \u2514\u2500\u2500 Shelf (Estante)\n                \u2514\u2500\u2500 Bin (Contenedor/Casillero)\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Ejemplo de C\xf3digo de Ubicaci\xf3n:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"WH01-Z01-A05-R03-S02-B01\n\u2502    \u2502   \u2502   \u2502   \u2502   \u2514\u2500\u2500 Bin 01\n\u2502    \u2502   \u2502   \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500 Shelf 02\n\u2502    \u2502   \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Rack 03\n\u2502    \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Aisle 05\n\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Zone 01\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Warehouse 01\n"})}),"\n",(0,i.jsx)(n.h3,{id:"5-stocktransfer",children:"5. StockTransfer"}),"\n",(0,i.jsx)(n.p,{children:"Transferencias de inventario entre bodegas."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE stock_transfers (\n    transfer_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    from_warehouse_id UUID NOT NULL REFERENCES warehouses(warehouse_id),\n    to_warehouse_id UUID NOT NULL REFERENCES warehouses(warehouse_id),\n\n    -- Estado y tipo\n    status VARCHAR(20) NOT NULL DEFAULT 'pending',\n    transfer_type VARCHAR(20) NOT NULL DEFAULT 'regular',\n\n    -- Fechas\n    scheduled_date DATE,\n    shipped_date DATE,\n    received_date DATE,\n\n    -- Aprobaciones\n    requested_by UUID NOT NULL,\n    approved_by UUID,\n    received_by UUID,\n\n    -- Informaci\xf3n adicional\n    cancellation_reason VARCHAR(500),\n    notes TEXT,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT transfer_status_valid CHECK (status IN ('pending', 'approved', 'in_transit', 'received', 'cancelled')),\n    CONSTRAINT transfer_type_valid CHECK (transfer_type IN ('regular', 'emergency', 'return')),\n    CONSTRAINT transfer_different_warehouses CHECK (from_warehouse_id != to_warehouse_id)\n);\n\nCREATE TABLE stock_transfer_items (\n    transfer_item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    transfer_id UUID NOT NULL REFERENCES stock_transfers(transfer_id) ON DELETE CASCADE,\n    variant_id UUID NOT NULL,\n\n    -- Cantidades\n    quantity_requested INTEGER NOT NULL,\n    quantity_sent INTEGER NOT NULL DEFAULT 0,\n    quantity_received INTEGER NOT NULL DEFAULT 0,\n\n    -- Tracking\n    lot_number VARCHAR(100),\n    serial_number VARCHAR(100),\n    condition VARCHAR(20) NOT NULL DEFAULT 'good',\n    notes TEXT,\n\n    CONSTRAINT transfer_item_quantities_valid CHECK (\n        quantity_sent <= quantity_requested AND\n        quantity_received <= quantity_sent\n    ),\n    CONSTRAINT transfer_item_condition_valid CHECK (condition IN ('good', 'damaged'))\n);\n\nCREATE INDEX idx_transfer_organization ON stock_transfers(organization_id);\nCREATE INDEX idx_transfer_from_warehouse ON stock_transfers(from_warehouse_id);\nCREATE INDEX idx_transfer_to_warehouse ON stock_transfers(to_warehouse_id);\nCREATE INDEX idx_transfer_status ON stock_transfers(status);\nCREATE INDEX idx_transfer_created_at ON stock_transfers(created_at DESC);\nCREATE INDEX idx_transfer_items_transfer ON stock_transfer_items(transfer_id);\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Estados de Transferencia:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pending"}),": Creada, esperando aprobaci\xf3n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"approved"}),": Aprobada, lista para env\xedo"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"in_transit"}),": En tr\xe1nsito a bodega destino"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"received"}),": Recibida en destino"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cancelled"}),": Cancelada"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Tipos de Transferencia:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"regular"}),": Transferencia normal programada"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"emergency"}),": Transferencia urgente"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"return"}),": Devoluci\xf3n de mercanc\xeda"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"6-stockadjustment",children:"6. StockAdjustment"}),"\n",(0,i.jsx)(n.p,{children:"Ajustes de inventario para correcciones y auditor\xedas."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE stock_adjustments (\n    adjustment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    stock_id UUID NOT NULL REFERENCES stock(stock_id),\n\n    -- Tipo y cantidades\n    adjustment_type VARCHAR(20) NOT NULL,\n    quantity_before INTEGER NOT NULL,\n    quantity_after INTEGER NOT NULL,\n    quantity_change INTEGER NOT NULL,\n\n    -- Motivo y estado\n    reason VARCHAR(50) NOT NULL,\n    status VARCHAR(20) NOT NULL DEFAULT 'pending',\n\n    -- Aprobaci\xf3n\n    created_by UUID NOT NULL,\n    approved_by UUID,\n    approval_date DATE,\n\n    notes TEXT,\n    metadata JSONB,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT adjustment_type_valid CHECK (adjustment_type IN ('positive', 'negative')),\n    CONSTRAINT adjustment_status_valid CHECK (status IN ('pending', 'approved', 'rejected', 'applied')),\n    CONSTRAINT adjustment_reason_valid CHECK (reason IN ('damaged', 'expired', 'lost', 'found', 'audit', 'other')),\n    CONSTRAINT adjustment_change_matches_type CHECK (\n        (adjustment_type = 'positive' AND quantity_change > 0) OR\n        (adjustment_type = 'negative' AND quantity_change < 0)\n    )\n);\n\nCREATE INDEX idx_adjustment_organization ON stock_adjustments(organization_id);\nCREATE INDEX idx_adjustment_stock ON stock_adjustments(stock_id);\nCREATE INDEX idx_adjustment_status ON stock_adjustments(status);\nCREATE INDEX idx_adjustment_created_by ON stock_adjustments(created_by);\nCREATE INDEX idx_adjustment_created_at ON stock_adjustments(created_at DESC);\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Motivos de Ajuste:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"damaged"}),": Producto da\xf1ado"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"expired"}),": Producto vencido"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"lost"}),": P\xe9rdida de inventario"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"found"}),": Inventario encontrado (sobrante)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"audit"}),": Ajuste por auditor\xeda f\xedsica"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"other"}),": Otro motivo (especificar en notes)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"7-stockreservation",children:"7. StockReservation"}),"\n",(0,i.jsx)(n.p,{children:"Reservas de stock para \xf3rdenes pendientes."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE stock_reservations (\n    reservation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    order_id UUID NOT NULL,  -- FK a Order Service\n\n    status VARCHAR(20) NOT NULL DEFAULT 'active',\n\n    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    fulfilled_at TIMESTAMP WITH TIME ZONE,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT reservation_status_valid CHECK (status IN ('active', 'fulfilled', 'cancelled', 'expired'))\n);\n\nCREATE TABLE stock_reservation_items (\n    reservation_item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    reservation_id UUID NOT NULL REFERENCES stock_reservations(reservation_id) ON DELETE CASCADE,\n    stock_id UUID NOT NULL REFERENCES stock(stock_id),\n    variant_id UUID NOT NULL,\n    warehouse_id UUID NOT NULL,\n\n    quantity INTEGER NOT NULL,\n    stock_before INTEGER NOT NULL,\n    stock_after INTEGER NOT NULL,\n\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT reservation_item_quantity_positive CHECK (quantity > 0),\n    CONSTRAINT reservation_item_stock_valid CHECK (stock_after = stock_before - quantity)\n);\n\nCREATE INDEX idx_reservation_organization ON stock_reservations(organization_id);\nCREATE INDEX idx_reservation_order ON stock_reservations(order_id);\nCREATE INDEX idx_reservation_status ON stock_reservations(status);\nCREATE INDEX idx_reservation_expires ON stock_reservations(expires_at) WHERE status = 'active';\n\nCREATE INDEX idx_reservation_item_reservation ON stock_reservation_items(reservation_id);\nCREATE INDEX idx_reservation_item_stock ON stock_reservation_items(stock_id);\nCREATE INDEX idx_reservation_item_variant ON stock_reservation_items(variant_id);\nCREATE INDEX idx_reservation_item_warehouse ON stock_reservation_items(warehouse_id);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vistas-\xfatiles",children:"Vistas \xdatiles"}),"\n",(0,i.jsx)(n.h3,{id:"vista-de-stock-agregado-por-variante",children:"Vista de Stock Agregado por Variante"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE VIEW v_stock_summary AS\nSELECT\n    s.organization_id,\n    s.variant_id,\n    COUNT(DISTINCT s.warehouse_id) as warehouse_count,\n    SUM(s.total_quantity) as total_quantity,\n    SUM(s.available_quantity) as available_quantity,\n    SUM(s.reserved_quantity) as reserved_quantity,\n    SUM(s.damaged_quantity) as damaged_quantity,\n    MIN(s.min_stock) as min_stock,\n    MAX(s.max_stock) as max_stock,\n    CASE\n        WHEN SUM(s.available_quantity) = 0 THEN 'out_of_stock'\n        WHEN SUM(s.available_quantity) <= MIN(s.min_stock) THEN 'low_stock'\n        ELSE 'in_stock'\n    END as stock_status\nFROM stock s\nGROUP BY s.organization_id, s.variant_id;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vista-de-alertas-de-stock-bajo",children:"Vista de Alertas de Stock Bajo"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE VIEW v_low_stock_alerts AS\nSELECT\n    s.stock_id,\n    s.organization_id,\n    s.variant_id,\n    s.warehouse_id,\n    w.name as warehouse_name,\n    s.available_quantity,\n    s.min_stock,\n    (s.min_stock - s.available_quantity) as quantity_needed,\n    s.last_movement_at\nFROM stock s\nJOIN warehouses w ON s.warehouse_id = w.warehouse_id\nWHERE s.available_quantity <= s.min_stock\n  AND w.is_active = true\nORDER BY (s.min_stock - s.available_quantity) DESC;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"triggers",children:"Triggers"}),"\n",(0,i.jsx)(n.h3,{id:"actualizaci\xf3n-autom\xe1tica-de-stock",children:"Actualizaci\xf3n Autom\xe1tica de Stock"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION update_stock_on_movement()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE stock\n    SET\n        total_quantity = total_quantity + NEW.quantity_change,\n        available_quantity = available_quantity + NEW.quantity_change,\n        last_movement_at = NEW.created_at,\n        updated_at = CURRENT_TIMESTAMP\n    WHERE stock_id = NEW.stock_id;\n\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_update_stock_on_movement\nAFTER INSERT ON stock_movements\nFOR EACH ROW\nEXECUTE FUNCTION update_stock_on_movement();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"publicaci\xf3n-de-eventos-de-stock-bajo",children:"Publicaci\xf3n de Eventos de Stock Bajo"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION notify_low_stock()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.available_quantity <= NEW.min_stock AND\n       OLD.available_quantity > OLD.min_stock THEN\n        PERFORM pg_notify(\n            'low_stock_alert',\n            json_build_object(\n                'stock_id', NEW.stock_id,\n                'variant_id', NEW.variant_id,\n                'warehouse_id', NEW.warehouse_id,\n                'available', NEW.available_quantity,\n                'min_stock', NEW.min_stock\n            )::text\n        );\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_notify_low_stock\nAFTER UPDATE ON stock\nFOR EACH ROW\nEXECUTE FUNCTION notify_low_stock();\n"})}),"\n",(0,i.jsx)(n.h2,{id:"multi-tenancy",children:"Multi-Tenancy"}),"\n",(0,i.jsxs)(n.p,{children:["Todas las tablas incluyen ",(0,i.jsx)(n.code,{children:"organization_id"})," con Row-Level Security (RLS):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Habilitar RLS en todas las tablas\nALTER TABLE stock ENABLE ROW LEVEL SECURITY;\nALTER TABLE stock_movements ENABLE ROW LEVEL SECURITY;\nALTER TABLE warehouses ENABLE ROW LEVEL SECURITY;\nALTER TABLE warehouse_locations ENABLE ROW LEVEL SECURITY;\nALTER TABLE stock_transfers ENABLE ROW LEVEL SECURITY;\nALTER TABLE stock_adjustments ENABLE ROW LEVEL SECURITY;\nALTER TABLE stock_reservations ENABLE ROW LEVEL SECURITY;\n\n-- Pol\xedtica de ejemplo para stock\nCREATE POLICY stock_organization_isolation ON stock\n    USING (organization_id = current_setting('app.current_organization_id')::uuid);\n\n-- Pol\xedtica de ejemplo para reservations\nCREATE POLICY stock_reservations_organization_isolation ON stock_reservations\n    USING (organization_id = current_setting('app.current_organization_id')::uuid);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./arquitectura",children:"Arquitectura"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./api-stock",children:"API: Stock"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./api-movements",children:"API: Movements"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./api-warehouses",children:"API: Warehouses"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./api-transfers",children:"API: Transfers"})}),"\n"]})]})}function _(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>o});var t=a(6540);const i={},s=t.createContext(i);function r(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);