"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1476],{1580:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"guias/crear-microservicio","title":"Crear un Nuevo Microservicio","description":"Gu\xeda paso a paso para crear un nuevo microservicio en zenLogic siguiendo los patrones establecidos.","source":"@site/docs/05-guias/01-crear-microservicio.md","sourceDirName":"05-guias","slug":"/guias/crear-microservicio","permalink":"/zenlogic/guias/crear-microservicio","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/05-guias/01-crear-microservicio.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docs","previous":{"title":"Setup Local de Desarrollo","permalink":"/zenlogic/guias/setup-local"},"next":{"title":"Testing","permalink":"/zenlogic/guias/testing"}}');var a=s(4848),t=s(8453);const r={sidebar_position:2},o="Crear un Nuevo Microservicio",c={},l=[{value:"Estructura del Microservicio",id:"estructura-del-microservicio",level:2},{value:"Paso 1: Crear Proyecto Base",id:"paso-1-crear-proyecto-base",level:2},{value:"Paso 2: Configuraci\xf3n (config.py)",id:"paso-2-configuraci\xf3n-configpy",level:2},{value:"Paso 3: Database (database.py)",id:"paso-3-database-databasepy",level:2},{value:"Paso 4: Main App (main.py)",id:"paso-4-main-app-mainpy",level:2},{value:"Paso 5: Event Publisher",id:"paso-5-event-publisher",level:2},{value:"Paso 6: Requirements",id:"paso-6-requirements",level:2},{value:"Paso 7: Docker",id:"paso-7-docker",level:2},{value:"Paso 8: A\xf1adir a Docker Compose",id:"paso-8-a\xf1adir-a-docker-compose",level:2},{value:"Paso 9: Inicializar Alembic",id:"paso-9-inicializar-alembic",level:2},{value:"Paso 10: Testing",id:"paso-10-testing",level:2},{value:"Checklist de Integraci\xf3n",id:"checklist-de-integraci\xf3n",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",input:"input",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"crear-un-nuevo-microservicio",children:"Crear un Nuevo Microservicio"})}),"\n",(0,a.jsx)(n.p,{children:"Gu\xeda paso a paso para crear un nuevo microservicio en zenLogic siguiendo los patrones establecidos."}),"\n",(0,a.jsx)(n.h2,{id:"estructura-del-microservicio",children:"Estructura del Microservicio"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"new-service/\n\u251c\u2500\u2500 app/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 main.py              # FastAPI app\n\u2502   \u251c\u2500\u2500 config.py            # Settings\n\u2502   \u251c\u2500\u2500 database.py          # DB connection\n\u2502   \u251c\u2500\u2500 models/              # SQLAlchemy models\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2502   \u2514\u2500\u2500 base.py\n\u2502   \u251c\u2500\u2500 schemas/             # Pydantic schemas\n\u2502   \u2502   \u2514\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 api/                 # API routers\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2502   \u2514\u2500\u2500 v1/\n\u2502   \u251c\u2500\u2500 services/            # Business logic\n\u2502   \u2502   \u2514\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 repositories/        # Data access\n\u2502   \u2502   \u2514\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 events/              # Event handlers\n\u2502   \u2502   \u251c\u2500\u2500 publisher.py\n\u2502   \u2502   \u2514\u2500\u2500 consumer.py\n\u2502   \u251c\u2500\u2500 grpc_server/         # gRPC (si aplica)\n\u2502   \u2502   \u2514\u2500\u2500 server.py\n\u2502   \u2514\u2500\u2500 clients/             # External clients\n\u2502       \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 tests/\n\u2502   \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 alembic/                 # Migrations\n\u2502   \u2514\u2500\u2500 versions/\n\u251c\u2500\u2500 scripts/\n\u2502   \u2514\u2500\u2500 seed_data.py\n\u251c\u2500\u2500 requirements.txt\n\u251c\u2500\u2500 .env.example\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 alembic.ini\n\u2514\u2500\u2500 README.md\n"})}),"\n",(0,a.jsx)(n.h2,{id:"paso-1-crear-proyecto-base",children:"Paso 1: Crear Proyecto Base"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Crear directorio\nmkdir services/new-service\ncd services/new-service\n\n# Crear estructura\nmkdir -p app/{models,schemas,api/v1,services,repositories,events,grpc_server,clients}\nmkdir -p tests scripts alembic/versions\n\n# Crear __init__.py\ntouch app/__init__.py\ntouch app/models/__init__.py\ntouch app/schemas/__init__.py\ntouch app/api/__init__.py\ntouch app/api/v1/__init__.py\ntouch tests/__init__.py\n"})}),"\n",(0,a.jsx)(n.h2,{id:"paso-2-configuraci\xf3n-configpy",children:"Paso 2: Configuraci\xf3n (config.py)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# app/config.py\nfrom pydantic_settings import BaseSettings\nfrom pydantic import Field\n\nclass Settings(BaseSettings):\n    """Configuraci\xf3n del servicio."""\n\n    # Service\n    service_name: str = "new-service"\n    api_port: int = Field(default=8004)\n    debug: bool = Field(default=False)\n\n    # Database\n    database_url: str = Field(..., env="DATABASE_URL")\n\n    # Redis\n    redis_url: str = Field(..., env="REDIS_URL")\n\n    # RabbitMQ\n    rabbitmq_url: str = Field(..., env="RABBITMQ_URL")\n    rabbitmq_exchange: str = Field(default="erp.events")\n\n    # Auth gRPC (si necesita validar con Auth)\n    auth_grpc_url: str = Field(default="localhost:50051")\n\n    # CORS\n    cors_origins: list[str] = Field(default=["http://localhost:3000"])\n\n    class Config:\n        env_file = ".env"\n        case_sensitive = False\n\nsettings = Settings()\n'})}),"\n",(0,a.jsx)(n.h2,{id:"paso-3-database-databasepy",children:"Paso 3: Database (database.py)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# app/database.py\nfrom sqlalchemy.ext.asyncio import create_async_engine, AsyncSession\nfrom sqlalchemy.orm import sessionmaker, declarative_base\nfrom sqlalchemy import text\nfrom app.config import settings\n\n# Base para modelos\nBase = declarative_base()\n\n# Engine\nengine = create_async_engine(\n    settings.database_url,\n    echo=settings.debug,\n    pool_size=20,\n    max_overflow=10,\n    pool_pre_ping=True\n)\n\n# Session factory\nasync_session_factory = sessionmaker(\n    engine,\n    class_=AsyncSession,\n    expire_on_commit=False\n)\n\nasync def get_db() -> AsyncSession:\n    """Dependency para obtener sesi\xf3n de DB."""\n    async with async_session_factory() as session:\n        yield session\n'})}),"\n",(0,a.jsx)(n.h2,{id:"paso-4-main-app-mainpy",children:"Paso 4: Main App (main.py)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# app/main.py\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom app.config import settings\nfrom app.api.v1 import router as api_router\nfrom app.events.publisher import event_publisher\nfrom app.events.consumer import event_consumer\n\napp = FastAPI(\n    title=f"{settings.service_name}",\n    version="1.0.0",\n    docs_url="/docs",\n    redoc_url="/redoc"\n)\n\n# CORS\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=settings.cors_origins,\n    allow_credentials=True,\n    allow_methods=["*"],\n    allow_headers=["*"],\n)\n\n# Routes\napp.include_router(api_router, prefix="/api/v1")\n\n# Health check\n@app.get("/health")\nasync def health_check():\n    return {"status": "healthy", "service": settings.service_name}\n\n# Startup\n@app.on_event("startup")\nasync def startup():\n    # Conectar event publisher\n    await event_publisher.connect()\n\n    # Iniciar event consumer\n    import asyncio\n    asyncio.create_task(event_consumer.start())\n\n# Shutdown\n@app.on_event("shutdown")\nasync def shutdown():\n    await event_publisher.close()\n    await event_consumer.stop()\n'})}),"\n",(0,a.jsx)(n.h2,{id:"paso-5-event-publisher",children:"Paso 5: Event Publisher"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# app/events/publisher.py\nimport aio_pika\nimport json\nfrom uuid import uuid4\nfrom datetime import datetime\nfrom app.config import settings\n\nclass EventPublisher:\n    def __init__(self):\n        self.connection = None\n        self.channel = None\n        self.exchange = None\n\n    async def connect(self):\n        self.connection = await aio_pika.connect_robust(settings.rabbitmq_url)\n        self.channel = await self.connection.channel()\n        self.exchange = await self.channel.declare_exchange(\n            settings.rabbitmq_exchange,\n            aio_pika.ExchangeType.TOPIC,\n            durable=True\n        )\n\n    async def publish(self, event_type: str, payload: dict):\n        event = {\n            "event_id": str(uuid4()),\n            "event_type": event_type,\n            "timestamp": datetime.utcnow().isoformat(),\n            "service": settings.service_name,\n            "payload": payload\n        }\n\n        message = aio_pika.Message(\n            body=json.dumps(event).encode(),\n            delivery_mode=aio_pika.DeliveryMode.PERSISTENT\n        )\n\n        await self.exchange.publish(message, routing_key=event_type)\n\n    async def close(self):\n        if self.connection:\n            await self.connection.close()\n\nevent_publisher = EventPublisher()\n'})}),"\n",(0,a.jsx)(n.h2,{id:"paso-6-requirements",children:"Paso 6: Requirements"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-txt",children:"# requirements.txt\nfastapi==0.104.1\nuvicorn[standard]==0.24.0\nsqlalchemy[asyncio]==2.0.23\nasyncpg==0.29.0\nalembic==1.12.1\npydantic==2.5.0\npydantic-settings==2.1.0\naio-pika==9.3.0\naioredis==2.0.1\ngrpcio==1.59.3\nprometheus-client==0.19.0\n\n# Testing\npytest==7.4.3\npytest-asyncio==0.21.1\npytest-cov==4.1.0\nhttpx==0.25.2\n"})}),"\n",(0,a.jsx)(n.h2,{id:"paso-7-docker",children:"Paso 7: Docker"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dockerfile",children:'# Dockerfile\nFROM python:3.11-slim\n\nWORKDIR /app\n\n# Dependencies\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\n# Code\nCOPY . .\n\n# Run\nCMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8004"]\n'})}),"\n",(0,a.jsx)(n.h2,{id:"paso-8-a\xf1adir-a-docker-compose",children:"Paso 8: A\xf1adir a Docker Compose"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'# docker-compose.yml (a\xf1adir)\nservices:\n  # ... servicios existentes\n\n  new-service:\n    build: ./services/new-service\n    ports:\n      - "8004:8004"\n    environment:\n      DATABASE_URL: postgresql+asyncpg://erp_user:erp_password@postgres:5432/new_db\n      REDIS_URL: redis://redis:6379/3\n      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672/\n    depends_on:\n      - postgres\n      - redis\n      - rabbitmq\n'})}),"\n",(0,a.jsx)(n.h2,{id:"paso-9-inicializar-alembic",children:"Paso 9: Inicializar Alembic"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Inicializar\nalembic init alembic\n\n# Configurar alembic.ini\nnano alembic.ini\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:"# alembic.ini\n[alembic]\nscript_location = alembic\nsqlalchemy.url = driver://user:pass@localhost/dbname  # Ser\xe1 override por env\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# alembic/env.py\nfrom app.database import Base, engine\nfrom app.models import *  # Importar todos los modelos\n\ntarget_metadata = Base.metadata\n\ndef run_migrations_online():\n    with engine.connect() as connection:\n        context.configure(connection=connection, target_metadata=target_metadata)\n        with context.begin_transaction():\n            context.run_migrations()\n"})}),"\n",(0,a.jsx)(n.h2,{id:"paso-10-testing",children:"Paso 10: Testing"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# tests/conftest.py\nimport pytest\nfrom httpx import AsyncClient\nfrom app.main import app\n\n@pytest.fixture\nasync def client():\n    async with AsyncClient(app=app, base_url="http://test") as ac:\n        yield ac\n\n# tests/test_api.py\n@pytest.mark.asyncio\nasync def test_health(client):\n    response = await client.get("/health")\n    assert response.status_code == 200\n    assert response.json()["status"] == "healthy"\n'})}),"\n",(0,a.jsx)(n.h2,{id:"checklist-de-integraci\xf3n",children:"Checklist de Integraci\xf3n"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Base de datos creada en PostgreSQL"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Migraciones ejecutadas"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Event publisher conectado a RabbitMQ"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Event consumer configurado (si aplica)"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Health check funcionando"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","API docs accesibles (/docs)"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Tests passing"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","A\xf1adido a docker-compose.yml"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","README.md actualizado"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Documentaci\xf3n en Docusaurus"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/guias/testing",children:"Testing"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/guias/deployment",children:"Deployment"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/guias/troubleshooting",children:"Troubleshooting"})}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var i=s(6540);const a={},t=i.createContext(a);function r(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);