"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[4380],{10:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>d,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"flujos-negocio/flujo-venta-completo","title":"Flujo de Venta Completo","description":"Flujo end-to-end de una venta desde que el cliente agrega productos al carrito hasta la entrega y registro en auditor\xeda.","source":"@site/docs/03-flujos-negocio/01-flujo-venta-completo.md","sourceDirName":"03-flujos-negocio","slug":"/flujos-negocio/flujo-venta-completo","permalink":"/zenlogic/flujos-negocio/flujo-venta-completo","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-flujos-negocio/01-flujo-venta-completo.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1}}');var a=n(4848),t=n(8453);const s={sidebar_position:1},d="Flujo de Venta Completo",o={},c=[{value:"Diagrama de Secuencia Completo",id:"diagrama-de-secuencia-completo",level:2},{value:"Fases del Flujo",id:"fases-del-flujo",level:2},{value:"Fase 1: Creaci\xf3n de Carrito",id:"fase-1-creaci\xf3n-de-carrito",level:3},{value:"Fase 2: Agregar Items al Carrito",id:"fase-2-agregar-items-al-carrito",level:3},{value:"Fase 3: Crear Orden desde Carrito",id:"fase-3-crear-orden-desde-carrito",level:3},{value:"Fase 4: Colocar Orden (Place Order) - Reserva de Stock",id:"fase-4-colocar-orden-place-order---reserva-de-stock",level:3},{value:"Fase 5: Procesar Pago",id:"fase-5-procesar-pago",level:3},{value:"Fase 6: Confirmar Reserva en Inventory",id:"fase-6-confirmar-reserva-en-inventory",level:3},{value:"Fase 7: Confirmar Orden",id:"fase-7-confirmar-orden",level:3},{value:"Fase 8: Fulfillment (Picking y Packing)",id:"fase-8-fulfillment-picking-y-packing",level:3},{value:"Fase 9: Crear Env\xedo y Generar Label",id:"fase-9-crear-env\xedo-y-generar-label",level:3},{value:"Fase 10: Despachar Orden - Deducci\xf3n Final de Stock",id:"fase-10-despachar-orden---deducci\xf3n-final-de-stock",level:3},{value:"Fase 11: Entrega",id:"fase-11-entrega",level:3},{value:"Escenarios de Error",id:"escenarios-de-error",level:2},{value:"1. Stock Insuficiente durante Reserva",id:"1-stock-insuficiente-durante-reserva",level:3},{value:"2. Pago Fallido",id:"2-pago-fallido",level:3},{value:"3. Reserva Expirada (TTL)",id:"3-reserva-expirada-ttl",level:3},{value:"M\xe9tricas y Monitoreo",id:"m\xe9tricas-y-monitoreo",level:2},{value:"M\xe9tricas Clave",id:"m\xe9tricas-clave",level:3},{value:"Logs Estructurados",id:"logs-estructurados",level:3},{value:"SLAs",id:"slas",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.header,{children:(0,a.jsx)(r.h1,{id:"flujo-de-venta-completo",children:"Flujo de Venta Completo"})}),"\n",(0,a.jsx)(r.p,{children:"Flujo end-to-end de una venta desde que el cliente agrega productos al carrito hasta la entrega y registro en auditor\xeda."}),"\n",(0,a.jsx)(r.h2,{id:"diagrama-de-secuencia-completo",children:"Diagrama de Secuencia Completo"}),"\n",(0,a.jsx)(r.mermaid,{value:"sequenceDiagram\n    participant Customer\n    participant OrderService\n    participant CatalogService\n    participant InventoryService\n    participant PaymentGateway\n    participant RabbitMQ\n    participant AuditService\n\n    %% Fase 1: Crear Carrito\n    Customer->>OrderService: POST /api/carts\n    OrderService->>OrderService: Crear cart en DB\n    OrderService->>RabbitMQ: Publicar cart.created\n    RabbitMQ->>AuditService: Consumir cart.created\n    OrderService--\x3e>Customer: 201 {cart_id}\n\n    %% Fase 2: Agregar Items\n    Customer->>OrderService: POST /api/carts/{id}/items\n    OrderService->>CatalogService: gRPC GetProductDetails(variant_id)\n    CatalogService--\x3e>OrderService: {price, sku, name}\n    OrderService->>OrderService: Validar precio y disponibilidad\n    OrderService->>OrderService: Agregar item a cart\n    OrderService->>RabbitMQ: Publicar cart.item_added\n    RabbitMQ->>AuditService: Consumir cart.item_added\n    OrderService--\x3e>Customer: 200 {cart}\n\n    %% Fase 3: Checkout - Crear Orden\n    Customer->>OrderService: POST /api/orders (from cart)\n    OrderService->>OrderService: Crear order (status=pending)\n    OrderService->>RabbitMQ: Publicar order.created\n    RabbitMQ->>AuditService: Consumir order.created\n    OrderService--\x3e>Customer: 201 {order_id, order_number}\n\n    %% Fase 4: Reservar Stock\n    Customer->>OrderService: POST /api/orders/{id}/place\n    OrderService->>InventoryService: gRPC ReserveStock(items, ttl=15min)\n    InventoryService->>InventoryService: Verificar disponibilidad\n    InventoryService->>InventoryService: Crear reservation (status=active)\n    InventoryService->>InventoryService: Actualizar stock (reserved_qty += qty)\n    InventoryService->>RabbitMQ: Publicar inventory.stock.reserved\n    RabbitMQ->>OrderService: Consumir stock.reserved\n    RabbitMQ->>AuditService: Consumir stock.reserved\n    InventoryService--\x3e>OrderService: {success, reservation_id, expires_at}\n\n    OrderService->>OrderService: Actualizar order.reservation_id\n    OrderService->>OrderService: Programar job release_if_not_paid (15min)\n    OrderService->>RabbitMQ: Publicar order.placed\n    RabbitMQ->>AuditService: Consumir order.placed\n    OrderService--\x3e>Customer: 200 {reservation_id, expires_at}\n\n    %% Fase 5: Procesar Pago\n    Customer->>OrderService: POST /api/orders/{id}/payment\n    OrderService->>PaymentGateway: Create payment intent\n    PaymentGateway--\x3e>OrderService: {payment_intent_id}\n    OrderService->>OrderService: Crear payment (status=pending)\n    OrderService->>RabbitMQ: Publicar payment.pending\n    OrderService--\x3e>Customer: 200 {client_secret}\n\n    Customer->>PaymentGateway: Confirm payment (card details)\n    PaymentGateway--\x3e>OrderService: Webhook payment.succeeded\n    OrderService->>OrderService: Actualizar payment (status=succeeded)\n    OrderService->>RabbitMQ: Publicar payment.succeeded\n    RabbitMQ->>AuditService: Consumir payment.succeeded\n\n    %% Fase 6: Confirmar Reserva\n    OrderService->>InventoryService: gRPC ConfirmReservation(reservation_id)\n    InventoryService->>InventoryService: Actualizar reservation (status=fulfilled)\n    InventoryService->>RabbitMQ: Publicar inventory.reservation.confirmed\n    RabbitMQ->>AuditService: Consumir reservation.confirmed\n    InventoryService--\x3e>OrderService: {success}\n\n    %% Fase 7: Confirmar Orden\n    OrderService->>OrderService: Actualizar order (status=confirmed)\n    OrderService->>RabbitMQ: Publicar order.confirmed\n    RabbitMQ->>AuditService: Consumir order.confirmed\n    OrderService--\x3e>Customer: 200 {order confirmed}\n\n    %% Fase 8: Fulfillment\n    OrderService->>OrderService: Crear fulfillment_task (status=pending)\n    OrderService->>RabbitMQ: Publicar fulfillment.started\n\n    Note over OrderService: Warehouse picks items\n    OrderService->>OrderService: Actualizar task (status=in_progress)\n    OrderService->>RabbitMQ: Publicar fulfillment.item_picked\n\n    Note over OrderService: Warehouse packs order\n    OrderService->>OrderService: Actualizar task (status=completed)\n    OrderService->>RabbitMQ: Publicar fulfillment.packed\n\n    %% Fase 9: Crear Env\xedo\n    OrderService->>OrderService: Crear shipment (status=pending)\n    OrderService->>OrderService: Generate shipping label\n    OrderService->>RabbitMQ: Publicar shipment.label_created\n    OrderService->>OrderService: Actualizar order (status=shipped)\n\n    %% Fase 10: Despachar y Deducir Stock\n    OrderService->>RabbitMQ: Publicar order.shipped\n    RabbitMQ->>InventoryService: Consumir order.shipped\n    InventoryService->>InventoryService: Deducir stock final (reserved -= qty, total -= qty)\n    InventoryService->>InventoryService: Crear stock_movement (type=out)\n    InventoryService->>RabbitMQ: Publicar inventory.stock.deducted\n    RabbitMQ->>AuditService: Consumir order.shipped\n    RabbitMQ->>AuditService: Consumir stock.deducted\n    OrderService--\x3e>Customer: Notification: Order shipped\n\n    %% Fase 11: Entrega\n    Note over Customer: Carrier delivers package\n    OrderService->>OrderService: Actualizar order (status=delivered)\n    OrderService->>RabbitMQ: Publicar order.delivered\n    RabbitMQ->>AuditService: Consumir order.delivered\n    OrderService--\x3e>Customer: Notification: Order delivered"}),"\n",(0,a.jsx)(r.h2,{id:"fases-del-flujo",children:"Fases del Flujo"}),"\n",(0,a.jsx)(r.h3,{id:"fase-1-creaci\xf3n-de-carrito",children:"Fase 1: Creaci\xf3n de Carrito"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Endpoint"}),": ",(0,a.jsx)(r.code,{children:"POST /api/v1/carts"})]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "customer_id": "cust_789",\n  "local_id": "local_101"\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "cart_id": "cart_123",\n  "customer_id": "cust_789",\n  "items": [],\n  "subtotal": 0.00,\n  "created_at": "2025-11-23T14:00:00Z"\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Evento Publicado"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "event": "cart.created",\n  "version": "1.0",\n  "timestamp": "2025-11-23T14:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "cart_id": "cart_123",\n    "customer_id": "cust_789",\n    "session_id": "sess_456",\n    "organization_id": "org_123"\n  }\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-2-agregar-items-al-carrito",children:"Fase 2: Agregar Items al Carrito"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Endpoint"}),": ",(0,a.jsx)(r.code,{children:"POST /api/v1/carts/{cart_id}/items"})]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "variant_id": "var_789",\n  "quantity": 2\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Integraciones"}),":"]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsx)(r.p,{children:"Order Service llama a Catalog Service v\xeda gRPC:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"catalog_client = CatalogClient()\nproduct_details = await catalog_client.get_product_details(\n    product_id=variant.product_id,\n    organization_id=org_id,\n    include_variants=True\n)\n"})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsx)(r.p,{children:"Order Service valida precio y stock disponible"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "cart_id": "cart_123",\n  "items": [\n    {\n      "cart_item_id": "item_456",\n      "variant_id": "var_789",\n      "sku": "TSH-RED-M",\n      "name": "Camiseta Roja - M",\n      "quantity": 2,\n      "unit_price": 24.99,\n      "subtotal": 49.98\n    }\n  ],\n  "subtotal": 49.98,\n  "updated_at": "2025-11-23T14:05:00Z"\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-3-crear-orden-desde-carrito",children:"Fase 3: Crear Orden desde Carrito"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Endpoint"}),": ",(0,a.jsx)(r.code,{children:"POST /api/v1/orders"})]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "cart_id": "cart_123",\n  "shipping_address": {\n    "street": "123 Main St",\n    "city": "New York",\n    "state": "NY",\n    "zip": "10001",\n    "country": "US"\n  },\n  "billing_address": { /* same structure */ }\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso Interno"}),":"]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"Validar que cart existe y tiene items"}),"\n",(0,a.jsx)(r.li,{children:"Calcular totales (subtotal, tax, shipping)"}),"\n",(0,a.jsxs)(r.li,{children:["Crear orden con status=",(0,a.jsx)(r.code,{children:"pending"})]}),"\n",(0,a.jsx)(r.li,{children:"Copiar cart_items a order_items"}),"\n",(0,a.jsxs)(r.li,{children:["Publicar evento ",(0,a.jsx)(r.code,{children:"order.created"})]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "order_id": "order_456",\n  "order_number": "ORD-2025-0001",\n  "status": "pending",\n  "total_amount": 54.98,\n  "created_at": "2025-11-23T14:10:00Z"\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-4-colocar-orden-place-order---reserva-de-stock",children:"Fase 4: Colocar Orden (Place Order) - Reserva de Stock"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Endpoint"}),": ",(0,a.jsx)(r.code,{children:"POST /api/v1/orders/{order_id}/place"})]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso Cr\xedtico"}),":"]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Order Service \u2192 Inventory Service (gRPC)"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'inventory_client = InventoryClient()\nreservation = await inventory_client.reserve_stock(\n    organization_id=org_id,\n    order_id=order_id,\n    items=[\n        {"variant_id": "var_789", "quantity": 2, "preferred_warehouse_id": "wh_101"}\n    ],\n    ttl_minutes=15\n)\n'})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Inventory Service verifica y reserva"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-sql",children:"-- Verificar disponibilidad\nSELECT available_quantity\nFROM stock\nWHERE variant_id = 'var_789'\n  AND warehouse_id = 'wh_101'\n  AND available_quantity >= 2\nFOR UPDATE;  -- Lock pesimista\n\n-- Actualizar stock\nUPDATE stock\nSET reserved_quantity = reserved_quantity + 2,\n    available_quantity = available_quantity - 2,\n    version = version + 1\nWHERE stock_id = 'stock_123'\n  AND version = {current_version};  -- Optimistic locking\n"})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Crear reserva con TTL"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-sql",children:"INSERT INTO stock_reservations (\n    reservation_id, organization_id, order_id,\n    status, expires_at\n) VALUES (\n    gen_random_uuid(), 'org_123', 'order_456',\n    'active', NOW() + INTERVAL '15 minutes'\n);\n"})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Publicar evento"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "event": "inventory.stock.reserved",\n  "data": {\n    "reservation_id": "res_123",\n    "order_id": "order_456",\n    "items": [\n      {"variant_id": "var_789", "quantity": 2, "warehouse_id": "wh_101"}\n    ],\n    "expires_at": "2025-11-23T14:25:00Z"\n  }\n}\n'})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Order Service consume evento y actualiza"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"async def handle_stock_reserved(event):\n    order = await order_repo.get_by_id(event['data']['order_id'])\n    order.reservation_id = event['data']['reservation_id']\n    await order_repo.update(order)\n\n    # Programar job para liberar si no se paga\n    await scheduler.schedule_at(\n        event['data']['expires_at'],\n        task='release_reservation_if_not_paid',\n        args={'order_id': order.order_id, 'reservation_id': order.reservation_id}\n    )\n"})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "success": true,\n  "reservation_id": "res_123",\n  "expires_at": "2025-11-23T14:25:00Z",\n  "message": "Stock reserved for 15 minutes"\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-5-procesar-pago",children:"Fase 5: Procesar Pago"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Endpoint"}),": ",(0,a.jsx)(r.code,{children:"POST /api/v1/orders/{order_id}/payments"})]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "payment_method": "stripe",\n  "payment_method_id": "pm_123abc"\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso"}),":"]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Crear Payment Intent en Stripe"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'import stripe\n\npayment_intent = stripe.PaymentIntent.create(\n    amount=int(order.total_amount * 100),  # centavos\n    currency="usd",\n    payment_method=payment_method_id,\n    confirm=True,\n    metadata={\n        "order_id": str(order.order_id),\n        "order_number": order.order_number\n    }\n)\n'})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Guardar en DB"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-sql",children:"INSERT INTO payments (\n    payment_id, order_id, amount, status,\n    payment_method, gateway_payment_id\n) VALUES (\n    gen_random_uuid(), 'order_456', 54.98, 'pending',\n    'stripe', 'pi_123abc'\n);\n"})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Webhook de Stripe"})," (cuando pago se completa):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"@app.post(\"/webhooks/stripe\")\nasync def stripe_webhook(request: Request):\n    payload = await request.body()\n    sig_header = request.headers.get('stripe-signature')\n\n    event = stripe.Webhook.construct_event(\n        payload, sig_header, webhook_secret\n    )\n\n    if event['type'] == 'payment_intent.succeeded':\n        payment_intent = event['data']['object']\n        order_id = payment_intent['metadata']['order_id']\n\n        # Actualizar payment\n        await payment_repo.update_status(\n            gateway_payment_id=payment_intent['id'],\n            status='succeeded'\n        )\n\n        # Publicar evento\n        await event_publisher.publish(\n            event_type=\"payment.succeeded\",\n            data={\n                \"payment_id\": payment.payment_id,\n                \"order_id\": order_id,\n                \"amount\": payment_intent['amount'] / 100\n            }\n        )\n"})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",children:'{\n  "payment_id": "pay_123",\n  "status": "succeeded",\n  "amount": 54.98,\n  "paid_at": "2025-11-23T14:15:00Z"\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-6-confirmar-reserva-en-inventory",children:"Fase 6: Confirmar Reserva en Inventory"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso Autom\xe1tico"})," (disparado por ",(0,a.jsx)(r.code,{children:"payment.succeeded"}),"):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'async def handle_payment_succeeded(event):\n    """Handler en Order Service."""\n    order_id = event[\'data\'][\'order_id\']\n    order = await order_repo.get_by_id(order_id)\n\n    # Confirmar reserva en Inventory\n    inventory_client = InventoryClient()\n    await inventory_client.confirm_reservation(\n        reservation_id=order.reservation_id,\n        organization_id=order.organization_id\n    )\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"En Inventory Service"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'async def ConfirmReservation(self, request, context):\n    """Confirmar reserva - stock ya est\xe1 reservado."""\n    reservation = await reservation_repo.get_by_id(request.reservation_id)\n\n    if reservation.status != \'active\':\n        raise ValueError(f"Reservation {reservation_id} is not active")\n\n    # Marcar como fulfilled\n    reservation.status = \'fulfilled\'\n    reservation.fulfilled_at = datetime.utcnow()\n    await reservation_repo.update(reservation)\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="inventory.reservation.confirmed",\n        data={\n            "reservation_id": str(reservation.reservation_id),\n            "order_id": str(reservation.order_id)\n        }\n    )\n\n    return ConfirmReservationResponse(success=True)\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-7-confirmar-orden",children:"Fase 7: Confirmar Orden"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso Autom\xe1tico"})," (despu\xe9s de confirmar reserva):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'async def handle_reservation_confirmed(event):\n    """Handler en Order Service."""\n    order_id = event[\'data\'][\'order_id\']\n\n    # Actualizar orden\n    order = await order_repo.get_by_id(order_id)\n    order.status = \'confirmed\'\n    order.confirmed_at = datetime.utcnow()\n    await order_repo.update(order)\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="order.confirmed",\n        data={\n            "order_id": str(order.order_id),\n            "order_number": order.order_number,\n            "reservation_id": str(order.reservation_id),\n            "confirmed_at": order.confirmed_at.isoformat()\n        }\n    )\n\n    # Notificar cliente\n    await notification_service.send_email(\n        to=order.customer_email,\n        template="order_confirmed",\n        data={"order_number": order.order_number}\n    )\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-8-fulfillment-picking-y-packing",children:"Fase 8: Fulfillment (Picking y Packing)"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso en Warehouse"}),":"]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Crear tarea de picking"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"fulfillment_task = await fulfillment_repo.create(\n    order_id=order.order_id,\n    warehouse_id=order.warehouse_id,\n    task_type='picking',\n    status='pending',\n    items_total=len(order.items)\n)\n"})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Asignar a trabajador"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"# Endpoint: PUT /api/fulfillment/tasks/{task_id}/assign\ntask.assigned_to = worker_id\ntask.status = 'in_progress'\ntask.started_at = datetime.utcnow()\n"})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Marcar items como picked"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'# Endpoint: POST /api/fulfillment/tasks/{task_id}/pick-item\ntask.items_picked += 1\n\nawait event_publisher.publish(\n    event_type="fulfillment.item_picked",\n    data={\n        "order_id": str(order.order_id),\n        "variant_id": variant_id,\n        "picked_by": worker_id\n    }\n)\n'})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Completar packing"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'task.status = \'completed\'\ntask.completed_at = datetime.utcnow()\n\nawait event_publisher.publish(\n    event_type="fulfillment.packed",\n    data={"order_id": str(order.order_id)}\n)\n'})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(r.h3,{id:"fase-9-crear-env\xedo-y-generar-label",children:"Fase 9: Crear Env\xedo y Generar Label"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'async def create_shipment(order_id: str):\n    """Crear env\xedo para orden confirmada."""\n    order = await order_repo.get_by_id(order_id)\n\n    # Crear shipment\n    shipment = await shipment_repo.create(\n        order_id=order.order_id,\n        carrier=\'fedex\',\n        service_type=\'ground\',\n        from_address=warehouse.address,\n        to_address=order.shipping_address\n    )\n\n    # Generar shipping label via carrier API\n    label = await fedex_client.create_shipment(\n        shipment_id=str(shipment.shipment_id),\n        from_address=warehouse.address,\n        to_address=order.shipping_address,\n        weight=calculate_weight(order.items),\n        dimensions=calculate_dimensions(order.items)\n    )\n\n    shipment.tracking_number = label.tracking_number\n    shipment.label_url = label.label_url\n    await shipment_repo.update(shipment)\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="shipment.label_created",\n        data={\n            "shipment_id": str(shipment.shipment_id),\n            "tracking_number": label.tracking_number,\n            "label_url": label.label_url\n        }\n    )\n'})}),"\n",(0,a.jsx)(r.h3,{id:"fase-10-despachar-orden---deducci\xf3n-final-de-stock",children:"Fase 10: Despachar Orden - Deducci\xf3n Final de Stock"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Endpoint"}),": ",(0,a.jsx)(r.code,{children:"POST /api/v1/shipments/{shipment_id}/dispatch"})]}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Proceso"}),":"]}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Order Service marca como shipped"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'shipment.status = \'dispatched\'\nshipment.shipped_at = datetime.utcnow()\n\norder.status = \'shipped\'\nawait order_repo.update(order)\n\n# Publicar evento con items despachados\nawait event_publisher.publish(\n    event_type="order.shipped",\n    data={\n        "order_id": str(order.order_id),\n        "shipment_id": str(shipment.shipment_id),\n        "tracking_number": shipment.tracking_number,\n        "shipped_items": [\n            {\n                "variant_id": str(item.variant_id),\n                "quantity": item.quantity,\n                "warehouse_id": str(order.warehouse_id)\n            }\n            for item in order.items\n        ]\n    }\n)\n'})}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:["\n",(0,a.jsxs)(r.p,{children:[(0,a.jsxs)(r.strong,{children:["Inventory Service consume ",(0,a.jsx)(r.code,{children:"order.shipped"})," y deduce stock"]}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"async def handle_order_shipped(event):\n    \"\"\"Deducir stock cuando orden se despacha.\"\"\"\n    shipped_items = event['data']['shipped_items']\n\n    for item in shipped_items:\n        stock = await stock_repo.get_by_variant_warehouse(\n            variant_id=item['variant_id'],\n            warehouse_id=item['warehouse_id']\n        )\n\n        # Deducir de reserved y total\n        stock.reserved_quantity -= item['quantity']\n        stock.total_quantity -= item['quantity']\n        stock.version += 1\n        stock.last_movement_at = datetime.utcnow()\n\n        await stock_repo.update(stock)\n\n        # Registrar movimiento\n        await movement_repo.create(\n            stock_id=stock.stock_id,\n            type='out',\n            quantity_before=stock.total_quantity + item['quantity'],\n            quantity_after=stock.total_quantity,\n            quantity_change=-item['quantity'],\n            reason='sale',\n            reference_id=event['data']['order_id'],\n            reference_type='order'\n        )\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type=\"inventory.stock.deducted\",\n        data={\n            \"order_id\": event['data']['order_id'],\n            \"items\": shipped_items\n        }\n    )\n"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(r.h3,{id:"fase-11-entrega",children:"Fase 11: Entrega"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Webhook de Carrier"})," (FedEx, UPS, etc.):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"@app.post(\"/webhooks/fedex/tracking\")\nasync def fedex_tracking_webhook(request: Request):\n    \"\"\"Recibir eventos de tracking del carrier.\"\"\"\n    payload = await request.json()\n\n    if payload['event_type'] == 'delivered':\n        tracking_number = payload['tracking_number']\n\n        shipment = await shipment_repo.get_by_tracking(tracking_number)\n        order = await order_repo.get_by_id(shipment.order_id)\n\n        # Actualizar estado\n        shipment.status = 'delivered'\n        order.status = 'delivered'\n        order.delivered_at = payload['delivered_at']\n\n        await shipment_repo.update(shipment)\n        await order_repo.update(order)\n\n        # Crear tracking event\n        await tracking_event_repo.create(\n            shipment_id=shipment.shipment_id,\n            status='delivered',\n            location=payload['location'],\n            event_timestamp=payload['delivered_at']\n        )\n\n        # Publicar evento\n        await event_publisher.publish(\n            event_type=\"order.delivered\",\n            data={\n                \"order_id\": str(order.order_id),\n                \"delivered_at\": payload['delivered_at'],\n                \"signature\": payload.get('signature')\n            }\n        )\n"})}),"\n",(0,a.jsx)(r.h2,{id:"escenarios-de-error",children:"Escenarios de Error"}),"\n",(0,a.jsx)(r.h3,{id:"1-stock-insuficiente-durante-reserva",children:"1. Stock Insuficiente durante Reserva"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'# En Inventory Service - ReserveStock RPC\nif stock.available_quantity < requested_quantity:\n    return ReserveStockResponse(\n        success=False,\n        message=f"Insufficient stock. Available: {stock.available_quantity}, Requested: {requested_quantity}"\n    )\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Manejo en Order Service"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'try:\n    reservation = await inventory_client.reserve_stock(...)\n    if not reservation.success:\n        # Marcar orden como failed\n        order.status = \'insufficient_stock\'\n        await order_repo.update(order)\n\n        # Notificar cliente\n        raise HTTPException(\n            status_code=409,\n            detail=reservation.message\n        )\nexcept grpc.RpcError as e:\n    logger.error(f"gRPC error reserving stock: {e}")\n    raise HTTPException(status_code=503, detail="Inventory service unavailable")\n'})}),"\n",(0,a.jsx)(r.h3,{id:"2-pago-fallido",children:"2. Pago Fallido"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"# Webhook de Stripe - payment_intent.payment_failed\nif event['type'] == 'payment_intent.payment_failed':\n    payment = await payment_repo.get_by_gateway_id(payment_intent['id'])\n    order = await order_repo.get_by_id(payment.order_id)\n\n    # Actualizar payment\n    payment.status = 'failed'\n    payment.error_code = payment_intent['last_payment_error']['code']\n    payment.error_message = payment_intent['last_payment_error']['message']\n\n    # Liberar reserva\n    await inventory_client.release_reservation(order.reservation_id)\n\n    # Actualizar orden\n    order.status = 'payment_failed'\n\n    # Publicar eventos\n    await event_publisher.publish(\"payment.failed\", {...})\n"})}),"\n",(0,a.jsx)(r.h3,{id:"3-reserva-expirada-ttl",children:"3. Reserva Expirada (TTL)"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"Job Programado"})," (se ejecuta despu\xe9s de 15 minutos):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'async def release_expired_reservation(order_id: str, reservation_id: str):\n    """Liberar reserva si orden no fue pagada."""\n    order = await order_repo.get_by_id(order_id)\n\n    # Si ya fue confirmada, no hacer nada\n    if order.status in [\'confirmed\', \'processing\', \'shipped\']:\n        logger.info(f"Order {order_id} already confirmed, skipping release")\n        return\n\n    # Liberar reserva\n    await inventory_client.release_reservation(reservation_id)\n\n    # Marcar orden como expirada\n    order.status = \'reservation_expired\'\n    await order_repo.update(order)\n\n    # Notificar cliente\n    await notification_service.send_email(\n        to=order.customer_email,\n        template="reservation_expired",\n        data={"order_number": order.order_number}\n    )\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.strong,{children:"En Inventory Service"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'async def ReleaseReservation(self, request, context):\n    """Liberar stock reservado."""\n    reservation = await reservation_repo.get_by_id(request.reservation_id)\n\n    if reservation.status != \'active\':\n        return ReleaseReservationResponse(\n            success=False,\n            message="Reservation already processed"\n        )\n\n    # Obtener items de la reserva\n    items = await reservation_item_repo.get_by_reservation(reservation.reservation_id)\n\n    for item in items:\n        stock = await stock_repo.get_by_id(item.stock_id)\n\n        # Devolver a available\n        stock.reserved_quantity -= item.quantity\n        stock.available_quantity += item.quantity\n        stock.version += 1\n\n        await stock_repo.update(stock)\n\n    # Marcar como cancelada\n    reservation.status = \'cancelled\'\n    await reservation_repo.update(reservation)\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="inventory.reservation.released",\n        data={"reservation_id": str(reservation.reservation_id)}\n    )\n\n    return ReleaseReservationResponse(success=True)\n'})}),"\n",(0,a.jsx)(r.h2,{id:"m\xe9tricas-y-monitoreo",children:"M\xe9tricas y Monitoreo"}),"\n",(0,a.jsx)(r.h3,{id:"m\xe9tricas-clave",children:"M\xe9tricas Clave"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:"# Order Service\norder_conversion_rate = Gauge('order_conversion_rate', 'Cart to order conversion')\nreservation_expiry_rate = Counter('reservation_expiry_total', 'Reservations that expired')\npayment_success_rate = Gauge('payment_success_rate', 'Payment success rate')\n\n# Inventory Service\nstock_reservation_duration = Histogram('stock_reservation_duration_seconds', 'Time stock is reserved')\nstock_deduction_latency = Histogram('stock_deduction_latency_seconds', 'Stock deduction latency')\nlow_stock_alerts = Counter('low_stock_alerts_total', 'Low stock alerts', ['variant_id'])\n"})}),"\n",(0,a.jsx)(r.h3,{id:"logs-estructurados",children:"Logs Estructurados"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-python",children:'logger.info(\n    "Order placed successfully",\n    extra={\n        "order_id": str(order.order_id),\n        "order_number": order.order_number,\n        "reservation_id": str(reservation.reservation_id),\n        "customer_id": str(order.customer_id),\n        "total_amount": float(order.total_amount),\n        "items_count": len(order.items)\n    }\n)\n'})}),"\n",(0,a.jsx)(r.h2,{id:"slas",children:"SLAs"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Reserva de Stock"}),": < 500ms (p95)"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Confirmaci\xf3n de Pago"}),": < 2s (p95)"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Deducci\xf3n de Stock"}),": < 1s (p95)"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"TTL de Reserva"}),": 15 minutos"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Tiempo de Fulfillment"}),": < 24 horas (target)"]}),"\n"]}),"\n",(0,a.jsx)(r.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"./flujo-devoluciones",children:"Flujo de Devoluciones"})}),"\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"./flujo-transferencias",children:"Flujo de Transferencias de Stock"})}),"\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"./manejo-errores",children:"Manejo de Errores y Compensaciones"})}),"\n"]})]})}function p(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>s,x:()=>d});var i=n(6540);const a={},t=i.createContext(a);function s(e){const r=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),i.createElement(t.Provider,{value:r},e.children)}}}]);