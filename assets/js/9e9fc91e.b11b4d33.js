"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[6270],{1550:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"microservicios/audit-service/queries-comunes","title":"Queries Comunes","description":"Ejemplos de consultas SQL frecuentes para auditor\xeda.","source":"@site/docs/02-microservicios/audit-service/07-queries-comunes.md","sourceDirName":"02-microservicios/audit-service","slug":"/microservicios/audit-service/queries-comunes","permalink":"/zenlogic/microservicios/audit-service/queries-comunes","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/audit-service/07-queries-comunes.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"docs","previous":{"title":"Retention Policy","permalink":"/zenlogic/microservicios/audit-service/retention-policy"},"next":{"title":"Introducci\xf3n a ADRs","permalink":"/zenlogic/adrs/introduccion-adrs"}}');var i=a(4848),d=a(8453);const r={sidebar_position:8},t="Queries Comunes",o={},c=[{value:"Por Usuario",id:"por-usuario",level:2},{value:"Todas las acciones de un usuario",id:"todas-las-acciones-de-un-usuario",level:3},{value:"Logins de un usuario",id:"logins-de-un-usuario",level:3},{value:"Por Organizaci\xf3n",id:"por-organizaci\xf3n",level:2},{value:"Actividad reciente de organizaci\xf3n",id:"actividad-reciente-de-organizaci\xf3n",level:3},{value:"Top usuarios activos",id:"top-usuarios-activos",level:3},{value:"Por Entidad",id:"por-entidad",level:2},{value:"Historial de un producto",id:"historial-de-un-producto",level:3},{value:"Cambios de precio",id:"cambios-de-precio",level:3},{value:"Estad\xedsticas",id:"estad\xedsticas",level:2},{value:"Eventos por d\xeda (\xfaltimos 30 d\xedas)",id:"eventos-por-d\xeda-\xfaltimos-30-d\xedas",level:3},{value:"Eventos por servicio",id:"eventos-por-servicio",level:3},{value:"Pico de actividad por hora",id:"pico-de-actividad-por-hora",level:3},{value:"Compliance",id:"compliance",level:2},{value:"Accesos a datos sensibles",id:"accesos-a-datos-sensibles",level:3},{value:"Cambios en permisos",id:"cambios-en-permisos",level:3},{value:"Usuarios desactivados",id:"usuarios-desactivados",level:3},{value:"Debugging",id:"debugging",level:2},{value:"Eventos fallidos",id:"eventos-fallidos",level:3},{value:"Timeline de una transacci\xf3n",id:"timeline-de-una-transacci\xf3n",level:3},{value:"Performance",id:"performance",level:2},{value:"Eventos con payloads grandes",id:"eventos-con-payloads-grandes",level:3},{value:"Particiones m\xe1s grandes",id:"particiones-m\xe1s-grandes",level:3},{value:"Implementaci\xf3n en Python",id:"implementaci\xf3n-en-python",level:2},{value:"Query Helper",id:"query-helper",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"queries-comunes",children:"Queries Comunes"})}),"\n",(0,i.jsx)(n.p,{children:"Ejemplos de consultas SQL frecuentes para auditor\xeda."}),"\n",(0,i.jsx)(n.h2,{id:"por-usuario",children:"Por Usuario"}),"\n",(0,i.jsx)(n.h3,{id:"todas-las-acciones-de-un-usuario",children:"Todas las acciones de un usuario"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    event_type,\n    created_at,\n    payload->>'entity_type' as entity,\n    payload\nFROM audit_logs\nWHERE user_id = 'user-uuid'\n  AND created_at >= NOW() - INTERVAL '7 days'\nORDER BY created_at DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"logins-de-un-usuario",children:"Logins de un usuario"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    created_at,\n    ip_address,\n    metadata->>'user_agent' as browser,\n    payload->>'result' as result\nFROM audit_logs\nWHERE user_id = 'user-uuid'\n  AND event_type = 'auth.session.created'\nORDER BY created_at DESC\nLIMIT 50;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"por-organizaci\xf3n",children:"Por Organizaci\xf3n"}),"\n",(0,i.jsx)(n.h3,{id:"actividad-reciente-de-organizaci\xf3n",children:"Actividad reciente de organizaci\xf3n"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    event_type,\n    service,\n    COUNT(*) as event_count,\n    array_agg(DISTINCT user_id) as users\nFROM audit_logs\nWHERE organization_id = 'org-uuid'\n  AND created_at >= NOW() - INTERVAL '24 hours'\nGROUP BY event_type, service\nORDER BY event_count DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"top-usuarios-activos",children:"Top usuarios activos"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    user_id,\n    COUNT(*) as actions_count,\n    COUNT(DISTINCT event_type) as event_types,\n    MAX(created_at) as last_action\nFROM audit_logs\nWHERE organization_id = 'org-uuid'\n  AND created_at >= NOW() - INTERVAL '30 days'\n  AND user_id IS NOT NULL\nGROUP BY user_id\nORDER BY actions_count DESC\nLIMIT 20;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"por-entidad",children:"Por Entidad"}),"\n",(0,i.jsx)(n.h3,{id:"historial-de-un-producto",children:"Historial de un producto"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    event_type,\n    created_at,\n    user_id,\n    payload->'changes' as changes\nFROM audit_logs\nWHERE payload->>'product_id' = 'product-uuid'\n  AND event_type LIKE 'catalog.product.%'\nORDER BY created_at ASC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cambios-de-precio",children:"Cambios de precio"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    payload->>'product_id' as product_id,\n    payload->'changes'->'base_price'->>'old' as old_price,\n    payload->'changes'->'base_price'->>'new' as new_price,\n    created_at,\n    user_id\nFROM audit_logs\nWHERE event_type = 'catalog.product.updated'\n  AND payload @> '{\"changes\": {\"base_price\": {}}}'::jsonb\n  AND created_at >= '2025-11-01'\nORDER BY created_at DESC;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"estad\xedsticas",children:"Estad\xedsticas"}),"\n",(0,i.jsx)(n.h3,{id:"eventos-por-d\xeda-\xfaltimos-30-d\xedas",children:"Eventos por d\xeda (\xfaltimos 30 d\xedas)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    DATE(created_at) as date,\n    COUNT(*) as events_count,\n    COUNT(DISTINCT user_id) as unique_users\nFROM audit_logs\nWHERE created_at >= NOW() - INTERVAL '30 days'\nGROUP BY DATE(created_at)\nORDER BY date DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"eventos-por-servicio",children:"Eventos por servicio"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    service,\n    event_type,\n    COUNT(*) as count,\n    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) as percentage\nFROM audit_logs\nWHERE created_at >= NOW() - INTERVAL '7 days'\nGROUP BY service, event_type\nORDER BY count DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"pico-de-actividad-por-hora",children:"Pico de actividad por hora"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    DATE_TRUNC('hour', created_at) as hour,\n    COUNT(*) as events\nFROM audit_logs\nWHERE created_at >= NOW() - INTERVAL '7 days'\nGROUP BY DATE_TRUNC('hour', created_at)\nORDER BY events DESC\nLIMIT 10;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"compliance",children:"Compliance"}),"\n",(0,i.jsx)(n.h3,{id:"accesos-a-datos-sensibles",children:"Accesos a datos sensibles"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    user_id,\n    event_type,\n    created_at,\n    ip_address,\n    payload->>'entity_id' as entity_accessed\nFROM audit_logs\nWHERE event_type IN (\n    'auth.user.accessed',\n    'catalog.product.viewed',\n    'order.order.viewed'\n)\n  AND created_at >= NOW() - INTERVAL '90 days'\nORDER BY created_at DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cambios-en-permisos",children:"Cambios en permisos"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    payload->>'role_id' as role_id,\n    payload->>'role_name' as role_name,\n    payload->'changes' as permission_changes,\n    user_id as modified_by,\n    created_at\nFROM audit_logs\nWHERE event_type = 'auth.role.permissions_changed'\nORDER BY created_at DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"usuarios-desactivados",children:"Usuarios desactivados"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    payload->>'user_id' as deactivated_user,\n    payload->>'email' as email,\n    user_id as deactivated_by,\n    created_at,\n    payload->>'reason' as reason\nFROM audit_logs\nWHERE event_type = 'auth.user.deactivated'\n  AND created_at >= NOW() - INTERVAL '1 year'\nORDER BY created_at DESC;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"debugging",children:"Debugging"}),"\n",(0,i.jsx)(n.h3,{id:"eventos-fallidos",children:"Eventos fallidos"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    event_type,\n    service,\n    payload->>'error' as error_message,\n    created_at,\n    COUNT(*) OVER (PARTITION BY event_type) as error_count\nFROM audit_logs\nWHERE payload ? 'error'\n  AND created_at >= NOW() - INTERVAL '1 day'\nORDER BY created_at DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"timeline-de-una-transacci\xf3n",children:"Timeline de una transacci\xf3n"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    event_type,\n    created_at,\n    service,\n    payload\nFROM audit_logs\nWHERE metadata->>'correlation_id' = 'transaction-uuid'\nORDER BY created_at ASC;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"performance",children:"Performance"}),"\n",(0,i.jsx)(n.h3,{id:"eventos-con-payloads-grandes",children:"Eventos con payloads grandes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    id,\n    event_type,\n    pg_column_size(payload) as payload_size_bytes,\n    created_at\nFROM audit_logs\nWHERE pg_column_size(payload) > 10240  -- > 10KB\nORDER BY payload_size_bytes DESC\nLIMIT 100;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"particiones-m\xe1s-grandes",children:"Particiones m\xe1s grandes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    schemaname,\n    tablename,\n    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size\nFROM pg_tables\nWHERE tablename LIKE 'audit_logs_%'\nORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"implementaci\xf3n-en-python",children:"Implementaci\xf3n en Python"}),"\n",(0,i.jsx)(n.h3,{id:"query-helper",children:"Query Helper"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from sqlalchemy import select, func, and_, or_\nfrom app.models.audit import AuditLog\n\nclass AuditQueries:\n    """Helpers para queries comunes."""\n\n    @staticmethod\n    async def get_user_timeline(db, user_id: str, days: int = 7):\n        """Timeline de usuario."""\n        query = select(AuditLog).where(\n            and_(\n                AuditLog.user_id == user_id,\n                AuditLog.created_at >= datetime.utcnow() - timedelta(days=days)\n            )\n        ).order_by(AuditLog.created_at.desc())\n\n        result = await db.execute(query)\n        return result.scalars().all()\n\n    @staticmethod\n    async def get_price_changes(db, start_date: datetime):\n        """Cambios de precio."""\n        query = select(AuditLog).where(\n            and_(\n                AuditLog.event_type == \'catalog.product.updated\',\n                AuditLog.payload.op(\'@>\')(\'{"changes": {"base_price": {}}}\'::JSONB),\n                AuditLog.created_at >= start_date\n            )\n        ).order_by(AuditLog.created_at.desc())\n\n        result = await db.execute(query)\n        return result.scalars().all()\n\n    @staticmethod\n    async def get_top_active_users(db, org_id: str, limit: int = 10):\n        """Usuarios m\xe1s activos."""\n        query = select(\n            AuditLog.user_id,\n            func.count().label(\'actions_count\')\n        ).where(\n            and_(\n                AuditLog.organization_id == org_id,\n                AuditLog.created_at >= datetime.utcnow() - timedelta(days=30),\n                AuditLog.user_id.isnot(None)\n            )\n        ).group_by(AuditLog.user_id).order_by(\n            func.count().desc()\n        ).limit(limit)\n\n        result = await db.execute(query)\n        return result.all()\n'})}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/audit-service/api-logs",children:"API Logs"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/audit-service/modelo-datos",children:"Modelo de Datos"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/audit-service/event-consumer",children:"Event Consumer"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>t});var s=a(6540);const i={},d=s.createContext(i);function r(e){const n=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);