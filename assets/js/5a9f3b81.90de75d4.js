"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[5026],{4335:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"guias/deployment","title":"Deployment","description":"Gu\xeda de deployment de zenLogic a producci\xf3n usando Docker y Kubernetes.","source":"@site/docs/05-guias/03-deployment.md","sourceDirName":"05-guias","slug":"/guias/deployment","permalink":"/zenlogic/guias/deployment","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/05-guias/03-deployment.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docs","previous":{"title":"Testing","permalink":"/zenlogic/guias/testing"},"next":{"title":"Troubleshooting","permalink":"/zenlogic/guias/troubleshooting"}}');var s=a(4848),r=a(8453);const t={sidebar_position:4},o="Deployment",l={},c=[{value:"Estrategia de Deployment",id:"estrategia-de-deployment",level:2},{value:"Docker Production",id:"docker-production",level:2},{value:"Dockerfile Optimizado",id:"dockerfile-optimizado",level:3},{value:"Docker Compose Production",id:"docker-compose-production",level:3},{value:"Kubernetes",id:"kubernetes",level:2},{value:"Namespace",id:"namespace",level:3},{value:"ConfigMap",id:"configmap",level:3},{value:"Secrets",id:"secrets",level:3},{value:"Deployment",id:"deployment-1",level:3},{value:"Service",id:"service",level:3},{value:"Ingress",id:"ingress",level:3},{value:"CI/CD Pipeline",id:"cicd-pipeline",level:2},{value:"GitHub Actions",id:"github-actions",level:3},{value:"Database Migrations",id:"database-migrations",level:2},{value:"Monitoring",id:"monitoring",level:2},{value:"Prometheus",id:"prometheus",level:3},{value:"Grafana Dashboard",id:"grafana-dashboard",level:3},{value:"Rollback",id:"rollback",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"deployment",children:"Deployment"})}),"\n",(0,s.jsx)(n.p,{children:"Gu\xeda de deployment de zenLogic a producci\xf3n usando Docker y Kubernetes."}),"\n",(0,s.jsx)(n.h2,{id:"estrategia-de-deployment",children:"Estrategia de Deployment"}),"\n",(0,s.jsx)(n.mermaid,{value:"graph TB\n    Dev[Development] --\x3e Build[Build Docker Images]\n    Build --\x3e Push[Push to Registry]\n    Push --\x3e Deploy[Deploy to K8s]\n    Deploy --\x3e Monitor[Monitor]"}),"\n",(0,s.jsx)(n.h2,{id:"docker-production",children:"Docker Production"}),"\n",(0,s.jsx)(n.h3,{id:"dockerfile-optimizado",children:"Dockerfile Optimizado"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dockerfile",children:'# Multi-stage build\nFROM python:3.11-slim as builder\n\nWORKDIR /app\n\n# Dependencies\nCOPY requirements.txt .\nRUN pip install --no-cache-dir --user -r requirements.txt\n\nFROM python:3.11-slim\n\nWORKDIR /app\n\n# Copy dependencies from builder\nCOPY --from=builder /root/.local /root/.local\nENV PATH=/root/.local/bin:$PATH\n\n# Copy code\nCOPY . .\n\n# Non-root user\nRUN useradd -m appuser && chown -R appuser:appuser /app\nUSER appuser\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=3s \\\n  CMD python -c "import requests; requests.get(\'http://localhost:8001/health\')"\n\n# Run\nCMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8001", "--workers", "4"]\n'})}),"\n",(0,s.jsx)(n.h3,{id:"docker-compose-production",children:"Docker Compose Production"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"version: '3.8'\n\nservices:\n  auth-service:\n    image: registry.example.com/auth-service:latest\n    deploy:\n      replicas: 3\n      restart_policy:\n        condition: on-failure\n    environment:\n      DATABASE_URL: ${AUTH_DB_URL}\n      REDIS_URL: ${REDIS_URL}\n      RABBITMQ_URL: ${RABBITMQ_URL}\n    secrets:\n      - jwt_private_key\n      - jwt_public_key\n\nsecrets:\n  jwt_private_key:\n    file: ./secrets/private_key.pem\n  jwt_public_key:\n    file: ./secrets/public_key.pem\n"})}),"\n",(0,s.jsx)(n.h2,{id:"kubernetes",children:"Kubernetes"}),"\n",(0,s.jsx)(n.h3,{id:"namespace",children:"Namespace"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# k8s/namespace.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: zenlogic\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configmap",children:"ConfigMap"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# k8s/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: zenlogic-config\n  namespace: zenlogic\ndata:\n  RABBITMQ_EXCHANGE: "erp.events"\n  LOG_LEVEL: "INFO"\n  CORS_ORIGINS: "https://app.zenlogic.com"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"secrets",children:"Secrets"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# k8s/secrets.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: zenlogic-secrets\n  namespace: zenlogic\ntype: Opaque\ndata:\n  DATABASE_URL: <base64-encoded>\n  REDIS_URL: <base64-encoded>\n  RABBITMQ_URL: <base64-encoded>\n  JWT_SECRET_KEY: <base64-encoded>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"deployment-1",children:"Deployment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# k8s/auth-service-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: auth-service\n  namespace: zenlogic\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: auth-service\n  template:\n    metadata:\n      labels:\n        app: auth-service\n    spec:\n      containers:\n      - name: auth-service\n        image: registry.example.com/auth-service:v1.0.0\n        ports:\n        - containerPort: 8001\n          name: http\n        - containerPort: 50051\n          name: grpc\n        env:\n        - name: SERVICE_NAME\n          value: "auth-service"\n        envFrom:\n        - configMapRef:\n            name: zenlogic-config\n        - secretRef:\n            name: zenlogic-secrets\n        resources:\n          requests:\n            memory: "256Mi"\n            cpu: "250m"\n          limits:\n            memory: "512Mi"\n            cpu: "500m"\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8001\n          initialDelaySeconds: 30\n          periodSeconds: 10\n        readinessProbe:\n          httpGet:\n            path: /health\n            port: 8001\n          initialDelaySeconds: 5\n          periodSeconds: 5\n'})}),"\n",(0,s.jsx)(n.h3,{id:"service",children:"Service"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# k8s/auth-service-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: auth-service\n  namespace: zenlogic\nspec:\n  selector:\n    app: auth-service\n  ports:\n  - name: http\n    port: 8001\n    targetPort: 8001\n  - name: grpc\n    port: 50051\n    targetPort: 50051\n  type: ClusterIP\n"})}),"\n",(0,s.jsx)(n.h3,{id:"ingress",children:"Ingress"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# k8s/ingress.yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: zenlogic-ingress\n  namespace: zenlogic\n  annotations:\n    cert-manager.io/cluster-issuer: "letsencrypt-prod"\n    nginx.ingress.kubernetes.io/ssl-redirect: "true"\nspec:\n  tls:\n  - hosts:\n    - api.zenlogic.com\n    secretName: zenlogic-tls\n  rules:\n  - host: api.zenlogic.com\n    http:\n      paths:\n      - path: /auth\n        pathType: Prefix\n        backend:\n          service:\n            name: auth-service\n            port:\n              number: 8001\n      - path: /catalog\n        pathType: Prefix\n        backend:\n          service:\n            name: catalog-service\n            port:\n              number: 8002\n'})}),"\n",(0,s.jsx)(n.h2,{id:"cicd-pipeline",children:"CI/CD Pipeline"}),"\n",(0,s.jsx)(n.h3,{id:"github-actions",children:"GitHub Actions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# .github/workflows/deploy.yml\nname: Deploy to Production\n\non:\n  push:\n    branches: [main]\n\njobs:\n  build-and-deploy:\n    runs-on: ubuntu-latest\n\n    steps:\n    - uses: actions/checkout@v3\n\n    - name: Login to Registry\n      uses: docker/login-action@v2\n      with:\n        registry: registry.example.com\n        username: ${{ secrets.REGISTRY_USERNAME }}\n        password: ${{ secrets.REGISTRY_PASSWORD }}\n\n    - name: Build and Push\n      run: |\n        docker build -t registry.example.com/auth-service:${{ github.sha }} services/auth-service\n        docker push registry.example.com/auth-service:${{ github.sha }}\n\n    - name: Deploy to Kubernetes\n      uses: azure/k8s-deploy@v4\n      with:\n        manifests: |\n          k8s/auth-service-deployment.yaml\n        images: |\n          registry.example.com/auth-service:${{ github.sha }}\n        kubeconfig: ${{ secrets.KUBECONFIG }}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"database-migrations",children:"Database Migrations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Script de migraci\xf3n segura\n#!/bin/bash\n\n# Backup DB\npg_dump -U user -d prod_db > backup_$(date +%Y%m%d).sql\n\n# Run migrations\nkubectl exec -it auth-service-pod -- alembic upgrade head\n\n# Verify\nkubectl exec -it auth-service-pod -- alembic current\n"})}),"\n",(0,s.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,s.jsx)(n.h3,{id:"prometheus",children:"Prometheus"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# k8s/prometheus-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\ndata:\n  prometheus.yml: |\n    scrape_configs:\n    - job_name: 'auth-service'\n      static_configs:\n      - targets: ['auth-service:8001']\n"})}),"\n",(0,s.jsx)(n.h3,{id:"grafana-dashboard",children:"Grafana Dashboard"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "dashboard": {\n    "title": "zenLogic Services",\n    "panels": [\n      {\n        "title": "Request Rate",\n        "targets": [{\n          "expr": "rate(http_requests_total[5m])"\n        }]\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"rollback",children:"Rollback"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Rollback a versi\xf3n anterior\nkubectl rollout undo deployment/auth-service -n zenlogic\n\n# Ver historial\nkubectl rollout history deployment/auth-service -n zenlogic\n\n# Rollback a versi\xf3n espec\xedfica\nkubectl rollout undo deployment/auth-service --to-revision=2 -n zenlogic\n"})}),"\n",(0,s.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/guias/troubleshooting",children:"Troubleshooting"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/arquitectura/vision-general",children:"Monitoring"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>t,x:()=>o});var i=a(6540);const s={},r=i.createContext(s);function t(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);