"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1577],{4266:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"adrs/adr-002-postgresql","title":"ADR-002: PostgreSQL como Base de Datos Principal","description":"Estado: Aceptado","source":"@site/docs/03-adrs/adr-002-postgresql.md","sourceDirName":"03-adrs","slug":"/adrs/adr-002-postgresql","permalink":"/zenlogic/adrs/adr-002-postgresql","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-adrs/adr-002-postgresql.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docs","previous":{"title":"ADR-001: Python + FastAPI","permalink":"/zenlogic/adrs/adr-001-python-fastapi"},"next":{"title":"ADR-003: Arquitectura Event-Driven","permalink":"/zenlogic/adrs/adr-003-event-driven"}}');var r=s(4848),a=s(8453);const l={sidebar_position:3},c="ADR-002: PostgreSQL como Base de Datos Principal",o={},t=[{value:"Contexto",id:"contexto",level:2},{value:"Decisi\xf3n",id:"decisi\xf3n",level:2},{value:"Configuraci\xf3n",id:"configuraci\xf3n",level:3},{value:"Alternativas Consideradas",id:"alternativas-consideradas",level:2},{value:"1. MySQL 8.0",id:"1-mysql-80",level:3},{value:"2. MongoDB",id:"2-mongodb",level:3},{value:"3. CockroachDB",id:"3-cockroachdb",level:3},{value:"Consecuencias",id:"consecuencias",level:2},{value:"Positivas",id:"positivas",level:3},{value:"Negativas",id:"negativas",level:3},{value:"Riesgos",id:"riesgos",level:3},{value:"Configuraci\xf3n de Producci\xf3n",id:"configuraci\xf3n-de-producci\xf3n",level:2},{value:"postgresql.conf",id:"postgresqlconf",level:3},{value:"Connection Pooling (PgBouncer)",id:"connection-pooling-pgbouncer",level:3},{value:"Monitoreo",id:"monitoreo",level:2},{value:"Queries Lentos",id:"queries-lentos",level:3},{value:"\xcdndices No Usados",id:"\xedndices-no-usados",level:3},{value:"Bloat de Tablas",id:"bloat-de-tablas",level:3},{value:"Benchmark",id:"benchmark",level:2},{value:"Revisi\xf3n Futura",id:"revisi\xf3n-futura",level:2},{value:"Referencias",id:"referencias",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"adr-002-postgresql-como-base-de-datos-principal",children:"ADR-002: PostgreSQL como Base de Datos Principal"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Estado"}),": Aceptado\n",(0,r.jsx)(n.strong,{children:"Fecha"}),": 2025-11-23\n",(0,r.jsx)(n.strong,{children:"Decisores"}),": Equipo de Arquitectura zenLogic"]}),"\n",(0,r.jsx)(n.h2,{id:"contexto",children:"Contexto"}),"\n",(0,r.jsx)(n.p,{children:"zenLogic requiere una base de datos relacional para almacenar:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Datos transaccionales"}),": Productos, pedidos, usuarios, roles"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Relaciones complejas"}),": Productos\u2194Variantes, Usuarios\u2194Roles\u2194Permisos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Multi-tenancy"}),": Aislamiento de datos por organizaci\xf3n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"JSONB"}),": Datos semi-estructurados (metadata, configuraciones)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ACID"}),": Consistencia cr\xedtica en transacciones de negocio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Escalabilidad"}),": Millones de filas en producci\xf3n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Full-text search"}),": B\xfasqueda de productos"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Cada microservicio necesita su propia base de datos (database per service pattern)."}),"\n",(0,r.jsx)(n.h2,{id:"decisi\xf3n",children:"Decisi\xf3n"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Usaremos PostgreSQL 15+"})," como base de datos relacional principal para todos los microservicios."]}),"\n",(0,r.jsx)(n.h3,{id:"configuraci\xf3n",children:"Configuraci\xf3n"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"PostgreSQL: 15+\nConnection Pool: asyncpg (async driver)\nORM: SQLAlchemy 2.0 (async mode)\nMigrations: Alembic\nBackup: pg_dump diario + WAL archiving\nReplication: Primary-Replica (read replicas)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"alternativas-consideradas",children:"Alternativas Consideradas"}),"\n",(0,r.jsx)(n.h3,{id:"1-mysql-80",children:"1. MySQL 8.0"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Popular, muchos devs lo conocen"}),"\n",(0,r.jsx)(n.li,{children:"Performance buena para workloads simples"}),"\n",(0,r.jsx)(n.li,{children:"Clustering con Galera"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"JSONB support inferior (JSON sin \xedndices eficientes)"}),"\n",(0,r.jsx)(n.li,{children:"Full-text search limitado"}),"\n",(0,r.jsx)(n.li,{children:"Row-level security no nativo (necesitar\xedamos middleware)"}),"\n",(0,r.jsx)(n.li,{children:"Transacciones DDL no soportadas (ALTER TABLE no es transaccional)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": JSONB y Row-Level Security son cr\xedticos para nuestro multi-tenancy."]}),"\n",(0,r.jsx)(n.h3,{id:"2-mongodb",children:"2. MongoDB"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Schema flexible"}),"\n",(0,r.jsx)(n.li,{children:"Scaling horizontal f\xe1cil (sharding)"}),"\n",(0,r.jsx)(n.li,{children:"BSON nativo (similar a JSON)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No ACID a nivel de documento (hasta MongoDB 4+, y a\xfan limitado)"}),"\n",(0,r.jsx)(n.li,{children:"JOINs ineficientes"}),"\n",(0,r.jsx)(n.li,{children:"No hay tipo safety en queries"}),"\n",(0,r.jsx)(n.li,{children:"Transacciones multi-documento complejas"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CR\xcdTICO"}),": Multi-tenancy row-level dif\xedcil de implementar"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": ERP requiere ACID estricto y relaciones complejas. NoSQL no es apropiado."]}),"\n",(0,r.jsx)(n.h3,{id:"3-cockroachdb",children:"3. CockroachDB"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Compatible con PostgreSQL"}),"\n",(0,r.jsx)(n.li,{children:"Distributed nativo, alta disponibilidad"}),"\n",(0,r.jsx)(n.li,{children:"ACID global"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Latencia mayor"})," que PostgreSQL (consensus overhead)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Costo licensing"})," para features enterprise"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Complejidad operacional"})," innecesaria para nuestro scale"]}),"\n",(0,r.jsx)(n.li,{children:"Menos maduro que PostgreSQL"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Over-engineering. No necesitamos distributed DB a\xfan. PostgreSQL + replicas es suficiente."]}),"\n",(0,r.jsx)(n.h2,{id:"consecuencias",children:"Consecuencias"}),"\n",(0,r.jsx)(n.h3,{id:"positivas",children:"Positivas"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"JSONB Potente"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \xcdndices GIN en JSONB\nCREATE INDEX idx_product_metadata ON products USING GIN (metadata);\n\n-- Queries eficientes\nSELECT * FROM products\nWHERE metadata @> '{\"featured\": true}'::jsonb;\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Row-Level Security (RLS)"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Multi-tenancy a nivel de DB\nCREATE POLICY tenant_isolation ON products\n    USING (organization_id = current_setting('app.current_tenant')::uuid);\n\nALTER TABLE products ENABLE ROW LEVEL SECURITY;\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Full-Text Search"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- tsvector + tsquery\nCREATE INDEX idx_product_search ON products\nUSING GIN (to_tsvector('spanish', name || ' ' || description));\n\nSELECT * FROM products\nWHERE to_tsvector('spanish', name || ' ' || description)\n    @@ to_tsquery('spanish', 'camiseta & algod\xf3n');\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Tipos de Datos Ricos"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE TYPE order_status AS ENUM ('pending', 'processing', 'completed', 'cancelled');\n\nCREATE TABLE orders (\n    id UUID PRIMARY KEY,\n    status order_status NOT NULL,\n    metadata JSONB,\n    tags TEXT[],  -- Array nativo\n    price NUMERIC(10, 2),  -- Exacto para dinero\n    created_at TIMESTAMPTZ DEFAULT NOW()\n);\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Transacciones DDL"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"BEGIN;\nALTER TABLE products ADD COLUMN is_featured BOOLEAN DEFAULT FALSE;\nUPDATE products SET is_featured = TRUE WHERE metadata->>'featured' = 'true';\nCOMMIT;  -- Si falla UPDATE, rollback de ALTER TABLE\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Window Functions"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Top 5 productos por categor\xeda\nSELECT\n    category,\n    name,\n    sales,\n    ROW_NUMBER() OVER (PARTITION BY category ORDER BY sales DESC) as rank\nFROM products\nWHERE rank <= 5;\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"CTEs Recursivos"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \xc1rbol de categor\xedas\nWITH RECURSIVE category_tree AS (\n    SELECT id, name, parent_id, 1 as level\n    FROM categories\n    WHERE parent_id IS NULL\n\n    UNION ALL\n\n    SELECT c.id, c.name, c.parent_id, ct.level + 1\n    FROM categories c\n    JOIN category_tree ct ON c.parent_id = ct.id\n)\nSELECT * FROM category_tree;\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Extensiones \xdatiles"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";       -- UUID generation\nCREATE EXTENSION IF NOT EXISTS "pg_trgm";         -- Fuzzy search\nCREATE EXTENSION IF NOT EXISTS "btree_gist";      -- Advanced indexes\nCREATE EXTENSION IF NOT EXISTS "pg_stat_statements"; -- Query monitoring\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"negativas",children:"Negativas"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Escalabilidad Vertical"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"PostgreSQL escala verticalmente mejor que horizontalmente"}),"\n",(0,r.jsx)(n.li,{children:"Sharding requiere herramientas externas (Citus, Postgres-XL)"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Para 100k-1M usuarios, vertical scaling es suficiente"}),"\n",(0,r.jsx)(n.li,{children:"Read replicas para queries pesados"}),"\n",(0,r.jsx)(n.li,{children:"Database per service reduce carga por DB"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Backup/Restore M\xe1s Lento que NoSQL"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"pg_dump de 1TB puede tomar horas"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"WAL archiving + Point-in-Time Recovery"}),"\n",(0,r.jsx)(n.li,{children:"pg_basebackup para backups incrementales"}),"\n",(0,r.jsx)(n.li,{children:"Replicas para DR (Disaster Recovery)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Schema Migrations Requieren Downtime (en casos espec\xedficos)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Agregar columna con default \u2192 lock table"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- En vez de:\nALTER TABLE products ADD COLUMN is_active BOOLEAN DEFAULT TRUE;\n\n-- Hacer:\nALTER TABLE products ADD COLUMN is_active BOOLEAN;\nUPDATE products SET is_active = TRUE WHERE is_active IS NULL;\nALTER TABLE products ALTER COLUMN is_active SET DEFAULT TRUE;\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Conexiones Costosas"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cada conexi\xf3n = proceso OS (overhead)"}),"\n",(0,r.jsx)(n.li,{children:"L\xedmite t\xedpico: 100-300 conexiones"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Connection pooling (asyncpg pool, PgBouncer)"}),"\n",(0,r.jsxs)(n.li,{children:["Configuraci\xf3n:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# SQLAlchemy async pool\nengine = create_async_engine(\n    DATABASE_URL,\n    pool_size=20,\n    max_overflow=10,\n    pool_pre_ping=True\n)\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"riesgos",children:"Riesgos"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Vacuuming Overhead"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"MVCC genera row versions que deben limpiarse"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Autovacuum configurado agresivamente\nALTER TABLE products SET (\n    autovacuum_vacuum_scale_factor = 0.05,\n    autovacuum_analyze_scale_factor = 0.02\n);\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\xcdndices Pueden Crecer Descontroladamente"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cada \xedndice duplica I/O en writes"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Solo \xedndices justificados por queries reales"}),"\n",(0,r.jsx)(n.li,{children:"Monitorear con pg_stat_user_indexes"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Transacciones Largas Bloquean VACUUM"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Transacci\xf3n abierta 1 hora \u2192 vacuum no puede limpiar"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Timeout: statement_timeout = 30s, idle_in_transaction_session_timeout = 10min"}),"\n",(0,r.jsx)(n.li,{children:"Monitorear transacciones largas"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuraci\xf3n-de-producci\xf3n",children:"Configuraci\xf3n de Producci\xf3n"}),"\n",(0,r.jsx)(n.h3,{id:"postgresqlconf",children:"postgresql.conf"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"# Connections\nmax_connections = 200\nsuperuser_reserved_connections = 3\n\n# Memory\nshared_buffers = 8GB            # 25% de RAM\neffective_cache_size = 24GB     # 75% de RAM\nwork_mem = 50MB                 # Per operation\nmaintenance_work_mem = 2GB\n\n# Checkpoints\ncheckpoint_timeout = 15min\ncheckpoint_completion_target = 0.9\nmax_wal_size = 4GB\n\n# Query Planner\nrandom_page_cost = 1.1          # SSD\neffective_io_concurrency = 200  # SSD\n\n# Logging\nlog_min_duration_statement = 1000  # Log queries > 1s\nlog_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '\nlog_checkpoints = on\nlog_connections = on\nlog_disconnections = on\n"})}),"\n",(0,r.jsx)(n.h3,{id:"connection-pooling-pgbouncer",children:"Connection Pooling (PgBouncer)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"[databases]\ncatalog_db = host=localhost port=5432 dbname=catalog\nauth_db = host=localhost port=5432 dbname=auth\n\n[pgbouncer]\npool_mode = transaction\nmax_client_conn = 1000\ndefault_pool_size = 25\nreserve_pool_size = 5\nreserve_pool_timeout = 3\n"})}),"\n",(0,r.jsx)(n.h2,{id:"monitoreo",children:"Monitoreo"}),"\n",(0,r.jsx)(n.h3,{id:"queries-lentos",children:"Queries Lentos"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Top 10 queries m\xe1s lentos\nSELECT\n    query,\n    calls,\n    total_exec_time / 1000 as total_time_sec,\n    mean_exec_time / 1000 as mean_time_sec,\n    max_exec_time / 1000 as max_time_sec\nFROM pg_stat_statements\nORDER BY mean_exec_time DESC\nLIMIT 10;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\xedndices-no-usados",children:"\xcdndices No Usados"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT\n    schemaname,\n    tablename,\n    indexname,\n    idx_scan,\n    pg_size_pretty(pg_relation_size(indexrelid)) as size\nFROM pg_stat_user_indexes\nWHERE idx_scan = 0\n  AND indexrelname NOT LIKE '%_pkey'\nORDER BY pg_relation_size(indexrelid) DESC;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"bloat-de-tablas",children:"Bloat de Tablas"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT\n    schemaname,\n    tablename,\n    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,\n    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) as index_size\nFROM pg_tables\nWHERE schemaname = 'public'\nORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"benchmark",children:"Benchmark"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"Hardware: 4 vCPU, 16GB RAM, SSD\nWorkload: 70% reads, 30% writes\n\nSimple SELECT (indexed):\n  Latency: 0.5-1ms\n  Throughput: 10,000+ QPS\n\nComplex JOIN (3 tables):\n  Latency: 5-10ms\n  Throughput: 2,000 QPS\n\nINSERT (with 3 indexes):\n  Latency: 2-3ms\n  Throughput: 3,000 TPS\n\nFull-text search:\n  Latency: 10-20ms\n  Throughput: 500 QPS\n"})}),"\n",(0,r.jsx)(n.h2,{id:"revisi\xf3n-futura",children:"Revisi\xf3n Futura"}),"\n",(0,r.jsx)(n.p,{children:"Este ADR debe revisarse si:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Alcanzamos 10M+ filas y queries se vuelven lentos (",(0,r.jsx)(n.code,{children:">100ms"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"Necesitamos sharding horizontal"}),"\n",(0,r.jsxs)(n.li,{children:["Costos de vertical scaling superan ",(0,r.jsx)(n.code,{children:">$10k/mes"})]}),"\n",(0,r.jsx)(n.li,{children:"Requieremos 99.99% uptime (actualmente 99.9% es suficiente)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fecha de pr\xf3xima revisi\xf3n"}),": 2026-11-23 (1 a\xf1o)"]}),"\n",(0,r.jsx)(n.h2,{id:"referencias",children:"Referencias"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.postgresql.org/docs/15/",children:"PostgreSQL 15 Documentation"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://wiki.postgresql.org/wiki/Performance_Optimization",children:"PostgreSQL Performance Tuning"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://use-the-index-luke.com/",children:"Use the Index, Luke"})," - SQL indexing guide"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.citusdata.com/",children:"Citus Data - PostgreSQL Scaling"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/adrs/adr-006-postgresql-multi-tenant",children:"ADR-006: PostgreSQL Row-Level Security para Multi-tenancy"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/auth-service/modelo-datos",children:"Auth Service - Modelo de Datos"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/catalog-service/modelo-datos",children:"Catalog Service - Modelo de Datos"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var i=s(6540);const r={},a=i.createContext(r);function l(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);