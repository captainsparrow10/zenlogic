"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1634],{3707:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"microservicios/auth-service/modelo-datos","title":"Modelo de Datos","description":"Diagrama de Entidad-Relaci\xf3n","source":"@site/docs/02-microservicios/auth-service/03-modelo-datos.md","sourceDirName":"02-microservicios/auth-service","slug":"/microservicios/auth-service/modelo-datos","permalink":"/zenlogic/microservicios/auth-service/modelo-datos","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/auth-service/03-modelo-datos.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docs","previous":{"title":"Arquitectura Interna","permalink":"/zenlogic/microservicios/auth-service/arquitectura"},"next":{"title":"Configuraci\xf3n","permalink":"/zenlogic/microservicios/auth-service/configuracion"}}');var a=s(4848),r=s(8453);const o={sidebar_position:4},l="Modelo de Datos",d={},c=[{value:"Diagrama de Entidad-Relaci\xf3n",id:"diagrama-de-entidad-relaci\xf3n",level:2},{value:"Tablas Principales",id:"tablas-principales",level:2},{value:"Organizations",id:"organizations",level:3},{value:"Users",id:"users",level:3},{value:"Roles",id:"roles",level:3},{value:"Permissions",id:"permissions",level:3},{value:"Modules",id:"modules",level:3},{value:"Locals",id:"locals",level:3},{value:"Tablas de Relaci\xf3n",id:"tablas-de-relaci\xf3n",level:2},{value:"User_Roles",id:"user_roles",level:3},{value:"Role_Permissions",id:"role_permissions",level:3},{value:"User_Locals",id:"user_locals",level:3},{value:"Organization_Modules",id:"organization_modules",level:3},{value:"Sessions",id:"sessions",level:3},{value:"SQLAlchemy Models",id:"sqlalchemy-models",level:2},{value:"User Model",id:"user-model",level:3},{value:"Role Model",id:"role-model",level:3},{value:"Queries Comunes",id:"queries-comunes",level:2},{value:"Obtener Usuario con Permisos",id:"obtener-usuario-con-permisos",level:3},{value:"Validar Permiso de Usuario",id:"validar-permiso-de-usuario",level:3},{value:"Obtener M\xf3dulos Habilitados de Organizaci\xf3n",id:"obtener-m\xf3dulos-habilitados-de-organizaci\xf3n",level:3},{value:"Datos Seed",id:"datos-seed",level:2},{value:"M\xf3dulos Predefinidos",id:"m\xf3dulos-predefinidos",level:3},{value:"Permisos Predefinidos",id:"permisos-predefinidos",level:3},{value:"Migraciones",id:"migraciones",level:2},{value:"Crear Migraci\xf3n",id:"crear-migraci\xf3n",level:3},{value:"Aplicar Migraciones",id:"aplicar-migraciones",level:3},{value:"Rollback",id:"rollback",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function t(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"modelo-de-datos",children:"Modelo de Datos"})}),"\n",(0,a.jsx)(n.h2,{id:"diagrama-de-entidad-relaci\xf3n",children:"Diagrama de Entidad-Relaci\xf3n"}),"\n",(0,a.jsx)(n.mermaid,{value:'erDiagram\n    ORGANIZATIONS ||--o{ USERS : "pertenece a"\n    ORGANIZATIONS ||--o{ LOCALS : "tiene"\n    ORGANIZATIONS ||--o{ ROLES : "define"\n    ORGANIZATIONS ||--o{ ORGANIZATION_MODULES : "habilita"\n\n    USERS ||--o{ USER_ROLES : "tiene"\n    USERS ||--o{ USER_LOCALS : "accede a"\n    USERS ||--o{ SESSIONS : "crea"\n\n    ROLES ||--o{ USER_ROLES : "asignado a"\n    ROLES ||--o{ ROLE_PERMISSIONS : "tiene"\n\n    PERMISSIONS ||--o{ ROLE_PERMISSIONS : "otorgado en"\n    MODULES ||--o{ PERMISSIONS : "contiene"\n    MODULES ||--o{ ORGANIZATION_MODULES : "habilitado en"\n\n    LOCALS ||--o{ USER_LOCALS : "accesible por"\n\n    ORGANIZATIONS {\n        varchar id PK\n        varchar name\n        varchar slug UK\n        varchar plan\n        varchar status\n        jsonb limits\n        timestamp created_date\n        timestamp updated_date\n    }\n\n    USERS {\n        varchar id PK\n        varchar organization_id FK\n        varchar email\n        varchar password_hash\n        varchar first_name\n        varchar last_name\n        varchar full_name\n        varchar phone\n        boolean active\n        boolean locked\n        timestamp last_login_at\n        timestamp password_changed_at\n        timestamp created_date\n        timestamp updated_date\n    }\n\n    ROLES {\n        varchar id PK\n        varchar organization_id FK\n        varchar name\n        varchar description\n        boolean system_role\n        timestamp created_date\n        timestamp updated_date\n    }\n\n    PERMISSIONS {\n        varchar id PK\n        varchar module_id FK\n        varchar name\n        varchar description\n        varchar action\n        timestamp created_date\n    }\n\n    MODULES {\n        varchar id PK\n        varchar name\n        varchar description\n        boolean active\n        timestamp created_date\n    }\n\n    LOCALS {\n        varchar id PK\n        varchar organization_id FK\n        varchar name\n        varchar code\n        varchar address\n        varchar status\n        timestamp created_date\n        timestamp updated_date\n    }\n\n    USER_ROLES {\n        varchar user_id PK,FK\n        varchar role_id PK,FK\n        timestamp assigned_date\n    }\n\n    ROLE_PERMISSIONS {\n        varchar role_id PK,FK\n        varchar permission_id PK,FK\n        timestamp granted_date\n    }\n\n    USER_LOCALS {\n        varchar user_id PK,FK\n        varchar local_id PK,FK\n        timestamp assigned_date\n    }\n\n    ORGANIZATION_MODULES {\n        varchar organization_id PK,FK\n        varchar module_id PK,FK\n        timestamp enabled_date\n    }\n\n    SESSIONS {\n        varchar id PK\n        varchar user_id FK\n        varchar refresh_token UK\n        varchar ip_address\n        varchar user_agent\n        timestamp expires_at\n        timestamp created_date\n    }'}),"\n",(0,a.jsx)(n.h2,{id:"tablas-principales",children:"Tablas Principales"}),"\n",(0,a.jsx)(n.h3,{id:"organizations",children:"Organizations"}),"\n",(0,a.jsx)(n.p,{children:"Representa los tenants del sistema."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE organizations (\n    id VARCHAR(50) PRIMARY KEY,\n    name VARCHAR(200) NOT NULL,\n    slug VARCHAR(100) UNIQUE NOT NULL,\n    plan VARCHAR(20) NOT NULL,  -- 'basic', 'pro', 'enterprise'\n    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- 'active', 'suspended', 'inactive'\n    limits JSONB,\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX idx_organizations_slug ON organizations(slug);\nCREATE INDEX idx_organizations_status ON organizations(status);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsxs)(n.strong,{children:["Ejemplo de ",(0,a.jsx)(n.code,{children:"limits"})]}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "max_users": 50,\n    "max_locals": 5,\n    "max_products": 10000,\n    "max_storage_gb": 100\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"users",children:"Users"}),"\n",(0,a.jsx)(n.p,{children:"Usuarios del sistema."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE users (\n    id VARCHAR(50) PRIMARY KEY,\n    organization_id VARCHAR(50) NOT NULL,\n    email VARCHAR(255) NOT NULL,\n    password_hash VARCHAR(255) NOT NULL,\n    first_name VARCHAR(100),\n    last_name VARCHAR(100),\n    full_name VARCHAR(255),  -- Nombre completo concatenado o personalizado\n    phone VARCHAR(20),  -- Tel\xe9fono del usuario\n    active BOOLEAN DEFAULT TRUE,\n    locked BOOLEAN DEFAULT FALSE,\n    last_login_at TIMESTAMP,  -- \xdaltima vez que el usuario se logueo\n    password_changed_at TIMESTAMP,  -- \xdaltima vez que cambi\xf3 su contrase\xf1a\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT fk_users_organization\n        FOREIGN KEY (organization_id)\n        REFERENCES organizations(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT uk_users_org_email\n        UNIQUE (organization_id, email)\n);\n\nCREATE INDEX idx_users_org ON users(organization_id);\nCREATE INDEX idx_users_email ON users(email);\nCREATE INDEX idx_users_active ON users(active);\nCREATE INDEX idx_users_phone ON users(phone);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Campos clave"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"organization_id"}),": Tenant al que pertenece (multi-tenancy)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"email"}),": \xdanico por organizaci\xf3n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"password_hash"}),": bcrypt hash"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"full_name"}),": Nombre completo del usuario (puede ser diferente a first_name + last_name)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"phone"}),": Tel\xe9fono de contacto"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"active"}),": \xbfUsuario puede loguearse?"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"locked"}),": \xbfUsuario bloqueado por intentos fallidos?"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"last_login_at"}),": Timestamp de \xfaltimo login (\xfatil para auditor\xeda y seguridad)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"password_changed_at"}),": Timestamp del \xfaltimo cambio de contrase\xf1a (para pol\xedticas de expiraci\xf3n)"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"roles",children:"Roles"}),"\n",(0,a.jsx)(n.p,{children:"Roles definidos por cada organizaci\xf3n."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE roles (\n    id VARCHAR(50) PRIMARY KEY,\n    organization_id VARCHAR(50) NOT NULL,\n    name VARCHAR(100) NOT NULL,\n    description TEXT,\n    system_role BOOLEAN DEFAULT FALSE,  -- Rol del sistema (no modificable)\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT fk_roles_organization\n        FOREIGN KEY (organization_id)\n        REFERENCES organizations(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT uk_roles_org_name\n        UNIQUE (organization_id, name)\n);\n\nCREATE INDEX idx_roles_org ON roles(organization_id);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"system_role"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"true"}),': Rol predefinido del sistema (ej: "Super Admin")']}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"false"}),": Rol creado por la organizaci\xf3n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"permissions",children:"Permissions"}),"\n",(0,a.jsx)(n.p,{children:"Permisos disponibles en el sistema."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE permissions (\n    id VARCHAR(50) PRIMARY KEY,\n    module_id VARCHAR(50) NOT NULL,\n    name VARCHAR(100) UNIQUE NOT NULL,  -- 'catalog:read', 'inventory:edit'\n    description TEXT,\n    action VARCHAR(50),  -- 'read', 'create', 'edit', 'delete'\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT fk_permissions_module\n        FOREIGN KEY (module_id)\n        REFERENCES modules(id)\n        ON DELETE CASCADE\n);\n\nCREATE INDEX idx_permissions_module ON permissions(module_id);\nCREATE INDEX idx_permissions_name ON permissions(name);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Formato de nombres"}),": ",(0,a.jsx)(n.code,{children:"{m\xf3dulo}:{acci\xf3n}"})]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplos:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"catalog:read"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"catalog:create"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"inventory:adjust"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"orders:cancel"})}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"modules",children:"Modules"}),"\n",(0,a.jsx)(n.p,{children:"M\xf3dulos del ERP."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE modules (\n    id VARCHAR(50) PRIMARY KEY,\n    name VARCHAR(100) UNIQUE NOT NULL,\n    description TEXT,\n    active BOOLEAN DEFAULT TRUE,\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"M\xf3dulos predefinidos"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"catalog"}),": Gesti\xf3n de productos"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"inventory"}),": Gesti\xf3n de inventario"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"orders"}),": \xd3rdenes de venta"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"pricing"}),": Gesti\xf3n de precios"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"reports"}),": Reportes y analytics"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"locals",children:"Locals"}),"\n",(0,a.jsx)(n.p,{children:"Sucursales o ubicaciones f\xedsicas."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE locals (\n    id VARCHAR(50) PRIMARY KEY,\n    organization_id VARCHAR(50) NOT NULL,\n    name VARCHAR(200) NOT NULL,\n    code VARCHAR(50),\n    address TEXT,\n    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'inactive'\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT fk_locals_organization\n        FOREIGN KEY (organization_id)\n        REFERENCES organizations(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT uk_locals_org_code\n        UNIQUE (organization_id, code)\n);\n\nCREATE INDEX idx_locals_org ON locals(organization_id);\nCREATE INDEX idx_locals_status ON locals(status);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"tablas-de-relaci\xf3n",children:"Tablas de Relaci\xf3n"}),"\n",(0,a.jsx)(n.h3,{id:"user_roles",children:"User_Roles"}),"\n",(0,a.jsx)(n.p,{children:"Asignaci\xf3n de roles a usuarios."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE user_roles (\n    user_id VARCHAR(50) NOT NULL,\n    role_id VARCHAR(50) NOT NULL,\n    assigned_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    PRIMARY KEY (user_id, role_id),\n\n    CONSTRAINT fk_user_roles_user\n        FOREIGN KEY (user_id)\n        REFERENCES users(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT fk_user_roles_role\n        FOREIGN KEY (role_id)\n        REFERENCES roles(id)\n        ON DELETE CASCADE\n);\n\nCREATE INDEX idx_user_roles_user ON user_roles(user_id);\nCREATE INDEX idx_user_roles_role ON user_roles(role_id);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Relaci\xf3n"}),": Un usuario puede tener m\xfaltiples roles."]}),"\n",(0,a.jsx)(n.h3,{id:"role_permissions",children:"Role_Permissions"}),"\n",(0,a.jsx)(n.p,{children:"Permisos asignados a roles."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE role_permissions (\n    role_id VARCHAR(50) NOT NULL,\n    permission_id VARCHAR(50) NOT NULL,\n    granted_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    PRIMARY KEY (role_id, permission_id),\n\n    CONSTRAINT fk_role_permissions_role\n        FOREIGN KEY (role_id)\n        REFERENCES roles(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT fk_role_permissions_permission\n        FOREIGN KEY (permission_id)\n        REFERENCES permissions(id)\n        ON DELETE CASCADE\n);\n\nCREATE INDEX idx_role_permissions_role ON role_permissions(role_id);\nCREATE INDEX idx_role_permissions_permission ON role_permissions(permission_id);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"user_locals",children:"User_Locals"}),"\n",(0,a.jsx)(n.p,{children:"Locales a los que un usuario tiene acceso."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE user_locals (\n    user_id VARCHAR(50) NOT NULL,\n    local_id VARCHAR(50) NOT NULL,\n    assigned_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    PRIMARY KEY (user_id, local_id),\n\n    CONSTRAINT fk_user_locals_user\n        FOREIGN KEY (user_id)\n        REFERENCES users(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT fk_user_locals_local\n        FOREIGN KEY (local_id)\n        REFERENCES locals(id)\n        ON DELETE CASCADE\n);\n\nCREATE INDEX idx_user_locals_user ON user_locals(user_id);\nCREATE INDEX idx_user_locals_local ON user_locals(local_id);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"organization_modules",children:"Organization_Modules"}),"\n",(0,a.jsx)(n.p,{children:"M\xf3dulos habilitados por organizaci\xf3n."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE organization_modules (\n    organization_id VARCHAR(50) NOT NULL,\n    module_id VARCHAR(50) NOT NULL,\n    enabled_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    PRIMARY KEY (organization_id, module_id),\n\n    CONSTRAINT fk_org_modules_org\n        FOREIGN KEY (organization_id)\n        REFERENCES organizations(id)\n        ON DELETE CASCADE,\n\n    CONSTRAINT fk_org_modules_module\n        FOREIGN KEY (module_id)\n        REFERENCES modules(id)\n        ON DELETE CASCADE\n);\n\nCREATE INDEX idx_org_modules_org ON organization_modules(organization_id);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"sessions",children:"Sessions"}),"\n",(0,a.jsx)(n.p,{children:"Sesiones de usuario (Refresh Tokens)."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE sessions (\n    id VARCHAR(50) PRIMARY KEY,\n    user_id VARCHAR(50) NOT NULL,\n    refresh_token TEXT UNIQUE NOT NULL,\n    ip_address VARCHAR(45),\n    user_agent TEXT,\n    expires_at TIMESTAMP NOT NULL,\n    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    CONSTRAINT fk_sessions_user\n        FOREIGN KEY (user_id)\n        REFERENCES users(id)\n        ON DELETE CASCADE\n);\n\nCREATE INDEX idx_sessions_user ON sessions(user_id);\nCREATE INDEX idx_sessions_refresh_token ON sessions(refresh_token);\nCREATE INDEX idx_sessions_expires ON sessions(expires_at);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"sqlalchemy-models",children:"SQLAlchemy Models"}),"\n",(0,a.jsx)(n.h3,{id:"user-model",children:"User Model"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'from sqlalchemy import Column, String, Boolean, DateTime, ForeignKey\nfrom sqlalchemy.orm import relationship\nfrom datetime import datetime\n\nclass User(Base):\n    __tablename__ = "users"\n\n    id = Column(String(50), primary_key=True)\n    organization_id = Column(String(50), ForeignKey("organizations.id"), nullable=False)\n    email = Column(String(255), nullable=False)\n    password_hash = Column(String(255), nullable=False)\n    first_name = Column(String(100))\n    last_name = Column(String(100))\n    full_name = Column(String(255))\n    phone = Column(String(20))\n    active = Column(Boolean, default=True)\n    locked = Column(Boolean, default=False)\n    last_login_at = Column(DateTime)\n    password_changed_at = Column(DateTime)\n    created_date = Column(DateTime, default=datetime.utcnow)\n    updated_date = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n\n    # Relationships\n    organization = relationship("Organization", back_populates="users")\n    roles = relationship("Role", secondary="user_roles", back_populates="users")\n    locals = relationship("Local", secondary="user_locals", back_populates="users")\n    sessions = relationship("Session", back_populates="user", cascade="all, delete-orphan")\n\n    def get_permissions(self) -> list[str]:\n        """Retorna lista de permisos del usuario"""\n        permissions = set()\n        for role in self.roles:\n            for permission in role.permissions:\n                permissions.add(permission.name)\n        return list(permissions)\n\n    def get_locals(self) -> list[str]:\n        """Retorna IDs de locales permitidos"""\n        return [local.id for local in self.locals]\n\n    def to_dict(self):\n        return {\n            "id": self.id,\n            "email": self.email,\n            "first_name": self.first_name,\n            "last_name": self.last_name,\n            "full_name": self.full_name,\n            "phone": self.phone,\n            "organization_id": self.organization_id,\n            "active": self.active,\n            "permissions": self.get_permissions(),\n            "locals": self.get_locals(),\n            "last_login_at": self.last_login_at.isoformat() if self.last_login_at else None,\n            "password_changed_at": self.password_changed_at.isoformat() if self.password_changed_at else None\n        }\n'})}),"\n",(0,a.jsx)(n.h3,{id:"role-model",children:"Role Model"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'class Role(Base):\n    __tablename__ = "roles"\n\n    id = Column(String(50), primary_key=True)\n    organization_id = Column(String(50), ForeignKey("organizations.id"), nullable=False)\n    name = Column(String(100), nullable=False)\n    description = Column(String)\n    system_role = Column(Boolean, default=False)\n    created_date = Column(DateTime, default=datetime.utcnow)\n    updated_date = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n\n    # Relationships\n    organization = relationship("Organization", back_populates="roles")\n    users = relationship("User", secondary="user_roles", back_populates="roles")\n    permissions = relationship("Permission", secondary="role_permissions", back_populates="roles")\n'})}),"\n",(0,a.jsx)(n.h2,{id:"queries-comunes",children:"Queries Comunes"}),"\n",(0,a.jsx)(n.h3,{id:"obtener-usuario-con-permisos",children:"Obtener Usuario con Permisos"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT\n    u.id,\n    u.email,\n    u.organization_id,\n    u.active,\n    array_agg(DISTINCT p.name) AS permissions,\n    array_agg(DISTINCT ul.local_id) AS locals\nFROM users u\nLEFT JOIN user_roles ur ON u.id = ur.user_id\nLEFT JOIN roles r ON ur.role_id = r.id\nLEFT JOIN role_permissions rp ON r.id = rp.role_id\nLEFT JOIN permissions p ON rp.permission_id = p.id\nLEFT JOIN user_locals ul ON u.id = ul.user_id\nWHERE u.id = $1 AND u.organization_id = $2\nGROUP BY u.id, u.email, u.organization_id, u.active;\n"})}),"\n",(0,a.jsx)(n.h3,{id:"validar-permiso-de-usuario",children:"Validar Permiso de Usuario"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT EXISTS (\n    SELECT 1\n    FROM users u\n    JOIN user_roles ur ON u.id = ur.user_id\n    JOIN roles r ON ur.role_id = r.id\n    JOIN role_permissions rp ON r.id = rp.role_id\n    JOIN permissions p ON rp.permission_id = p.id\n    WHERE u.id = $1\n      AND u.organization_id = $2\n      AND p.name = $3\n) AS has_permission;\n"})}),"\n",(0,a.jsx)(n.h3,{id:"obtener-m\xf3dulos-habilitados-de-organizaci\xf3n",children:"Obtener M\xf3dulos Habilitados de Organizaci\xf3n"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT m.*\nFROM modules m\nJOIN organization_modules om ON m.id = om.module_id\nWHERE om.organization_id = $1\n  AND m.active = TRUE;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"datos-seed",children:"Datos Seed"}),"\n",(0,a.jsx)(n.h3,{id:"m\xf3dulos-predefinidos",children:"M\xf3dulos Predefinidos"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"INSERT INTO modules (id, name, description) VALUES\n('module_catalog', 'Cat\xe1logo', 'Gesti\xf3n de productos y variantes'),\n('module_inventory', 'Inventario', 'Control de stock y movimientos'),\n('module_orders', '\xd3rdenes', 'Gesti\xf3n de \xf3rdenes de venta'),\n('module_pricing', 'Precios', 'Gesti\xf3n de precios y promociones'),\n('module_reports', 'Reportes', 'Analytics y reportes');\n"})}),"\n",(0,a.jsx)(n.h3,{id:"permisos-predefinidos",children:"Permisos Predefinidos"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"INSERT INTO permissions (id, module_id, name, description, action) VALUES\n-- Catalog\n('perm_catalog_read', 'module_catalog', 'catalog:read', 'Ver productos', 'read'),\n('perm_catalog_create', 'module_catalog', 'catalog:create', 'Crear productos', 'create'),\n('perm_catalog_edit', 'module_catalog', 'catalog:edit', 'Editar productos', 'edit'),\n('perm_catalog_delete', 'module_catalog', 'catalog:delete', 'Eliminar productos', 'delete'),\n\n-- Inventory\n('perm_inventory_read', 'module_inventory', 'inventory:read', 'Ver inventario', 'read'),\n('perm_inventory_adjust', 'module_inventory', 'inventory:adjust', 'Ajustar stock', 'edit'),\n\n-- Orders\n('perm_orders_read', 'module_orders', 'orders:read', 'Ver \xf3rdenes', 'read'),\n('perm_orders_create', 'module_orders', 'orders:create', 'Crear \xf3rdenes', 'create'),\n('perm_orders_cancel', 'module_orders', 'orders:cancel', 'Cancelar \xf3rdenes', 'delete');\n"})}),"\n",(0,a.jsx)(n.h2,{id:"migraciones",children:"Migraciones"}),"\n",(0,a.jsxs)(n.p,{children:["Las migraciones se gestionan con ",(0,a.jsx)(n.strong,{children:"Alembic"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"crear-migraci\xf3n",children:"Crear Migraci\xf3n"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'alembic revision --autogenerate -m "Add user_locals table"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"aplicar-migraciones",children:"Aplicar Migraciones"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"alembic upgrade head\n"})}),"\n",(0,a.jsx)(n.h3,{id:"rollback",children:"Rollback"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"alembic downgrade -1\n"})}),"\n",(0,a.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/microservicios/auth-service/eventos-publicados",children:"Eventos Publicados"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/microservicios/auth-service/grpc-server",children:"gRPC Server"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/microservicios/auth-service/api-auth",children:"API Auth"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var i=s(6540);const a={},r=i.createContext(a);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);