"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1479],{1703:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>d});const c=JSON.parse('{"id":"microservicios/catalog-service/cache-strategy","title":"Estrategia de Cache","description":"Implementaci\xf3n de cache con Redis para optimizar performance.","source":"@site/docs/02-microservicios/catalog-service/13-cache-strategy.md","sourceDirName":"02-microservicios/catalog-service","slug":"/microservicios/catalog-service/cache-strategy","permalink":"/zenlogic/microservicios/catalog-service/cache-strategy","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/catalog-service/13-cache-strategy.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14},"sidebar":"docs","previous":{"title":"Paginaci\xf3n con Cursor","permalink":"/zenlogic/microservicios/catalog-service/paginacion-cursor"},"next":{"title":"Flujos de Negocio","permalink":"/zenlogic/microservicios/catalog-service/flujos-negocio"}}');var i=a(4848),t=a(8453);const r={sidebar_position:14},s="Estrategia de Cache",o={},d=[{value:"Niveles de Cache",id:"niveles-de-cache",level:2},{value:"1. Cache de Entidades Completas",id:"1-cache-de-entidades-completas",level:3},{value:"2. Cache de Listados",id:"2-cache-de-listados",level:3},{value:"3. Cache de Relaciones",id:"3-cache-de-relaciones",level:3},{value:"4. Cache de Validaciones",id:"4-cache-de-validaciones",level:3},{value:"Implementaci\xf3n",id:"implementaci\xf3n",level:2},{value:"Redis Client",id:"redis-client",level:3},{value:"Cache Decorator",id:"cache-decorator",level:3},{value:"Invalidaci\xf3n de Cache",id:"invalidaci\xf3n-de-cache",level:2},{value:"Por Evento",id:"por-evento",level:3},{value:"Cache-Aside Pattern",id:"cache-aside-pattern",level:3},{value:"M\xe9tricas",id:"m\xe9tricas",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"estrategia-de-cache",children:"Estrategia de Cache"})}),"\n",(0,i.jsx)(n.p,{children:"Implementaci\xf3n de cache con Redis para optimizar performance."}),"\n",(0,i.jsx)(n.h2,{id:"niveles-de-cache",children:"Niveles de Cache"}),"\n",(0,i.jsx)(n.h3,{id:"1-cache-de-entidades-completas",children:"1. Cache de Entidades Completas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Pattern: {entity}:{org_id}:{entity_id}\n"product:org-123:product-456"\n"variant:org-123:variant-789"\n"option:org-123:option-abc"\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"TTL"}),": 10 minutos (600s)"]}),"\n",(0,i.jsx)(n.h3,{id:"2-cache-de-listados",children:"2. Cache de Listados"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Pattern: {entity}_list:{org_id}:{filters_hash}\n"product_list:org-123:7a8b9c"\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"TTL"}),": 5 minutos (300s)"]}),"\n",(0,i.jsx)(n.h3,{id:"3-cache-de-relaciones",children:"3. Cache de Relaciones"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Pattern: {entity}_by_{relation}:{org_id}:{relation_id}\n"variants_by_product:org-123:product-456"\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"TTL"}),": 10 minutos (600s)"]}),"\n",(0,i.jsx)(n.h3,{id:"4-cache-de-validaciones",children:"4. Cache de Validaciones"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Pattern: locals:{org_id}:{user_id}\n"locals:org-123:user-456"\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"TTL"}),": 1 hora (3600s)"]}),"\n",(0,i.jsx)(n.h2,{id:"implementaci\xf3n",children:"Implementaci\xf3n"}),"\n",(0,i.jsx)(n.h3,{id:"redis-client",children:"Redis Client"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import redis.asyncio as redis\nimport json\nfrom typing import Optional, Any\nfrom config.settings import settings\n\nclass RedisCache:\n    def __init__(self):\n        self.client = redis.from_url(\n            settings.redis_url,\n            encoding="utf-8",\n            decode_responses=True\n        )\n\n    async def get(self, key: str) -> Optional[Any]:\n        """Obtener valor del cache."""\n        value = await self.client.get(key)\n        return json.loads(value) if value else None\n\n    async def set(\n        self,\n        key: str,\n        value: Any,\n        ttl: int = 300\n    ):\n        """Guardar valor en cache."""\n        await self.client.setex(\n            key,\n            ttl,\n            json.dumps(value, default=str)\n        )\n\n    async def delete(self, key: str):\n        """Eliminar clave del cache."""\n        await self.client.delete(key)\n\n    async def delete_pattern(self, pattern: str):\n        """Eliminar todas las claves que coincidan con el patr\xf3n."""\n        async for key in self.client.scan_iter(match=pattern):\n            await self.client.delete(key)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"cache-decorator",children:"Cache Decorator"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from functools import wraps\n\ndef cached(key_prefix: str, ttl: int = 300):\n    """Decorator para cachear resultados de funciones."""\n    def decorator(func):\n        @wraps(func)\n        async def wrapper(*args, **kwargs):\n            # Construir cache key\n            cache_key = f"{key_prefix}:{args[1]}"  # org_id\n\n            # Intentar obtener del cache\n            cached_value = await cache.get(cache_key)\n            if cached_value:\n                return cached_value\n\n            # Ejecutar funci\xf3n\n            result = await func(*args, **kwargs)\n\n            # Guardar en cache\n            await cache.set(cache_key, result, ttl)\n\n            return result\n        return wrapper\n    return decorator\n\n# Uso\n@cached(key_prefix="product", ttl=600)\nasync def get_product(self, product_id: str, org_id: str):\n    return await self.db.query(Product).get(product_id)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"invalidaci\xf3n-de-cache",children:"Invalidaci\xf3n de Cache"}),"\n",(0,i.jsx)(n.h3,{id:"por-evento",children:"Por Evento"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def handle_product_updated(event: dict):\n    """Invalidar cache cuando se actualiza un producto."""\n    product_id = event["payload"]["product_id"]\n    org_id = event["payload"]["organization_id"]\n\n    # Invalidar producto espec\xedfico\n    await cache.delete(f"product:{org_id}:{product_id}")\n\n    # Invalidar listados relacionados\n    await cache.delete_pattern(f"product_list:{org_id}:*")\n\n    # Invalidar variantes del producto\n    await cache.delete_pattern(f"variants_by_product:{org_id}:{product_id}")\n'})}),"\n",(0,i.jsx)(n.h3,{id:"cache-aside-pattern",children:"Cache-Aside Pattern"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def update_product(product_id: str, data: dict, org_id: str):\n    """Actualizar producto e invalidar cache."""\n\n    # 1. Actualizar en DB\n    product = await product_repo.update(product_id, data, org_id)\n\n    # 2. Invalidar cache\n    await cache.delete(f"product:{org_id}:{product_id}")\n\n    # 3. Publicar evento (para otros servicios)\n    await event_publisher.publish("catalog.product.updated", {...})\n\n    return product\n'})}),"\n",(0,i.jsx)(n.h2,{id:"m\xe9tricas",children:"M\xe9tricas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from prometheus_client import Counter, Histogram\n\ncache_hits = Counter("catalog_cache_hits_total", "Cache hits", ["entity"])\ncache_misses = Counter("catalog_cache_misses_total", "Cache misses", ["entity"])\n\nasync def get_with_metrics(key: str, entity: str):\n    value = await cache.get(key)\n    if value:\n        cache_hits.labels(entity=entity).inc()\n    else:\n        cache_misses.labels(entity=entity).inc()\n    return value\n'})}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/catalog-service/eventos-consumidos",children:"Eventos Consumidos"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/catalog-service/validacion-locales",children:"Validaci\xf3n de Locales"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>s});var c=a(6540);const i={},t=c.createContext(i);function r(e){const n=c.useContext(t);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),c.createElement(t.Provider,{value:n},e.children)}}}]);