"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[7796],{4994:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"microservicios/catalog-service/migraciones","title":"Migraciones de Base de Datos","description":"Gesti\xf3n de migraciones con Alembic para Catalog Service.","source":"@site/docs/02-microservicios/catalog-service/17-migraciones.md","sourceDirName":"02-microservicios/catalog-service","slug":"/microservicios/catalog-service/migraciones","permalink":"/zenlogic/microservicios/catalog-service/migraciones","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/catalog-service/17-migraciones.md","tags":[],"version":"current","sidebarPosition":18,"frontMatter":{"sidebar_position":18},"sidebar":"docs","previous":{"title":"Errores Comunes","permalink":"/zenlogic/microservicios/catalog-service/errores-comunes"},"next":{"title":"Inventory Service - Overview","permalink":"/zenlogic/microservicios/inventory-service/overview"}}');var o=a(4848),r=a(8453);const s={sidebar_position:18},c="Migraciones de Base de Datos",l={},t=[{value:"Configuraci\xf3n",id:"configuraci\xf3n",level:2},{value:"<code>alembic.ini</code>",id:"alembicini",level:3},{value:"<code>alembic/env.py</code>",id:"alembicenvpy",level:3},{value:"Migraciones Principales",id:"migraciones-principales",level:2},{value:"001 - Crear Tablas Iniciales",id:"001---crear-tablas-iniciales",level:3},{value:"002 - Agregar Auditor\xeda",id:"002---agregar-auditor\xeda",level:3},{value:"Comandos Alembic",id:"comandos-alembic",level:2},{value:"Buenas Pr\xe1cticas",id:"buenas-pr\xe1cticas",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"migraciones-de-base-de-datos",children:"Migraciones de Base de Datos"})}),"\n",(0,o.jsx)(n.p,{children:"Gesti\xf3n de migraciones con Alembic para Catalog Service."}),"\n",(0,o.jsx)(n.h2,{id:"configuraci\xf3n",children:"Configuraci\xf3n"}),"\n",(0,o.jsx)(n.h3,{id:"alembicini",children:(0,o.jsx)(n.code,{children:"alembic.ini"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ini",children:"[alembic]\nscript_location = alembic\nsqlalchemy.url = postgresql://catalog_user:password@localhost/erp_catalog\n\n[loggers]\nkeys = root,sqlalchemy,alembic\n\n[logger_alembic]\nlevel = INFO\nhandlers =\nqualname = alembic\n"})}),"\n",(0,o.jsx)(n.h3,{id:"alembicenvpy",children:(0,o.jsx)(n.code,{children:"alembic/env.py"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'from logging.config import fileConfig\nfrom sqlalchemy import engine_from_config, pool\nfrom alembic import context\n\nfrom app.models import Base\nfrom config.settings import settings\n\nconfig = context.config\nconfig.set_main_option("sqlalchemy.url", settings.database_url)\n\ntarget_metadata = Base.metadata\n\ndef run_migrations_online():\n    connectable = engine_from_config(\n        config.get_section(config.config_ini_section),\n        prefix="sqlalchemy.",\n        poolclass=pool.NullPool,\n    )\n\n    with connectable.connect() as connection:\n        context.configure(\n            connection=connection,\n            target_metadata=target_metadata\n        )\n\n        with context.begin_transaction():\n            context.run_migrations()\n'})}),"\n",(0,o.jsx)(n.h2,{id:"migraciones-principales",children:"Migraciones Principales"}),"\n",(0,o.jsx)(n.h3,{id:"001---crear-tablas-iniciales",children:"001 - Crear Tablas Iniciales"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"\"\"\"create initial tables\n\nRevision ID: 001_initial\nCreate Date: 2025-11-23\n\"\"\"\n\nfrom alembic import op\nimport sqlalchemy as sa\nfrom sqlalchemy.dialects.postgresql import UUID\n\nrevision = '001_initial'\ndown_revision = None\n\ndef upgrade():\n    # Products\n    op.create_table(\n        'products',\n        sa.Column('id', UUID(as_uuid=True), primary_key=True),\n        sa.Column('organization_id', UUID(as_uuid=True), nullable=False),\n        sa.Column('name', sa.String(200), nullable=False),\n        sa.Column('sku', sa.String(50), nullable=False),\n        sa.Column('category', sa.String(100)),\n        sa.Column('description', sa.Text()),\n        sa.Column('base_price', sa.Numeric(10, 2), nullable=False),\n        sa.Column('is_active', sa.Boolean(), default=True),\n        sa.Column('created_at', sa.DateTime(timezone=True)),\n        sa.Column('updated_at', sa.DateTime(timezone=True)),\n        sa.Column('deleted_at', sa.DateTime(timezone=True))\n    )\n\n    # \xcdndices\n    op.create_index(\n        'idx_products_org',\n        'products',\n        ['organization_id']\n    )\n    op.create_index(\n        'idx_products_sku_org',\n        'products',\n        ['sku', 'organization_id'],\n        unique=True\n    )\n\n    # Variants\n    op.create_table(\n        'variants',\n        sa.Column('id', UUID(as_uuid=True), primary_key=True),\n        sa.Column('product_id', UUID(as_uuid=True), nullable=False),\n        sa.Column('sku', sa.String(50), nullable=False),\n        sa.Column('name', sa.String(200)),\n        sa.Column('price', sa.Numeric(10, 2), nullable=False),\n        sa.Column('is_active', sa.Boolean(), default=True),\n        sa.Column('created_at', sa.DateTime(timezone=True)),\n        sa.ForeignKeyConstraint(['product_id'], ['products.id'])\n    )\n\n    # Options\n    op.create_table(\n        'options',\n        sa.Column('id', UUID(as_uuid=True), primary_key=True),\n        sa.Column('organization_id', UUID(as_uuid=True), nullable=False),\n        sa.Column('name', sa.String(100), nullable=False),\n        sa.Column('values', sa.ARRAY(sa.String(100))),\n        sa.Column('created_at', sa.DateTime(timezone=True))\n    )\n\ndef downgrade():\n    op.drop_table('options')\n    op.drop_table('variants')\n    op.drop_table('products')\n"})}),"\n",(0,o.jsx)(n.h3,{id:"002---agregar-auditor\xeda",children:"002 - Agregar Auditor\xeda"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"\"\"\"add audit fields\n\nRevision ID: 002_audit\n\"\"\"\n\ndef upgrade():\n    op.add_column('products', sa.Column('created_by', UUID(as_uuid=True)))\n    op.add_column('products', sa.Column('updated_by', UUID(as_uuid=True)))\n    op.add_column('variants', sa.Column('created_by', UUID(as_uuid=True)))\n\ndef downgrade():\n    op.drop_column('products', 'created_by')\n    op.drop_column('products', 'updated_by')\n    op.drop_column('variants', 'created_by')\n"})}),"\n",(0,o.jsx)(n.h2,{id:"comandos-alembic",children:"Comandos Alembic"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# Crear nueva migraci\xf3n autom\xe1tica\nalembic revision --autogenerate -m "descripcion del cambio"\n\n# Aplicar migraciones\nalembic upgrade head\n\n# Rollback \xfaltima migraci\xf3n\nalembic downgrade -1\n\n# Ver historial\nalembic history\n\n# Ver estado actual\nalembic current\n\n# Rollback a versi\xf3n espec\xedfica\nalembic downgrade 001_initial\n'})}),"\n",(0,o.jsx)(n.h2,{id:"buenas-pr\xe1cticas",children:"Buenas Pr\xe1cticas"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.strong,{children:"Siempre revisar migraciones auto-generadas"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.strong,{children:"Nunca modificar migraciones ya aplicadas en producci\xf3n"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.strong,{children:"Usar transacciones para cambios complejos"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.strong,{children:"Probar rollback antes de deploy"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.strong,{children:"Hacer backup antes de aplicar migraciones"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/microservicios/catalog-service/configuracion",children:"Configuraci\xf3n"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/microservicios/catalog-service/modelo-datos",children:"Modelo de Datos"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>s,x:()=>c});var i=a(6540);const o={},r=i.createContext(o);function s(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);