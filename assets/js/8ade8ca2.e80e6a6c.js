"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[925],{8052:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>v,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"microservicios/inventory-service/integraciones","title":"Integraciones","description":"Documentaci\xf3n completa de las integraciones del Inventory Service con otros microservicios del sistema ERP.","source":"@site/docs/02-microservicios/inventory-service/16-integraciones.md","sourceDirName":"02-microservicios/inventory-service","slug":"/microservicios/inventory-service/integraciones","permalink":"/zenlogic/microservicios/inventory-service/integraciones","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/inventory-service/16-integraciones.md","tags":[],"version":"current","sidebarPosition":16,"frontMatter":{"sidebar_position":16},"sidebar":"docs","previous":{"title":"Eventos Consumidos","permalink":"/zenlogic/microservicios/inventory-service/eventos-consumidos"},"next":{"title":"Errores Comunes","permalink":"/zenlogic/microservicios/inventory-service/errores-comunes"}}');var a=i(4848),t=i(8453);const s={sidebar_position:16},o="Integraciones",c={},l=[{value:"Arquitectura de Integraci\xf3n",id:"arquitectura-de-integraci\xf3n",level:2},{value:"Integraci\xf3n con Catalog Service",id:"integraci\xf3n-con-catalog-service",level:2},{value:"Comunicaci\xf3n As\xedncrona (RabbitMQ)",id:"comunicaci\xf3n-as\xedncrona-rabbitmq",level:3},{value:"1. Inicializaci\xf3n de Stock para Nueva Variante",id:"1-inicializaci\xf3n-de-stock-para-nueva-variante",level:4},{value:"2. Validaci\xf3n antes de Eliminar Variante",id:"2-validaci\xf3n-antes-de-eliminar-variante",level:4},{value:"Comunicaci\xf3n S\xedncrona (gRPC)",id:"comunicaci\xf3n-s\xedncrona-grpc",level:3},{value:"Validaci\xf3n de Variante",id:"validaci\xf3n-de-variante",level:4},{value:"Cache Synchronization",id:"cache-synchronization",level:3},{value:"Integraci\xf3n con Order Service",id:"integraci\xf3n-con-order-service",level:2},{value:"Comunicaci\xf3n S\xedncrona (gRPC)",id:"comunicaci\xf3n-s\xedncrona-grpc-1",level:3},{value:"1. Verificar Disponibilidad de Stock",id:"1-verificar-disponibilidad-de-stock",level:4},{value:"2. Flujo Completo de Orden",id:"2-flujo-completo-de-orden",level:4},{value:"3. Manejo de Cancelaciones",id:"3-manejo-de-cancelaciones",level:4},{value:"Event-Based Integration",id:"event-based-integration",level:3},{value:"Order Events Consumed",id:"order-events-consumed",level:4},{value:"Inventory Events Published to Order Service",id:"inventory-events-published-to-order-service",level:4},{value:"Integraci\xf3n con Notification Service",id:"integraci\xf3n-con-notification-service",level:2},{value:"Low Stock Alerts",id:"low-stock-alerts",level:3},{value:"Integraci\xf3n con Purchasing Service",id:"integraci\xf3n-con-purchasing-service",level:2},{value:"Automatic Reorder Triggers",id:"automatic-reorder-triggers",level:3},{value:"Health Checks &amp; Circuit Breaker",id:"health-checks--circuit-breaker",level:2},{value:"Service Health Monitoring",id:"service-health-monitoring",level:3},{value:"Graceful Degradation",id:"graceful-degradation",level:3},{value:"Rate Limiting &amp; Retry Logic",id:"rate-limiting--retry-logic",level:2},{value:"gRPC Retry Configuration",id:"grpc-retry-configuration",level:3},{value:"Testing Integrations",id:"testing-integrations",level:2},{value:"Integration Test Examples",id:"integration-test-examples",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"integraciones",children:"Integraciones"})}),"\n",(0,a.jsx)(n.p,{children:"Documentaci\xf3n completa de las integraciones del Inventory Service con otros microservicios del sistema ERP."}),"\n",(0,a.jsx)(n.h2,{id:"arquitectura-de-integraci\xf3n",children:"Arquitectura de Integraci\xf3n"}),"\n",(0,a.jsx)(n.mermaid,{value:'graph TB\n    subgraph "Inventory Service"\n        INV[Inventory Core]\n        STOCK[Stock Manager]\n        TRANSFER[Transfer Manager]\n        EVENT_PUB[Event Publisher]\n        EVENT_SUB[Event Subscriber]\n        GRPC_SERVER[gRPC Server]\n        GRPC_CLIENT[gRPC Client]\n    end\n\n    subgraph "Catalog Service"\n        CAT[Catalog API]\n        CAT_EVENT[Catalog Events]\n        CAT_GRPC[Catalog gRPC]\n    end\n\n    subgraph "Order Service"\n        ORDER[Order API]\n        ORDER_EVENT[Order Events]\n        ORDER_GRPC[Order gRPC]\n    end\n\n    subgraph "Notification Service"\n        NOTIF[Notification API]\n    end\n\n    subgraph "Purchasing Service"\n        PURCH[Purchasing API]\n    end\n\n    subgraph "Message Broker"\n        RMQ[RabbitMQ]\n    end\n\n    CAT_EVENT --\x3e|variant.created| RMQ\n    CAT_EVENT --\x3e|variant.deleted| RMQ\n    RMQ --\x3e|consume| EVENT_SUB\n\n    ORDER_EVENT --\x3e|order.placed| RMQ\n    ORDER_EVENT --\x3e|order.cancelled| RMQ\n    ORDER_EVENT --\x3e|order.shipped| RMQ\n    RMQ --\x3e|consume| EVENT_SUB\n\n    EVENT_PUB --\x3e|stock.updated| RMQ\n    EVENT_PUB --\x3e|stock.low_level| RMQ\n    RMQ --\x3e|notify| NOTIF\n    RMQ --\x3e|notify| CAT\n    RMQ --\x3e|notify| ORDER\n\n    ORDER_GRPC --\x3e|CheckAvailability| GRPC_SERVER\n    GRPC_CLIENT --\x3e|ValidateVariant| CAT_GRPC\n\n    EVENT_PUB --\x3e|stock.low_level| RMQ\n    RMQ --\x3e|trigger purchase| PURCH'}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"integraci\xf3n-con-catalog-service",children:"Integraci\xf3n con Catalog Service"}),"\n",(0,a.jsx)(n.h3,{id:"comunicaci\xf3n-as\xedncrona-rabbitmq",children:"Comunicaci\xf3n As\xedncrona (RabbitMQ)"}),"\n",(0,a.jsx)(n.h4,{id:"1-inicializaci\xf3n-de-stock-para-nueva-variante",children:"1. Inicializaci\xf3n de Stock para Nueva Variante"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Trigger:"})," ",(0,a.jsx)(n.code,{children:"catalog.variant.created"})]}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant CS as Catalog Service\n    participant RMQ as RabbitMQ\n    participant IS as Inventory Service\n    participant DB as Database\n\n    CS->>RMQ: Publish variant.created\n    RMQ->>IS: Consume event\n    IS->>IS: Validate event data\n    IS->>DB: Get active warehouses\n    DB--\x3e>IS: Return warehouses list\n\n    loop For each warehouse\n        IS->>DB: Create stock record\n        DB--\x3e>IS: Stock created\n    end\n\n    IS->>RMQ: Publish stock.initialized\n    RMQ->>CS: Notify initialization complete"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Event Flow:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'// Input: catalog.variant.created\n{\n  "event": "catalog.variant.created",\n  "data": {\n    "variant_id": "var_789",\n    "product_id": "prod_456",\n    "sku": "PROD-001-RED-M",\n    "track_inventory": true,\n    "default_min_stock": 20,\n    "default_max_stock": 200\n  }\n}\n\n// Output: inventory.stock.initialized\n{\n  "event": "inventory.stock.initialized",\n  "data": {\n    "variant_id": "var_789",\n    "warehouses": [\n      {\n        "warehouse_id": "wh_101",\n        "stock_id": "stock_456",\n        "initial_quantity": 0\n      }\n    ],\n    "status": "success"\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h4,{id:"2-validaci\xf3n-antes-de-eliminar-variante",children:"2. Validaci\xf3n antes de Eliminar Variante"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Trigger:"})," ",(0,a.jsx)(n.code,{children:"catalog.variant.deleted"})]}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant CS as Catalog Service\n    participant RMQ as RabbitMQ\n    participant IS as Inventory Service\n    participant DB as Database\n\n    CS->>RMQ: Publish variant.deleted\n    RMQ->>IS: Consume event\n    IS->>DB: Check stock for variant\n    DB--\x3e>IS: Return stock records\n\n    alt Stock > 0\n        IS->>RMQ: Publish stock.validation_failed\n        RMQ->>CS: Notify deletion blocked\n        Note over CS: Rollback deletion\n    else Stock = 0\n        IS->>DB: Archive stock records\n        DB--\x3e>IS: Records archived\n        IS->>RMQ: Publish stock.archived\n        RMQ->>CS: Confirm archival\n    end"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Validation Response:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'// When stock exists (blocking deletion)\n{\n  "event": "inventory.stock.validation_failed",\n  "data": {\n    "variant_id": "var_789",\n    "reason": "stock_not_zero",\n    "details": {\n      "total_stock": 45,\n      "warehouses_affected": [\n        {\n          "warehouse_id": "wh_101",\n          "quantity": 30\n        },\n        {\n          "warehouse_id": "wh_102",\n          "quantity": 15\n        }\n      ]\n    },\n    "action_required": "Clear all stock before deleting variant"\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"comunicaci\xf3n-s\xedncrona-grpc",children:"Comunicaci\xf3n S\xedncrona (gRPC)"}),"\n",(0,a.jsx)(n.h4,{id:"validaci\xf3n-de-variante",children:"Validaci\xf3n de Variante"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Service Definition:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-protobuf",children:"// catalog.proto\nservice CatalogService {\n  rpc ValidateVariant(ValidateVariantRequest) returns (ValidateVariantResponse);\n  rpc GetVariantDetails(VariantRequest) returns (VariantResponse);\n  rpc CheckVariantActive(VariantRequest) returns (ActiveStatusResponse);\n}\n\nmessage ValidateVariantRequest {\n  string organization_id = 1;\n  string variant_id = 2;\n}\n\nmessage ValidateVariantResponse {\n  bool exists = 1;\n  bool is_active = 2;\n  bool tracks_inventory = 3;\n  string sku = 4;\n  string product_name = 5;\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Client Implementation:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# inventory_service/grpc/catalog_client.py\nfrom grpc import aio\nfrom proto import catalog_pb2, catalog_pb2_grpc\n\nclass CatalogGrpcClient:\n    def __init__(self, host: str, port: int):\n        self.channel = aio.insecure_channel(f\"{host}:{port}\")\n        self.stub = catalog_pb2_grpc.CatalogServiceStub(self.channel)\n\n    async def validate_variant(\n        self,\n        organization_id: str,\n        variant_id: str\n    ) -> Dict[str, Any]:\n        \"\"\"\n        Validate variant exists and is active before stock operations.\n        \"\"\"\n        request = catalog_pb2.ValidateVariantRequest(\n            organization_id=organization_id,\n            variant_id=variant_id\n        )\n\n        try:\n            response = await self.stub.ValidateVariant(\n                request,\n                timeout=5.0\n            )\n\n            return {\n                'exists': response.exists,\n                'is_active': response.is_active,\n                'tracks_inventory': response.tracks_inventory,\n                'sku': response.sku,\n                'product_name': response.product_name\n            }\n        except grpc.RpcError as e:\n            logger.error(f\"gRPC error validating variant: {e.code()} - {e.details()}\")\n            raise\n\n    async def close(self):\n        await self.channel.close()\n\n# Usage in stock service\nasync def create_stock_movement(\n    variant_id: str,\n    warehouse_id: str,\n    quantity: int,\n    organization_id: str\n) -> StockMovement:\n    # Validate variant via gRPC\n    catalog_client = CatalogGrpcClient(\n        host=settings.CATALOG_GRPC_HOST,\n        port=settings.CATALOG_GRPC_PORT\n    )\n\n    variant_info = await catalog_client.validate_variant(\n        organization_id=organization_id,\n        variant_id=variant_id\n    )\n\n    if not variant_info['exists']:\n        raise VariantNotFoundError(f\"Variant {variant_id} does not exist\")\n\n    if not variant_info['is_active']:\n        raise VariantInactiveError(f\"Variant {variant_id} is inactive\")\n\n    if not variant_info['tracks_inventory']:\n        raise InventoryNotTrackedError(\n            f\"Variant {variant_id} does not track inventory\"\n        )\n\n    # Proceed with movement creation\n    # ...\n"})}),"\n",(0,a.jsx)(n.h3,{id:"cache-synchronization",children:"Cache Synchronization"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Redis Cache Strategy:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# inventory_service/cache/variant_cache.py\nimport redis.asyncio as redis\nfrom typing import Optional, Dict, Any\n\nclass VariantCache:\n    """Cache for variant data from Catalog Service."""\n\n    def __init__(self, redis_client: redis.Redis):\n        self.redis = redis_client\n        self.ttl = 3600  # 1 hour\n\n    async def get_variant(self, variant_id: str) -> Optional[Dict[str, Any]]:\n        """Get cached variant data."""\n        key = f"variant:{variant_id}"\n        data = await self.redis.get(key)\n\n        if data:\n            return json.loads(data)\n        return None\n\n    async def set_variant(self, variant_id: str, data: Dict[str, Any]) -> None:\n        """Cache variant data."""\n        key = f"variant:{variant_id}"\n        await self.redis.setex(\n            key,\n            self.ttl,\n            json.dumps(data)\n        )\n\n    async def invalidate_variant(self, variant_id: str) -> None:\n        """Remove variant from cache."""\n        key = f"variant:{variant_id}"\n        await self.redis.delete(key)\n\n# Event handler to invalidate cache\nasync def handle_variant_updated(event: Dict[str, Any]) -> None:\n    """Invalidate cache when variant is updated in Catalog."""\n    variant_id = event[\'data\'][\'variant_id\']\n    await variant_cache.invalidate_variant(variant_id)\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"integraci\xf3n-con-order-service",children:"Integraci\xf3n con Order Service"}),"\n",(0,a.jsx)(n.h3,{id:"comunicaci\xf3n-s\xedncrona-grpc-1",children:"Comunicaci\xf3n S\xedncrona (gRPC)"}),"\n",(0,a.jsx)(n.h4,{id:"1-verificar-disponibilidad-de-stock",children:"1. Verificar Disponibilidad de Stock"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Service Definition:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-protobuf",children:"// inventory.proto\nservice InventoryService {\n  rpc CheckAvailability(AvailabilityRequest) returns (AvailabilityResponse);\n  rpc ReserveStock(ReserveStockRequest) returns (ReserveStockResponse);\n  rpc ReleaseReservation(ReleaseRequest) returns (ReleaseResponse);\n  rpc ConfirmReservation(ConfirmRequest) returns (ConfirmResponse);\n}\n\nmessage AvailabilityRequest {\n  string organization_id = 1;\n  repeated AvailabilityItem items = 2;\n  string preferred_warehouse_id = 3;\n}\n\nmessage AvailabilityItem {\n  string variant_id = 1;\n  int32 quantity = 2;\n}\n\nmessage AvailabilityResponse {\n  bool all_available = 1;\n  repeated AvailabilityResult results = 2;\n}\n\nmessage AvailabilityResult {\n  string variant_id = 1;\n  int32 requested = 2;\n  int32 available = 3;\n  bool sufficient = 4;\n  string warehouse_id = 5;\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Server Implementation:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# inventory_service/grpc/inventory_server.py\nfrom proto import inventory_pb2, inventory_pb2_grpc\n\nclass InventoryServicer(inventory_pb2_grpc.InventoryServiceServicer):\n    def __init__(self, stock_service: StockService):\n        self.stock_service = stock_service\n\n    async def CheckAvailability(\n        self,\n        request: inventory_pb2.AvailabilityRequest,\n        context: grpc.aio.ServicerContext\n    ) -> inventory_pb2.AvailabilityResponse:\n        """\n        Check stock availability for multiple items.\n        Called by Order Service before confirming order.\n        """\n        organization_id = request.organization_id\n        items = request.items\n        preferred_warehouse = request.preferred_warehouse_id or None\n\n        results = []\n        all_available = True\n\n        for item in items:\n            variant_id = item.variant_id\n            requested_qty = item.quantity\n\n            # Find best warehouse with available stock\n            stock = await self.stock_service.find_available_stock(\n                variant_id=variant_id,\n                quantity=requested_qty,\n                organization_id=organization_id,\n                preferred_warehouse_id=preferred_warehouse\n            )\n\n            if stock and stock.available_quantity >= requested_qty:\n                results.append(inventory_pb2.AvailabilityResult(\n                    variant_id=variant_id,\n                    requested=requested_qty,\n                    available=stock.available_quantity,\n                    sufficient=True,\n                    warehouse_id=stock.warehouse_id\n                ))\n            else:\n                all_available = False\n                results.append(inventory_pb2.AvailabilityResult(\n                    variant_id=variant_id,\n                    requested=requested_qty,\n                    available=stock.available_quantity if stock else 0,\n                    sufficient=False,\n                    warehouse_id=stock.warehouse_id if stock else ""\n                ))\n\n        return inventory_pb2.AvailabilityResponse(\n            all_available=all_available,\n            results=results\n        )\n\n    async def ReserveStock(\n        self,\n        request: inventory_pb2.ReserveStockRequest,\n        context: grpc.aio.ServicerContext\n    ) -> inventory_pb2.ReserveStockResponse:\n        """\n        Create stock reservation for order.\n        """\n        try:\n            reservation = await self.stock_service.create_reservation(\n                order_id=request.order_id,\n                organization_id=request.organization_id,\n                items=[\n                    {\n                        \'variant_id\': item.variant_id,\n                        \'quantity\': item.quantity,\n                        \'warehouse_id\': item.warehouse_id\n                    }\n                    for item in request.items\n                ],\n                ttl_minutes=request.ttl_minutes\n            )\n\n            return inventory_pb2.ReserveStockResponse(\n                success=True,\n                reservation_id=reservation.reservation_id,\n                expires_at=reservation.expires_at.isoformat()\n            )\n\n        except InsufficientStockError as e:\n            context.set_code(grpc.StatusCode.FAILED_PRECONDITION)\n            context.set_details(str(e))\n            return inventory_pb2.ReserveStockResponse(\n                success=False,\n                error_message=str(e)\n            )\n'})}),"\n",(0,a.jsx)(n.h4,{id:"2-flujo-completo-de-orden",children:"2. Flujo Completo de Orden"}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant C as Customer\n    participant OS as Order Service\n    participant IS as Inventory Service\n    participant RMQ as RabbitMQ\n    participant PS as Payment Service\n\n    C->>OS: POST /orders (Create order)\n    OS->>IS: gRPC: CheckAvailability\n    IS--\x3e>OS: Available: true\n\n    OS->>IS: gRPC: ReserveStock(ttl=15min)\n    IS->>IS: Create reservation\n    IS--\x3e>OS: Reservation ID + Expires At\n\n    OS->>C: Order created (pending payment)\n\n    Note over OS,IS: Customer has 15 min to pay\n\n    C->>PS: Complete payment\n    PS->>RMQ: Publish payment.success\n    RMQ->>OS: Consume event\n    OS->>IS: gRPC: ConfirmReservation\n    IS->>IS: Remove TTL, mark permanent\n\n    OS->>RMQ: Publish order.confirmed\n    RMQ->>IS: Consume event\n    IS->>IS: Update reservation status\n\n    Note over OS,IS: Later when shipping\n\n    OS->>RMQ: Publish order.shipped\n    RMQ->>IS: Consume event\n    IS->>IS: Deduct stock (reserved -> out)\n    IS->>RMQ: Publish movement.out"}),"\n",(0,a.jsx)(n.h4,{id:"3-manejo-de-cancelaciones",children:"3. Manejo de Cancelaciones"}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant C as Customer\n    participant OS as Order Service\n    participant IS as Inventory Service\n    participant RMQ as RabbitMQ\n\n    alt Order cancelled before payment\n        C->>OS: Cancel order\n        OS->>IS: gRPC: ReleaseReservation\n        IS->>IS: Release stock (reserved -> available)\n        IS--\x3e>OS: Released successfully\n    else Order cancelled after confirmation\n        C->>OS: Cancel order\n        OS->>RMQ: Publish order.cancelled\n        RMQ->>IS: Consume event\n        IS->>IS: Release stock\n        IS->>RMQ: Publish stock.released\n    else Automatic expiration (no payment)\n        Note over IS: TTL expires (15 min)\n        IS->>IS: Auto-release reservation\n        IS->>RMQ: Publish reservation.expired\n        RMQ->>OS: Notify order expired\n        OS->>OS: Mark order as expired\n    end"}),"\n",(0,a.jsx)(n.h3,{id:"event-based-integration",children:"Event-Based Integration"}),"\n",(0,a.jsx)(n.h4,{id:"order-events-consumed",children:"Order Events Consumed"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# Order event handlers\nORDER_EVENT_HANDLERS = {\n    'order.placed': handle_order_placed,\n    'order.confirmed': handle_order_confirmed,\n    'order.cancelled': handle_order_cancelled,\n    'order.shipped': handle_order_shipped,\n    'order.returned': handle_order_returned\n}\n\n# Configuration\nORDER_EVENT_CONFIG = {\n    'exchange': 'order_events',\n    'queue': 'inventory_order_consumer',\n    'routing_keys': [\n        'order.placed',\n        'order.confirmed',\n        'order.cancelled',\n        'order.shipped',\n        'order.returned'\n    ],\n    'prefetch_count': 20\n}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"inventory-events-published-to-order-service",children:"Inventory Events Published to Order Service"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# Events that Order Service consumes\nORDER_RELEVANT_EVENTS = [\n    'inventory.stock.updated',      # Update product availability\n    'inventory.stock.depleted',      # Mark product as out of stock\n    'inventory.stock.released',      # Reservation expired/released\n    'inventory.reservation.failed'   # Could not reserve stock\n]\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"integraci\xf3n-con-notification-service",children:"Integraci\xf3n con Notification Service"}),"\n",(0,a.jsx)(n.h3,{id:"low-stock-alerts",children:"Low Stock Alerts"}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant IS as Inventory Service\n    participant RMQ as RabbitMQ\n    participant NS as Notification Service\n    participant U as User\n\n    IS->>IS: Detect stock <= min_stock\n    IS->>RMQ: Publish stock.low_level\n    RMQ->>NS: Consume event\n    NS->>NS: Create notification\n    NS->>U: Send email alert\n    NS->>U: Send in-app notification"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Event Payload:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "event": "inventory.stock.low_level",\n  "data": {\n    "stock_id": "stock_456",\n    "variant_id": "var_789",\n    "warehouse_id": "wh_101",\n    "product_name": "Camiseta Roja M",\n    "sku": "CAM-ROJA-M",\n    "available_quantity": 15,\n    "min_stock": 20,\n    "reorder_point": 30,\n    "shortage": 5,\n    "alert_level": "warning",\n    "warehouse_name": "Bodega Principal"\n  },\n  "notification_config": {\n    "channels": ["email", "in_app"],\n    "priority": "high",\n    "recipients": ["inventory_manager", "purchasing_manager"]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"integraci\xf3n-con-purchasing-service",children:"Integraci\xf3n con Purchasing Service"}),"\n",(0,a.jsx)(n.h3,{id:"automatic-reorder-triggers",children:"Automatic Reorder Triggers"}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant IS as Inventory Service\n    participant RMQ as RabbitMQ\n    participant PURCH as Purchasing Service\n    participant SUP as Supplier\n\n    IS->>IS: Stock reaches reorder point\n    IS->>RMQ: Publish stock.reorder_needed\n    RMQ->>PURCH: Consume event\n    PURCH->>PURCH: Calculate order quantity\n    PURCH->>PURCH: Select preferred supplier\n    PURCH->>SUP: Create purchase order\n    SUP--\x3e>PURCH: PO confirmed\n\n    PURCH->>RMQ: Publish purchase_order.created\n    RMQ->>IS: Consume event\n    IS->>IS: Mark stock as "pending_purchase"\n    IS->>IS: Update in_transit_quantity'}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Reorder Event:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "event": "inventory.stock.reorder_needed",\n  "data": {\n    "variant_id": "var_789",\n    "warehouse_id": "wh_101",\n    "current_stock": 18,\n    "reorder_point": 30,\n    "max_stock": 200,\n    "suggested_order_quantity": 182,\n    "last_supplier_id": "sup_456",\n    "average_lead_time_days": 7\n  }\n}\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"health-checks--circuit-breaker",children:"Health Checks & Circuit Breaker"}),"\n",(0,a.jsx)(n.h3,{id:"service-health-monitoring",children:"Service Health Monitoring"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# inventory_service/health/integration_health.py\nfrom datetime import datetime, timedelta\nfrom typing import Dict, Any\n\nclass IntegrationHealthCheck:\n    """Monitor health of external service integrations."""\n\n    def __init__(self):\n        self.last_success = {}\n        self.failure_count = {}\n        self.circuit_breaker = {}\n\n    async def check_catalog_service(self) -> Dict[str, Any]:\n        """Check Catalog Service health via gRPC."""\n        try:\n            client = CatalogGrpcClient(\n                host=settings.CATALOG_GRPC_HOST,\n                port=settings.CATALOG_GRPC_PORT\n            )\n            # Test call\n            response = await client.health_check(timeout=3.0)\n            self.record_success(\'catalog\')\n\n            return {\n                \'service\': \'catalog\',\n                \'status\': \'healthy\',\n                \'response_time_ms\': response.time,\n                \'last_check\': datetime.utcnow().isoformat()\n            }\n\n        except Exception as e:\n            self.record_failure(\'catalog\')\n            return {\n                \'service\': \'catalog\',\n                \'status\': \'unhealthy\',\n                \'error\': str(e),\n                \'failure_count\': self.failure_count.get(\'catalog\', 0)\n            }\n\n    async def check_order_service(self) -> Dict[str, Any]:\n        """Check Order Service can reach us via gRPC."""\n        # Similar implementation\n        pass\n\n    def record_success(self, service: str) -> None:\n        """Record successful service call."""\n        self.last_success[service] = datetime.utcnow()\n        self.failure_count[service] = 0\n        if service in self.circuit_breaker:\n            self.circuit_breaker[service] = False\n\n    def record_failure(self, service: str) -> None:\n        """Record failed service call."""\n        self.failure_count[service] = self.failure_count.get(service, 0) + 1\n\n        # Open circuit breaker after 5 failures\n        if self.failure_count[service] >= 5:\n            self.circuit_breaker[service] = True\n            logger.error(f"Circuit breaker opened for {service}")\n\n    def is_circuit_open(self, service: str) -> bool:\n        """Check if circuit breaker is open."""\n        return self.circuit_breaker.get(service, False)\n'})}),"\n",(0,a.jsx)(n.h3,{id:"graceful-degradation",children:"Graceful Degradation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"async def get_variant_info(variant_id: str) -> Dict[str, Any]:\n    \"\"\"\n    Get variant info with fallback strategy.\n    1. Try cache\n    2. Try gRPC\n    3. Use minimal data if both fail\n    \"\"\"\n    # Try cache first\n    cached = await variant_cache.get_variant(variant_id)\n    if cached:\n        return cached\n\n    # Check circuit breaker\n    if health_check.is_circuit_open('catalog'):\n        logger.warning(\"Catalog circuit breaker open, using minimal data\")\n        return {\n            'variant_id': variant_id,\n            'exists': True,  # Assume exists\n            'is_active': True,  # Allow operation\n            'source': 'degraded'\n        }\n\n    # Try gRPC\n    try:\n        client = CatalogGrpcClient()\n        variant = await client.get_variant_details(variant_id)\n        await variant_cache.set_variant(variant_id, variant)\n        return variant\n\n    except Exception as e:\n        logger.error(f\"Failed to get variant info: {e}\")\n        # Return minimal data to allow operation\n        return {\n            'variant_id': variant_id,\n            'exists': True,\n            'is_active': True,\n            'source': 'fallback',\n            'error': str(e)\n        }\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"rate-limiting--retry-logic",children:"Rate Limiting & Retry Logic"}),"\n",(0,a.jsx)(n.h3,{id:"grpc-retry-configuration",children:"gRPC Retry Configuration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# gRPC client with retry\nfrom grpc import aio\nfrom grpc_retry import RetryPolicy\n\nretry_policy = RetryPolicy(\n    max_attempts=3,\n    initial_backoff=0.1,\n    max_backoff=1.0,\n    backoff_multiplier=2,\n    retryable_status_codes=[\n        grpc.StatusCode.UNAVAILABLE,\n        grpc.StatusCode.DEADLINE_EXCEEDED\n    ]\n)\n\nchannel = aio.insecure_channel(\n    f\"{host}:{port}\",\n    options=[\n        ('grpc.max_send_message_length', 10 * 1024 * 1024),\n        ('grpc.max_receive_message_length', 10 * 1024 * 1024),\n        ('grpc.service_config', json.dumps({\n            'methodConfig': [{\n                'name': [{}],\n                'retryPolicy': {\n                    'maxAttempts': 3,\n                    'initialBackoff': '0.1s',\n                    'maxBackoff': '1s',\n                    'backoffMultiplier': 2,\n                    'retryableStatusCodes': ['UNAVAILABLE', 'DEADLINE_EXCEEDED']\n                }\n            }]\n        }))\n    ]\n)\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"testing-integrations",children:"Testing Integrations"}),"\n",(0,a.jsx)(n.h3,{id:"integration-test-examples",children:"Integration Test Examples"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# tests/integration/test_catalog_integration.py\nimport pytest\nfrom unittest.mock import AsyncMock, patch\n\n@pytest.mark.integration\nasync def test_variant_created_integration():\n    \"\"\"Test full flow of variant creation.\"\"\"\n    # Mock Catalog Service publishes event\n    event = {\n        'event': 'catalog.variant.created',\n        'data': {\n            'variant_id': 'test_var_123',\n            'track_inventory': True,\n            'default_min_stock': 10\n        }\n    }\n\n    # Consume event\n    await inventory_event_consumer.handle_event(event)\n\n    # Verify stock initialized\n    stock_records = await stock_service.get_by_variant('test_var_123')\n    assert len(stock_records) > 0\n    assert all(s.min_stock == 10 for s in stock_records)\n\n@pytest.mark.integration\nasync def test_order_reserve_flow():\n    \"\"\"Test order reservation via gRPC.\"\"\"\n    # Setup\n    variant_id = 'test_var_456'\n    await create_test_stock(variant_id, warehouse_id='wh_101', quantity=100)\n\n    # Mock Order Service calls gRPC\n    client = InventoryGrpcClient()\n    response = await client.ReserveStock(\n        order_id='order_789',\n        items=[{'variant_id': variant_id, 'quantity': 10}],\n        ttl_minutes=15\n    )\n\n    assert response.success is True\n    assert response.reservation_id is not None\n\n    # Verify stock updated\n    stock = await stock_service.get_stock(variant_id, 'wh_101')\n    assert stock.reserved_quantity == 10\n    assert stock.available_quantity == 90\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"./errores-comunes",children:"Errores Comunes"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"./flujos-negocio",children:"Flujos de Negocio"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"./arquitectura",children:"Arquitectura"})}),"\n"]})]})}function v(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>o});var r=i(6540);const a={},t=r.createContext(a);function s(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);