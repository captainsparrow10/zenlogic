"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[9298],{2877:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"arquitectura/seguridad-rbac","title":"Seguridad y RBAC","description":"Introducci\xf3n","source":"@site/docs/01-arquitectura/05-seguridad-rbac.md","sourceDirName":"01-arquitectura","slug":"/arquitectura/seguridad-rbac","permalink":"/zenlogic/arquitectura/seguridad-rbac","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/01-arquitectura/05-seguridad-rbac.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docs","previous":{"title":"Multi-tenancy","permalink":"/zenlogic/arquitectura/multi-tenancy"},"next":{"title":"Patrones de Dise\xf1o","permalink":"/zenlogic/arquitectura/patrones-diseno"}}');var r=i(4848),a=i(8453);const o={sidebar_position:6},l="Seguridad y RBAC",d={},c=[{value:"Introducci\xf3n",id:"introducci\xf3n",level:2},{value:"Modelo de Seguridad General",id:"modelo-de-seguridad-general",level:2},{value:"Componentes del Modelo RBAC",id:"componentes-del-modelo-rbac",level:2},{value:"1. Usuarios (Users)",id:"1-usuarios-users",level:3},{value:"2. Organizaciones (Organizations)",id:"2-organizaciones-organizations",level:3},{value:"3. M\xf3dulos (Modules)",id:"3-m\xf3dulos-modules",level:3},{value:"4. Permisos (Permissions)",id:"4-permisos-permissions",level:3},{value:"5. Roles",id:"5-roles",level:3},{value:"6. Locales (Sucursales)",id:"6-locales-sucursales",level:3},{value:"Flujo de Autenticaci\xf3n y Autorizaci\xf3n",id:"flujo-de-autenticaci\xf3n-y-autorizaci\xf3n",level:2},{value:"1. Login",id:"1-login",level:3},{value:"2. Request Autorizado",id:"2-request-autorizado",level:3},{value:"Tokens JWT",id:"tokens-jwt",level:2},{value:"Access Token",id:"access-token",level:3},{value:"Refresh Token",id:"refresh-token",level:3},{value:"Validaci\xf3n de Permisos",id:"validaci\xf3n-de-permisos",level:2},{value:"En el Microservicio",id:"en-el-microservicio",level:3},{value:"Permisos Especiales",id:"permisos-especiales",level:3},{value:"local",id:"local",level:4},{value:"admin",id:"admin",level:4},{value:"Jerarqu\xeda de Roles (Ejemplo)",id:"jerarqu\xeda-de-roles-ejemplo",level:2},{value:"Rol: Super Admin",id:"rol-super-admin",level:3},{value:"Rol: Admin Organizacional",id:"rol-admin-organizacional",level:3},{value:"Rol: Gerente",id:"rol-gerente",level:3},{value:"Rol: Vendedor",id:"rol-vendedor",level:3},{value:"Rol: Bodeguero",id:"rol-bodeguero",level:3},{value:"Validaci\xf3n de M\xf3dulos Habilitados",id:"validaci\xf3n-de-m\xf3dulos-habilitados",level:2},{value:"Control de Acceso por Local",id:"control-de-acceso-por-local",level:2},{value:"Ejemplo Completo de Validaci\xf3n",id:"ejemplo-completo-de-validaci\xf3n",level:2},{value:"Seguridad de Contrase\xf1as",id:"seguridad-de-contrase\xf1as",level:2},{value:"Hashing",id:"hashing",level:3},{value:"Pol\xedticas de Contrase\xf1as",id:"pol\xedticas-de-contrase\xf1as",level:3},{value:"Bloqueo por Intentos Fallidos",id:"bloqueo-por-intentos-fallidos",level:3},{value:"Rate Limiting",id:"rate-limiting",level:2},{value:"Auditor\xeda de Seguridad",id:"auditor\xeda-de-seguridad",level:2},{value:"Headers de Seguridad",id:"headers-de-seguridad",level:2},{value:"CORS",id:"cors",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function t(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"seguridad-y-rbac",children:"Seguridad y RBAC"})}),"\n",(0,r.jsx)(n.h2,{id:"introducci\xf3n",children:"Introducci\xf3n"}),"\n",(0,r.jsxs)(n.p,{children:["El sistema implementa un modelo de ",(0,r.jsx)(n.strong,{children:"RBAC (Role-Based Access Control) multinivel"})," que permite control granular de acceso a recursos y operaciones."]}),"\n",(0,r.jsx)(n.h2,{id:"modelo-de-seguridad-general",children:"Modelo de Seguridad General"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph TB\n    User[Usuario]\n    Org[Organizaci\xf3n]\n    Local[Local/Sucursal]\n    Role[Rol]\n    Permission[Permiso]\n    Module[M\xf3dulo]\n\n    User --\x3e|pertenece a| Org\n    User --\x3e|tiene acceso a| Local\n    User --\x3e|tiene asignado| Role\n    Role --\x3e|tiene| Permission\n    Permission --\x3e|pertenece a| Module\n    Org --\x3e|tiene habilitados| Module"}),"\n",(0,r.jsx)(n.h2,{id:"componentes-del-modelo-rbac",children:"Componentes del Modelo RBAC"}),"\n",(0,r.jsx)(n.h3,{id:"1-usuarios-users",children:"1. Usuarios (Users)"}),"\n",(0,r.jsx)(n.p,{children:"Personas que usan el sistema."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "user_001",\n  "email": "admin@empresa.com",\n  "organization_id": "org_123",\n  "active": true,\n  "roles": ["role_admin"],\n  "locals": ["local_01", "local_02"]\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-organizaciones-organizations",children:"2. Organizaciones (Organizations)"}),"\n",(0,r.jsx)(n.p,{children:"Tenants del sistema."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "org_123",\n  "name": "Mi Empresa S.A.",\n  "plan": "pro",\n  "modules_enabled": ["catalog", "inventory", "orders"]\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3-m\xf3dulos-modules",children:"3. M\xf3dulos (Modules)"}),"\n",(0,r.jsx)(n.p,{children:"Funcionalidades del ERP."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "module_catalog",\n  "name": "Cat\xe1logo",\n  "description": "Gesti\xf3n de productos y variantes"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"M\xf3dulos disponibles"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"catalog"}),": Cat\xe1logo de productos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"inventory"}),": Gesti\xf3n de inventario"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"orders"}),": \xd3rdenes de venta"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pricing"}),": Gesti\xf3n de precios"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reports"}),": Reportes y analytics"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"4-permisos-permissions",children:"4. Permisos (Permissions)"}),"\n",(0,r.jsx)(n.p,{children:"Acciones espec\xedficas que se pueden realizar."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "perm_catalog_create",\n  "module_id": "module_catalog",\n  "name": "catalog:create",\n  "description": "Crear productos en el cat\xe1logo"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Formato de permisos"}),": ",(0,r.jsx)(n.code,{children:"{m\xf3dulo}:{acci\xf3n}"})]}),"\n",(0,r.jsx)(n.p,{children:"Ejemplos:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:read"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:create"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:edit"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:delete"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"inventory:read"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"inventory:adjust"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"orders:create"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"orders:cancel"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"5-roles",children:"5. Roles"}),"\n",(0,r.jsx)(n.p,{children:"Agrupaci\xf3n de permisos."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "role_admin",\n  "organization_id": "org_123",\n  "name": "Administrador",\n  "permissions": [\n    "catalog:read",\n    "catalog:create",\n    "catalog:edit",\n    "catalog:delete",\n    "inventory:read",\n    "inventory:adjust"\n  ]\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Caracter\xedsticas"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cada organizaci\xf3n define sus propios roles"}),"\n",(0,r.jsx)(n.li,{children:"Un rol puede tener m\xfaltiples permisos"}),"\n",(0,r.jsx)(n.li,{children:"Un usuario puede tener m\xfaltiples roles"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"6-locales-sucursales",children:"6. Locales (Sucursales)"}),"\n",(0,r.jsx)(n.p,{children:"Ubicaciones f\xedsicas o l\xf3gicas de operaci\xf3n."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "local_01",\n  "organization_id": "org_123",\n  "name": "Sucursal Centro",\n  "code": "SC-01"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Control de acceso por local"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Un usuario puede tener acceso a uno o m\xe1s locales"}),"\n",(0,r.jsx)(n.li,{children:"Operaciones se validan contra los locales permitidos"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"flujo-de-autenticaci\xf3n-y-autorizaci\xf3n",children:"Flujo de Autenticaci\xf3n y Autorizaci\xf3n"}),"\n",(0,r.jsx)(n.h3,{id:"1-login",children:"1. Login"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User\n    participant Auth\n    participant DB\n    participant TokenStore\n\n    User->>Auth: POST /auth/login<br/>{email, password}\n    Auth->>DB: Validar credenciales\n    DB--\x3e>Auth: Usuario v\xe1lido\n    Auth->>DB: Obtener roles, permisos, locales\n    Auth->>TokenStore: Guardar sesi\xf3n\n    Auth->>Auth: Generar Access Token + Refresh Token\n    Auth--\x3e>User: Tokens + informaci\xf3n de usuario"}),"\n",(0,r.jsx)(n.h3,{id:"2-request-autorizado",children:"2. Request Autorizado"}),"\n",(0,r.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Client\n    participant Catalog\n    participant Auth\n\n    Client->>Catalog: POST /products<br/>Authorization: Bearer <token><br/>X-Tenant-ID: org_123\n    Catalog->>Auth: VerifyToken(token)\n    Auth--\x3e>Catalog: {user_id, org_id, permissions, locals}\n\n    Catalog->>Catalog: Validar:<br/>1. Token v\xe1lido<br/>2. org_id coincide<br/>3. Tiene permiso "catalog:create"<br/>4. M\xf3dulo "catalog" habilitado\n\n    alt Autorizado\n        Catalog->>DB: Crear producto\n        Catalog--\x3e>Client: 201 Created\n    else No autorizado\n        Catalog--\x3e>Client: 403 Forbidden\n    end'}),"\n",(0,r.jsx)(n.h2,{id:"tokens-jwt",children:"Tokens JWT"}),"\n",(0,r.jsx)(n.h3,{id:"access-token",children:"Access Token"}),"\n",(0,r.jsx)(n.p,{children:"Token de corta duraci\xf3n para acceder a recursos."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Estructura"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "header": {\n    "alg": "RS256",\n    "typ": "JWT"\n  },\n  "payload": {\n    "user_id": "user_001",\n    "email": "admin@empresa.com",\n    "organization_id": "org_123",\n    "roles": ["role_admin"],\n    "permissions": ["catalog:read", "catalog:create", ...],\n    "locals": ["local_01", "local_02"],\n    "exp": 1705851600,  // 15 minutos\n    "iat": 1705850700\n  },\n  "signature": "..."\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"TTL"}),": 15 minutos"]}),"\n",(0,r.jsx)(n.h3,{id:"refresh-token",children:"Refresh Token"}),"\n",(0,r.jsx)(n.p,{children:"Token de larga duraci\xf3n para obtener nuevos access tokens."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"TTL"}),": 7 d\xedas"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Uso"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:'POST /auth/refresh\nContent-Type: application/json\n\n{\n  "refresh_token": "jwt-refresh..."\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "access_token": "new-jwt-access...",\n  "expires_in": 900\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"validaci\xf3n-de-permisos",children:"Validaci\xf3n de Permisos"}),"\n",(0,r.jsx)(n.h3,{id:"en-el-microservicio",children:"En el Microservicio"}),"\n",(0,r.jsx)(n.p,{children:"Cada microservicio valida permisos localmente:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from fastapi import Depends, HTTPException\n\nasync def require_permission(\n    permission: str,\n    user: User = Depends(get_current_user)\n):\n    """\n    Dependency para validar que el usuario tenga un permiso\n    """\n    if permission not in user.permissions:\n        raise HTTPException(\n            status_code=403,\n            detail={\n                "code": "INSUFFICIENT_PERMISSIONS",\n                "message": f"Se requiere permiso: {permission}",\n                "required": permission,\n                "user_permissions": user.permissions\n            }\n        )\n    return user\n\n# Uso en endpoint\n@router.post("/products")\nasync def create_product(\n    data: ProductCreate,\n    user: User = Depends(require_permission("catalog:create"))\n):\n    # Usuario tiene permiso catalog:create\n    product = await product_service.create(data, user)\n    return product\n'})}),"\n",(0,r.jsx)(n.h3,{id:"permisos-especiales",children:"Permisos Especiales"}),"\n",(0,r.jsxs)(n.h4,{id:"local",children:["local",":access_all"]}),"\n",(0,r.jsx)(n.p,{children:"Permite acceso a todos los locales de la organizaci\xf3n sin restricci\xf3n:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def can_access_local(user: User, local_id: str) -> bool:\n    """Verifica si usuario puede acceder a un local"""\n    # Si tiene permiso especial, puede acceder a todos\n    if "local:access_all" in user.permissions:\n        return True\n\n    # Si no, debe estar en su lista de locales\n    return local_id in user.locals\n'})}),"\n",(0,r.jsxs)(n.h4,{id:"admin",children:["admin",":global"]}),"\n",(0,r.jsx)(n.p,{children:"Super admin que puede gestionar todas las organizaciones:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def is_system_admin(user: User) -> bool:\n    return "admin:global" in user.permissions\n'})}),"\n",(0,r.jsx)(n.h2,{id:"jerarqu\xeda-de-roles-ejemplo",children:"Jerarqu\xeda de Roles (Ejemplo)"}),"\n",(0,r.jsx)(n.h3,{id:"rol-super-admin",children:"Rol: Super Admin"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Permisos"}),": Todos (",(0,r.jsx)(n.code,{children:"*"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Uso"}),": Administrador del zenLogic (proveedor SaaS)"]}),"\n",(0,r.jsx)(n.h3,{id:"rol-admin-organizacional",children:"Rol: Admin Organizacional"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Permisos"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:*"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"inventory:*"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"orders:*"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"users:read"}),", ",(0,r.jsx)(n.code,{children:"users:create"}),", ",(0,r.jsx)(n.code,{children:"users:edit"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"roles:read"}),", ",(0,r.jsx)(n.code,{children:"roles:create"}),", ",(0,r.jsx)(n.code,{children:"roles:edit"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Uso"}),": Administrador de una organizaci\xf3n"]}),"\n",(0,r.jsx)(n.h3,{id:"rol-gerente",children:"Rol: Gerente"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Permisos"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"catalog:read"}),", ",(0,r.jsx)(n.code,{children:"catalog:edit"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"inventory:read"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"orders:read"}),", ",(0,r.jsx)(n.code,{children:"orders:create"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"users:read"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Uso"}),": Gerente de sucursal"]}),"\n",(0,r.jsx)(n.h3,{id:"rol-vendedor",children:"Rol: Vendedor"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Permisos"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:read"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"orders:read"}),", ",(0,r.jsx)(n.code,{children:"orders:create"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Uso"}),": Personal de ventas"]}),"\n",(0,r.jsx)(n.h3,{id:"rol-bodeguero",children:"Rol: Bodeguero"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Permisos"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog:read"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"inventory:read"}),", ",(0,r.jsx)(n.code,{children:"inventory:adjust"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Uso"}),": Personal de bodega"]}),"\n",(0,r.jsx)(n.h2,{id:"validaci\xf3n-de-m\xf3dulos-habilitados",children:"Validaci\xf3n de M\xf3dulos Habilitados"}),"\n",(0,r.jsx)(n.p,{children:"Adem\xe1s de permisos, se valida que el m\xf3dulo est\xe9 habilitado para la organizaci\xf3n:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'async def validate_module_access(\n    user: User,\n    required_module: str\n):\n    """\n    Valida que la organizaci\xf3n tenga el m\xf3dulo habilitado\n    """\n    org = await db.get_organization(user.organization_id)\n\n    if required_module not in org.modules_enabled:\n        raise HTTPException(\n            status_code=403,\n            detail={\n                "code": "MODULE_NOT_ENABLED",\n                "message": f"M\xf3dulo {required_module} no habilitado",\n                "enabled_modules": org.modules_enabled\n            }\n        )\n'})}),"\n",(0,r.jsx)(n.h2,{id:"control-de-acceso-por-local",children:"Control de Acceso por Local"}),"\n",(0,r.jsx)(n.p,{children:"Validaci\xf3n de que usuario opere solo en locales permitidos:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'async def validate_local_access(\n    user: User,\n    local_id: str\n):\n    """\n    Valida que usuario tenga acceso al local\n    """\n    # Permiso especial permite acceso a todos\n    if "local:access_all" in user.permissions:\n        return True\n\n    # Validar que local est\xe9 en lista del usuario\n    if local_id not in user.locals:\n        raise HTTPException(\n            status_code=403,\n            detail={\n                "code": "LOCAL_ACCESS_DENIED",\n                "message": f"No tienes acceso al local {local_id}",\n                "allowed_locals": user.locals\n            }\n        )\n'})}),"\n",(0,r.jsx)(n.h2,{id:"ejemplo-completo-de-validaci\xf3n",children:"Ejemplo Completo de Validaci\xf3n"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'@router.post("/products/{product_id}/variants")\nasync def create_variant(\n    product_id: str,\n    data: VariantCreate,\n    user: User = Depends(get_current_user)\n):\n    """\n    Crear variante con validaciones completas\n    """\n    # 1. Validar que usuario est\xe9 activo\n    if not user.active:\n        raise HTTPException(403, "Usuario inactivo")\n\n    # 2. Validar que organizaci\xf3n est\xe9 activa\n    org = await db.get_organization(user.organization_id)\n    if org.status != "active":\n        raise HTTPException(403, "Organizaci\xf3n suspendida")\n\n    # 3. Validar m\xf3dulo habilitado\n    if "catalog" not in org.modules_enabled:\n        raise HTTPException(403, "M\xf3dulo catalog no habilitado")\n\n    # 4. Validar permiso\n    if "catalog:create" not in user.permissions:\n        raise HTTPException(403, "Permiso catalog:create requerido")\n\n    # 5. Validar acceso al local (warehouseId)\n    if not await can_access_local(user, data.warehouseId):\n        raise HTTPException(403, f"Sin acceso al local {data.warehouseId}")\n\n    # 6. Validar que producto pertenece a la organizaci\xf3n\n    product = await db.get_product(product_id)\n    if product.organization_id != user.organization_id:\n        raise HTTPException(404, "Producto no encontrado")\n\n    # Todo OK, crear variante\n    variant = await variant_service.create(product_id, data, user)\n    return variant\n'})}),"\n",(0,r.jsx)(n.h2,{id:"seguridad-de-contrase\xf1as",children:"Seguridad de Contrase\xf1as"}),"\n",(0,r.jsx)(n.h3,{id:"hashing",children:"Hashing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from passlib.context import CryptContext\n\npwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")\n\n# Al crear usuario\nhashed = pwd_context.hash("password123")\n\n# Al validar login\nis_valid = pwd_context.verify("password123", hashed)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"pol\xedticas-de-contrase\xf1as",children:"Pol\xedticas de Contrase\xf1as"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def validate_password_strength(password: str):\n    """\n    Valida fortaleza de contrase\xf1a\n    """\n    if len(password) < 8:\n        raise ValueError("M\xednimo 8 caracteres")\n\n    if not any(c.isupper() for c in password):\n        raise ValueError("Debe tener al menos una may\xfascula")\n\n    if not any(c.isdigit() for c in password):\n        raise ValueError("Debe tener al menos un n\xfamero")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"bloqueo-por-intentos-fallidos",children:"Bloqueo por Intentos Fallidos"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'async def handle_failed_login(email: str):\n    """\n    Incrementa contador de intentos fallidos\n    Bloquea usuario despu\xe9s de 5 intentos\n    """\n    key = f"failed_login:{email}"\n    attempts = await redis.incr(key)\n    await redis.expire(key, 900)  # 15 minutos\n\n    if attempts >= 5:\n        await db.update_user(email, locked=True)\n        raise HTTPException(423, "Usuario bloqueado por seguridad")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"rate-limiting",children:"Rate Limiting"}),"\n",(0,r.jsx)(n.p,{children:"L\xedmites de requests por endpoint:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from slowapi import Limiter\n\nlimiter = Limiter(key_func=get_remote_address)\n\n@router.post("/auth/login")\n@limiter.limit("5/minute")\nasync def login(request: Request, credentials: LoginRequest):\n    # M\xe1ximo 5 intentos de login por minuto por IP\n    pass\n'})}),"\n",(0,r.jsx)(n.h2,{id:"auditor\xeda-de-seguridad",children:"Auditor\xeda de Seguridad"}),"\n",(0,r.jsx)(n.p,{children:"Todos los eventos de seguridad se registran:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'await audit_log.security(\n    event_type="LOGIN_SUCCESS",\n    user_id=user.id,\n    organization_id=user.organization_id,\n    ip=request.client.host,\n    user_agent=request.headers.get("user-agent")\n)\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Eventos auditados"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Login exitoso/fallido"}),"\n",(0,r.jsx)(n.li,{children:"Cambio de contrase\xf1a"}),"\n",(0,r.jsx)(n.li,{children:"Asignaci\xf3n/revocaci\xf3n de roles"}),"\n",(0,r.jsx)(n.li,{children:"Cambio de permisos"}),"\n",(0,r.jsx)(n.li,{children:"Intentos de acceso denegado"}),"\n",(0,r.jsx)(n.li,{children:"Usuario bloqueado/desbloqueado"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"headers-de-seguridad",children:"Headers de Seguridad"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'@app.middleware("http")\nasync def add_security_headers(request: Request, call_next):\n    response = await call_next(request)\n\n    response.headers["X-Content-Type-Options"] = "nosniff"\n    response.headers["X-Frame-Options"] = "DENY"\n    response.headers["X-XSS-Protection"] = "1; mode=block"\n    response.headers["Strict-Transport-Security"] = "max-age=31536000"\n\n    return response\n'})}),"\n",(0,r.jsx)(n.h2,{id:"cors",children:"CORS"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from fastapi.middleware.cors import CORSMiddleware\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=["https://app.example.com"],  # Solo or\xedgenes permitidos\n    allow_credentials=True,\n    allow_methods=["GET", "POST", "PUT", "DELETE"],\n    allow_headers=["Authorization", "Content-Type", "X-Tenant-ID"],\n)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/auth-service/overview",children:"Auth Service - Overview"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/auth-service/api-users",children:"Auth Service - API Users"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/auth-service/api-roles",children:"Auth Service - API Roles"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/auth-service/api-permissions",children:"Auth Service - API Permissions"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/catalog-service/validacion-locales",children:"Catalog Service - Validaci\xf3n de Locales"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(t,{...e})}):t(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>l});var s=i(6540);const r={},a=s.createContext(r);function o(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);