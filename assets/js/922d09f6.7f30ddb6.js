"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[7821],{8453:(e,n,a)=>{a.d(n,{R:()=>s,x:()=>r});var i=a(6540);const t={},d=i.createContext(t);function s(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),i.createElement(d.Provider,{value:n},e.children)}},8611:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"microservicios/audit-service/modelo-datos","title":"Modelo de Datos","description":"Estructura de base de datos para almacenar logs de auditor\xeda.","source":"@site/docs/02-microservicios/audit-service/03-modelo-datos.md","sourceDirName":"02-microservicios/audit-service","slug":"/microservicios/audit-service/modelo-datos","permalink":"/zenlogic/microservicios/audit-service/modelo-datos","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/audit-service/03-modelo-datos.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docs","previous":{"title":"Arquitectura","permalink":"/zenlogic/microservicios/audit-service/arquitectura"},"next":{"title":"Event Consumer","permalink":"/zenlogic/microservicios/audit-service/event-consumer"}}');var t=a(4848),d=a(8453);const s={sidebar_position:4},r="Modelo de Datos",o={},l=[{value:"Diagrama ER",id:"diagrama-er",level:2},{value:"Tabla Principal",id:"tabla-principal",level:2},{value:"<code>audit_logs</code>",id:"audit_logs",level:3},{value:"Particiones por Mes",id:"particiones-por-mes",level:2},{value:"\xcdndices",id:"\xedndices",level:2},{value:"\xcdndices de B\xfasqueda",id:"\xedndices-de-b\xfasqueda",level:3},{value:"Modelo SQLAlchemy",id:"modelo-sqlalchemy",level:2},{value:"Schemas Pydantic",id:"schemas-pydantic",level:2},{value:"Queries Comunes",id:"queries-comunes",level:2},{value:"Buscar por Organizaci\xf3n",id:"buscar-por-organizaci\xf3n",level:3},{value:"Buscar por Usuario",id:"buscar-por-usuario",level:3},{value:"Buscar en Payload JSON",id:"buscar-en-payload-json",level:3},{value:"Estad\xedsticas",id:"estad\xedsticas",level:3},{value:"Triggers de Inmutabilidad",id:"triggers-de-inmutabilidad",level:2},{value:"Estimaciones de Tama\xf1o",id:"estimaciones-de-tama\xf1o",level:2},{value:"Por Evento",id:"por-evento",level:3},{value:"Por Volumen",id:"por-volumen",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"modelo-de-datos",children:"Modelo de Datos"})}),"\n",(0,t.jsx)(n.p,{children:"Estructura de base de datos para almacenar logs de auditor\xeda."}),"\n",(0,t.jsx)(n.h2,{id:"diagrama-er",children:"Diagrama ER"}),"\n",(0,t.jsx)(n.mermaid,{value:"erDiagram\n    AUDIT_LOGS {\n        uuid id PK\n        string event_id UK\n        string event_type\n        timestamp created_at\n        string service\n        string version\n        jsonb payload\n        jsonb metadata\n        uuid organization_id\n        uuid user_id\n        string ip_address\n        string user_agent\n    }"}),"\n",(0,t.jsx)(n.h2,{id:"tabla-principal",children:"Tabla Principal"}),"\n",(0,t.jsx)(n.h3,{id:"audit_logs",children:(0,t.jsx)(n.code,{children:"audit_logs"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE audit_logs (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    event_id VARCHAR(100) UNIQUE NOT NULL,\n    event_type VARCHAR(100) NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    service VARCHAR(50) NOT NULL,\n    version VARCHAR(20) DEFAULT '1.0',\n\n    -- Payload del evento (JSON completo)\n    payload JSONB NOT NULL,\n\n    -- Metadata adicional\n    metadata JSONB,\n\n    -- Datos de contexto\n    organization_id UUID,\n    user_id UUID,\n    ip_address INET,\n    user_agent TEXT,\n\n    -- Particionamiento\n    CONSTRAINT audit_logs_created_at_check CHECK (created_at >= DATE '2025-01-01')\n) PARTITION BY RANGE (created_at);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"particiones-por-mes",children:"Particiones por Mes"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Partici\xf3n Noviembre 2025\nCREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs\n    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');\n\n-- Partici\xf3n Diciembre 2025\nCREATE TABLE audit_logs_2025_12 PARTITION OF audit_logs\n    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');\n\n-- Script autom\xe1tico para crear particiones futuras\nCREATE OR REPLACE FUNCTION create_audit_partition(year INT, month INT)\nRETURNS VOID AS $$\nDECLARE\n    partition_name TEXT;\n    start_date DATE;\n    end_date DATE;\nBEGIN\n    partition_name := 'audit_logs_' || year || '_' || LPAD(month::TEXT, 2, '0');\n    start_date := make_date(year, month, 1);\n    end_date := start_date + INTERVAL '1 month';\n\n    EXECUTE format(\n        'CREATE TABLE IF NOT EXISTS %I PARTITION OF audit_logs FOR VALUES FROM (%L) TO (%L)',\n        partition_name, start_date, end_date\n    );\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\xedndices",children:"\xcdndices"}),"\n",(0,t.jsx)(n.h3,{id:"\xedndices-de-b\xfasqueda",children:"\xcdndices de B\xfasqueda"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Por organizaci\xf3n y fecha (query m\xe1s com\xfan)\nCREATE INDEX idx_audit_org_time\n    ON audit_logs(organization_id, created_at DESC)\n    WHERE organization_id IS NOT NULL;\n\n-- Por usuario y fecha\nCREATE INDEX idx_audit_user_time\n    ON audit_logs(user_id, created_at DESC)\n    WHERE user_id IS NOT NULL;\n\n-- Por tipo de evento\nCREATE INDEX idx_audit_event_type\n    ON audit_logs(event_type, created_at DESC);\n\n-- Por servicio\nCREATE INDEX idx_audit_service\n    ON audit_logs(service, created_at DESC);\n\n-- \xcdndice \xfanico para idempotencia\nCREATE UNIQUE INDEX idx_audit_event_id\n    ON audit_logs(event_id);\n\n-- GIN para b\xfasqueda en payload JSON\nCREATE INDEX idx_audit_payload_gin\n    ON audit_logs USING GIN (payload jsonb_path_ops);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"modelo-sqlalchemy",children:"Modelo SQLAlchemy"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"from sqlalchemy import Column, String, DateTime, Text, Index\nfrom sqlalchemy.dialects.postgresql import UUID, INET, JSONB\nfrom datetime import datetime\nimport uuid\n\nclass AuditLog(Base):\n    \"\"\"Modelo de log de auditor\xeda.\"\"\"\n\n    __tablename__ = \"audit_logs\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    event_id = Column(String(100), unique=True, nullable=False, index=True)\n    event_type = Column(String(100), nullable=False, index=True)\n    created_at = Column(DateTime(timezone=True), nullable=False, default=datetime.utcnow, index=True)\n    service = Column(String(50), nullable=False, index=True)\n    version = Column(String(20), default=\"1.0\")\n\n    # JSON fields\n    payload = Column(JSONB, nullable=False)\n    metadata = Column(JSONB)\n\n    # Contexto\n    organization_id = Column(UUID(as_uuid=True), index=True)\n    user_id = Column(UUID(as_uuid=True), index=True)\n    ip_address = Column(INET)\n    user_agent = Column(Text)\n\n    # \xcdndices compuestos\n    __table_args__ = (\n        Index('idx_audit_org_time', 'organization_id', 'created_at'),\n        Index('idx_audit_user_time', 'user_id', 'created_at'),\n        Index('idx_audit_payload_gin', 'payload', postgresql_using='gin'),\n    )\n\n    def __repr__(self):\n        return f\"<AuditLog {self.event_type} at {self.created_at}>\"\n"})}),"\n",(0,t.jsx)(n.h2,{id:"schemas-pydantic",children:"Schemas Pydantic"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from pydantic import BaseModel, Field\nfrom datetime import datetime\nfrom typing import Optional, Dict, Any\nfrom uuid import UUID\n\nclass AuditLogCreate(BaseModel):\n    """Schema para crear log de auditor\xeda."""\n\n    event_id: str = Field(..., max_length=100)\n    event_type: str = Field(..., max_length=100)\n    service: str = Field(..., max_length=50)\n    version: str = Field(default="1.0", max_length=20)\n    payload: Dict[str, Any]\n    metadata: Optional[Dict[str, Any]] = None\n    organization_id: Optional[UUID] = None\n    user_id: Optional[UUID] = None\n    ip_address: Optional[str] = None\n    user_agent: Optional[str] = None\n\nclass AuditLogResponse(BaseModel):\n    """Schema de respuesta de log de auditor\xeda."""\n\n    id: UUID\n    event_id: str\n    event_type: str\n    created_at: datetime\n    service: str\n    version: str\n    payload: Dict[str, Any]\n    metadata: Optional[Dict[str, Any]]\n    organization_id: Optional[UUID]\n    user_id: Optional[UUID]\n    ip_address: Optional[str]\n    user_agent: Optional[str]\n\n    class Config:\n        from_attributes = True\n'})}),"\n",(0,t.jsx)(n.h2,{id:"queries-comunes",children:"Queries Comunes"}),"\n",(0,t.jsx)(n.h3,{id:"buscar-por-organizaci\xf3n",children:"Buscar por Organizaci\xf3n"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM audit_logs\nWHERE organization_id = 'org-uuid'\n  AND created_at >= '2025-11-01'\n  AND created_at < '2025-12-01'\nORDER BY created_at DESC\nLIMIT 100;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"buscar-por-usuario",children:"Buscar por Usuario"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM audit_logs\nWHERE user_id = 'user-uuid'\n  AND event_type LIKE 'auth.%'\nORDER BY created_at DESC;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"buscar-en-payload-json",children:"Buscar en Payload JSON"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Buscar cambios de precio\nSELECT *\nFROM audit_logs\nWHERE event_type = 'catalog.product.updated'\n  AND payload @> '{\"changes\": {\"base_price\": {}}}'::jsonb;\n\n-- Buscar producto espec\xedfico\nSELECT *\nFROM audit_logs\nWHERE payload->>'product_id' = 'product-uuid';\n"})}),"\n",(0,t.jsx)(n.h3,{id:"estad\xedsticas",children:"Estad\xedsticas"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Eventos por tipo en \xfaltimas 24h\nSELECT\n    event_type,\n    COUNT(*) as count\nFROM audit_logs\nWHERE created_at >= NOW() - INTERVAL '24 hours'\nGROUP BY event_type\nORDER BY count DESC;\n\n-- Actividad por usuario en el mes\nSELECT\n    user_id,\n    COUNT(*) as events_count,\n    COUNT(DISTINCT event_type) as event_types\nFROM audit_logs\nWHERE created_at >= DATE_TRUNC('month', NOW())\n  AND user_id IS NOT NULL\nGROUP BY user_id\nORDER BY events_count DESC\nLIMIT 20;\n"})}),"\n",(0,t.jsx)(n.h2,{id:"triggers-de-inmutabilidad",children:"Triggers de Inmutabilidad"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Prevenir UPDATE\nCREATE OR REPLACE FUNCTION prevent_audit_update()\nRETURNS TRIGGER AS $$\nBEGIN\n    RAISE EXCEPTION 'Audit logs are immutable - UPDATE not allowed';\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER prevent_update_audit_logs\nBEFORE UPDATE ON audit_logs\nFOR EACH ROW EXECUTE FUNCTION prevent_audit_update();\n\n-- Prevenir DELETE\nCREATE OR REPLACE FUNCTION prevent_audit_delete()\nRETURNS TRIGGER AS $$\nBEGIN\n    RAISE EXCEPTION 'Audit logs are immutable - DELETE not allowed';\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER prevent_delete_audit_logs\nBEFORE DELETE ON audit_logs\nFOR EACH ROW EXECUTE FUNCTION prevent_audit_delete();\n"})}),"\n",(0,t.jsx)(n.h2,{id:"estimaciones-de-tama\xf1o",children:"Estimaciones de Tama\xf1o"}),"\n",(0,t.jsx)(n.h3,{id:"por-evento",children:"Por Evento"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Tama\xf1o promedio por evento: 1-2 KB\n- Metadata: 200 bytes\n- Payload: 500-1500 bytes\n- \xcdndices: 300 bytes\n"})}),"\n",(0,t.jsx)(n.h3,{id:"por-volumen",children:"Por Volumen"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"100 eventos/minuto = 6,000/hora = 144,000/d\xeda\n\nTama\xf1o diario: 144,000 * 1.5 KB \u2248 216 MB/d\xeda\nTama\xf1o mensual: 216 MB * 30 \u2248 6.5 GB/mes\nTama\xf1o anual: 6.5 GB * 12 \u2248 78 GB/a\xf1o\n"})}),"\n",(0,t.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/microservicios/audit-service/event-consumer",children:"Event Consumer"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/microservicios/audit-service/api-logs",children:"API Logs"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/microservicios/audit-service/retention-policy",children:"Retention Policy"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);