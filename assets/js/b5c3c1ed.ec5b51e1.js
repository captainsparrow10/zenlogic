"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[5001],{5899:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>d,default:()=>E,frontMatter:()=>s,metadata:()=>r,toc:()=>_});const r=JSON.parse('{"id":"microservicios/order-service/modelo-datos","title":"Modelo de Datos","description":"Esquema completo de la base de datos del Order Service con entidades, relaciones e \xedndices.","source":"@site/docs/02-microservicios/order-service/03-modelo-datos.md","sourceDirName":"02-microservicios/order-service","slug":"/microservicios/order-service/modelo-datos","permalink":"/zenlogic/microservicios/order-service/modelo-datos","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/order-service/03-modelo-datos.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docs","previous":{"title":"Order Service - Overview","permalink":"/zenlogic/microservicios/order-service/overview"},"next":{"title":"API: Orders","permalink":"/zenlogic/microservicios/order-service/api-orders"}}');var a=t(4848),i=t(8453);const s={sidebar_position:3},d="Modelo de Datos",o={},_=[{value:"Diagrama ER",id:"diagrama-er",level:2},{value:"Entidades Principales",id:"entidades-principales",level:2},{value:"1. Order (orders)",id:"1-order-orders",level:3},{value:"2. OrderItem (order_items)",id:"2-orderitem-order_items",level:3},{value:"3. Cart (carts)",id:"3-cart-carts",level:3},{value:"4. CartItem (cart_items)",id:"4-cartitem-cart_items",level:3},{value:"5. Payment (payments)",id:"5-payment-payments",level:3},{value:"6. Shipment (shipments)",id:"6-shipment-shipments",level:3},{value:"7. Return (returns)",id:"7-return-returns",level:3},{value:"8. Invoice (invoices)",id:"8-invoice-invoices",level:3},{value:"9. ReturnItem (return_items)",id:"9-returnitem-return_items",level:3},{value:"10. ShipmentTrackingEvent (shipment_tracking_events)",id:"10-shipmenttrackingevent-shipment_tracking_events",level:3},{value:"11. FulfillmentTask (fulfillment_tasks)",id:"11-fulfillmenttask-fulfillment_tasks",level:3},{value:"12. OrderStatusHistory (order_status_history)",id:"12-orderstatushistory-order_status_history",level:3},{value:"13. PaymentTransaction (payment_transactions)",id:"13-paymenttransaction-payment_transactions",level:3},{value:"Vistas",id:"vistas",level:2},{value:"v_order_summary",id:"v_order_summary",level:3},{value:"Row-Level Security",id:"row-level-security",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function c(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"modelo-de-datos",children:"Modelo de Datos"})}),"\n",(0,a.jsx)(e.p,{children:"Esquema completo de la base de datos del Order Service con entidades, relaciones e \xedndices."}),"\n",(0,a.jsx)(e.h2,{id:"diagrama-er",children:"Diagrama ER"}),"\n",(0,a.jsx)(e.mermaid,{value:"erDiagram\n    ORDER ||--o{ ORDER_ITEM : contains\n    ORDER ||--o{ PAYMENT : has\n    ORDER ||--o{ SHIPMENT : has\n    ORDER ||--o{ RETURN : has\n    ORDER ||--|| INVOICE : generates\n    ORDER ||--o{ FULFILLMENT_TASK : requires\n    ORDER ||--o{ ORDER_STATUS_HISTORY : tracks\n\n    CART ||--o{ CART_ITEM : contains\n\n    SHIPMENT ||--o{ SHIPMENT_TRACKING_EVENT : has\n    RETURN ||--o{ RETURN_ITEM : contains\n\n    PAYMENT ||--o{ PAYMENT_TRANSACTION : records\n    ORDER_ITEM ||--o{ RETURN_ITEM : can_be_returned\n    ORDER ||--o{ FULFILLMENT_TASK : requires\n\n    ORDER {\n        uuid order_id PK\n        uuid organization_id FK\n        uuid customer_id FK\n        uuid local_id FK\n        string order_number UK\n        enum status\n        enum order_type\n        decimal subtotal\n        decimal shipping_cost\n        decimal tax_amount\n        decimal discount_amount\n        decimal total_amount\n        string currency\n        jsonb shipping_address\n        jsonb billing_address\n        uuid cart_id FK\n        timestamp placed_at\n        timestamp confirmed_at\n        timestamp cancelled_at\n        timestamp created_at\n    }\n\n    ORDER_ITEM {\n        uuid order_item_id PK\n        uuid order_id FK\n        uuid variant_id FK\n        string sku\n        string product_name\n        int quantity\n        decimal unit_price\n        decimal subtotal\n        decimal tax_amount\n        decimal discount_amount\n        decimal total\n        jsonb variant_snapshot\n    }\n\n    CART {\n        uuid cart_id PK\n        uuid organization_id FK\n        uuid customer_id FK\n        uuid session_id\n        enum status\n        decimal subtotal\n        decimal total\n        timestamp expires_at\n        timestamp converted_at\n    }\n\n    PAYMENT {\n        uuid payment_id PK\n        uuid order_id FK\n        enum status\n        enum payment_method\n        decimal amount\n        string currency\n        string gateway_payment_id\n        string gateway_customer_id\n        jsonb metadata\n        timestamp paid_at\n    }\n\n    SHIPMENT {\n        uuid shipment_id PK\n        uuid order_id FK\n        uuid warehouse_id FK\n        enum status\n        string carrier\n        string tracking_number\n        jsonb shipping_address\n        date estimated_delivery\n        timestamp shipped_at\n        timestamp delivered_at\n    }\n\n    RETURN {\n        uuid return_id PK\n        uuid order_id FK\n        string rma_number UK\n        enum status\n        enum reason\n        decimal refund_amount\n        timestamp requested_at\n        timestamp approved_at\n    }\n\n    INVOICE {\n        uuid invoice_id PK\n        uuid order_id FK\n        string invoice_number UK\n        enum invoice_type\n        decimal total_amount\n        string currency\n        string pdf_url\n        string xml_url\n        timestamp issued_at\n    }"}),"\n",(0,a.jsx)(e.h2,{id:"entidades-principales",children:"Entidades Principales"}),"\n",(0,a.jsx)(e.h3,{id:"1-order-orders",children:"1. Order (orders)"}),"\n",(0,a.jsx)(e.p,{children:"Tabla principal de \xf3rdenes de venta."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE orders (\n    order_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    customer_id UUID NOT NULL,\n    local_id UUID NOT NULL,\n\n    -- Identificadores\n    order_number VARCHAR(50) NOT NULL UNIQUE,\n    cart_id UUID,\n    reservation_id UUID,  -- FK a Inventory Service (reservation)\n\n    -- Estado\n    status VARCHAR(30) NOT NULL DEFAULT 'pending',\n    order_type VARCHAR(20) NOT NULL DEFAULT 'online',\n    version INTEGER NOT NULL DEFAULT 1,  -- Para optimistic locking\n\n    -- Montos\n    subtotal DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    shipping_cost DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    tax_amount DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    discount_amount DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    total_amount DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    currency VARCHAR(3) NOT NULL DEFAULT 'USD',\n\n    -- Direcciones (JSONB)\n    shipping_address JSONB NOT NULL,\n    billing_address JSONB NOT NULL,\n\n    -- M\xe9todo de env\xedo\n    shipping_method VARCHAR(50),\n    shipping_carrier VARCHAR(50),\n\n    -- Metadata\n    notes TEXT,\n    internal_notes TEXT,\n    customer_notes TEXT,\n    tags VARCHAR(255)[],\n    metadata JSONB,\n\n    -- Timestamps\n    placed_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    confirmed_at TIMESTAMP,\n    cancelled_at TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP,\n\n    -- Constraints\n    CONSTRAINT check_total_amount CHECK (total_amount >= 0),\n    CONSTRAINT check_subtotal CHECK (subtotal >= 0),\n    CONSTRAINT check_valid_status CHECK (\n        status IN (\n            'cart', 'pending', 'payment_pending', 'payment_failed',\n            'confirmed', 'processing', 'ready_to_ship', 'shipped',\n            'delivered', 'cancelled', 'return_requested', 'returned', 'refunded'\n        )\n    ),\n    CONSTRAINT check_valid_order_type CHECK (\n        order_type IN ('online', 'pos', 'phone', 'b2b', 'subscription')\n    )\n);\n\n-- \xcdndices\nCREATE INDEX idx_orders_organization ON orders(organization_id);\nCREATE INDEX idx_orders_customer ON orders(customer_id);\nCREATE INDEX idx_orders_status ON orders(status);\nCREATE INDEX idx_orders_placed_at ON orders(placed_at DESC);\nCREATE INDEX idx_orders_order_number ON orders(order_number);\nCREATE INDEX idx_orders_local ON orders(local_id);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"2-orderitem-order_items",children:"2. OrderItem (order_items)"}),"\n",(0,a.jsx)(e.p,{children:"L\xedneas de productos en la orden."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE order_items (\n    order_item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    order_id UUID NOT NULL REFERENCES orders(order_id) ON DELETE CASCADE,\n\n    -- Producto\n    variant_id UUID NOT NULL,\n    sku VARCHAR(100) NOT NULL,\n    product_name VARCHAR(255) NOT NULL,\n\n    -- Cantidades y precios\n    quantity INTEGER NOT NULL CHECK (quantity > 0),\n    unit_price DECIMAL(12, 2) NOT NULL CHECK (unit_price >= 0),\n    subtotal DECIMAL(12, 2) NOT NULL,\n    tax_amount DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    discount_amount DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    total DECIMAL(12, 2) NOT NULL,\n\n    -- Snapshot del producto al momento de la orden\n    variant_snapshot JSONB,\n\n    -- Fulfillment\n    warehouse_id UUID,\n    fulfillment_status VARCHAR(30) DEFAULT 'pending',\n\n    -- Metadata\n    notes TEXT,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_item_total CHECK (total >= 0)\n);\n\nCREATE INDEX idx_order_items_order ON order_items(order_id);\nCREATE INDEX idx_order_items_variant ON order_items(variant_id);\nCREATE INDEX idx_order_items_sku ON order_items(sku);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"3-cart-carts",children:"3. Cart (carts)"}),"\n",(0,a.jsx)(e.p,{children:"Carritos de compra."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE carts (\n    cart_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    customer_id UUID,\n    session_id VARCHAR(255),\n\n    -- Estado\n    status VARCHAR(20) NOT NULL DEFAULT 'active',\n\n    -- Totales\n    subtotal DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    total DECIMAL(12, 2) NOT NULL DEFAULT 0.00,\n    items_count INTEGER NOT NULL DEFAULT 0,\n\n    -- Metadata\n    metadata JSONB,\n\n    -- Expiraci\xf3n\n    expires_at TIMESTAMP NOT NULL,\n    converted_to_order_id UUID REFERENCES orders(order_id),\n    converted_at TIMESTAMP,\n\n    -- Timestamps\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP,\n    last_activity_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_cart_status CHECK (\n        status IN ('active', 'abandoned', 'converted', 'expired')\n    )\n);\n\nCREATE INDEX idx_carts_customer ON carts(customer_id);\nCREATE INDEX idx_carts_session ON carts(session_id);\nCREATE INDEX idx_carts_status ON carts(status);\nCREATE INDEX idx_carts_expires_at ON carts(expires_at);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"4-cartitem-cart_items",children:"4. CartItem (cart_items)"}),"\n",(0,a.jsx)(e.p,{children:"Productos en el carrito."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE cart_items (\n    cart_item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    cart_id UUID NOT NULL REFERENCES carts(cart_id) ON DELETE CASCADE,\n\n    variant_id UUID NOT NULL,\n    sku VARCHAR(100) NOT NULL,\n    product_name VARCHAR(255) NOT NULL,\n\n    quantity INTEGER NOT NULL CHECK (quantity > 0),\n    unit_price DECIMAL(12, 2) NOT NULL,\n    subtotal DECIMAL(12, 2) NOT NULL,\n\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP\n);\n\nCREATE INDEX idx_cart_items_cart ON cart_items(cart_id);\nCREATE INDEX idx_cart_items_variant ON cart_items(variant_id);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"5-payment-payments",children:"5. Payment (payments)"}),"\n",(0,a.jsx)(e.p,{children:"Transacciones de pago."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE payments (\n    payment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    order_id UUID NOT NULL REFERENCES orders(order_id),\n\n    -- Estado\n    status VARCHAR(30) NOT NULL DEFAULT 'pending',\n\n    -- M\xe9todo de pago\n    payment_method VARCHAR(50) NOT NULL,\n    payment_gateway VARCHAR(50),\n\n    -- Montos\n    amount DECIMAL(12, 2) NOT NULL CHECK (amount > 0),\n    currency VARCHAR(3) NOT NULL DEFAULT 'USD',\n\n    -- IDs del gateway\n    gateway_payment_id VARCHAR(255),\n    gateway_customer_id VARCHAR(255),\n    gateway_charge_id VARCHAR(255),\n\n    -- Detalles\n    card_brand VARCHAR(50),\n    card_last4 VARCHAR(4),\n\n    -- Metadata del gateway\n    metadata JSONB,\n    error_code VARCHAR(100),\n    error_message TEXT,\n\n    -- Timestamps\n    attempted_at TIMESTAMP,\n    paid_at TIMESTAMP,\n    failed_at TIMESTAMP,\n    refunded_at TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_payment_status CHECK (\n        status IN ('pending', 'processing', 'succeeded', 'failed', 'refunded', 'partially_refunded')\n    ),\n    CONSTRAINT check_payment_method CHECK (\n        payment_method IN ('stripe', 'paypal', 'mercadopago', 'cash', 'transfer', 'pos')\n    )\n);\n\nCREATE INDEX idx_payments_order ON payments(order_id);\nCREATE INDEX idx_payments_status ON payments(status);\nCREATE INDEX idx_payments_gateway_payment_id ON payments(gateway_payment_id);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"6-shipment-shipments",children:"6. Shipment (shipments)"}),"\n",(0,a.jsx)(e.p,{children:"Env\xedos y tracking."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE shipments (\n    shipment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    order_id UUID NOT NULL REFERENCES orders(order_id),\n    warehouse_id UUID NOT NULL,\n\n    -- Estado\n    status VARCHAR(30) NOT NULL DEFAULT 'pending',\n\n    -- Carrier\n    carrier VARCHAR(100),\n    carrier_service VARCHAR(100),\n    tracking_number VARCHAR(255),\n    tracking_url TEXT,\n\n    -- Direcci\xf3n\n    shipping_address JSONB NOT NULL,\n\n    -- Costos\n    shipping_cost DECIMAL(12, 2),\n    carrier_cost DECIMAL(12, 2),\n\n    -- Fechas\n    estimated_delivery_date DATE,\n    shipped_at TIMESTAMP,\n    delivered_at TIMESTAMP,\n    failed_at TIMESTAMP,\n\n    -- Metadata\n    label_url TEXT,\n    metadata JSONB,\n    notes TEXT,\n\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP,\n\n    CONSTRAINT check_shipment_status CHECK (\n        status IN ('pending', 'label_created', 'dispatched', 'in_transit', 'out_for_delivery', 'delivered', 'failed', 'returned')\n    )\n);\n\nCREATE INDEX idx_shipments_order ON shipments(order_id);\nCREATE INDEX idx_shipments_tracking_number ON shipments(tracking_number);\nCREATE INDEX idx_shipments_status ON shipments(status);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"7-return-returns",children:"7. Return (returns)"}),"\n",(0,a.jsx)(e.p,{children:"Devoluciones de productos."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE returns (\n    return_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    order_id UUID NOT NULL REFERENCES orders(order_id),\n\n    -- RMA\n    rma_number VARCHAR(50) NOT NULL UNIQUE,\n\n    -- Estado\n    status VARCHAR(30) NOT NULL DEFAULT 'requested',\n\n    -- Motivo\n    reason VARCHAR(50) NOT NULL,\n    reason_detail TEXT,\n\n    -- Reembolso\n    refund_amount DECIMAL(12, 2),\n    refund_method VARCHAR(50),\n    refund_status VARCHAR(30),\n\n    -- Aprobaci\xf3n\n    approved_by UUID,\n    approved_at TIMESTAMP,\n    rejected_by UUID,\n    rejected_at TIMESTAMP,\n    rejection_reason TEXT,\n\n    -- Recepci\xf3n\n    received_at TIMESTAMP,\n    inspected_at TIMESTAMP,\n    inspection_notes TEXT,\n\n    -- Timestamps\n    requested_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    completed_at TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_return_status CHECK (\n        status IN ('requested', 'approved', 'rejected', 'received', 'inspected', 'refunded', 'completed')\n    ),\n    CONSTRAINT check_return_reason CHECK (\n        reason IN ('wrong_size', 'wrong_product', 'defective', 'damaged', 'not_as_described', 'changed_mind', 'other')\n    )\n);\n\nCREATE INDEX idx_returns_order ON returns(order_id);\nCREATE INDEX idx_returns_rma_number ON returns(rma_number);\nCREATE INDEX idx_returns_status ON returns(status);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"8-invoice-invoices",children:"8. Invoice (invoices)"}),"\n",(0,a.jsx)(e.p,{children:"Facturas electr\xf3nicas."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE invoices (\n    invoice_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    order_id UUID NOT NULL REFERENCES orders(order_id),\n\n    -- N\xfamero de factura\n    invoice_number VARCHAR(50) NOT NULL UNIQUE,\n    invoice_type VARCHAR(20) NOT NULL DEFAULT 'sale',\n\n    -- Montos\n    subtotal DECIMAL(12, 2) NOT NULL,\n    tax_amount DECIMAL(12, 2) NOT NULL,\n    total_amount DECIMAL(12, 2) NOT NULL,\n    currency VARCHAR(3) NOT NULL DEFAULT 'USD',\n\n    -- Documentos\n    pdf_url TEXT,\n    xml_url TEXT,\n\n    -- Datos fiscales\n    tax_id VARCHAR(50),\n    tax_name VARCHAR(255),\n    fiscal_address JSONB,\n\n    -- Estado tributario\n    tax_authority_status VARCHAR(50),\n    tax_authority_id VARCHAR(255),\n    tax_authority_response JSONB,\n\n    -- Fechas\n    issued_at TIMESTAMP NOT NULL,\n    due_at TIMESTAMP,\n    sent_at TIMESTAMP,\n    paid_at TIMESTAMP,\n\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_invoice_type CHECK (\n        invoice_type IN ('sale', 'credit_note', 'debit_note', 'proforma')\n    )\n);\n\nCREATE INDEX idx_invoices_order ON invoices(order_id);\nCREATE INDEX idx_invoices_invoice_number ON invoices(invoice_number);\nCREATE INDEX idx_invoices_issued_at ON invoices(issued_at DESC);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"9-returnitem-return_items",children:"9. ReturnItem (return_items)"}),"\n",(0,a.jsx)(e.p,{children:"Items espec\xedficos de una devoluci\xf3n."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE return_items (\n    return_item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    return_id UUID NOT NULL REFERENCES returns(return_id) ON DELETE CASCADE,\n    order_item_id UUID NOT NULL REFERENCES order_items(order_item_id),\n    variant_id UUID NOT NULL,\n\n    -- Cantidades\n    quantity INTEGER NOT NULL CHECK (quantity > 0),\n\n    -- Condici\xf3n\n    condition VARCHAR(30),\n    reason VARCHAR(255),\n\n    -- Reembolso\n    refund_amount DECIMAL(12, 2),\n\n    -- Inspecci\xf3n\n    inspected_quantity INTEGER DEFAULT 0,\n    approved_quantity INTEGER DEFAULT 0,\n    rejected_quantity INTEGER DEFAULT 0,\n    inspection_notes TEXT,\n\n    created_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_return_items_return ON return_items(return_id);\nCREATE INDEX idx_return_items_order_item ON return_items(order_item_id);\nCREATE INDEX idx_return_items_variant ON return_items(variant_id);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"10-shipmenttrackingevent-shipment_tracking_events",children:"10. ShipmentTrackingEvent (shipment_tracking_events)"}),"\n",(0,a.jsx)(e.p,{children:"Historial de eventos de tracking."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE shipment_tracking_events (\n    tracking_event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    shipment_id UUID NOT NULL REFERENCES shipments(shipment_id) ON DELETE CASCADE,\n\n    -- Estado\n    status VARCHAR(50) NOT NULL,\n    status_description TEXT,\n\n    -- Ubicaci\xf3n\n    location VARCHAR(255),\n    location_city VARCHAR(100),\n    location_state VARCHAR(100),\n    location_country VARCHAR(3),\n\n    -- Detalles\n    carrier_status VARCHAR(100),\n    carrier_status_code VARCHAR(50),\n\n    -- Timestamp del evento\n    event_timestamp TIMESTAMP NOT NULL,\n\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_tracking_status CHECK (\n        status IN ('pending', 'label_created', 'picked_up', 'in_transit', 'out_for_delivery',\n                   'delivery_attempted', 'delivered', 'exception', 'failed', 'returned')\n    )\n);\n\nCREATE INDEX idx_tracking_events_shipment ON shipment_tracking_events(shipment_id);\nCREATE INDEX idx_tracking_events_timestamp ON shipment_tracking_events(event_timestamp DESC);\nCREATE INDEX idx_tracking_events_status ON shipment_tracking_events(status);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"11-fulfillmenttask-fulfillment_tasks",children:"11. FulfillmentTask (fulfillment_tasks)"}),"\n",(0,a.jsx)(e.p,{children:"Tareas de picking y packing."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE fulfillment_tasks (\n    task_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    organization_id UUID NOT NULL,\n    order_id UUID NOT NULL REFERENCES orders(order_id),\n    warehouse_id UUID NOT NULL,\n\n    -- Tipo de tarea\n    task_type VARCHAR(30) NOT NULL,\n\n    -- Estado\n    status VARCHAR(30) NOT NULL DEFAULT 'pending',\n    priority INTEGER DEFAULT 0,\n\n    -- Asignaci\xf3n\n    assigned_to UUID,\n    assigned_at TIMESTAMP,\n\n    -- Progreso\n    items_total INTEGER NOT NULL,\n    items_picked INTEGER DEFAULT 0,\n    items_packed INTEGER DEFAULT 0,\n\n    -- Timestamps\n    started_at TIMESTAMP,\n    completed_at TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    -- Metadata\n    notes TEXT,\n    metadata JSONB,\n\n    CONSTRAINT check_task_type CHECK (\n        task_type IN ('picking', 'packing', 'quality_check', 'label_printing')\n    ),\n    CONSTRAINT check_task_status CHECK (\n        status IN ('pending', 'assigned', 'in_progress', 'completed', 'cancelled')\n    )\n);\n\nCREATE INDEX idx_fulfillment_tasks_order ON fulfillment_tasks(order_id);\nCREATE INDEX idx_fulfillment_tasks_warehouse ON fulfillment_tasks(warehouse_id);\nCREATE INDEX idx_fulfillment_tasks_assigned_to ON fulfillment_tasks(assigned_to);\nCREATE INDEX idx_fulfillment_tasks_status ON fulfillment_tasks(status);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"12-orderstatushistory-order_status_history",children:"12. OrderStatusHistory (order_status_history)"}),"\n",(0,a.jsx)(e.p,{children:"Historial de cambios de estado de \xf3rdenes."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE order_status_history (\n    history_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    order_id UUID NOT NULL REFERENCES orders(order_id) ON DELETE CASCADE,\n\n    -- Estado\n    from_status VARCHAR(30),\n    to_status VARCHAR(30) NOT NULL,\n\n    -- Raz\xf3n del cambio\n    reason VARCHAR(255),\n    notes TEXT,\n\n    -- Usuario que realiz\xf3 el cambio\n    changed_by UUID,\n\n    -- Metadata\n    metadata JSONB,\n\n    changed_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_from_status_valid CHECK (\n        from_status IN (\n            'cart', 'pending', 'payment_pending', 'payment_failed',\n            'confirmed', 'processing', 'ready_to_ship', 'shipped',\n            'delivered', 'cancelled', 'return_requested', 'returned', 'refunded'\n        )\n    ),\n    CONSTRAINT check_to_status_valid CHECK (\n        to_status IN (\n            'cart', 'pending', 'payment_pending', 'payment_failed',\n            'confirmed', 'processing', 'ready_to_ship', 'shipped',\n            'delivered', 'cancelled', 'return_requested', 'returned', 'refunded'\n        )\n    )\n);\n\nCREATE INDEX idx_order_status_history_order ON order_status_history(order_id);\nCREATE INDEX idx_order_status_history_changed_at ON order_status_history(changed_at DESC);\nCREATE INDEX idx_order_status_history_to_status ON order_status_history(to_status);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"13-paymenttransaction-payment_transactions",children:"13. PaymentTransaction (payment_transactions)"}),"\n",(0,a.jsx)(e.p,{children:"Registro detallado de transacciones con payment gateways."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE payment_transactions (\n    transaction_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    payment_id UUID NOT NULL REFERENCES payments(payment_id) ON DELETE CASCADE,\n\n    -- Tipo de transacci\xf3n\n    transaction_type VARCHAR(30) NOT NULL,\n\n    -- Estado\n    status VARCHAR(30) NOT NULL,\n\n    -- Montos\n    amount DECIMAL(12, 2) NOT NULL,\n    currency VARCHAR(3) NOT NULL DEFAULT 'USD',\n\n    -- Gateway\n    gateway_transaction_id VARCHAR(255),\n    gateway_response JSONB,\n\n    -- Error\n    error_code VARCHAR(100),\n    error_message TEXT,\n\n    -- Timestamps\n    processed_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT check_transaction_type CHECK (\n        transaction_type IN ('authorize', 'capture', 'charge', 'refund', 'void')\n    ),\n    CONSTRAINT check_transaction_status CHECK (\n        status IN ('pending', 'processing', 'succeeded', 'failed')\n    )\n);\n\nCREATE INDEX idx_payment_transactions_payment ON payment_transactions(payment_id);\nCREATE INDEX idx_payment_transactions_type ON payment_transactions(transaction_type);\nCREATE INDEX idx_payment_transactions_status ON payment_transactions(status);\nCREATE INDEX idx_payment_transactions_gateway_id ON payment_transactions(gateway_transaction_id);\n"})}),"\n",(0,a.jsx)(e.h2,{id:"vistas",children:"Vistas"}),"\n",(0,a.jsx)(e.h3,{id:"v_order_summary",children:"v_order_summary"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"CREATE VIEW v_order_summary AS\nSELECT\n    o.order_id,\n    o.order_number,\n    o.organization_id,\n    o.customer_id,\n    o.status,\n    o.total_amount,\n    o.currency,\n    COUNT(oi.order_item_id) as items_count,\n    SUM(oi.quantity) as total_quantity,\n    o.placed_at,\n    o.confirmed_at,\n    p.status as payment_status,\n    s.status as shipment_status,\n    s.tracking_number\nFROM orders o\nLEFT JOIN order_items oi ON o.order_id = oi.order_id\nLEFT JOIN payments p ON o.order_id = p.order_id AND p.status = 'succeeded'\nLEFT JOIN shipments s ON o.order_id = s.order_id\nGROUP BY o.order_id, p.status, s.status, s.tracking_number;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"row-level-security",children:"Row-Level Security"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"ALTER TABLE orders ENABLE ROW LEVEL SECURITY;\nALTER TABLE payments ENABLE ROW LEVEL SECURITY;\nALTER TABLE shipments ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY orders_organization_isolation ON orders\n    USING (organization_id = current_setting('app.current_organization_id')::uuid);\n\nCREATE POLICY payments_organization_isolation ON payments\n    USING (organization_id = current_setting('app.current_organization_id')::uuid);\n"})}),"\n",(0,a.jsx)(e.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"./arquitectura",children:"Arquitectura"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"./api-orders",children:"API: Orders"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"./state-machine",children:"State Machine"})}),"\n"]})]})}function E(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(c,{...n})}):c(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>d});var r=t(6540);const a={},i=r.createContext(a);function s(n){const e=r.useContext(i);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:s(n.components),r.createElement(i.Provider,{value:e},n.children)}}}]);