"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[9371],{7977:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"microservicios/audit-service/api-logs","title":"API Logs","description":"Endpoints REST para consulta de logs de auditor\xeda.","source":"@site/docs/02-microservicios/audit-service/05-api-logs.md","sourceDirName":"02-microservicios/audit-service","slug":"/microservicios/audit-service/api-logs","permalink":"/zenlogic/microservicios/audit-service/api-logs","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/audit-service/05-api-logs.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docs","previous":{"title":"Event Consumer","permalink":"/zenlogic/microservicios/audit-service/event-consumer"},"next":{"title":"Retention Policy","permalink":"/zenlogic/microservicios/audit-service/retention-policy"}}');var s=i(4848),r=i(8453);const o={sidebar_position:6},d="API Logs",a={},l=[{value:"Base URL",id:"base-url",level:2},{value:"Listar Logs",id:"listar-logs",level:2},{value:"<code>GET /api/v1/logs</code>",id:"get-apiv1logs",level:3},{value:"Obtener Log Espec\xedfico",id:"obtener-log-espec\xedfico",level:2},{value:"<code>GET /api/v1/logs/{id}</code>",id:"get-apiv1logsid",level:3},{value:"Timeline de Eventos",id:"timeline-de-eventos",level:2},{value:"<code>GET /api/v1/logs/timeline</code>",id:"get-apiv1logstimeline",level:3},{value:"Estad\xedsticas",id:"estad\xedsticas",level:2},{value:"<code>GET /api/v1/logs/stats</code>",id:"get-apiv1logsstats",level:3},{value:"Implementaci\xf3n",id:"implementaci\xf3n",level:2},{value:"Router",id:"router",level:3},{value:"Query Service",id:"query-service",level:3},{value:"C\xf3digos de Error",id:"c\xf3digos-de-error",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"api-logs",children:"API Logs"})}),"\n",(0,s.jsx)(n.p,{children:"Endpoints REST para consulta de logs de auditor\xeda."}),"\n",(0,s.jsx)(n.h2,{id:"base-url",children:"Base URL"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET /api/v1/logs\nGET /api/v1/logs/{id}\nGET /api/v1/logs/timeline\nGET /api/v1/logs/stats\n"})}),"\n",(0,s.jsx)(n.h2,{id:"listar-logs",children:"Listar Logs"}),"\n",(0,s.jsx)(n.h3,{id:"get-apiv1logs",children:(0,s.jsx)(n.code,{children:"GET /api/v1/logs"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Headers"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Authorization: Bearer {access_token}\nX-Tenant-ID: {organization_id}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Query Parameters"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"start_date"})," (optional): Fecha inicio (ISO 8601)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"end_date"})," (optional): Fecha fin (ISO 8601)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"event_type"})," (optional): Filtrar por tipo de evento"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"user_id"})," (optional): Filtrar por usuario"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service"})," (optional): Filtrar por servicio"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"limit"})," (optional, default=50, max=200): Cantidad de resultados"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"offset"})," (optional, default=0): Offset para paginaci\xf3n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response 200 OK"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": [\n    {\n      "id": "log-uuid",\n      "event_id": "correlation-id-123",\n      "event_type": "catalog.product.created",\n      "created_at": "2025-11-23T15:00:00Z",\n      "service": "catalog-service",\n      "version": "1.0",\n      "payload": {\n        "product_id": "product-uuid",\n        "organization_id": "org-uuid",\n        "name": "Camiseta B\xe1sica",\n        "sku": "CAM-001",\n        "base_price": 19.99\n      },\n      "metadata": {\n        "user_id": "user-uuid",\n        "correlation_id": "correlation-id-123",\n        "ip_address": "192.168.1.100"\n      },\n      "organization_id": "org-uuid",\n      "user_id": "user-uuid",\n      "ip_address": "192.168.1.100"\n    }\n  ],\n  "pagination": {\n    "total": 1523,\n    "limit": 50,\n    "offset": 0,\n    "has_next": true\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"obtener-log-espec\xedfico",children:"Obtener Log Espec\xedfico"}),"\n",(0,s.jsx)(n.h3,{id:"get-apiv1logsid",children:(0,s.jsx)(n.code,{children:"GET /api/v1/logs/{id}"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response 200 OK"}),": Log completo con todos los detalles"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response 404 Not Found"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "detail": "Log no encontrado"\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"timeline-de-eventos",children:"Timeline de Eventos"}),"\n",(0,s.jsx)(n.h3,{id:"get-apiv1logstimeline",children:(0,s.jsx)(n.code,{children:"GET /api/v1/logs/timeline"})}),"\n",(0,s.jsx)(n.p,{children:"Obtener timeline cronol\xf3gico de eventos para una entidad espec\xedfica."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Query Parameters"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"entity_type"})," (required): Tipo de entidad (product, user, role, etc.)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"entity_id"})," (required): ID de la entidad"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"start_date"})," (optional): Fecha inicio"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"end_date"})," (optional): Fecha fin"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response 200 OK"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "entity_type": "product",\n  "entity_id": "product-uuid",\n  "events": [\n    {\n      "timestamp": "2025-11-23T10:00:00Z",\n      "event_type": "catalog.product.created",\n      "user": {\n        "id": "user-uuid",\n        "email": "admin@example.com"\n      },\n      "changes": {\n        "name": "Camiseta B\xe1sica",\n        "base_price": 19.99\n      }\n    },\n    {\n      "timestamp": "2025-11-23T14:30:00Z",\n      "event_type": "catalog.product.updated",\n      "user": {\n        "id": "user-uuid-2",\n        "email": "manager@example.com"\n      },\n      "changes": {\n        "base_price": {\n          "old": 19.99,\n          "new": 29.99\n        }\n      }\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"estad\xedsticas",children:"Estad\xedsticas"}),"\n",(0,s.jsx)(n.h3,{id:"get-apiv1logsstats",children:(0,s.jsx)(n.code,{children:"GET /api/v1/logs/stats"})}),"\n",(0,s.jsx)(n.p,{children:"Obtener estad\xedsticas agregadas de logs."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Query Parameters"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"group_by"})," (required): Campo para agrupar (event_type, service, user_id)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"start_date"})," (optional): Fecha inicio"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"end_date"})," (optional): Fecha fin"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response 200 OK"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "group_by": "event_type",\n  "stats": [\n    {\n      "group": "auth.session.created",\n      "count": 1523,\n      "percentage": 35.2\n    },\n    {\n      "group": "catalog.product.updated",\n      "count": 892,\n      "percentage": 20.6\n    },\n    {\n      "group": "auth.user.created",\n      "count": 456,\n      "percentage": 10.5\n    }\n  ],\n  "total_events": 4328,\n  "period": {\n    "start": "2025-11-01T00:00:00Z",\n    "end": "2025-11-30T23:59:59Z"\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"implementaci\xf3n",children:"Implementaci\xf3n"}),"\n",(0,s.jsx)(n.h3,{id:"router",children:"Router"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from fastapi import APIRouter, Depends, Query, HTTPException\nfrom typing import Optional\nfrom datetime import datetime\n\nfrom app.services.query_service import QueryService\nfrom app.schemas.audit import AuditLogResponse, TimelineResponse, StatsResponse\nfrom app.dependencies import get_current_user, get_organization_id\n\nrouter = APIRouter(prefix="/api/v1/logs", tags=["Audit Logs"])\n\n@router.get("/", response_model=dict)\nasync def list_logs(\n    start_date: Optional[datetime] = Query(None),\n    end_date: Optional[datetime] = Query(None),\n    event_type: Optional[str] = Query(None),\n    user_id: Optional[str] = Query(None),\n    service: Optional[str] = Query(None),\n    limit: int = Query(50, ge=1, le=200),\n    offset: int = Query(0, ge=0),\n    org_id: str = Depends(get_organization_id),\n    current_user: dict = Depends(get_current_user),\n    query_service: QueryService = Depends()\n):\n    """Listar logs de auditor\xeda con filtros."""\n\n    # Solo admins pueden ver logs\n    if "audit:read" not in current_user["permissions"]:\n        raise HTTPException(status_code=403, detail="No autorizado")\n\n    filters = {\n        "organization_id": org_id,\n        "start_date": start_date,\n        "end_date": end_date,\n        "event_type": event_type,\n        "user_id": user_id,\n        "service": service\n    }\n\n    # Remover filtros None\n    filters = {k: v for k, v in filters.items() if v is not None}\n\n    result = await query_service.query_logs(\n        filters=filters,\n        limit=limit,\n        offset=offset\n    )\n\n    return result\n\n@router.get("/timeline", response_model=TimelineResponse)\nasync def get_timeline(\n    entity_type: str = Query(...),\n    entity_id: str = Query(...),\n    start_date: Optional[datetime] = Query(None),\n    end_date: Optional[datetime] = Query(None),\n    current_user: dict = Depends(get_current_user),\n    query_service: QueryService = Depends()\n):\n    """Obtener timeline de eventos para una entidad."""\n\n    if "audit:read" not in current_user["permissions"]:\n        raise HTTPException(status_code=403, detail="No autorizado")\n\n    return await query_service.get_timeline(\n        entity_type=entity_type,\n        entity_id=entity_id,\n        start_date=start_date,\n        end_date=end_date\n    )\n\n@router.get("/stats", response_model=StatsResponse)\nasync def get_stats(\n    group_by: str = Query(..., regex="^(event_type|service|user_id)$"),\n    start_date: Optional[datetime] = Query(None),\n    end_date: Optional[datetime] = Query(None),\n    org_id: str = Depends(get_organization_id),\n    current_user: dict = Depends(get_current_user),\n    query_service: QueryService = Depends()\n):\n    """Obtener estad\xedsticas agregadas."""\n\n    if "audit:read" not in current_user["permissions"]:\n        raise HTTPException(status_code=403, detail="No autorizado")\n\n    return await query_service.get_stats(\n        organization_id=org_id,\n        group_by=group_by,\n        start_date=start_date,\n        end_date=end_date\n    )\n'})}),"\n",(0,s.jsx)(n.h3,{id:"query-service",children:"Query Service"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from sqlalchemy import select, func, and_\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom typing import Dict, Any, Optional, List\nfrom datetime import datetime\n\nfrom app.models.audit import AuditLog\nfrom app.repositories.audit_repository import AuditRepository\n\nclass QueryService:\n    """Servicio para queries complejas de auditor\xeda."""\n\n    def __init__(self, audit_repo: AuditRepository):\n        self.audit_repo = audit_repo\n\n    async def query_logs(\n        self,\n        filters: Dict[str, Any],\n        limit: int = 50,\n        offset: int = 0\n    ) -> Dict[str, Any]:\n        """Consultar logs con filtros."""\n\n        # Contar total\n        total = await self.audit_repo.count_by_filters(filters)\n\n        # Obtener logs\n        logs = await self.audit_repo.find_by_filters(\n            filters=filters,\n            limit=limit,\n            offset=offset,\n            order_by=AuditLog.created_at.desc()\n        )\n\n        return {\n            "data": logs,\n            "pagination": {\n                "total": total,\n                "limit": limit,\n                "offset": offset,\n                "has_next": (offset + limit) < total\n            }\n        }\n\n    async def get_timeline(\n        self,\n        entity_type: str,\n        entity_id: str,\n        start_date: Optional[datetime] = None,\n        end_date: Optional[datetime] = None\n    ) -> Dict[str, Any]:\n        """Obtener timeline de eventos para una entidad."""\n\n        # Buscar en payload JSON\n        filters = {}\n        if start_date:\n            filters["start_date"] = start_date\n        if end_date:\n            filters["end_date"] = end_date\n\n        # Query con JSONB\n        logs = await self.audit_repo.find_by_entity(\n            entity_type=entity_type,\n            entity_id=entity_id,\n            filters=filters\n        )\n\n        return {\n            "entity_type": entity_type,\n            "entity_id": entity_id,\n            "events": [self._format_timeline_event(log) for log in logs]\n        }\n\n    def _format_timeline_event(self, log: AuditLog) -> Dict[str, Any]:\n        """Formatear evento para timeline."""\n        return {\n            "timestamp": log.created_at,\n            "event_type": log.event_type,\n            "user": {\n                "id": str(log.user_id) if log.user_id else None,\n                "email": log.payload.get("user_email")\n            },\n            "changes": log.payload.get("changes", log.payload)\n        }\n'})}),"\n",(0,s.jsx)(n.h2,{id:"c\xf3digos-de-error",children:"C\xf3digos de Error"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"C\xf3digo"}),(0,s.jsx)(n.th,{children:"Error Code"}),(0,s.jsx)(n.th,{children:"Descripci\xf3n"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"401"}),(0,s.jsx)(n.td,{children:"UNAUTHORIZED"}),(0,s.jsx)(n.td,{children:"Token inv\xe1lido"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"403"}),(0,s.jsx)(n.td,{children:"FORBIDDEN"}),(0,s.jsx)(n.td,{children:"Sin permisos de auditor\xeda"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"404"}),(0,s.jsx)(n.td,{children:"LOG_NOT_FOUND"}),(0,s.jsx)(n.td,{children:"Log no encontrado"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"422"}),(0,s.jsx)(n.td,{children:"INVALID_FILTERS"}),(0,s.jsx)(n.td,{children:"Filtros inv\xe1lidos"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/audit-service/queries-comunes",children:"Queries Comunes"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/audit-service/retention-policy",children:"Retention Policy"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/audit-service/modelo-datos",children:"Modelo de Datos"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>d});var t=i(6540);const s={},r=t.createContext(s);function o(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);