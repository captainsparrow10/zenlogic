"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[963],{5432:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>s,contentTitle:()=>d,default:()=>v,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"microservicios/order-service/eventos-consumidos","title":"Eventos Consumidos","description":"Eventos que Order Service consume de otros servicios para mantener sincronizaci\xf3n y responder a cambios.","source":"@site/docs/02-microservicios/order-service/12-eventos-consumidos.md","sourceDirName":"02-microservicios/order-service","slug":"/microservicios/order-service/eventos-consumidos","permalink":"/zenlogic/microservicios/order-service/eventos-consumidos","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/order-service/12-eventos-consumidos.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"sidebar_position":12}}');var t=a(4848),i=a(8453);const o={sidebar_position:12},d="Eventos Consumidos",s={},c=[{value:"Configuraci\xf3n de Consumidores",id:"configuraci\xf3n-de-consumidores",level:2},{value:"Eventos de Inventory Service",id:"eventos-de-inventory-service",level:2},{value:"inventory.stock.updated",id:"inventorystockupdated",level:3},{value:"inventory.stock.depleted",id:"inventorystockdepleted",level:3},{value:"inventory.stock.reserved",id:"inventorystockreserved",level:3},{value:"inventory.stock.released",id:"inventorystockreleased",level:3},{value:"Eventos de Catalog Service",id:"eventos-de-catalog-service",level:2},{value:"catalog.product.updated",id:"catalogproductupdated",level:3},{value:"catalog.variant.updated",id:"catalogvariantupdated",level:3},{value:"catalog.product.deleted",id:"catalogproductdeleted",level:3},{value:"catalog.variant.deleted",id:"catalogvariantdeleted",level:3},{value:"Payment Gateway Webhooks",id:"payment-gateway-webhooks",level:2},{value:"Stripe Webhook",id:"stripe-webhook",level:3},{value:"Resumen de Eventos Consumidos",id:"resumen-de-eventos-consumidos",level:2},{value:"Event Consumer Service",id:"event-consumer-service",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"eventos-consumidos",children:"Eventos Consumidos"})}),"\n",(0,t.jsx)(n.p,{children:"Eventos que Order Service consume de otros servicios para mantener sincronizaci\xf3n y responder a cambios."}),"\n",(0,t.jsx)(n.h2,{id:"configuraci\xf3n-de-consumidores",children:"Configuraci\xf3n de Consumidores"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"EVENT_CONSUMER_CONFIG = {\n    'inventory_consumer': {\n        'exchange': 'inventory_events',\n        'exchange_type': 'topic',\n        'queue': 'order_inventory_consumer',\n        'routing_keys': [\n            'inventory.stock.updated',\n            'inventory.stock.depleted',\n            'inventory.stock.reserved',\n            'inventory.stock.released'\n        ],\n        'prefetch_count': 20,\n        'auto_ack': False\n    },\n    'catalog_consumer': {\n        'exchange': 'catalog_events',\n        'exchange_type': 'topic',\n        'queue': 'order_catalog_consumer',\n        'routing_keys': [\n            'catalog.product.updated',\n            'catalog.variant.updated',\n            'catalog.product.deleted',\n            'catalog.variant.deleted'\n        ],\n        'prefetch_count': 20,\n        'auto_ack': False\n    },\n    'payment_webhooks': {\n        # Webhooks de payment gateways se reciben v\xeda HTTP, no RabbitMQ\n        # Se procesan en endpoints espec\xedficos: /webhooks/stripe, /webhooks/paypal, etc.\n    }\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"eventos-de-inventory-service",children:"Eventos de Inventory Service"}),"\n",(0,t.jsx)(n.h3,{id:"inventorystockupdated",children:"inventory.stock.updated"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Inventory actualiza stock (entrada, salida, ajuste)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Invalidar cache de disponibilidad de producto"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "inventory.stock.updated",\n  "version": "1.0",\n  "timestamp": "2025-11-23T15:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "stock_id": "stock_456",\n    "variant_id": "var_789",\n    "warehouse_id": "wh_101",\n    "quantities": {\n      "total": 150,\n      "available": 120,\n      "reserved": 25,\n      "damaged": 5\n    },\n    "previous_quantities": {\n      "total": 145,\n      "available": 115,\n      "reserved": 25,\n      "damaged": 5\n    },\n    "change_type": "in",\n    "movement_id": "mov_123"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"async def handle_inventory_stock_updated(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Handle stock update events from Inventory Service.\n\n    - Invalidate cache for product availability\n    - Update cart items if stock became unavailable\n    - Notify customers with pending carts if stock became available\n    \"\"\"\n    variant_id = event['data']['variant_id']\n    warehouse_id = event['data']['warehouse_id']\n    new_available = event['data']['quantities']['available']\n    old_available = event['data']['previous_quantities']['available']\n\n    # Invalidar cache de disponibilidad\n    await redis_client.delete(f\"stock:availability:{variant_id}:{warehouse_id}\")\n\n    # Si stock se agot\xf3, notificar carritos activos\n    if old_available > 0 and new_available == 0:\n        await notify_carts_with_variant(variant_id, \"stock_depleted\")\n\n    # Si stock se recuper\xf3, notificar usuarios en waitlist\n    if old_available == 0 and new_available > 0:\n        await notify_waitlist(variant_id, warehouse_id)\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"inventorystockdepleted",children:"inventory.stock.depleted"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Stock de una variante llega a 0"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Marcar producto como agotado en carritos activos"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "inventory.stock.depleted",\n  "version": "1.0",\n  "timestamp": "2025-11-23T14:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "stock_id": "stock_456",\n    "variant_id": "var_789",\n    "warehouse_id": "wh_101",\n    "last_movement_at": "2025-11-23T14:00:00Z"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'async def handle_inventory_stock_depleted(event: Dict[str, Any]) -> None:\n    """\n    Handle stock depleted events.\n\n    - Mark variant as out of stock in carts\n    - Prevent new cart additions\n    - Notify customers with items in cart\n    """\n    variant_id = event[\'data\'][\'variant_id\']\n    warehouse_id = event[\'data\'][\'warehouse_id\']\n\n    # Buscar carritos activos con esta variante\n    carts = await cart_repo.find_active_carts_with_variant(variant_id)\n\n    for cart in carts:\n        # Marcar item como no disponible\n        await cart_repo.mark_item_unavailable(\n            cart.cart_id,\n            variant_id,\n            reason="out_of_stock"\n        )\n\n        # Notificar al cliente\n        await notification_service.send(\n            cart.customer_id,\n            "cart_item_out_of_stock",\n            {"variant_id": variant_id, "cart_id": cart.cart_id}\n        )\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"inventorystockreserved",children:"inventory.stock.reserved"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Inventory confirma reserva de stock (respuesta a order.placed)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Actualizar orden con reservation_id"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "inventory.stock.reserved",\n  "version": "1.0",\n  "timestamp": "2025-11-23T15:01:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "reservation_id": "res_123",\n    "order_id": "order_456",\n    "items": [\n      {\n        "variant_id": "var_789",\n        "warehouse_id": "wh_101",\n        "quantity": 10,\n        "stock_before": 120,\n        "stock_after": 110\n      }\n    ],\n    "expires_at": "2025-11-23T15:16:00Z"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"async def handle_inventory_stock_reserved(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Handle stock reservation confirmation.\n\n    - Update order with reservation_id\n    - Set reservation expiration timer\n    - Update order status if needed\n    \"\"\"\n    order_id = event['data']['order_id']\n    reservation_id = event['data']['reservation_id']\n    expires_at = datetime.fromisoformat(event['data']['expires_at'])\n\n    # Actualizar orden con reservation_id\n    await order_repo.update(\n        order_id=order_id,\n        reservation_id=reservation_id\n    )\n\n    # Programar job para liberar reserva si no se confirma pago a tiempo\n    await task_queue.schedule(\n        task='release_expired_reservation',\n        args={'reservation_id': reservation_id, 'order_id': order_id},\n        eta=expires_at\n    )\n\n    logger.info(f\"Reservation {reservation_id} confirmed for order {order_id}\")\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"inventorystockreleased",children:"inventory.stock.released"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Inventory libera reserva (timeout o cancelaci\xf3n)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Actualizar estado de orden si es necesario"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "inventory.stock.released",\n  "version": "1.0",\n  "timestamp": "2025-11-23T15:20:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "reservation_id": "res_123",\n    "order_id": "order_456",\n    "reason": "timeout",\n    "items_released": 2,\n    "total_quantity_released": 15\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"async def handle_inventory_stock_released(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Handle stock reservation release.\n\n    - Check if order payment is still pending\n    - Cancel order if reservation expired due to timeout\n    - Log release reason\n    \"\"\"\n    order_id = event['data']['order_id']\n    reservation_id = event['data']['reservation_id']\n    reason = event['data']['reason']\n\n    order = await order_repo.find_by_id(order_id)\n\n    if not order:\n        logger.warning(f\"Order {order_id} not found for released reservation\")\n        return\n\n    # Si la reserva expir\xf3 por timeout y el pago a\xfan est\xe1 pendiente\n    if reason == 'timeout' and order.status == 'payment_pending':\n        await order_service.cancel_order(\n            order_id=order_id,\n            reason='payment_timeout',\n            auto_cancelled=True\n        )\n\n        # Notificar cliente\n        await notification_service.send(\n            order.customer_id,\n            \"order_cancelled_timeout\",\n            {\"order_number\": order.order_number}\n        )\n\n    logger.info(f\"Reservation {reservation_id} released for order {order_id}, reason: {reason}\")\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"eventos-de-catalog-service",children:"Eventos de Catalog Service"}),"\n",(0,t.jsx)(n.h3,{id:"catalogproductupdated",children:"catalog.product.updated"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Catalog actualiza informaci\xf3n de producto"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Invalidar cache, no afectar \xf3rdenes existentes (snapshot)"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.product.updated",\n  "version": "1.0",\n  "timestamp": "2025-11-23T16:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "product_id": "prod_123",\n    "organization_id": "org_123",\n    "changes": {\n      "name": {\n        "old": "Camiseta B\xe1sica",\n        "new": "Camiseta Premium"\n      },\n      "base_price": {\n        "old": 19.99,\n        "new": 29.99\n      }\n    },\n    "updated_by": "user_456",\n    "updated_at": "2025-11-23T16:00:00Z"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"async def handle_catalog_product_updated(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Handle product updates from Catalog Service.\n\n    - Invalidate product cache\n    - Update active carts with new pricing (optional)\n    - Existing orders are NOT affected (they have snapshots)\n    \"\"\"\n    product_id = event['data']['product_id']\n    changes = event['data']['changes']\n\n    # Invalidar cache de producto\n    await redis_client.delete(f\"product:{product_id}\")\n\n    # Si el precio cambi\xf3, actualizar carritos activos (opcional - decisi\xf3n de negocio)\n    if 'base_price' in changes:\n        # Opci\xf3n A: No actualizar (carritos mantienen precio anterior)\n        pass\n\n        # Opci\xf3n B: Actualizar carritos (mostrar nuevo precio)\n        # await update_carts_with_new_price(product_id, changes['base_price']['new'])\n\n    logger.info(f\"Product {product_id} updated in catalog\")\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"catalogvariantupdated",children:"catalog.variant.updated"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Catalog actualiza variante (precio, SKU, etc.)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Invalidar cache de variante, actualizar carritos activos"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.variant.updated",\n  "version": "1.0",\n  "timestamp": "2025-11-23T16:15:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "variant_id": "var_789",\n    "product_id": "prod_123",\n    "organization_id": "org_123",\n    "changes": {\n      "price": {\n        "old": 29.99,\n        "new": 34.99\n      }\n    },\n    "updated_by": "user_456",\n    "updated_at": "2025-11-23T16:15:00Z"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"async def handle_catalog_variant_updated(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Handle variant updates.\n\n    - Invalidate variant cache\n    - Update active carts with new pricing\n    - Notify customers if price increased significantly\n    \"\"\"\n    variant_id = event['data']['variant_id']\n    changes = event['data']['changes']\n\n    # Invalidar cache\n    await redis_client.delete(f\"variant:{variant_id}\")\n\n    # Si el precio cambi\xf3\n    if 'price' in changes:\n        old_price = changes['price']['old']\n        new_price = changes['price']['new']\n        price_increase = new_price - old_price\n\n        # Actualizar carritos activos\n        await cart_service.update_variant_price(variant_id, new_price)\n\n        # Si el aumento es > 10%, notificar clientes\n        if price_increase / old_price > 0.10:\n            await notify_price_increase(variant_id, old_price, new_price)\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"catalogproductdeleted",children:"catalog.product.deleted"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Catalog elimina producto"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Remover de carritos activos, no afectar \xf3rdenes confirmadas"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.product.deleted",\n  "version": "1.0",\n  "timestamp": "2025-11-23T17:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "product_id": "prod_123",\n    "organization_id": "org_123",\n    "variant_ids": ["var_456", "var_789", "var_101"],\n    "deleted_by": "user_456",\n    "deleted_at": "2025-11-23T17:00:00Z",\n    "reason": "Producto descontinuado"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"async def handle_catalog_product_deleted(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Handle product deletion.\n\n    - Remove product from all active carts\n    - Cancel pending orders with this product (if not yet confirmed)\n    - Notify affected customers\n    \"\"\"\n    product_id = event['data']['product_id']\n    variant_ids = event['data']['variant_ids']\n\n    # Remover de carritos activos\n    for variant_id in variant_ids:\n        carts_affected = await cart_repo.remove_variant_from_carts(variant_id)\n\n        # Notificar clientes afectados\n        for cart in carts_affected:\n            await notification_service.send(\n                cart.customer_id,\n                \"cart_item_removed\",\n                {\n                    \"variant_id\": variant_id,\n                    \"reason\": \"product_discontinued\"\n                }\n            )\n\n    # Cancelar \xf3rdenes pendientes (a\xfan no confirmadas)\n    pending_orders = await order_repo.find_pending_orders_with_variants(variant_ids)\n\n    for order in pending_orders:\n        if order.status in ['pending', 'payment_pending']:\n            await order_service.cancel_order(\n                order_id=order.order_id,\n                reason='product_discontinued',\n                auto_cancelled=True\n            )\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"catalogvariantdeleted",children:"catalog.variant.deleted"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Trigger:"})," Catalog elimina variante espec\xedfica"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Acci\xf3n:"})," Similar a product.deleted pero solo para esa variante"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.variant.deleted",\n  "version": "1.0",\n  "timestamp": "2025-11-23T17:30:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "variant_id": "var_789",\n    "product_id": "prod_123",\n    "organization_id": "org_123",\n    "deleted_by": "user_456",\n    "deleted_at": "2025-11-23T17:30:00Z"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"payment-gateway-webhooks",children:"Payment Gateway Webhooks"}),"\n",(0,t.jsx)(n.p,{children:"Los webhooks de payment gateways se reciben v\xeda HTTP POST, no v\xeda RabbitMQ."}),"\n",(0,t.jsx)(n.h3,{id:"stripe-webhook",children:"Stripe Webhook"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"@app.post(\"/api/v1/webhooks/stripe\")\nasync def stripe_webhook(request: Request):\n    \"\"\"\n    Handle Stripe payment webhooks.\n\n    Eventos importantes:\n    - payment_intent.succeeded\n    - payment_intent.payment_failed\n    - charge.refunded\n    \"\"\"\n    payload = await request.body()\n    sig_header = request.headers.get('stripe-signature')\n\n    try:\n        event = stripe.Webhook.construct_event(\n            payload, sig_header, settings.stripe_webhook_secret\n        )\n    except ValueError:\n        return JSONResponse(status_code=400, content={\"error\": \"Invalid payload\"})\n    except stripe.error.SignatureVerificationError:\n        return JSONResponse(status_code=400, content={\"error\": \"Invalid signature\"})\n\n    # Manejar evento\n    if event['type'] == 'payment_intent.succeeded':\n        payment_intent = event['data']['object']\n        await handle_payment_succeeded(payment_intent)\n\n    elif event['type'] == 'payment_intent.payment_failed':\n        payment_intent = event['data']['object']\n        await handle_payment_failed(payment_intent)\n\n    elif event['type'] == 'charge.refunded':\n        charge = event['data']['object']\n        await handle_payment_refunded(charge)\n\n    return JSONResponse(content={\"status\": \"success\"})\n\n\nasync def handle_payment_succeeded(payment_intent):\n    \"\"\"Handle successful payment.\"\"\"\n    # Buscar pago por gateway_payment_id\n    payment = await payment_repo.find_by_gateway_id(payment_intent['id'])\n\n    if payment:\n        # Actualizar estado de pago\n        await payment_repo.update(\n            payment_id=payment.payment_id,\n            status='succeeded',\n            paid_at=datetime.now()\n        )\n\n        # Actualizar orden a confirmed\n        await order_service.confirm_order(payment.order_id)\n\n        # Confirmar reserva de stock en Inventory\n        order = await order_repo.find_by_id(payment.order_id)\n        if order.reservation_id:\n            await inventory_client.confirm_reservation(\n                organization_id=order.organization_id,\n                reservation_id=order.reservation_id,\n                order_id=order.order_id\n            )\n\n        # Publicar evento order.confirmed\n        await event_publisher.publish('order.confirmed', {...})\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"resumen-de-eventos-consumidos",children:"Resumen de Eventos Consumidos"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Servicio"}),(0,t.jsx)(n.th,{children:"Exchange"}),(0,t.jsx)(n.th,{children:"Total Eventos"}),(0,t.jsx)(n.th,{children:"Eventos Cr\xedticos"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Inventory"})}),(0,t.jsx)(n.td,{children:"inventory_events"}),(0,t.jsx)(n.td,{children:"4"}),(0,t.jsx)(n.td,{children:"stock.reserved, stock.released"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Catalog"})}),(0,t.jsx)(n.td,{children:"catalog_events"}),(0,t.jsx)(n.td,{children:"4"}),(0,t.jsx)(n.td,{children:"variant.updated, product.deleted"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Payment Gateways"})}),(0,t.jsx)(n.td,{children:"HTTP Webhooks"}),(0,t.jsx)(n.td,{children:"3+"}),(0,t.jsx)(n.td,{children:"payment.succeeded, payment.failed"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"TOTAL"})}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"11+"})}),(0,t.jsx)(n.td,{})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"event-consumer-service",children:"Event Consumer Service"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import asyncio\nfrom app.events.handlers import inventory_handlers, catalog_handlers\nfrom app.config.rabbitmq import RabbitMQConsumer\n\nasync def start_event_consumers():\n    \"\"\"Start all event consumers.\"\"\"\n\n    # Inventory consumer\n    inventory_consumer = RabbitMQConsumer(\n        exchange='inventory_events',\n        queue='order_inventory_consumer',\n        routing_keys=[\n            'inventory.stock.updated',\n            'inventory.stock.depleted',\n            'inventory.stock.reserved',\n            'inventory.stock.released'\n        ]\n    )\n\n    await inventory_consumer.start(\n        handlers={\n            'inventory.stock.updated': inventory_handlers.handle_stock_updated,\n            'inventory.stock.depleted': inventory_handlers.handle_stock_depleted,\n            'inventory.stock.reserved': inventory_handlers.handle_stock_reserved,\n            'inventory.stock.released': inventory_handlers.handle_stock_released\n        }\n    )\n\n    # Catalog consumer\n    catalog_consumer = RabbitMQConsumer(\n        exchange='catalog_events',\n        queue='order_catalog_consumer',\n        routing_keys=[\n            'catalog.product.updated',\n            'catalog.variant.updated',\n            'catalog.product.deleted',\n            'catalog.variant.deleted'\n        ]\n    )\n\n    await catalog_consumer.start(\n        handlers={\n            'catalog.product.updated': catalog_handlers.handle_product_updated,\n            'catalog.variant.updated': catalog_handlers.handle_variant_updated,\n            'catalog.product.deleted': catalog_handlers.handle_product_deleted,\n            'catalog.variant.deleted': catalog_handlers.handle_variant_deleted\n        }\n    )\n\n    logger.info(\"All event consumers started\")\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"./eventos-publicados",children:"Eventos Publicados"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"./integraciones",children:"Integraciones"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"./flujos-negocio",children:"Flujos de Negocio"})}),"\n"]})]})}function v(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>d});var r=a(6540);const t={},i=r.createContext(t);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);