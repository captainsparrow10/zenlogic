"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1027],{4503:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>t,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"arquitectura/multi-tenancy","title":"Multi-tenancy","description":"Introducci\xf3n","source":"@site/docs/01-arquitectura/04-multi-tenancy.md","sourceDirName":"01-arquitectura","slug":"/arquitectura/multi-tenancy","permalink":"/zenlogic/arquitectura/multi-tenancy","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/01-arquitectura/04-multi-tenancy.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"docs","previous":{"title":"Comunicaci\xf3n entre Microservicios","permalink":"/zenlogic/arquitectura/comunicacion-microservicios"},"next":{"title":"Seguridad y RBAC","permalink":"/zenlogic/arquitectura/seguridad-rbac"}}');var s=i(4848),r=i(8453);const t={sidebar_position:5},o="Multi-tenancy",d={},l=[{value:"Introducci\xf3n",id:"introducci\xf3n",level:2},{value:"\xbfQu\xe9 es un Tenant?",id:"qu\xe9-es-un-tenant",level:2},{value:"Ejemplos de Tenants",id:"ejemplos-de-tenants",level:3},{value:"Modelos de Multi-tenancy",id:"modelos-de-multi-tenancy",level:2},{value:"1. Database per Tenant",id:"1-database-per-tenant",level:3},{value:"2. Schema per Tenant",id:"2-schema-per-tenant",level:3},{value:"3. Row-Level Isolation \u2705 (Elegido)",id:"3-row-level-isolation--elegido",level:3},{value:"Implementaci\xf3n en el ERP",id:"implementaci\xf3n-en-el-erp",level:2},{value:"Modelo de Datos",id:"modelo-de-datos",level:3},{value:"\xcdndices Obligatorios",id:"\xedndices-obligatorios",level:3},{value:"Enforcement en C\xf3digo",id:"enforcement-en-c\xf3digo",level:3},{value:"FastAPI Dependency",id:"fastapi-dependency",level:4},{value:"Validaci\xf3n Token + Tenant",id:"validaci\xf3n-token--tenant",level:4},{value:"Row-Level Security (Opcional)",id:"row-level-security-opcional",level:3},{value:"Aislamiento de Datos",id:"aislamiento-de-datos",level:2},{value:"Diagrama de Aislamiento",id:"diagrama-de-aislamiento",level:3},{value:"Garant\xedas de Aislamiento",id:"garant\xedas-de-aislamiento",level:3},{value:"Gesti\xf3n de Organizaciones",id:"gesti\xf3n-de-organizaciones",level:2},{value:"Tabla Organizations",id:"tabla-organizations",level:3},{value:"L\xedmites por Plan",id:"l\xedmites-por-plan",level:3},{value:"Validaci\xf3n de L\xedmites",id:"validaci\xf3n-de-l\xedmites",level:3},{value:"Locales (Sucursales)",id:"locales-sucursales",level:2},{value:"Tabla Locals",id:"tabla-locals",level:3},{value:"Usuarios y Locales",id:"usuarios-y-locales",level:3},{value:"Validaci\xf3n de Acceso a Local",id:"validaci\xf3n-de-acceso-a-local",level:3},{value:"Ejemplos de Queries Multi-tenant",id:"ejemplos-de-queries-multi-tenant",level:2},{value:"Query Correcto \u2705",id:"query-correcto-",level:3},{value:"Query Incorrecto \u274c",id:"query-incorrecto-",level:3},{value:"Query Cross-tenant (Admin Only)",id:"query-cross-tenant-admin-only",level:3},{value:"Migraci\xf3n de Datos entre Tenants",id:"migraci\xf3n-de-datos-entre-tenants",level:2},{value:"Pruebas de Aislamiento",id:"pruebas-de-aislamiento",level:2},{value:"Test Unitario",id:"test-unitario",level:3},{value:"Consideraciones de Performance",id:"consideraciones-de-performance",level:2},{value:"1. \xcdndices por Tenant",id:"1-\xedndices-por-tenant",level:3},{value:"2. Particionamiento (Opcional)",id:"2-particionamiento-opcional",level:3},{value:"3. Cache por Tenant",id:"3-cache-por-tenant",level:3},{value:"Seguridad",id:"seguridad",level:2},{value:"Amenazas y Mitigaciones",id:"amenazas-y-mitigaciones",level:3},{value:"Auditor\xeda de Acceso Cross-tenant",id:"auditor\xeda-de-acceso-cross-tenant",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"multi-tenancy",children:"Multi-tenancy"})}),"\n",(0,s.jsx)(n.h2,{id:"introducci\xf3n",children:"Introducci\xf3n"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Multi-tenancy"})," es la capacidad de un sistema de servir a m\xfaltiples organizaciones (tenants) usando la misma infraestructura, manteniendo sus datos completamente aislados."]}),"\n",(0,s.jsx)(n.h2,{id:"qu\xe9-es-un-tenant",children:"\xbfQu\xe9 es un Tenant?"}),"\n",(0,s.jsxs)(n.p,{children:["En nuestro contexto, un ",(0,s.jsx)(n.strong,{children:"tenant"})," es una ",(0,s.jsx)(n.strong,{children:"organizaci\xf3n"})," que usa el ERP."]}),"\n",(0,s.jsx)(n.h3,{id:"ejemplos-de-tenants",children:"Ejemplos de Tenants"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'Tenant 1: "Empresa Zapatos S.A." (org_001)\n  - 50 usuarios\n  - 3 sucursales\n  - 1,000 productos\n\nTenant 2: "Tienda Ropa Ltda." (org_002)\n  - 10 usuarios\n  - 1 sucursal\n  - 500 productos\n\nTenant 3: "Distribuidora XYZ" (org_003)\n  - 200 usuarios\n  - 15 sucursales\n  - 10,000 productos\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Mismo sistema, datos completamente separados."})}),"\n",(0,s.jsx)(n.h2,{id:"modelos-de-multi-tenancy",children:"Modelos de Multi-tenancy"}),"\n",(0,s.jsx)(n.h3,{id:"1-database-per-tenant",children:"1. Database per Tenant"}),"\n",(0,s.jsx)(n.p,{children:"Cada tenant tiene su propia base de datos."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"org_001_db\norg_002_db\norg_003_db\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ventajas"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 M\xe1ximo aislamiento"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Backup y restore independiente"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 F\xe1cil migraci\xf3n de datos"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Desventajas"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u274c No escala (miles de BDs)"}),"\n",(0,s.jsx)(n.li,{children:"\u274c Alto costo operacional"}),"\n",(0,s.jsx)(n.li,{children:"\u274c Mantenimiento complejo (migraciones en N bases)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-schema-per-tenant",children:"2. Schema per Tenant"}),"\n",(0,s.jsx)(n.p,{children:"Cada tenant tiene su propio schema en la misma BD."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE SCHEMA org_001;\nCREATE SCHEMA org_002;\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ventajas"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 Buen aislamiento"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Una sola BD"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Desventajas"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u274c Complejidad en queries cross-tenant"}),"\n",(0,s.jsx)(n.li,{children:"\u274c Migraciones m\xe1s complejas"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-row-level-isolation--elegido",children:"3. Row-Level Isolation \u2705 (Elegido)"}),"\n",(0,s.jsxs)(n.p,{children:["Todos los tenants comparten las mismas tablas, cada fila tiene ",(0,s.jsx)(n.code,{children:"organization_id"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE products (\n  id VARCHAR PRIMARY KEY,\n  organization_id VARCHAR NOT NULL,  \u2190 Tenant ID\n  title VARCHAR,\n  sku VARCHAR,\n  ...\n);\n\nCREATE INDEX idx_products_org ON products(organization_id);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ventajas"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 Escalable (millones de tenants)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Queries cross-tenant f\xe1ciles (reportes globales)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Migraciones simples"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Menor costo operacional"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Desventajas"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u274c Requiere cuidado en queries (siempre filtrar por org_id)"}),"\n",(0,s.jsx)(n.li,{children:"\u274c Menor aislamiento que database-per-tenant"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"implementaci\xf3n-en-el-erp",children:"Implementaci\xf3n en el ERP"}),"\n",(0,s.jsx)(n.h3,{id:"modelo-de-datos",children:"Modelo de Datos"}),"\n",(0,s.jsxs)(n.p,{children:["Todas las tablas principales incluyen ",(0,s.jsx)(n.code,{children:"organization_id"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Auth Service\nCREATE TABLE users (\n  id VARCHAR PRIMARY KEY,\n  organization_id VARCHAR NOT NULL,\n  email VARCHAR NOT NULL,\n  password_hash VARCHAR,\n  active BOOLEAN,\n  ...\n  CONSTRAINT uk_org_email UNIQUE (organization_id, email)\n);\n\n-- Catalog Service\nCREATE TABLE products (\n  id VARCHAR PRIMARY KEY,\n  organization_id VARCHAR NOT NULL,\n  title VARCHAR,\n  sku VARCHAR,\n  ...\n  CONSTRAINT uk_org_sku UNIQUE (organization_id, sku)\n);\n\n-- Audit Service\nCREATE TABLE audit_logs (\n  id VARCHAR PRIMARY KEY,\n  organization_id VARCHAR NOT NULL,\n  event_type VARCHAR,\n  ...\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\xedndices-obligatorios",children:"\xcdndices Obligatorios"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cada tabla con multi-tenancy DEBE tener"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE INDEX idx_{tabla}_org ON {tabla}(organization_id);\n"})}),"\n",(0,s.jsx)(n.p,{children:"Esto permite queries eficientes por tenant:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- R\xe1pido: usa \xedndice\nSELECT * FROM products\nWHERE organization_id = 'org_123'\nAND sku = 'PROD-001';\n\n-- Lento: full table scan\nSELECT * FROM products\nWHERE sku = 'PROD-001';  \u2190 \u274c Falta filtro por org\n"})}),"\n",(0,s.jsx)(n.h3,{id:"enforcement-en-c\xf3digo",children:"Enforcement en C\xf3digo"}),"\n",(0,s.jsx)(n.h4,{id:"fastapi-dependency",children:"FastAPI Dependency"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from fastapi import Depends, Header, HTTPException\n\nasync def get_organization_id(\n    x_tenant_id: str = Header(..., alias="X-Tenant-ID")\n) -> str:\n    """\n    Extrae organization_id del header X-Tenant-ID\n    Obligatorio en todas las requests\n    """\n    if not x_tenant_id:\n        raise HTTPException(\n            status_code=428,\n            detail="Header X-Tenant-ID es obligatorio"\n        )\n    return x_tenant_id\n\n# Uso en endpoints\n@router.get("/products")\nasync def list_products(\n    org_id: str = Depends(get_organization_id)\n):\n    products = await db.query(Product).filter(\n        Product.organization_id == org_id\n    ).all()\n    return products\n'})}),"\n",(0,s.jsx)(n.h4,{id:"validaci\xf3n-token--tenant",children:"Validaci\xf3n Token + Tenant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'async def verify_request(\n    token: str = Depends(oauth2_scheme),\n    tenant_id: str = Header(..., alias="X-Tenant-ID"),\n    auth_client: AuthClient = Depends()\n):\n    """\n    Valida:\n    1. Token v\xe1lido\n    2. Token pertenece al tenant especificado\n    """\n    user = await auth_client.verify_token(token)\n\n    if user["organization_id"] != tenant_id:\n        raise HTTPException(\n            status_code=403,\n            detail="Token no pertenece a esta organizaci\xf3n"\n        )\n\n    return user\n'})}),"\n",(0,s.jsx)(n.h3,{id:"row-level-security-opcional",children:"Row-Level Security (Opcional)"}),"\n",(0,s.jsx)(n.p,{children:"PostgreSQL soporta pol\xedticas de seguridad a nivel de fila:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Habilitar RLS\nALTER TABLE products ENABLE ROW LEVEL SECURITY;\n\n-- Crear pol\xedtica\nCREATE POLICY tenant_isolation ON products\n  USING (organization_id = current_setting('app.organization_id'));\n\n-- Establecer org_id en sesi\xf3n\nSET app.organization_id = 'org_123';\n\n-- Ahora solo ve filas de org_123\nSELECT * FROM products;  -- Filtrado autom\xe1ticamente\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ventaja"}),": Protecci\xf3n a nivel de BD, imposible de bypassear desde c\xf3digo."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Desventaja"}),": Complejidad adicional, debugging m\xe1s dif\xedcil."]}),"\n",(0,s.jsx)(n.h2,{id:"aislamiento-de-datos",children:"Aislamiento de Datos"}),"\n",(0,s.jsx)(n.h3,{id:"diagrama-de-aislamiento",children:"Diagrama de Aislamiento"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TB\n    subgraph "Tenant A: org_001"\n        UsersA[Usuarios: 50]\n        ProductsA[Productos: 1,000]\n        OrdersA[\xd3rdenes: 5,000]\n    end\n\n    subgraph "Tenant B: org_002"\n        UsersB[Usuarios: 10]\n        ProductsB[Productos: 500]\n        OrdersB[\xd3rdenes: 800]\n    end\n\n    subgraph "PostgreSQL"\n        DB[(Shared Database)]\n    end\n\n    UsersA -.org_001.-> DB\n    ProductsA -.org_001.-> DB\n    OrdersA -.org_001.-> DB\n\n    UsersB -.org_002.-> DB\n    ProductsB -.org_002.-> DB\n    OrdersB -.org_002.-> DB'}),"\n",(0,s.jsx)(n.h3,{id:"garant\xedas-de-aislamiento",children:"Garant\xedas de Aislamiento"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Queries siempre filtrados por organization_id"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Validaci\xf3n en API layer"})," (FastAPI dependencies)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Validaci\xf3n en token"})," (JWT contiene organization_id)"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Header X-Tenant-ID debe coincidir con token"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"\xcdndices optimizados por tenant"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"gesti\xf3n-de-organizaciones",children:"Gesti\xf3n de Organizaciones"}),"\n",(0,s.jsx)(n.h3,{id:"tabla-organizations",children:"Tabla Organizations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:'CREATE TABLE organizations (\n  id VARCHAR PRIMARY KEY,\n  name VARCHAR NOT NULL,\n  slug VARCHAR UNIQUE,\n  plan VARCHAR,  -- basic, pro, enterprise\n  status VARCHAR,  -- active, suspended, inactive\n  limits JSONB,  -- { max_users: 50, max_locals: 5 }\n  modules_enabled JSONB,  -- ["catalog", "inventory", "orders"]\n  created_date TIMESTAMP,\n  updated_date TIMESTAMP\n);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"l\xedmites-por-plan",children:"L\xedmites por Plan"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "basic": {\n    "max_users": 10,\n    "max_locals": 1,\n    "max_products": 1000,\n    "modules": ["catalog"]\n  },\n  "pro": {\n    "max_users": 50,\n    "max_locals": 5,\n    "max_products": 10000,\n    "modules": ["catalog", "inventory", "orders"]\n  },\n  "enterprise": {\n    "max_users": "unlimited",\n    "max_locals": "unlimited",\n    "max_products": "unlimited",\n    "modules": ["all"]\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"validaci\xf3n-de-l\xedmites",children:"Validaci\xf3n de L\xedmites"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'async def check_user_limit(org_id: str):\n    org = await db.get_organization(org_id)\n    current_users = await db.count_users(org_id)\n\n    if current_users >= org.limits["max_users"]:\n        raise LimitExceededError(\n            f"L\xedmite de usuarios alcanzado: {org.limits[\'max_users\']}"\n        )\n'})}),"\n",(0,s.jsx)(n.h2,{id:"locales-sucursales",children:"Locales (Sucursales)"}),"\n",(0,s.jsxs)(n.p,{children:["Cada organizaci\xf3n puede tener m\xfaltiples ",(0,s.jsx)(n.strong,{children:"locales"})," (sucursales, bodegas)."]}),"\n",(0,s.jsx)(n.h3,{id:"tabla-locals",children:"Tabla Locals"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE locals (\n  id VARCHAR PRIMARY KEY,\n  organization_id VARCHAR NOT NULL,  \u2190 Pertenece a un tenant\n  name VARCHAR,\n  code VARCHAR,\n  address TEXT,\n  status VARCHAR,\n  ...\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"usuarios-y-locales",children:"Usuarios y Locales"}),"\n",(0,s.jsx)(n.p,{children:"Un usuario puede tener acceso a uno o m\xe1s locales:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE user_local (\n  user_id VARCHAR,\n  local_id VARCHAR,\n  PRIMARY KEY (user_id, local_id)\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"validaci\xf3n-de-acceso-a-local",children:"Validaci\xf3n de Acceso a Local"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'async def validate_local_access(user_id: str, local_id: str):\n    """Valida que usuario tenga acceso al local"""\n    has_access = await db.query(\n        UserLocal\n    ).filter(\n        UserLocal.user_id == user_id,\n        UserLocal.local_id == local_id\n    ).exists()\n\n    if not has_access:\n        raise ForbiddenError(\n            f"Usuario no tiene acceso al local {local_id}"\n        )\n'})}),"\n",(0,s.jsx)(n.h2,{id:"ejemplos-de-queries-multi-tenant",children:"Ejemplos de Queries Multi-tenant"}),"\n",(0,s.jsx)(n.h3,{id:"query-correcto-",children:"Query Correcto \u2705"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# Siempre filtrar por organization_id\nproducts = await db.query(Product).filter(\n    Product.organization_id == org_id,  \u2190 Obligatorio\n    Product.status == "active"\n).all()\n'})}),"\n",(0,s.jsx)(n.h3,{id:"query-incorrecto-",children:"Query Incorrecto \u274c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# \u274c NUNCA hacer queries sin filtro por org_id\nproducts = await db.query(Product).filter(\n    Product.sku == "PROD-001"\n).first()  # Puede retornar producto de otro tenant!\n'})}),"\n",(0,s.jsx)(n.h3,{id:"query-cross-tenant-admin-only",children:"Query Cross-tenant (Admin Only)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"# Solo para super admin del sistema\nif user.is_system_admin:\n    # Puede ver todos los tenants\n    all_orgs = await db.query(Organization).all()\n"})}),"\n",(0,s.jsx)(n.h2,{id:"migraci\xf3n-de-datos-entre-tenants",children:"Migraci\xf3n de Datos entre Tenants"}),"\n",(0,s.jsx)(n.p,{children:"Si un tenant necesita migrar datos:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'async def migrate_tenant_data(\n    from_org_id: str,\n    to_org_id: str\n):\n    """\n    Migra todos los datos de un tenant a otro\n    \xdatil para fusiones de empresas\n    """\n    # Migrar usuarios\n    await db.execute(\n        f"UPDATE users SET organization_id = \'{to_org_id}\' "\n        f"WHERE organization_id = \'{from_org_id}\'"\n    )\n\n    # Migrar productos\n    await db.execute(\n        f"UPDATE products SET organization_id = \'{to_org_id}\' "\n        f"WHERE organization_id = \'{from_org_id}\'"\n    )\n\n    # ... migrar todas las entidades\n'})}),"\n",(0,s.jsx)(n.h2,{id:"pruebas-de-aislamiento",children:"Pruebas de Aislamiento"}),"\n",(0,s.jsx)(n.h3,{id:"test-unitario",children:"Test Unitario"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'async def test_tenant_isolation():\n    """Verifica que un tenant no ve datos de otro"""\n\n    # Crear producto para org_001\n    product_org1 = await create_product(\n        organization_id="org_001",\n        title="Producto A"\n    )\n\n    # Crear producto para org_002\n    product_org2 = await create_product(\n        organization_id="org_002",\n        title="Producto B"\n    )\n\n    # Listar productos de org_001\n    products = await list_products(organization_id="org_001")\n\n    # Debe ver solo su producto\n    assert len(products) == 1\n    assert products[0].id == product_org1.id\n    assert products[0].organization_id == "org_001"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"consideraciones-de-performance",children:"Consideraciones de Performance"}),"\n",(0,s.jsx)(n.h3,{id:"1-\xedndices-por-tenant",children:"1. \xcdndices por Tenant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \xcdndice compuesto para queries frecuentes\nCREATE INDEX idx_products_org_sku\nON products(organization_id, sku);\n\n-- Query optimizado\nSELECT * FROM products\nWHERE organization_id = 'org_123' AND sku = 'PROD-001';\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-particionamiento-opcional",children:"2. Particionamiento (Opcional)"}),"\n",(0,s.jsx)(n.p,{children:"Para tenants muy grandes:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Particionar por organization_id\nCREATE TABLE products_org_001\nPARTITION OF products\nFOR VALUES IN ('org_001');\n\nCREATE TABLE products_org_002\nPARTITION OF products\nFOR VALUES IN ('org_002');\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-cache-por-tenant",children:"3. Cache por Tenant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# Cache key incluye organization_id\ncache_key = f"products:{org_id}:{product_id}"\nproduct = await redis.get(cache_key)\n'})}),"\n",(0,s.jsx)(n.h2,{id:"seguridad",children:"Seguridad"}),"\n",(0,s.jsx)(n.h3,{id:"amenazas-y-mitigaciones",children:"Amenazas y Mitigaciones"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Amenaza"}),(0,s.jsx)(n.th,{children:"Mitigaci\xf3n"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Tenant A accede a datos de Tenant B"})}),(0,s.jsx)(n.td,{children:"Validaci\xf3n estricta de organization_id en todos los queries"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Token de un tenant usado en otro"})}),(0,s.jsx)(n.td,{children:"Validar que token.org_id == header.X-Tenant-ID"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Query sin filtro por org_id"})}),(0,s.jsx)(n.td,{children:"Code review, linting, tests"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"SQL Injection"})}),(0,s.jsx)(n.td,{children:"ORM (SQLAlchemy), prepared statements"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"auditor\xeda-de-acceso-cross-tenant",children:"Auditor\xeda de Acceso Cross-tenant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'async def audit_potential_breach(\n    user_id: str,\n    requested_org_id: str,\n    user_org_id: str\n):\n    """Registra intentos de acceso cross-tenant"""\n    if requested_org_id != user_org_id:\n        await audit_log.critical(\n            event="CROSS_TENANT_ATTEMPT",\n            user_id=user_id,\n            user_org=user_org_id,\n            requested_org=requested_org_id\n        )\n        raise ForbiddenError("Acceso denegado")\n'})}),"\n",(0,s.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/arquitectura/seguridad-rbac",children:"Seguridad y RBAC"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/auth-service/api-organizations",children:"Auth Service - Organizations"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/auth-service/api-locals",children:"Auth Service - Locals"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/decisiones-arquitectura/adr-006-postgresql-multi-tenant",children:"ADR-006: PostgreSQL Multi-tenant"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/integraciones/04-postgresql",children:"Integraciones - PostgreSQL"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>o});var a=i(6540);const s={},r=a.createContext(s);function t(e){const n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);