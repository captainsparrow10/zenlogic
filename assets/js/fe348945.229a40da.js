"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[3465],{160:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>v,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"microservicios/inventory-service/eventos-consumidos","title":"Eventos Consumidos","description":"Eventos externos que el Inventory Service consume desde otros microservicios para mantener sincronizaci\xf3n y ejecutar acciones autom\xe1ticas.","source":"@site/docs/02-microservicios/inventory-service/15-eventos-consumidos.md","sourceDirName":"02-microservicios/inventory-service","slug":"/microservicios/inventory-service/eventos-consumidos","permalink":"/zenlogic/microservicios/inventory-service/eventos-consumidos","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/inventory-service/15-eventos-consumidos.md","tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"sidebar_position":15},"sidebar":"docs","previous":{"title":"Eventos Publicados","permalink":"/zenlogic/microservicios/inventory-service/eventos-publicados"},"next":{"title":"Integraciones","permalink":"/zenlogic/microservicios/inventory-service/integraciones"}}');var i=r(4848),a=r(8453);const s={sidebar_position:15},o="Eventos Consumidos",d={},c=[{value:"Configuraci\xf3n de Consumidores",id:"configuraci\xf3n-de-consumidores",level:2},{value:"RabbitMQ Setup",id:"rabbitmq-setup",level:3},{value:"Catalog Service Events",id:"catalog-service-events",level:2},{value:"catalog.variant.created",id:"catalogvariantcreated",level:3},{value:"catalog.variant.updated",id:"catalogvariantupdated",level:3},{value:"catalog.variant.deleted",id:"catalogvariantdeleted",level:3},{value:"catalog.product.deleted",id:"catalogproductdeleted",level:3},{value:"Order Service Events",id:"order-service-events",level:2},{value:"order.placed",id:"orderplaced",level:3},{value:"order.confirmed",id:"orderconfirmed",level:3},{value:"order.cancelled",id:"ordercancelled",level:3},{value:"order.shipped",id:"ordershipped",level:3},{value:"return.received",id:"returnreceived",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Retry Policy",id:"retry-policy",level:3},{value:"Dead Letter Queue",id:"dead-letter-queue",level:3},{value:"Idempotency",id:"idempotency",level:3},{value:"Monitoring y Observabilidad",id:"monitoring-y-observabilidad",level:2},{value:"M\xe9tricas",id:"m\xe9tricas",level:3},{value:"Logging",id:"logging",level:3},{value:"Testing",id:"testing",level:2},{value:"Mock Events",id:"mock-events",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"eventos-consumidos",children:"Eventos Consumidos"})}),"\n",(0,i.jsx)(n.p,{children:"Eventos externos que el Inventory Service consume desde otros microservicios para mantener sincronizaci\xf3n y ejecutar acciones autom\xe1ticas."}),"\n",(0,i.jsx)(n.h2,{id:"configuraci\xf3n-de-consumidores",children:"Configuraci\xf3n de Consumidores"}),"\n",(0,i.jsx)(n.h3,{id:"rabbitmq-setup",children:"RabbitMQ Setup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Event consumer configuration\nCONSUMER_CONFIG = {\n    'catalog_events': {\n        'exchange': 'catalog_events',\n        'exchange_type': 'topic',\n        'queue': 'inventory_catalog_consumer',\n        'routing_keys': [\n            'catalog.variant.created',\n            'catalog.variant.updated',\n            'catalog.variant.deleted',\n            'catalog.product.deleted'\n        ],\n        'prefetch_count': 10,\n        'auto_ack': False\n    },\n    'order_events': {\n        'exchange': 'order_events',\n        'exchange_type': 'topic',\n        'queue': 'inventory_order_consumer',\n        'routing_keys': [\n            'order.placed',\n            'order.confirmed',\n            'order.cancelled',\n            'order.shipped',\n            'return.received'\n        ],\n        'prefetch_count': 20,\n        'auto_ack': False\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"catalog-service-events",children:"Catalog Service Events"}),"\n",(0,i.jsx)(n.h3,{id:"catalogvariantcreated",children:"catalog.variant.created"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Nueva variante creada en Catalog Service"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Inicializar registros de stock en todas las bodegas activas"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.variant.created",\n  "version": "1.0",\n  "timestamp": "2025-11-23T15:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "variant_id": "var_789",\n    "product_id": "prod_456",\n    "sku": "PROD-001-RED-M",\n    "track_inventory": true,\n    "default_min_stock": 20,\n    "default_max_stock": 200\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_variant_created(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Initialize stock records for new variant in all active warehouses.\n    \"\"\"\n    variant_id = event['data']['variant_id']\n    organization_id = event['organization_id']\n    track_inventory = event['data'].get('track_inventory', True)\n\n    if not track_inventory:\n        logger.info(f\"Variant {variant_id} does not track inventory. Skipping.\")\n        return\n\n    # Get all active warehouses for this organization\n    warehouses = await warehouse_service.get_active_warehouses(\n        organization_id=organization_id\n    )\n\n    # Create stock records\n    stock_records = []\n    for warehouse in warehouses:\n        stock = Stock(\n            stock_id=generate_uuid(),\n            organization_id=organization_id,\n            variant_id=variant_id,\n            warehouse_id=warehouse.warehouse_id,\n            total_quantity=0,\n            available_quantity=0,\n            reserved_quantity=0,\n            damaged_quantity=0,\n            in_transit_quantity=0,\n            min_stock=event['data'].get('default_min_stock', 0),\n            max_stock=event['data'].get('default_max_stock', 999999),\n            stock_strategy='FIFO',\n            created_at=datetime.utcnow()\n        )\n        stock_records.append(stock)\n\n    # Bulk insert\n    await stock_service.bulk_create(stock_records)\n\n    # Publish confirmation event\n    await publish_event('inventory.stock.initialized', {\n        'variant_id': variant_id,\n        'warehouses_count': len(warehouses),\n        'stock_records_created': len(stock_records)\n    })\n\n    logger.info(f\"Initialized stock for variant {variant_id} in {len(warehouses)} warehouses\")\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Error Handling:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Warehouse not found:"})," Log warning, continue with available warehouses"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Duplicate stock record:"})," Skip, log as already initialized"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Database error:"})," Retry with exponential backoff (max 3 retries)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Validation error:"})," Send to dead letter queue for manual review"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"catalogvariantupdated",children:"catalog.variant.updated"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Variante actualizada (ej: SKU, tracking status)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Actualizar configuraci\xf3n de stock si aplica"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.variant.updated",\n  "data": {\n    "variant_id": "var_789",\n    "changes": {\n      "sku": {\n        "old": "PROD-001-RED-M",\n        "new": "PROD-001-ROJO-M"\n      },\n      "track_inventory": {\n        "old": false,\n        "new": true\n      }\n    }\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_variant_updated(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Update stock configuration when variant tracking changes.\n    \"\"\"\n    variant_id = event['data']['variant_id']\n    changes = event['data']['changes']\n\n    # Check if inventory tracking was enabled\n    if 'track_inventory' in changes:\n        old_value = changes['track_inventory']['old']\n        new_value = changes['track_inventory']['new']\n\n        if not old_value and new_value:\n            # Tracking was enabled, initialize stock\n            await handle_variant_created(event)\n        elif old_value and not new_value:\n            # Tracking was disabled, verify zero stock\n            stock_records = await stock_service.get_by_variant(variant_id)\n            has_stock = any(s.total_quantity > 0 for s in stock_records)\n\n            if has_stock:\n                raise ValueError(\n                    f\"Cannot disable tracking for variant {variant_id}. \"\n                    f\"Stock must be zero in all warehouses.\"\n                )\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"catalogvariantdeleted",children:"catalog.variant.deleted"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Variante eliminada (soft delete)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Validar stock cero y archivar registros"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.variant.deleted",\n  "data": {\n    "variant_id": "var_789",\n    "product_id": "prod_456",\n    "deletion_type": "soft",\n    "deleted_by": "user_123"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def handle_variant_deleted(event: Dict[str, Any]) -> None:\n    """\n    Archive stock records when variant is deleted.\n    Validates that all stock is zero before archiving.\n    """\n    variant_id = event[\'data\'][\'variant_id\']\n    organization_id = event[\'organization_id\']\n\n    # Get all stock records for this variant\n    stock_records = await stock_service.get_by_variant(\n        variant_id=variant_id,\n        organization_id=organization_id\n    )\n\n    # Validate all stock is zero\n    for stock in stock_records:\n        if stock.total_quantity != 0:\n            raise ValueError(\n                f"Cannot delete variant {variant_id}. "\n                f"Warehouse {stock.warehouse_id} has {stock.total_quantity} units. "\n                f"Stock must be zero before deletion."\n            )\n\n    # Archive stock records (soft delete)\n    await stock_service.archive_by_variant(variant_id)\n\n    # Publish confirmation\n    await publish_event(\'inventory.stock.archived\', {\n        \'variant_id\': variant_id,\n        \'records_archived\': len(stock_records)\n    })\n\n    logger.info(f"Archived {len(stock_records)} stock records for variant {variant_id}")\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Validation Errors:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "error": "STOCK_NOT_ZERO",\n  "message": "Cannot delete variant with existing stock",\n  "details": {\n    "variant_id": "var_789",\n    "warehouses_with_stock": [\n      {\n        "warehouse_id": "wh_101",\n        "warehouse_name": "Bodega Principal",\n        "total_quantity": 45,\n        "available": 30,\n        "reserved": 15\n      }\n    ],\n    "action_required": "Clear all stock before deleting variant"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"catalogproductdeleted",children:"catalog.product.deleted"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Producto completo eliminado (afecta todas las variantes)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Validar y archivar stock de todas las variantes del producto"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "catalog.product.deleted",\n  "data": {\n    "product_id": "prod_456",\n    "variant_ids": ["var_789", "var_790", "var_791"],\n    "deleted_by": "user_123"\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Handler:"})," Llama a ",(0,i.jsx)(n.code,{children:"handle_variant_deleted"})," para cada variante"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"order-service-events",children:"Order Service Events"}),"\n",(0,i.jsx)(n.h3,{id:"orderplaced",children:"order.placed"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Orden creada pero no confirmada (pendiente de pago)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Reservar stock temporalmente"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "order.placed",\n  "version": "1.0",\n  "timestamp": "2025-11-23T15:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "order_id": "order_456",\n    "customer_id": "cust_789",\n    "local_id": "local_101",\n    "items": [\n      {\n        "variant_id": "var_789",\n        "quantity": 2,\n        "preferred_warehouse_id": "wh_101"\n      }\n    ],\n    "reservation_ttl_minutes": 15\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_order_placed(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Reserve stock for placed order with TTL.\n    \"\"\"\n    order_id = event['data']['order_id']\n    items = event['data']['items']\n    ttl_minutes = event['data'].get('reservation_ttl_minutes', 15)\n    organization_id = event['organization_id']\n\n    reservation_items = []\n\n    for item in items:\n        variant_id = item['variant_id']\n        quantity = item['quantity']\n        warehouse_id = item.get('preferred_warehouse_id')\n\n        # Find available stock\n        if warehouse_id:\n            # Try preferred warehouse first\n            stock = await stock_service.get_stock(\n                variant_id=variant_id,\n                warehouse_id=warehouse_id,\n                organization_id=organization_id\n            )\n        else:\n            # Find warehouse with most available stock\n            stock = await stock_service.find_best_warehouse(\n                variant_id=variant_id,\n                quantity=quantity,\n                organization_id=organization_id\n            )\n\n        if not stock or stock.available_quantity < quantity:\n            # Insufficient stock\n            await publish_event('inventory.reservation.failed', {\n                'order_id': order_id,\n                'variant_id': variant_id,\n                'requested': quantity,\n                'available': stock.available_quantity if stock else 0,\n                'reason': 'insufficient_stock'\n            })\n            raise InsufficientStockError(\n                f\"Insufficient stock for variant {variant_id}. \"\n                f\"Requested: {quantity}, Available: {stock.available_quantity if stock else 0}\"\n            )\n\n        reservation_items.append({\n            'stock_id': stock.stock_id,\n            'variant_id': variant_id,\n            'warehouse_id': stock.warehouse_id,\n            'quantity': quantity\n        })\n\n    # Create reservation\n    reservation = await reservation_service.create(\n        reservation_id=generate_uuid(),\n        order_id=order_id,\n        organization_id=organization_id,\n        items=reservation_items,\n        expires_at=datetime.utcnow() + timedelta(minutes=ttl_minutes),\n        status='active'\n    )\n\n    # Update stock quantities (available -> reserved)\n    for item in reservation_items:\n        await stock_service.reserve_quantity(\n            stock_id=item['stock_id'],\n            quantity=item['quantity']\n        )\n\n    # Publish success event\n    await publish_event('inventory.stock.reserved', {\n        'reservation_id': reservation.reservation_id,\n        'order_id': order_id,\n        'items': reservation_items,\n        'expires_at': reservation.expires_at.isoformat()\n    })\n\n    # Schedule auto-release job\n    await scheduler.schedule_task(\n        task='release_expired_reservation',\n        execute_at=reservation.expires_at,\n        args={'reservation_id': reservation.reservation_id}\n    )\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"orderconfirmed",children:"order.confirmed"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Orden confirmada (pago exitoso)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Convertir reserva temporal en permanente"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "order.confirmed",\n  "data": {\n    "order_id": "order_456",\n    "reservation_id": "res_123",\n    "payment_confirmed": true\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_order_confirmed(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Convert temporary reservation to permanent.\n    \"\"\"\n    order_id = event['data']['order_id']\n    reservation_id = event['data']['reservation_id']\n\n    # Update reservation status\n    await reservation_service.confirm(reservation_id)\n\n    # Remove TTL (no auto-release)\n    await scheduler.cancel_task(\n        task='release_expired_reservation',\n        args={'reservation_id': reservation_id}\n    )\n\n    logger.info(f\"Order {order_id} confirmed. Reservation {reservation_id} is now permanent.\")\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"ordercancelled",children:"order.cancelled"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Orden cancelada antes de env\xedo"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Liberar stock reservado"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "order.cancelled",\n  "data": {\n    "order_id": "order_456",\n    "reservation_id": "res_123",\n    "cancellation_reason": "customer_request",\n    "cancelled_by": "user_789"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_order_cancelled(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Release reserved stock when order is cancelled.\n    \"\"\"\n    order_id = event['data']['order_id']\n    reservation_id = event['data']['reservation_id']\n    reason = event['data'].get('cancellation_reason', 'unknown')\n\n    # Get reservation details\n    reservation = await reservation_service.get(reservation_id)\n\n    if not reservation:\n        logger.warning(f\"Reservation {reservation_id} not found. May be already released.\")\n        return\n\n    # Release stock (reserved -> available)\n    for item in reservation.items:\n        await stock_service.release_quantity(\n            stock_id=item['stock_id'],\n            quantity=item['quantity']\n        )\n\n    # Update reservation status\n    await reservation_service.cancel(reservation_id, reason=reason)\n\n    # Publish event\n    await publish_event('inventory.stock.released', {\n        'reservation_id': reservation_id,\n        'order_id': order_id,\n        'reason': reason,\n        'items_released': len(reservation.items)\n    })\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"ordershipped",children:"order.shipped"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Orden enviada al cliente"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Descontar stock reservado (reserved -> out movement)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "order.shipped",\n  "data": {\n    "order_id": "order_456",\n    "reservation_id": "res_123",\n    "shipment_id": "ship_789",\n    "shipped_items": [\n      {\n        "variant_id": "var_789",\n        "quantity": 2,\n        "warehouse_id": "wh_101"\n      }\n    ]\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_order_shipped(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Deduct stock when order is shipped.\n    Creates outbound movements and updates stock quantities.\n    \"\"\"\n    order_id = event['data']['order_id']\n    reservation_id = event['data']['reservation_id']\n    shipment_id = event['data']['shipment_id']\n    items = event['data']['shipped_items']\n    organization_id = event['organization_id']\n\n    movements = []\n\n    for item in items:\n        variant_id = item['variant_id']\n        quantity = item['quantity']\n        warehouse_id = item['warehouse_id']\n\n        # Get stock record\n        stock = await stock_service.get_stock(\n            variant_id=variant_id,\n            warehouse_id=warehouse_id,\n            organization_id=organization_id\n        )\n\n        # Create outbound movement\n        movement = StockMovement(\n            movement_id=generate_uuid(),\n            organization_id=organization_id,\n            stock_id=stock.stock_id,\n            variant_id=variant_id,\n            warehouse_id=warehouse_id,\n            movement_type='out',\n            quantity_change=-quantity,\n            quantity_before=stock.total_quantity,\n            quantity_after=stock.total_quantity - quantity,\n            reason='order_shipment',\n            reference_type='order',\n            reference_id=order_id,\n            notes=f\"Shipped via {shipment_id}\",\n            created_at=datetime.utcnow()\n        )\n        movements.append(movement)\n\n        # Update stock (reserved -> out)\n        await stock_service.deduct_reserved(\n            stock_id=stock.stock_id,\n            quantity=quantity\n        )\n\n    # Bulk insert movements\n    await movement_service.bulk_create(movements)\n\n    # Release reservation\n    await reservation_service.fulfill(reservation_id)\n\n    # Publish events\n    for movement in movements:\n        await publish_event('inventory.movement.out', {\n            'movement_id': movement.movement_id,\n            'variant_id': movement.variant_id,\n            'warehouse_id': movement.warehouse_id,\n            'quantity': abs(movement.quantity_change),\n            'reason': 'order_shipment',\n            'order_id': order_id\n        })\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"returnreceived",children:"return.received"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trigger:"})," Cliente devuelve orden y productos son recibidos en bodega"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Acci\xf3n:"})," Registrar entrada y reevaluar calidad"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "event": "return.received",\n  "version": "1.0",\n  "timestamp": "2025-11-28T14:00:00Z",\n  "organization_id": "org_123",\n  "data": {\n    "order_id": "order_456",\n    "return_id": "ret_123",\n    "rma_number": "RMA-2025-0001",\n    "warehouse_id": "wh_101",\n    "returned_items": [\n      {\n        "variant_id": "var_789",\n        "quantity": 1,\n        "condition": "good",\n        "return_reason": "wrong_size"\n      }\n    ],\n    "received_at": "2025-11-28T14:00:00Z"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handler Implementation:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_return_received(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Process returned items and update stock accordingly.\n    \"\"\"\n    return_id = event['data']['return_id']\n    order_id = event['data']['order_id']\n    items = event['data']['returned_items']\n    organization_id = event['organization_id']\n\n    for item in items:\n        variant_id = item['variant_id']\n        quantity = item['quantity']\n        condition = item['condition']  # good, damaged, defective\n        warehouse_id = item['warehouse_id']\n\n        # Determine stock category based on condition\n        if condition == 'good':\n            category = 'available'\n        else:\n            category = 'damaged'\n\n        # Create inbound movement\n        await movement_service.create_in(\n            variant_id=variant_id,\n            warehouse_id=warehouse_id,\n            quantity=quantity,\n            reason='customer_return',\n            reference_type='return',\n            reference_id=return_id,\n            stock_category=category,\n            notes=f\"Return from order {order_id}. Condition: {condition}\"\n        )\n\n        # Update stock in appropriate category\n        await stock_service.add_quantity(\n            variant_id=variant_id,\n            warehouse_id=warehouse_id,\n            quantity=quantity,\n            category=category\n        )\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.h3,{id:"retry-policy",children:"Retry Policy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"RETRY_CONFIG = {\n    'max_retries': 3,\n    'retry_backoff': 'exponential',  # 1s, 2s, 4s\n    'retry_on': [\n        'DatabaseError',\n        'ConnectionError',\n        'TimeoutError'\n    ],\n    'dead_letter_on': [\n        'ValidationError',\n        'InsufficientStockError',\n        'DuplicateRecordError'\n    ]\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"dead-letter-queue",children:"Dead Letter Queue"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Events that cannot be processed go to DLQ\nDEAD_LETTER_CONFIG = {\n    'exchange': 'inventory_dlq',\n    'queue': 'inventory_failed_events',\n    'ttl': 86400000,  # 24 hours\n    'max_length': 10000\n}\n\n# DLQ monitoring\nasync def monitor_dead_letter_queue():\n    \"\"\"Alert when DLQ has items.\"\"\"\n    queue_size = await rabbitmq.get_queue_size('inventory_failed_events')\n\n    if queue_size > 100:\n        await alert_service.send_alert(\n            level='critical',\n            message=f\"Inventory DLQ has {queue_size} failed events\",\n            action_required=\"Review and reprocess failed events\"\n        )\n"})}),"\n",(0,i.jsx)(n.h3,{id:"idempotency",children:"Idempotency"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def consume_event_with_idempotency(event: Dict[str, Any]) -> None:\n    \"\"\"\n    Process event with idempotency check.\n    \"\"\"\n    event_id = event.get('event_id') or event.get('message_id')\n\n    # Check if already processed\n    if await event_log_service.exists(event_id):\n        logger.info(f\"Event {event_id} already processed. Skipping.\")\n        return\n\n    # Process event\n    try:\n        await process_event(event)\n\n        # Log as processed\n        await event_log_service.create(\n            event_id=event_id,\n            event_type=event['event'],\n            processed_at=datetime.utcnow(),\n            status='success'\n        )\n    except Exception as e:\n        await event_log_service.create(\n            event_id=event_id,\n            event_type=event['event'],\n            processed_at=datetime.utcnow(),\n            status='failed',\n            error=str(e)\n        )\n        raise\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"monitoring-y-observabilidad",children:"Monitoring y Observabilidad"}),"\n",(0,i.jsx)(n.h3,{id:"m\xe9tricas",children:"M\xe9tricas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Prometheus metrics\ninventory_events_consumed = Counter(\n    'inventory_events_consumed_total',\n    'Total events consumed',\n    ['event_type', 'source_service']\n)\n\ninventory_event_processing_duration = Histogram(\n    'inventory_event_processing_seconds',\n    'Event processing duration',\n    ['event_type']\n)\n\ninventory_event_errors = Counter(\n    'inventory_event_errors_total',\n    'Event processing errors',\n    ['event_type', 'error_type']\n)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"logger.info(\n    \"Event consumed\",\n    extra={\n        'event_type': event['event'],\n        'event_id': event.get('event_id'),\n        'source': event.get('source'),\n        'organization_id': event.get('organization_id'),\n        'processing_time_ms': processing_time\n    }\n)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsx)(n.h3,{id:"mock-events",children:"Mock Events"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Test helper\nasync def publish_mock_event(\n    event_type: str,\n    data: Dict[str, Any],\n    organization_id: str = \"test_org\"\n) -> None:\n    \"\"\"Publish test event to RabbitMQ.\"\"\"\n    event = {\n        'event': event_type,\n        'version': '1.0',\n        'timestamp': datetime.utcnow().isoformat(),\n        'organization_id': organization_id,\n        'event_id': generate_uuid(),\n        'data': data\n    }\n\n    await rabbitmq.publish(\n        exchange=get_exchange_for_event(event_type),\n        routing_key=event_type,\n        message=event\n    )\n\n# Test example\n@pytest.mark.asyncio\nasync def test_variant_created_handler():\n    \"\"\"Test stock initialization when variant is created.\"\"\"\n    # Publish mock event\n    await publish_mock_event('catalog.variant.created', {\n        'variant_id': 'test_var_123',\n        'product_id': 'test_prod_456',\n        'sku': 'TEST-SKU',\n        'track_inventory': True,\n        'default_min_stock': 10\n    })\n\n    # Wait for processing\n    await asyncio.sleep(1)\n\n    # Verify stock records created\n    stock_records = await stock_service.get_by_variant('test_var_123')\n    assert len(stock_records) > 0\n    assert all(s.min_stock == 10 for s in stock_records)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./integraciones",children:"Integraciones"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./errores-comunes",children:"Errores Comunes"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./flujos-negocio",children:"Flujos de Negocio"})}),"\n"]})]})}function v(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>o});var t=r(6540);const i={},a=t.createContext(i);function s(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);