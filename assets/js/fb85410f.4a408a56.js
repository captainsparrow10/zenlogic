"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[3501],{2492:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"microservicios/auth-service/flujos-negocio","title":"Flujos de Negocio","description":"Diagramas de flujos principales de Auth Service.","source":"@site/docs/02-microservicios/auth-service/13-flujos-negocio.md","sourceDirName":"02-microservicios/auth-service","slug":"/microservicios/auth-service/flujos-negocio","permalink":"/zenlogic/microservicios/auth-service/flujos-negocio","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/auth-service/13-flujos-negocio.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14},"sidebar":"docs","previous":{"title":"API - Organizations","permalink":"/zenlogic/microservicios/auth-service/api-organizations"},"next":{"title":"Catalog Service - Overview","permalink":"/zenlogic/microservicios/catalog-service/overview"}}');var o=i(4848),a=i(8453);const s={sidebar_position:14},t="Flujos de Negocio",c={},d=[{value:"Flujo de Login",id:"flujo-de-login",level:2},{value:"Flujo de Verificaci\xf3n de Token (gRPC)",id:"flujo-de-verificaci\xf3n-de-token-grpc",level:2},{value:"Flujo de Creaci\xf3n de Usuario",id:"flujo-de-creaci\xf3n-de-usuario",level:2},{value:"Flujo de Asignaci\xf3n de Permisos a Rol",id:"flujo-de-asignaci\xf3n-de-permisos-a-rol",level:2},{value:"Flujo de Logout",id:"flujo-de-logout",level:2},{value:"Flujo de Cambio de Plan de Organizaci\xf3n",id:"flujo-de-cambio-de-plan-de-organizaci\xf3n",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",p:"p",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"flujos-de-negocio",children:"Flujos de Negocio"})}),"\n",(0,o.jsx)(n.p,{children:"Diagramas de flujos principales de Auth Service."}),"\n",(0,o.jsx)(n.h2,{id:"flujo-de-login",children:"Flujo de Login"}),"\n",(0,o.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Client\n    participant API\n    participant AuthService\n    participant UserRepo\n    participant Crypto\n    participant TokenService\n    participant Redis\n    participant EventPub\n\n    Client->>API: POST /auth/login<br/>{email, password}\n    API->>AuthService: login(email, password)\n\n    AuthService->>UserRepo: get_by_email(email)\n    UserRepo--\x3e>AuthService: User\n\n    alt Usuario no encontrado\n        AuthService--\x3e>API: InvalidCredentialsError\n        API--\x3e>Client: 401 Unauthorized\n    end\n\n    AuthService->>Crypto: verify_password(password, hash)\n    Crypto--\x3e>AuthService: valid=True\n\n    alt Contrase\xf1a inv\xe1lida\n        AuthService->>Redis: INCR failed_login:user_id\n        alt >= 5 intentos\n            AuthService->>UserRepo: update(locked=True)\n            AuthService--\x3e>API: UserLockedError\n            API--\x3e>Client: 423 Locked\n        else\n            AuthService--\x3e>API: InvalidCredentialsError\n            API--\x3e>Client: 401 Unauthorized\n        end\n    end\n\n    alt Usuario inactivo\n        AuthService--\x3e>API: UserInactiveError\n        API--\x3e>Client: 403 Forbidden\n    end\n\n    AuthService->>TokenService: create_access_token(user)\n    TokenService--\x3e>AuthService: access_token\n\n    AuthService->>TokenService: create_refresh_token(user)\n    TokenService->>Redis: SETEX refresh_token\n    TokenService--\x3e>AuthService: refresh_token\n\n    AuthService->>EventPub: publish("auth.session.created")\n\n    AuthService--\x3e>API: {access_token, refresh_token, user}\n    API--\x3e>Client: 200 OK + tokens'}),"\n",(0,o.jsx)(n.h2,{id:"flujo-de-verificaci\xf3n-de-token-grpc",children:"Flujo de Verificaci\xf3n de Token (gRPC)"}),"\n",(0,o.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant CatalogService\n    participant AuthGRPC\n    participant TokenService\n    participant Redis\n    participant UserRepo\n    participant DB\n\n    CatalogService->>AuthGRPC: VerifyToken(token)\n    AuthGRPC->>TokenService: verify_token(token)\n\n    TokenService->>Redis: EXISTS blacklist:{token}\n    alt Token en blacklist\n        Redis--\x3e>TokenService: True\n        TokenService--\x3e>AuthGRPC: TokenRevokedError\n        AuthGRPC--\x3e>CatalogService: UNAUTHENTICATED\n    end\n\n    TokenService->>TokenService: jwt.decode(token, public_key)\n    alt Firma inv\xe1lida\n        TokenService--\x3e>AuthGRPC: InvalidTokenError\n        AuthGRPC--\x3e>CatalogService: UNAUTHENTICATED\n    end\n\n    alt Token expirado\n        TokenService--\x3e>AuthGRPC: TokenExpiredError\n        AuthGRPC--\x3e>CatalogService: UNAUTHENTICATED\n    end\n\n    TokenService->>Redis: GET user:{user_id}\n    alt Cache hit\n        Redis--\x3e>TokenService: User data\n    else Cache miss\n        TokenService->>UserRepo: get_by_id(user_id)\n        UserRepo->>DB: SELECT * FROM users\n        DB--\x3e>UserRepo: User\n        UserRepo--\x3e>TokenService: User\n        TokenService->>Redis: SETEX user:{user_id}\n    end\n\n    alt Usuario inactivo\n        TokenService--\x3e>AuthGRPC: UserInactiveError\n        AuthGRPC--\x3e>CatalogService: PERMISSION_DENIED\n    end\n\n    TokenService--\x3e>AuthGRPC: User data\n    AuthGRPC--\x3e>CatalogService: VerifyTokenResponse{...}"}),"\n",(0,o.jsx)(n.h2,{id:"flujo-de-creaci\xf3n-de-usuario",children:"Flujo de Creaci\xf3n de Usuario"}),"\n",(0,o.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Admin\n    participant API\n    participant UserService\n    participant OrgService\n    participant Crypto\n    participant UserRepo\n    participant EventPub\n\n    Admin->>API: POST /api/v1/users<br/>{email, password, roles, locals}\n    API->>UserService: create_user(data, admin)\n\n    UserService->>OrgService: check_user_limit(org_id)\n    alt L\xedmite excedido\n        OrgService--\x3e>UserService: LimitExceededError\n        UserService--\x3e>API: Error\n        API--\x3e>Admin: 400 Bad Request\n    end\n\n    UserService->>UserRepo: get_by_email(email)\n    alt Email ya existe\n        UserRepo--\x3e>UserService: User exists\n        UserService--\x3e>API: EmailAlreadyExistsError\n        API--\x3e>Admin: 409 Conflict\n    end\n\n    UserService->>Crypto: hash_password(password)\n    Crypto--\x3e>UserService: password_hash\n\n    UserService->>UserRepo: create(user)\n    UserRepo--\x3e>UserService: User\n\n    UserService->>UserRepo: assign_roles(user_id, role_ids)\n    UserService->>UserRepo: assign_locals(user_id, local_ids)\n\n    UserService->>EventPub: publish("auth.user.created", {...})\n\n    UserService--\x3e>API: User\n    API--\x3e>Admin: 201 Created + User'}),"\n",(0,o.jsx)(n.h2,{id:"flujo-de-asignaci\xf3n-de-permisos-a-rol",children:"Flujo de Asignaci\xf3n de Permisos a Rol"}),"\n",(0,o.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Admin\n    participant API\n    participant RoleService\n    participant PermRepo\n    participant RoleRepo\n    participant EventPub\n    participant Cache\n\n    Admin->>API: PUT /api/v1/roles/:id<br/>{permission_ids: [...]}\n    API->>RoleService: update_role_permissions(role_id, permissions)\n\n    RoleService->>RoleRepo: get_by_id(role_id)\n    RoleRepo--\x3e>RoleService: Role\n\n    loop Para cada permission_id\n        RoleService->>PermRepo: get_by_id(permission_id)\n        alt Permiso no existe\n            PermRepo--\x3e>RoleService: None\n            RoleService--\x3e>API: PermissionNotFoundError\n            API--\x3e>Admin: 404 Not Found\n        end\n    end\n\n    RoleService->>RoleRepo: get_current_permissions(role_id)\n    RoleRepo--\x3e>RoleService: current_permissions\n\n    RoleService->>RoleService: calculate_diff(current, new)\n    Note over RoleService: added = new - current<br/>removed = current - new\n\n    RoleService->>RoleRepo: remove_permissions(role_id, removed)\n    RoleService->>RoleRepo: add_permissions(role_id, added)\n\n    RoleService->>EventPub: publish("auth.role.permissions_changed", {...})\n\n    loop Para cada microservicio\n        EventPub->>Cache: Invalidar cache de permisos\n    end\n\n    RoleService--\x3e>API: Role\n    API--\x3e>Admin: 200 OK + Role'}),"\n",(0,o.jsx)(n.h2,{id:"flujo-de-logout",children:"Flujo de Logout"}),"\n",(0,o.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Client\n    participant API\n    participant AuthService\n    participant Redis\n    participant SessionRepo\n    participant EventPub\n\n    Client->>API: POST /auth/logout<br/>Bearer {access_token}<br/>{refresh_token}\n    API->>AuthService: logout(user_id, refresh_token)\n\n    AuthService->>Redis: SETEX blacklist:{access_token}<br/>TTL = token exp time\n\n    AuthService->>Redis: GET session:{refresh_token}\n    Redis--\x3e>AuthService: session_id\n\n    AuthService->>SessionRepo: delete(session_id)\n\n    AuthService->>Redis: DEL session:{refresh_token}\n    AuthService->>Redis: DEL user:{user_id}\n\n    AuthService->>EventPub: publish("auth.session.revoked", {...})\n\n    AuthService--\x3e>API: Success\n    API--\x3e>Client: 200 OK'}),"\n",(0,o.jsx)(n.h2,{id:"flujo-de-cambio-de-plan-de-organizaci\xf3n",children:"Flujo de Cambio de Plan de Organizaci\xf3n"}),"\n",(0,o.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant SysAdmin\n    participant API\n    participant OrgService\n    participant OrgRepo\n    participant EventPub\n    participant AllServices\n\n    SysAdmin->>API: PUT /api/v1/organizations/:id<br/>{plan: "enterprise", modules: [...]}\n    API->>OrgService: update_organization(org_id, data)\n\n    OrgService->>OrgRepo: get_by_id(org_id)\n    OrgRepo--\x3e>OrgService: Organization\n\n    OrgService->>OrgService: validate_plan_change(old_plan, new_plan)\n\n    OrgService->>OrgRepo: update(org_id, {plan, modules})\n    OrgRepo--\x3e>OrgService: Organization\n\n    alt Nuevos m\xf3dulos habilitados\n        loop Para cada m\xf3dulo nuevo\n            OrgService->>EventPub: publish("auth.organization.module_enabled", {...})\n            EventPub->>AllServices: Notificar\n        end\n    end\n\n    alt M\xf3dulos deshabilitados\n        loop Para cada m\xf3dulo removido\n            OrgService->>EventPub: publish("auth.organization.module_disabled", {...})\n            EventPub->>AllServices: Notificar\n        end\n    end\n\n    OrgService--\x3e>API: Organization\n    API--\x3e>SysAdmin: 200 OK'}),"\n",(0,o.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/microservicios/catalog-service/overview",children:"Catalog Service"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/arquitectura/seguridad-rbac",children:"Seguridad y RBAC"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>t});var r=i(6540);const o={},a=r.createContext(o);function s(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);