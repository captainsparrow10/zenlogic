"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1974],{2599:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"adrs/adr-006-postgresql-multi-tenant","title":"ADR-006: PostgreSQL Row-Level Security para Multi-tenancy","description":"Estado: Aceptado","source":"@site/docs/03-adrs/adr-006-postgresql-multi-tenant.md","sourceDirName":"03-adrs","slug":"/adrs/adr-006-postgresql-multi-tenant","permalink":"/zenlogic/adrs/adr-006-postgresql-multi-tenant","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-adrs/adr-006-postgresql-multi-tenant.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"docs","previous":{"title":"ADR-005: RBAC Multi-nivel","permalink":"/zenlogic/adrs/adr-005-rbac-multinivel"},"next":{"title":"ADR-007: Cursor-based Pagination","permalink":"/zenlogic/adrs/adr-007-cursor-pagination"}}');var t=s(4848),i=s(8453);const r={sidebar_position:7},o="ADR-006: PostgreSQL Row-Level Security para Multi-tenancy",l={},c=[{value:"Contexto",id:"contexto",level:2},{value:"Requisitos de Multi-tenancy",id:"requisitos-de-multi-tenancy",level:3},{value:"Ejemplo Problema",id:"ejemplo-problema",level:3},{value:"Decisi\xf3n",id:"decisi\xf3n",level:2},{value:"Enfoque Hybrid",id:"enfoque-hybrid",level:3},{value:"Alternativas Consideradas",id:"alternativas-consideradas",level:2},{value:"1. Database per Tenant",id:"1-database-per-tenant",level:3},{value:"2. Schema per Tenant (PostgreSQL Schemas)",id:"2-schema-per-tenant-postgresql-schemas",level:3},{value:"3. Application-Level Filtering (Sin RLS)",id:"3-application-level-filtering-sin-rls",level:3},{value:"Consecuencias",id:"consecuencias",level:2},{value:"Positivas",id:"positivas",level:3},{value:"Negativas",id:"negativas",level:3},{value:"Riesgos",id:"riesgos",level:3},{value:"Implementaci\xf3n Completa",id:"implementaci\xf3n-completa",level:2},{value:"Migration",id:"migration",level:3},{value:"Testing",id:"testing",level:3},{value:"Monitoreo",id:"monitoreo",level:2},{value:"Revisi\xf3n Futura",id:"revisi\xf3n-futura",level:2},{value:"Referencias",id:"referencias",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"adr-006-postgresql-row-level-security-para-multi-tenancy",children:"ADR-006: PostgreSQL Row-Level Security para Multi-tenancy"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Estado"}),": Aceptado\n",(0,t.jsx)(e.strong,{children:"Fecha"}),": 2025-11-23\n",(0,t.jsx)(e.strong,{children:"Decisores"}),": Equipo de Arquitectura zenLogic"]}),"\n",(0,t.jsx)(e.h2,{id:"contexto",children:"Contexto"}),"\n",(0,t.jsx)(e.p,{children:"zenLogic es una plataforma SaaS multi-tenant donde m\xfaltiples organizaciones comparten la misma infraestructura. Los requisitos son:"}),"\n",(0,t.jsx)(e.h3,{id:"requisitos-de-multi-tenancy",children:"Requisitos de Multi-tenancy"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Aislamiento Total"}),": Organizaci\xf3n A no puede ver datos de Organizaci\xf3n B"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Performance"}),": Queries deben ser r\xe1pidos incluso con millones de filas"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Seguridad"}),": Aislamiento a nivel de base de datos, no solo aplicaci\xf3n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Simplicidad"}),": Desarrolladores no deben pensar en tenant filtering en cada query"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Costo-efectivo"}),": Compartir infraestructura reduce costos vs DB per tenant"]}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"ejemplo-problema",children:"Ejemplo Problema"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# \u274c MAL: F\xe1cil olvidar filtrar por organization_id\nproducts = await db.execute(\n    select(Product).where(Product.name.like("%Camiseta%"))\n)\n# BUG: Retorna productos de TODAS las organizaciones\n\n# \u2705 BIEN: Filtrar expl\xedcitamente\nproducts = await db.execute(\n    select(Product)\n    .where(Product.name.like("%Camiseta%"))\n    .where(Product.organization_id == current_org_id)\n)\n# Pero es propenso a errores si lo olvidamos\n'})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Desaf\xedo"}),": \xbfC\xf3mo garantizar aislamiento sin depender de developers acordarse?"]}),"\n",(0,t.jsx)(e.h2,{id:"decisi\xf3n",children:"Decisi\xf3n"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Usaremos PostgreSQL Row-Level Security (RLS)"})," para implementar multi-tenancy a nivel de base de datos."]}),"\n",(0,t.jsx)(e.h3,{id:"enfoque-hybrid",children:"Enfoque Hybrid"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-yaml",children:"Database per Service: S\xed\n  - auth_db\n  - catalog_db\n  - audit_db\n\nTenants per Database: Todos (shared schema)\n  - Tabla products contiene productos de todas las organizaciones\n  - Filtrado autom\xe1tico con RLS\n\nRow-Level Security: Habilitado\n  - Pol\xedticas RLS filtran por organization_id autom\xe1ticamente\n  - Imposible acceder datos de otro tenant\n"})}),"\n",(0,t.jsx)(e.h2,{id:"alternativas-consideradas",children:"Alternativas Consideradas"}),"\n",(0,t.jsx)(e.h3,{id:"1-database-per-tenant",children:"1. Database per Tenant"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Modelo"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-yaml",children:"Tenant A \u2192 database: tenant_a_catalog\nTenant B \u2192 database: tenant_b_catalog\nTenant C \u2192 database: tenant_c_catalog\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Pros"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Aislamiento perfecto"}),": DB totalmente separadas"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Backup/restore per tenant"}),": F\xe1cil recuperar tenant espec\xedfico"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Customizaci\xf3n"}),": Cada tenant puede tener schema diferente"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Contras"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Costo alto"}),": 100 tenants = 100 databases = mucha RAM/storage"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Ops complejidad"}),": Gestionar 100 databases vs 1"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Migraciones pesadilla"}),": Aplicar schema change a 100 DBs"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Connection pools"}),": 100 pools vs 1"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Cross-tenant queries imposibles"}),": Reportes agregados, analytics"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Raz\xf3n de rechazo"}),": No escala para SaaS con cientos de tenants."]}),"\n",(0,t.jsx)(e.h3,{id:"2-schema-per-tenant-postgresql-schemas",children:"2. Schema per Tenant (PostgreSQL Schemas)"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Modelo"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- Database \xfanico, schemas por tenant\nDatabase: catalog_db\n  - Schema: tenant_a (tables: products, variants...)\n  - Schema: tenant_b (tables: products, variants...)\n  - Schema: tenant_c (tables: products, variants...)\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Pros"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Aislamiento razonable (schema-level)"}),"\n",(0,t.jsx)(e.li,{children:"Menos overhead que DB per tenant"}),"\n",(0,t.jsx)(e.li,{children:"Queries cross-tenant posibles"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Contras"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Migraciones a\xfan complejas"}),": Aplicar a cada schema"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Search_path management"}),": Configurar schema por request"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Connection pools"}),": Pool per schema idealmente"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Escalabilidad limitada"}),": 1000 tenants = 1000 schemas"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Raz\xf3n de rechazo"}),": Complejidad operacional innecesaria. RLS es m\xe1s simple."]}),"\n",(0,t.jsx)(e.h3,{id:"3-application-level-filtering-sin-rls",children:"3. Application-Level Filtering (Sin RLS)"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Modelo"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:"# Middleware agrega filtro en cada query\nasync def get_products(org_id: str):\n    return await db.execute(\n        select(Product).where(Product.organization_id == org_id)\n    )\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Pros"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Simple de implementar inicialmente"}),"\n",(0,t.jsx)(e.li,{children:"No requiere features especiales de DB"}),"\n",(0,t.jsx)(e.li,{children:"Funciona con cualquier base de datos"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Contras"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"ERROR-PRONE"}),": F\xe1cil olvidar filtrar"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Riesgo de seguridad ALTO"}),": Un query sin filtro = data leak"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"No defense in depth"}),": Si app tiene bug, no hay segunda barrera"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Auditor\xeda dif\xedcil"}),": \xbfC\xf3mo asegurar que TODOS los queries filtran?"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Raz\xf3n de rechazo"}),": Inseguro. Dependemos 100% de developers."]}),"\n",(0,t.jsx)(e.h2,{id:"consecuencias",children:"Consecuencias"}),"\n",(0,t.jsx)(e.h3,{id:"positivas",children:"Positivas"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"RLS Autom\xe1tico"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- 1. Habilitar RLS en tabla\nALTER TABLE products ENABLE ROW LEVEL SECURITY;\n\n-- 2. Crear pol\xedtica: usuarios solo ven su organizaci\xf3n\nCREATE POLICY tenant_isolation ON products\n    USING (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- 3. \u2728 Magia: queries autom\xe1ticamente filtrados\nSELECT * FROM products WHERE name LIKE '%Camiseta%';\n-- PostgreSQL inyecta: AND organization_id = current_setting('app.current_tenant')::uuid\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"2",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Configuraci\xf3n per Request"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# app/middleware/tenant_context.py\nfrom fastapi import Request\nfrom app.database import get_db\n\nasync def set_tenant_context(request: Request):\n    """Middleware para configurar tenant ID en PostgreSQL."""\n\n    # Extraer organization_id del JWT\n    current_user = request.state.user  # Seteado por auth middleware\n    org_id = current_user["organization_id"]\n\n    # Configurar PostgreSQL session variable\n    async with get_db() as db:\n        await db.execute(\n            text("SET app.current_tenant = :tenant_id"),\n            {"tenant_id": str(org_id)}\n        )\n\n    # Todos los queries subsecuentes usan este tenant\n    yield\n\n# app/main.py\napp.middleware("http")(set_tenant_context)\n'})}),"\n",(0,t.jsxs)(e.ol,{start:"3",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Desarrollo Sin Pensar en Tenancy"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:"# Developers escriben queries NORMALMENTE\n# RLS maneja tenant filtering autom\xe1ticamente\n\nasync def search_products(search_term: str):\n    # \u2705 No necesita filtrar por organization_id expl\xedcitamente\n    query = select(Product).where(Product.name.like(f\"%{search_term}%\"))\n    result = await db.execute(query)\n    return result.scalars().all()\n\n# PostgreSQL RLS autom\xe1ticamente inyecta:\n# AND organization_id = current_setting('app.current_tenant')\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"4",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Defense in Depth"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:"# Incluso con bug en aplicaci\xf3n, RLS protege\nasync def buggy_get_all_products():\n    # \u274c BUG: Developer olvid\xf3 filtrar\n    query = select(Product)  # Sin WHERE clause\n\n    # \u2705 RLS RESCATA: PostgreSQL filtra autom\xe1ticamente\n    # Solo retorna productos del tenant actual\n    result = await db.execute(query)\n    return result.scalars().all()\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"5",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Policies Flexibles"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- Pol\xedtica para SELECT (read)\nCREATE POLICY tenant_isolation_select ON products\n    FOR SELECT\n    USING (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- Pol\xedtica para INSERT (create)\nCREATE POLICY tenant_isolation_insert ON products\n    FOR INSERT\n    WITH CHECK (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- Pol\xedtica para UPDATE (update)\nCREATE POLICY tenant_isolation_update ON products\n    FOR UPDATE\n    USING (organization_id = current_setting('app.current_tenant')::uuid)\n    WITH CHECK (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- Pol\xedtica para DELETE (delete)\nCREATE POLICY tenant_isolation_delete ON products\n    FOR DELETE\n    USING (organization_id = current_setting('app.current_tenant')::uuid);\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"6",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Bypass para Admin Tasks"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- Super user puede bypass RLS para migrations, backups\nCREATE ROLE admin_user WITH SUPERUSER;\n\n-- O usar SECURITY DEFINER functions\nCREATE FUNCTION cross_tenant_report()\nRETURNS TABLE(org_id UUID, product_count INT)\nSECURITY DEFINER  -- Run with function owner's privileges\nAS $$\n    SELECT organization_id, COUNT(*)\n    FROM products\n    GROUP BY organization_id;\n$$ LANGUAGE SQL;\n"})}),"\n",(0,t.jsx)(e.h3,{id:"negativas",children:"Negativas"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Overhead de Performance"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-yaml",children:"Sin RLS:\n  Query: SELECT * FROM products WHERE sku = 'CAM-001'\n  Plan: Index Scan on products_sku_idx\n  Time: 1ms\n\nCon RLS:\n  Query: SELECT * FROM products WHERE sku = 'CAM-001'\n  Plan: Index Scan on products_sku_idx + Filter (organization_id = ...)\n  Time: 1.2ms\n\nOverhead: ~20% (aceptable)\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\xcdndice compuesto: ",(0,t.jsx)(e.code,{children:"(organization_id, sku)"})]}),"\n",(0,t.jsx)(e.li,{children:"Reduce overhead a ~5%"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"CREATE INDEX idx_products_org_sku ON products(organization_id, sku);\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"2",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Debugging M\xe1s Dif\xedcil"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# Query parece no retornar nada\nproducts = await db.execute(select(Product).where(Product.sku == "CAM-001"))\n# Result: []\n\n# \xbfPor qu\xe9? Posibles razones:\n# 1. Producto no existe\n# 2. Producto existe pero en otro tenant (RLS lo filtr\xf3)\n# 3. app.current_tenant no est\xe1 configurado (RLS bloquea todo)\n'})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["Logging de ",(0,t.jsx)(e.code,{children:"app.current_tenant"})," en cada request"]}),"\n",(0,t.jsx)(e.li,{children:"Tests que verifican tenant isolation"}),"\n",(0,t.jsx)(e.li,{children:"Alertas si queries retornan 0 rows inesperadamente"}),"\n"]}),"\n",(0,t.jsxs)(e.ol,{start:"3",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Configuraci\xf3n Requerida en Cada Request"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# CR\xcdTICO: Olvidar SET app.current_tenant = \'...\'\n# Resultado: RLS bloquea TODO (no data visible)\n\n# \u274c MAL:\nasync with get_db() as db:\n    products = await db.execute(select(Product))\n    # No configuramos tenant \u2192 RLS bloquea todo \u2192 []\n\n# \u2705 BIEN:\nasync with get_db() as db:\n    await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_id})\n    products = await db.execute(select(Product))\n'})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Middleware autom\xe1tico configura tenant"}),"\n",(0,t.jsx)(e.li,{children:"Tests verifican middleware est\xe1 activo"}),"\n",(0,t.jsx)(e.li,{children:"Si tenant no est\xe1 configurado, lanzar excepci\xf3n expl\xedcita"}),"\n"]}),"\n",(0,t.jsxs)(e.ol,{start:"4",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Connection Pooling Consideraciones"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# Problema: Session variables persisten en conexi\xf3n pooled\n# Conexi\xf3n 1: SET app.current_tenant = \'org-A\'\n# Conexi\xf3n retorna a pool\n# Request 2 reutiliza conexi\xf3n \u2192 ve tenant \'org-A\' (INCORRECTO)\n\n# Soluci\xf3n 1: Reset tenant al retornar conexi\xf3n\nasync def get_db():\n    async with async_session() as session:\n        try:\n            yield session\n        finally:\n            await session.execute(text("RESET app.current_tenant"))\n\n# Soluci\xf3n 2: Configurar tenant por transacci\xf3n (no por sesi\xf3n)\nasync def get_db():\n    async with async_session() as session:\n        # LOCAL: solo para esta transacci\xf3n\n        await session.execute(\n            text("SET LOCAL app.current_tenant = :tid"),\n            {"tid": current_tenant_id}\n        )\n        yield session\n'})}),"\n",(0,t.jsx)(e.h3,{id:"riesgos",children:"Riesgos"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Misconfiguration = Data Leak"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:"# PELIGRO: Si middleware no configura tenant\n# Y RLS policy tiene bug\n# \u2192 Posible data leak\n\n# Ejemplo INCORRECTO:\nCREATE POLICY bad_policy ON products\n    USING (organization_id = NULLIF(current_setting('app.current_tenant', true), '')::uuid);\n    --                                                                    ^^^^\n    -- \"true\" = no error si variable no existe \u2192 retorna NULL\n    -- NULLIF(NULL, '') = NULL\n    -- WHERE organization_id = NULL \u2192 FALSE para todos (seguro)\n    -- PERO si hay bug en policy logic \u2192 peligro\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Testing exhaustivo de RLS policies"}),"\n",(0,t.jsx)(e.li,{children:"Auditor\xeda de policies en code review"}),"\n",(0,t.jsx)(e.li,{children:"Monitorear queries sin tenant configurado"}),"\n"]}),"\n",(0,t.jsxs)(e.ol,{start:"2",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Bypass Accidental con SECURITY DEFINER"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- PELIGRO: Function SECURITY DEFINER puede bypass RLS\nCREATE FUNCTION get_all_products_unsafe()\nRETURNS SETOF products\nSECURITY DEFINER  -- \u26a0\ufe0f Runs as function owner (puede tener bypass)\nAS $$\n    SELECT * FROM products;  -- Ve TODOS los tenants\n$$ LANGUAGE SQL;\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Evitar SECURITY DEFINER a menos que absolutamente necesario"}),"\n",(0,t.jsx)(e.li,{children:"Si se usa, documentar claramente por qu\xe9"}),"\n",(0,t.jsx)(e.li,{children:"Review de todas las functions SECURITY DEFINER"}),"\n"]}),"\n",(0,t.jsxs)(e.ol,{start:"3",children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Performance Degradation en Cross-Tenant Queries"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- Para analytics, a veces necesitamos cross-tenant\n-- RLS puede hacer esto dif\xedcil\n\n-- Soluci\xf3n: Role con bypass para analytics\nCREATE ROLE analytics_user WITH BYPASSRLS;\n\n-- O disable RLS temporalmente (con cuidado)\nALTER TABLE products DISABLE ROW LEVEL SECURITY;\n-- Run analytics query\nALTER TABLE products ENABLE ROW LEVEL SECURITY;\n"})}),"\n",(0,t.jsx)(e.h2,{id:"implementaci\xf3n-completa",children:"Implementaci\xf3n Completa"}),"\n",(0,t.jsx)(e.h3,{id:"migration",children:"Migration"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# migrations/versions/001_enable_rls.py\n"""Enable Row-Level Security on all tables."""\n\nfrom alembic import op\nimport sqlalchemy as sa\n\ndef upgrade():\n    # Habilitar RLS en todas las tablas multi-tenant\n    tables = [\'products\', \'variants\', \'options\', \'prices\']\n\n    for table in tables:\n        # 1. Enable RLS\n        op.execute(f"ALTER TABLE {table} ENABLE ROW LEVEL SECURITY")\n\n        # 2. Policy para SELECT\n        op.execute(f"""\n            CREATE POLICY tenant_isolation_select ON {table}\n            FOR SELECT\n            USING (organization_id = current_setting(\'app.current_tenant\')::uuid)\n        """)\n\n        # 3. Policy para INSERT\n        op.execute(f"""\n            CREATE POLICY tenant_isolation_insert ON {table}\n            FOR INSERT\n            WITH CHECK (organization_id = current_setting(\'app.current_tenant\')::uuid)\n        """)\n\n        # 4. Policy para UPDATE\n        op.execute(f"""\n            CREATE POLICY tenant_isolation_update ON {table}\n            FOR UPDATE\n            USING (organization_id = current_setting(\'app.current_tenant\')::uuid)\n            WITH CHECK (organization_id = current_setting(\'app.current_tenant\')::uuid)\n        """)\n\n        # 5. Policy para DELETE\n        op.execute(f"""\n            CREATE POLICY tenant_isolation_delete ON {table}\n            FOR DELETE\n            USING (organization_id = current_setting(\'app.current_tenant\')::uuid)\n        """)\n\ndef downgrade():\n    tables = [\'products\', \'variants\', \'options\', \'prices\']\n    for table in tables:\n        op.execute(f"ALTER TABLE {table} DISABLE ROW LEVEL SECURITY")\n'})}),"\n",(0,t.jsx)(e.h3,{id:"testing",children:"Testing"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'# tests/test_rls.py\nimport pytest\nfrom app.database import get_db\n\n@pytest.mark.asyncio\nasync def test_rls_isolates_tenants():\n    """Verificar que RLS a\xedsla tenants."""\n\n    org_a_id = "org-a-uuid"\n    org_b_id = "org-b-uuid"\n\n    # Crear productos para Org A\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_a_id})\n        await db.execute(\n            insert(Product).values(\n                name="Product A",\n                organization_id=org_a_id\n            )\n        )\n        await db.commit()\n\n    # Crear productos para Org B\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_b_id})\n        await db.execute(\n            insert(Product).values(\n                name="Product B",\n                organization_id=org_b_id\n            )\n        )\n        await db.commit()\n\n    # Verificar Org A solo ve sus productos\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_a_id})\n        result = await db.execute(select(Product))\n        products = result.scalars().all()\n\n        assert len(products) == 1\n        assert products[0].name == "Product A"\n\n    # Verificar Org B solo ve sus productos\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_b_id})\n        result = await db.execute(select(Product))\n        products = result.scalars().all()\n\n        assert len(products) == 1\n        assert products[0].name == "Product B"\n'})}),"\n",(0,t.jsx)(e.h2,{id:"monitoreo",children:"Monitoreo"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-python",children:'from prometheus_client import Counter, Histogram\n\ntenant_isolation_violations = Counter(\n    "tenant_isolation_violations_total",\n    "Potential tenant isolation violations detected"\n)\n\n# Log si tenant no est\xe1 configurado\nasync def verify_tenant_configured(db):\n    result = await db.execute(text("SELECT current_setting(\'app.current_tenant\', true)"))\n    tenant_id = result.scalar()\n\n    if not tenant_id:\n        tenant_isolation_violations.inc()\n        logger.error("Tenant not configured in database session!")\n        raise Exception("Tenant ID not configured")\n'})}),"\n",(0,t.jsx)(e.h2,{id:"revisi\xf3n-futura",children:"Revisi\xf3n Futura"}),"\n",(0,t.jsx)(e.p,{children:"Este ADR debe revisarse si:"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"Performance overhead de RLS supera 30%"}),"\n",(0,t.jsx)(e.li,{children:"Necesitamos sharding (RLS complica sharding strategies)"}),"\n",(0,t.jsx)(e.li,{children:"Requisito de tenant customization extremo (schema diferente)"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Fecha de pr\xf3xima revisi\xf3n"}),": 2026-11-23 (1 a\xf1o)"]}),"\n",(0,t.jsx)(e.h2,{id:"referencias",children:"Referencias"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/ddl-rowsecurity.html",children:"PostgreSQL Row-Level Security"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.citusdata.com/blog/2016/10/03/designing-your-saas-database-for-high-scalability/",children:"Multi-tenancy with PostgreSQL"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.2ndquadrant.com/en/blog/postgresql-row-level-security-performance/",children:"RLS Performance Considerations"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"/arquitectura/multi-tenancy",children:"Multi-tenancy"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"/microservicios/catalog-service/validacion-locales",children:"Catalog Service - Validaci\xf3n de Locales"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"/adrs/adr-002-postgresql",children:"ADR-002: PostgreSQL"})}),"\n"]})]})}function u(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(d,{...n})}):d(n)}},8453:(n,e,s)=>{s.d(e,{R:()=>r,x:()=>o});var a=s(6540);const t={},i=a.createContext(t);function r(n){const e=a.useContext(i);return a.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:r(n.components),a.createElement(i.Provider,{value:e},n.children)}}}]);