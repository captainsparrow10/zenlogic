"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[9402],{7818:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"integraciones/postgresql","title":"PostgreSQL - Base de Datos","description":"Integraci\xf3n con PostgreSQL para almacenamiento relacional persistente.","source":"@site/docs/04-integraciones/04-postgresql.md","sourceDirName":"04-integraciones","slug":"/integraciones/postgresql","permalink":"/zenlogic/integraciones/postgresql","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/04-integraciones/04-postgresql.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"docs","previous":{"title":"gRPC - Comunicaci\xf3n Interna","permalink":"/zenlogic/integraciones/grpc"},"next":{"title":"Setup Local de Desarrollo","permalink":"/zenlogic/guias/setup-local"}}');var i=t(4848),s=t(8453);const r={sidebar_position:5},o="PostgreSQL - Base de Datos",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Configuraci\xf3n",id:"configuraci\xf3n",level:2},{value:"Docker Compose",id:"docker-compose",level:3},{value:"Init Script",id:"init-script",level:3},{value:"SQLAlchemy Async",id:"sqlalchemy-async",level:2},{value:"Engine Configuration",id:"engine-configuration",level:3},{value:"Base Model",id:"base-model",level:3},{value:"Row-Level Security",id:"row-level-security",level:2},{value:"Habilitar RLS",id:"habilitar-rls",level:3},{value:"Testing RLS",id:"testing-rls",level:3},{value:"Migraciones con Alembic",id:"migraciones-con-alembic",level:2},{value:"Configuraci\xf3n",id:"configuraci\xf3n-1",level:3},{value:"Crear Migraci\xf3n",id:"crear-migraci\xf3n",level:3},{value:"\xcdndices",id:"\xedndices",level:2},{value:"\xcdndices Recomendados",id:"\xedndices-recomendados",level:3},{value:"Full-Text Search",id:"full-text-search",level:2},{value:"Monitoring",id:"monitoring",level:2},{value:"Slow Queries",id:"slow-queries",level:3},{value:"Connection Pool",id:"connection-pool",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"postgresql---base-de-datos",children:"PostgreSQL - Base de Datos"})}),"\n",(0,i.jsx)(n.p,{children:"Integraci\xf3n con PostgreSQL para almacenamiento relacional persistente."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"PostgreSQL 15+ es la base de datos principal de zenLogic. Cada microservicio tiene su propia base de datos (database-per-service pattern) con Row-Level Security para multi-tenancy."}),"\n",(0,i.jsx)(n.h2,{id:"configuraci\xf3n",children:"Configuraci\xf3n"}),"\n",(0,i.jsx)(n.h3,{id:"docker-compose",children:"Docker Compose"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"version: '3.8'\nservices:\n  postgres:\n    image: postgres:15-alpine\n    ports:\n      - \"5432:5432\"\n    environment:\n      POSTGRES_USER: erp_user\n      POSTGRES_PASSWORD: erp_password\n      POSTGRES_DB: postgres\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n      - ./init-dbs.sql:/docker-entrypoint-initdb.d/init-dbs.sql\n\nvolumes:\n  postgres_data:\n"})}),"\n",(0,i.jsx)(n.h3,{id:"init-script",children:"Init Script"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:'-- init-dbs.sql\nCREATE DATABASE auth_db;\nCREATE DATABASE catalog_db;\nCREATE DATABASE audit_db;\n\n-- Extensions\n\\c auth_db\nCREATE EXTENSION IF NOT EXISTS "uuid-ossp";\nCREATE EXTENSION IF NOT EXISTS "pg_trgm";\n\n\\c catalog_db\nCREATE EXTENSION IF NOT EXISTS "uuid-ossp";\nCREATE EXTENSION IF NOT EXISTS "pg_trgm";\nCREATE EXTENSION IF NOT EXISTS "btree_gist";\n\n\\c audit_db\nCREATE EXTENSION IF NOT EXISTS "uuid-ossp";\n'})}),"\n",(0,i.jsx)(n.h2,{id:"sqlalchemy-async",children:"SQLAlchemy Async"}),"\n",(0,i.jsx)(n.h3,{id:"engine-configuration",children:"Engine Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/database.py\nfrom sqlalchemy.ext.asyncio import create_async_engine, AsyncSession\nfrom sqlalchemy.orm import sessionmaker\nfrom app.config import settings\n\n# Engine con connection pooling\nengine = create_async_engine(\n    settings.database_url,\n    echo=settings.debug,\n    pool_size=20,              # 20 conexiones permanentes\n    max_overflow=10,           # +10 temporales\n    pool_pre_ping=True,        # Health check antes de usar\n    pool_recycle=3600,         # Reciclar cada hora\n    pool_timeout=30,           # Timeout en obtener conexi\xf3n\n)\n\n# Session factory\nasync_session_factory = sessionmaker(\n    engine,\n    class_=AsyncSession,\n    expire_on_commit=False\n)\n\nasync def get_db() -> AsyncSession:\n    """Dependency para obtener sesi\xf3n de DB."""\n\n    async with async_session_factory() as session:\n        try:\n            # Configurar tenant context\n            org_id = get_current_organization_id()\n            if org_id:\n                await session.execute(\n                    text("SET LOCAL app.current_tenant = :tenant_id"),\n                    {"tenant_id": str(org_id)}\n                )\n\n            yield session\n\n        finally:\n            await session.close()\n'})}),"\n",(0,i.jsx)(n.h3,{id:"base-model",children:"Base Model"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/models/base.py\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy import Column, DateTime, func\nfrom uuid import uuid4\n\nBase = declarative_base()\n\nclass BaseModel(Base):\n    """Modelo base con campos comunes."""\n\n    __abstract__ = True\n\n    created_at = Column(\n        DateTime(timezone=True),\n        server_default=func.now(),\n        nullable=False\n    )\n\n    updated_at = Column(\n        DateTime(timezone=True),\n        server_default=func.now(),\n        onupdate=func.now(),\n        nullable=False\n    )\n\n    def dict(self):\n        """Convertir a diccionario."""\n        return {c.name: getattr(self, c.name) for c in self.__table__.columns}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"row-level-security",children:"Row-Level Security"}),"\n",(0,i.jsx)(n.h3,{id:"habilitar-rls",children:"Habilitar RLS"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Habilitar RLS en tabla\nALTER TABLE products ENABLE ROW LEVEL SECURITY;\n\n-- Pol\xedtica de SELECT\nCREATE POLICY tenant_isolation_select ON products\n    FOR SELECT\n    USING (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- Pol\xedtica de INSERT\nCREATE POLICY tenant_isolation_insert ON products\n    FOR INSERT\n    WITH CHECK (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- Pol\xedtica de UPDATE\nCREATE POLICY tenant_isolation_update ON products\n    FOR UPDATE\n    USING (organization_id = current_setting('app.current_tenant')::uuid)\n    WITH CHECK (organization_id = current_setting('app.current_tenant')::uuid);\n\n-- Pol\xedtica de DELETE\nCREATE POLICY tenant_isolation_delete ON products\n    FOR DELETE\n    USING (organization_id = current_setting('app.current_tenant')::uuid);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"testing-rls",children:"Testing RLS"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# tests/test_rls.py\nimport pytest\n\n@pytest.mark.asyncio\nasync def test_rls_isolates_tenants():\n    """Verificar que RLS a\xedsla tenants."""\n\n    org_a = "org-a-uuid"\n    org_b = "org-b-uuid"\n\n    # Crear producto para Org A\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_a})\n        await db.execute(\n            insert(Product).values(name="Product A", organization_id=org_a)\n        )\n        await db.commit()\n\n    # Crear producto para Org B\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_b})\n        await db.execute(\n            insert(Product).values(name="Product B", organization_id=org_b)\n        )\n        await db.commit()\n\n    # Verificar Org A solo ve sus productos\n    async with get_db() as db:\n        await db.execute(text("SET app.current_tenant = :tid"), {"tid": org_a})\n        result = await db.execute(select(Product))\n        products = result.scalars().all()\n\n        assert len(products) == 1\n        assert products[0].name == "Product A"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"migraciones-con-alembic",children:"Migraciones con Alembic"}),"\n",(0,i.jsx)(n.h3,{id:"configuraci\xf3n-1",children:"Configuraci\xf3n"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# alembic/env.py\nfrom sqlalchemy import pool\nfrom alembic import context\nfrom app.database import engine\nfrom app.models import Base\n\ntarget_metadata = Base.metadata\n\ndef run_migrations_online():\n    """Run migrations in \'online\' mode."""\n\n    with engine.connect() as connection:\n        context.configure(\n            connection=connection,\n            target_metadata=target_metadata,\n            compare_type=True,\n            compare_server_default=True\n        )\n\n        with context.begin_transaction():\n            context.run_migrations()\n'})}),"\n",(0,i.jsx)(n.h3,{id:"crear-migraci\xf3n",children:"Crear Migraci\xf3n"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Generar migraci\xf3n autom\xe1ticamente\nalembic revision --autogenerate -m "add products table"\n\n# Aplicar migraciones\nalembic upgrade head\n\n# Rollback \xfaltima migraci\xf3n\nalembic downgrade -1\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\xedndices",children:"\xcdndices"}),"\n",(0,i.jsx)(n.h3,{id:"\xedndices-recomendados",children:"\xcdndices Recomendados"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \xcdndices para multi-tenancy (RLS)\nCREATE INDEX idx_products_org ON products(organization_id);\nCREATE INDEX idx_variants_org ON variants(organization_id);\n\n-- \xcdndices compuestos para queries comunes\nCREATE INDEX idx_products_org_sku ON products(organization_id, sku);\nCREATE INDEX idx_products_org_created ON products(organization_id, created_at DESC);\n\n-- \xcdndices para b\xfasqueda\nCREATE INDEX idx_products_name_trgm ON products USING GIN (name gin_trgm_ops);\n\n-- \xcdndices para JSONB\nCREATE INDEX idx_products_metadata ON products USING GIN (metadata);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"full-text-search",children:"Full-Text Search"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def search_products(search_term: str, org_id: str) -> list[Product]:\n    \"\"\"Buscar productos por nombre o descripci\xf3n.\"\"\"\n\n    # Configurar tenant\n    await db.execute(\n        text(\"SET app.current_tenant = :tid\"),\n        {\"tid\": org_id}\n    )\n\n    # Full-text search\n    query = select(Product).where(\n        func.to_tsvector('spanish', Product.name + ' ' + Product.description).op('@@')(\n            func.to_tsquery('spanish', search_term)\n        )\n    ).order_by(\n        func.ts_rank(\n            func.to_tsvector('spanish', Product.name),\n            func.to_tsquery('spanish', search_term)\n        ).desc()\n    )\n\n    result = await db.execute(query)\n    return result.scalars().all()\n"})}),"\n",(0,i.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,i.jsx)(n.h3,{id:"slow-queries",children:"Slow Queries"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Habilitar pg_stat_statements\nCREATE EXTENSION IF NOT EXISTS pg_stat_statements;\n\n-- Queries m\xe1s lentos\nSELECT\n    query,\n    calls,\n    mean_exec_time / 1000 as mean_time_sec,\n    total_exec_time / 1000 as total_time_sec\nFROM pg_stat_statements\nWHERE query NOT LIKE '%pg_stat_statements%'\nORDER BY mean_exec_time DESC\nLIMIT 10;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"connection-pool",children:"Connection Pool"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from prometheus_client import Gauge\n\ndb_pool_size = Gauge("db_pool_size", "DB connection pool size")\ndb_pool_overflow = Gauge("db_pool_overflow", "DB pool overflow connections")\n\nasync def monitor_pool():\n    """Monitorear connection pool."""\n\n    db_pool_size.set(engine.pool.size())\n    db_pool_overflow.set(engine.pool.overflow())\n'})}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/adrs/adr-002-postgresql",children:"ADR-002: PostgreSQL"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/adrs/adr-006-postgresql-multi-tenant",children:"ADR-006: Row-Level Security Multi-tenant"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/catalog-service/modelo-datos",children:"Catalog Service - Modelo de Datos"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var a=t(6540);const i={},s=a.createContext(i);function r(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);