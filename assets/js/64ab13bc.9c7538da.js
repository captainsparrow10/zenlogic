"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[2925],{1356:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"adrs/adr-007-cursor-pagination","title":"ADR-007: Cursor-based Pagination","description":"Estado: Aceptado","source":"@site/docs/03-adrs/adr-007-cursor-pagination.md","sourceDirName":"03-adrs","slug":"/adrs/adr-007-cursor-pagination","permalink":"/zenlogic/adrs/adr-007-cursor-pagination","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-adrs/adr-007-cursor-pagination.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"docs","previous":{"title":"ADR-006: PostgreSQL Row-Level Security para Multi-tenancy","permalink":"/zenlogic/adrs/adr-006-postgresql-multi-tenant"},"next":{"title":"Integraciones - Overview","permalink":"/zenlogic/integraciones/overview"}}');var i=r(4848),a=r(8453);const o={sidebar_position:8},t="ADR-007: Cursor-based Pagination",d={},c=[{value:"Contexto",id:"contexto",level:2},{value:"Requisitos",id:"requisitos",level:3},{value:"Problema con Offset Pagination",id:"problema-con-offset-pagination",level:3},{value:"Problema con Datasets Din\xe1micos",id:"problema-con-datasets-din\xe1micos",level:3},{value:"Decisi\xf3n",id:"decisi\xf3n",level:2},{value:"Formato de Cursor",id:"formato-de-cursor",level:3},{value:"Alternativas Consideradas",id:"alternativas-consideradas",level:2},{value:"1. Offset-based Pagination",id:"1-offset-based-pagination",level:3},{value:"2. Keyset Pagination (WHERE &gt; last_id)",id:"2-keyset-pagination-where--last_id",level:3},{value:"3. Elasticsearch Scroll API",id:"3-elasticsearch-scroll-api",level:3},{value:"Consecuencias",id:"consecuencias",level:2},{value:"Positivas",id:"positivas",level:3},{value:"Negativas",id:"negativas",level:3},{value:"Riesgos",id:"riesgos",level:3},{value:"Implementaci\xf3n",id:"implementaci\xf3n",level:2},{value:"Encode/Decode Cursor",id:"encodedecode-cursor",level:3},{value:"Repository Method",id:"repository-method",level:3},{value:"API Endpoint",id:"api-endpoint",level:3},{value:"Response Schema",id:"response-schema",level:3},{value:"Ejemplo de Uso",id:"ejemplo-de-uso",level:2},{value:"Request/Response",id:"requestresponse",level:3},{value:"Revisi\xf3n Futura",id:"revisi\xf3n-futura",level:2},{value:"Referencias",id:"referencias",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"adr-007-cursor-based-pagination",children:"ADR-007: Cursor-based Pagination"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Estado"}),": Aceptado\n",(0,i.jsx)(n.strong,{children:"Fecha"}),": 2025-11-23\n",(0,i.jsx)(n.strong,{children:"Decisores"}),": Equipo de Arquitectura zenLogic"]}),"\n",(0,i.jsx)(n.h2,{id:"contexto",children:"Contexto"}),"\n",(0,i.jsx)(n.p,{children:"Catalog Service necesita paginar productos, variantes y opciones. Los requisitos son:"}),"\n",(0,i.jsx)(n.h3,{id:"requisitos",children:"Requisitos"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Escalabilidad"}),": Funcionar con millones de productos"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance"}),": Respuesta ",(0,i.jsx)(n.code,{children:"<100ms"})," incluso en p\xe1gina 10,000"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Consistencia"}),": Evitar duplicados o items faltantes al paginar"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"API-friendly"}),": Compatible con REST + GraphQL"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Sorting flexible"}),": Ordenar por diferentes campos (created_at, name, price)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"problema-con-offset-pagination",children:"Problema con Offset Pagination"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- P\xe1gina 1 (r\xe1pido)\nSELECT * FROM products ORDER BY created_at DESC LIMIT 50 OFFSET 0;\n-- Index scan: ~2ms\n\n-- P\xe1gina 100 (lento)\nSELECT * FROM products ORDER BY created_at DESC LIMIT 50 OFFSET 5000;\n-- PostgreSQL debe escanear 5000 rows + descartar + retornar 50\n-- Time: ~50ms\n\n-- P\xe1gina 10,000 (muy lento)\nSELECT * FROM products ORDER BY created_at DESC LIMIT 50 OFFSET 500000;\n-- Time: ~2000ms (2 segundos!)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Problema"}),": OFFSET es O(n) - escala linealmente con p\xe1gina number."]}),"\n",(0,i.jsx)(n.h3,{id:"problema-con-datasets-din\xe1micos",children:"Problema con Datasets Din\xe1micos"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Usuario est\xe1 en p\xe1gina 3\nGET /products?limit=50&offset=100\n\n# Entre requests, se crea un producto nuevo al inicio\n# Resultado: P\xe1gina 3 muestra items que ya vio en p\xe1gina 2 (duplicados)\n# O peor: salta items sin mostrarlos\n"})}),"\n",(0,i.jsx)(n.h2,{id:"decisi\xf3n",children:"Decisi\xf3n"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Usaremos Cursor-based Pagination"})," (estilo Shopify/GraphQL Relay) para todas las listas en APIs REST."]}),"\n",(0,i.jsx)(n.h3,{id:"formato-de-cursor",children:"Formato de Cursor"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'Cursor: Base64-encoded JSON con informaci\xf3n de posici\xf3n\n\nEjemplo:\n  Cursor string: "eyJpZCI6IjEyMyIsImNyZWF0ZWRfYXQiOiIyMDI1LTExLTIzVDEwOjAwOjAwWiJ9"\n  Decoded: {"id": "123", "created_at": "2025-11-23T10:00:00Z"}\n\nResponse format:\n  {\n    "data": [...],\n    "page_info": {\n      "has_next_page": true,\n      "has_previous_page": false,\n      "start_cursor": "abc...",\n      "end_cursor": "xyz..."\n    }\n  }\n'})}),"\n",(0,i.jsx)(n.h2,{id:"alternativas-consideradas",children:"Alternativas Consideradas"}),"\n",(0,i.jsx)(n.h3,{id:"1-offset-based-pagination",children:"1. Offset-based Pagination"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Formato"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GET /products?limit=50&offset=100\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Simple de implementar"}),"\n",(0,i.jsx)(n.li,{children:'Usuarios entienden "p\xe1gina 5 de 100"'}),"\n",(0,i.jsx)(n.li,{children:"Puede saltar a p\xe1gina arbitraria"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance O(n)"}),": P\xe1gina 10,000 = escanear 500k rows"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Inconsistencia"}),": Duplicados/faltantes si data cambia"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No escala"}),": ",(0,i.jsx)(n.code,{children:">1M rows"})," = segundos de latencia"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"DB overhead"}),": OFFSET fuerza full scan"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": No escala para millones de productos."]}),"\n",(0,i.jsx)(n.h3,{id:"2-keyset-pagination-where--last_id",children:"2. Keyset Pagination (WHERE > last_id)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Formato"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Primera p\xe1gina\nSELECT * FROM products ORDER BY id LIMIT 50;\n\n-- Siguiente p\xe1gina (last_id = 50)\nSELECT * FROM products WHERE id > 50 ORDER BY id LIMIT 50;\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance O(1)"}),": Siempre r\xe1pido, usa \xedndice"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Consistente"}),": No duplicados"]}),"\n",(0,i.jsx)(n.li,{children:"Simple de implementar"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Solo funciona con IDs secuenciales"}),": UUID no es ordenado"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Sorting limitado"}),": Solo puede ordenar por campo en WHERE"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No backward pagination"}),": Dif\xedcil ir a p\xe1gina anterior"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No sorting multi-campo"}),": ORDER BY created_at, name imposible"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": UUIDs + sorting flexible requerido."]}),"\n",(0,i.jsx)(n.h3,{id:"3-elasticsearch-scroll-api",children:"3. Elasticsearch Scroll API"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Formato"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'POST /products/_search?scroll=1m\n{\n  "size": 50,\n  "query": { "match_all": {} }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Dise\xf1ado para deep pagination"}),"\n",(0,i.jsx)(n.li,{children:"Performance excelente"}),"\n",(0,i.jsx)(n.li,{children:"Full-text search incluido"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Requiere Elasticsearch"}),": Stack adicional"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Eventual consistency"}),": Elasticsearch no es source of truth"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Scroll stateful"}),": Mantiene contexto en server (overhead)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Overkill"}),": No necesitamos full-text search en todos los endpoints"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Over-engineering. PostgreSQL es suficiente."]}),"\n",(0,i.jsx)(n.h2,{id:"consecuencias",children:"Consecuencias"}),"\n",(0,i.jsx)(n.h3,{id:"positivas",children:"Positivas"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Performance O(1) Constante"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Primera p\xe1gina (sin cursor)\nSELECT * FROM products\nORDER BY created_at DESC, id ASC\nLIMIT 51;  -- +1 para detectar has_next_page\n-- Time: 2ms (index scan)\n\n-- P\xe1gina siguiente (cursor = {created_at: \"2025-11-23\", id: \"uuid-123\"})\nSELECT * FROM products\nWHERE (created_at, id) < ('2025-11-23T10:00:00Z', 'uuid-123')\nORDER BY created_at DESC, id ASC\nLIMIT 51;\n-- Time: 2ms (index scan)\n\n-- P\xe1gina 10,000 (mismo query pattern)\n-- Time: SIGUE SIENDO 2ms! \ud83c\udf89\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\xcdndice requerido"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE INDEX idx_products_cursor ON products(created_at DESC, id ASC);\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Consistencia Total"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Request 1: Primera p\xe1gina\nresponse = GET /products?limit=50\n# Retorna productos 1-50 + end_cursor\n\n# Entre requests: Se crean 100 productos nuevos\n\n# Request 2: Siguiente p\xe1gina (usando end_cursor de request 1)\nresponse = GET /products?after=cursor_from_request_1&limit=50\n# Retorna productos 51-100 del snapshot original\n# No duplicados, no faltantes \u2705\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Sorting Flexible"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Ordenar por created_at DESC\nGET /products?order_by=created_at&direction=desc&limit=50\n\n# Ordenar por price ASC\nGET /products?order_by=price&direction=asc&limit=50\n\n# Cursor autom\xe1ticamente incluye campo de sorting\n# {created_at, id} vs {price, id}\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Backward Pagination"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Forward: despu\xe9s de cursor\nGET /products?after=cursor_A&limit=50\n\n# Backward: antes de cursor\nGET /products?before=cursor_B&limit=50\n\n# Implementaci\xf3n:\nif before:\n    query = query.where((created_at, id) > (cursor_created_at, cursor_id))\n    query = query.order_by(created_at.asc(), id.asc())  # Reversed\n    results = list(reversed(results))  # Re-reverse para user\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"GraphQL Relay Compatible"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:'query {\n  products(first: 50, after: "cursor_abc") {\n    edges {\n      cursor\n      node {\n        id\n        name\n        price\n      }\n    }\n    pageInfo {\n      hasNextPage\n      hasPreviousPage\n      startCursor\n      endCursor\n    }\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"negativas",children:"Negativas"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:'No "Jump to Page N"'})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# \u274c IMPOSIBLE con cursors\nGET /products?page=100\n\n# Solo puedes ir:\n# - Primera p\xe1gina (sin cursor)\n# - Siguiente p\xe1gina (after=cursor)\n# - P\xe1gina anterior (before=cursor)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Para UIs que necesitan "p\xe1gina 100", usar offset en backend'}),"\n",(0,i.jsx)(n.li,{children:"Exponer cursor pagination en API p\xfablica"}),"\n",(0,i.jsx)(n.li,{children:'UI muestra "Load More" o "Next/Previous", no "Page 5 of 100"'}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Cursors Son Opacos para Usuarios"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Usuario no entiende qu\xe9 significa cursor\nafter: "eyJpZCI6IjEyMyIsImNyZWF0ZWRfYXQiOiIyMDI1LTExLTIzVDEwOjAwOjAwWiJ9"\n\n# vs offset que es intuitivo\noffset: 100\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Documentaci\xf3n clara"}),"\n",(0,i.jsx)(n.li,{children:'UI abstrae cursors (bot\xf3n "Next" maneja cursor internamente)'}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Cursor Invalidation"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Cursor apunta a producto que fue eliminado\n# Query: WHERE (created_at, id) < ('2025-11-23', 'deleted-product-id')\n# Resultado: Funciona igual, el cursor sigue siendo v\xe1lido\n# Solo \"salta\" el producto eliminado\n\n# PERO: Si campo de sorting cambia significativamente\n# Ejemplo: producto ten\xeda created_at = 2025-11-23, ahora = 2025-11-01\n# Cursor puede retornar resultados inesperados\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"No actualizar campos de sorting (created_at es immutable)"}),"\n",(0,i.jsx)(n.li,{children:"Si es necesario, invalidar cursors (retornar error, forzar primera p\xe1gina)"}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"\xcdndice por Cada Combinaci\xf3n de Sorting"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Sorting por created_at\nCREATE INDEX idx_products_created ON products(created_at DESC, id ASC);\n\n-- Sorting por price\nCREATE INDEX idx_products_price ON products(price ASC, id ASC);\n\n-- Sorting por name\nCREATE INDEX idx_products_name ON products(name ASC, id ASC);\n\n-- M\xfaltiples \xedndices = m\xe1s storage, m\xe1s overhead en writes\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Solo \xedndices para sortings comunes (created_at, updated_at)"}),"\n",(0,i.jsx)(n.li,{children:"Sortings raros (price, name) pueden usar offset fallback"}),"\n",(0,i.jsx)(n.li,{children:"Monitorear uso de \xedndices, eliminar los no usados"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"riesgos",children:"Riesgos"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Cursor Tampering"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Usuario modifica cursor manualmente\n# Original: {"id": "product-123", "created_at": "2025-11-23"}\n# Modified: {"id": "product-999", "created_at": "2025-12-31"}\n\n# Resultado: Query retorna desde posici\xf3n falsa\n# Impacto: Usuario ve datos incorrectos (pero solo SUS datos por RLS)\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Firmar cursors con HMAC","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"import hmac\nimport hashlib\n\ndef sign_cursor(cursor_data: dict, secret: str) -> str:\n    payload = json.dumps(cursor_data).encode()\n    signature = hmac.new(secret.encode(), payload, hashlib.sha256).hexdigest()\n    return base64.b64encode(payload + b':' + signature.encode()).decode()\n\ndef verify_cursor(cursor: str, secret: str) -> dict:\n    decoded = base64.b64decode(cursor)\n    payload, signature = decoded.split(b':')\n    expected_sig = hmac.new(secret.encode(), payload, hashlib.sha256).hexdigest()\n    if signature.decode() != expected_sig:\n        raise ValueError(\"Invalid cursor signature\")\n    return json.loads(payload)\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Complex Sorting = Complex Cursors"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Sorting por m\xfaltiples campos: ORDER BY price ASC, name ASC, id ASC\n# Cursor: {"price": 19.99, "name": "Camiseta", "id": "uuid-123"}\n# Query: WHERE (price, name, id) > (19.99, \'Camiseta\', \'uuid-123\')\n\n# \u2705 PostgreSQL soporta tuple comparison\n# Pero debugging se complica\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Limitar sorting a 2 campos max: [sort_field, id]"}),"\n",(0,i.jsx)(n.li,{children:"Documentar claramente formato de cursor"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"implementaci\xf3n",children:"Implementaci\xf3n"}),"\n",(0,i.jsx)(n.h3,{id:"encodedecode-cursor",children:"Encode/Decode Cursor"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/utils/cursor.py\nimport base64\nimport json\nfrom typing import Any, Dict\n\ndef encode_cursor(data: Dict[str, Any]) -> str:\n    """Encode cursor data to base64 string."""\n    json_str = json.dumps(data, default=str)  # default=str para datetime\n    return base64.b64encode(json_str.encode()).decode()\n\ndef decode_cursor(cursor: str) -> Dict[str, Any]:\n    """Decode base64 cursor to dict."""\n    try:\n        json_str = base64.b64decode(cursor.encode()).decode()\n        return json.loads(json_str)\n    except Exception as e:\n        raise ValueError(f"Invalid cursor: {e}")\n\n# Ejemplo\ncursor_data = {"id": "product-123", "created_at": "2025-11-23T10:00:00Z"}\ncursor = encode_cursor(cursor_data)\n# "eyJpZCI6InByb2R1Y3QtMTIzIiwiY3JlYXRlZF9hdCI6IjIwMjUtMTEtMjNUMTA6MDA6MDBaIn0="\n\ndecoded = decode_cursor(cursor)\n# {"id": "product-123", "created_at": "2025-11-23T10:00:00Z"}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"repository-method",children:"Repository Method"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/repositories/product_repository.py\nfrom typing import List, Optional\nfrom sqlalchemy import select, and_, tuple_\nfrom app.models.product import Product\nfrom app.utils.cursor import encode_cursor, decode_cursor\n\nclass ProductRepository:\n    async def find_paginated(\n        self,\n        organization_id: str,\n        limit: int = 50,\n        after: Optional[str] = None,\n        order_by: str = "created_at",\n        direction: str = "desc"\n    ) -> Dict[str, Any]:\n        """Cursor-based pagination."""\n\n        # Base query\n        query = select(Product).where(Product.organization_id == organization_id)\n\n        # Aplicar cursor si existe\n        if after:\n            cursor_data = decode_cursor(after)\n            cursor_value = cursor_data.get(order_by)\n            cursor_id = cursor_data.get("id")\n\n            # Tuple comparison: (created_at, id) < (cursor_created_at, cursor_id)\n            if direction == "desc":\n                query = query.where(\n                    tuple_(\n                        getattr(Product, order_by),\n                        Product.id\n                    ) < (cursor_value, cursor_id)\n                )\n            else:\n                query = query.where(\n                    tuple_(\n                        getattr(Product, order_by),\n                        Product.id\n                    ) > (cursor_value, cursor_id)\n                )\n\n        # Ordenar\n        if direction == "desc":\n            query = query.order_by(\n                getattr(Product, order_by).desc(),\n                Product.id.desc()\n            )\n        else:\n            query = query.order_by(\n                getattr(Product, order_by).asc(),\n                Product.id.asc()\n            )\n\n        # +1 para detectar has_next_page\n        query = query.limit(limit + 1)\n\n        # Ejecutar\n        result = await self.db.execute(query)\n        products = result.scalars().all()\n\n        # Determinar has_next_page\n        has_next_page = len(products) > limit\n        if has_next_page:\n            products = products[:limit]\n\n        # Generar cursors\n        start_cursor = None\n        end_cursor = None\n        if products:\n            start_cursor = encode_cursor({\n                "id": str(products[0].id),\n                order_by: getattr(products[0], order_by).isoformat()\n            })\n            end_cursor = encode_cursor({\n                "id": str(products[-1].id),\n                order_by: getattr(products[-1], order_by).isoformat()\n            })\n\n        return {\n            "data": products,\n            "page_info": {\n                "has_next_page": has_next_page,\n                "has_previous_page": after is not None,\n                "start_cursor": start_cursor,\n                "end_cursor": end_cursor\n            }\n        }\n'})}),"\n",(0,i.jsx)(n.h3,{id:"api-endpoint",children:"API Endpoint"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/api/products.py\nfrom fastapi import APIRouter, Query\nfrom app.schemas.pagination import PaginatedResponse\n\nrouter = APIRouter()\n\n@router.get("/products", response_model=PaginatedResponse[ProductResponse])\nasync def list_products(\n    after: Optional[str] = Query(None, description="Cursor for pagination"),\n    limit: int = Query(50, ge=1, le=100),\n    order_by: str = Query("created_at", regex="^(created_at|name|base_price)$"),\n    direction: str = Query("desc", regex="^(asc|desc)$"),\n    organization_id: str = Depends(get_organization_id),\n    product_repo: ProductRepository = Depends()\n):\n    """List products with cursor pagination."""\n\n    result = await product_repo.find_paginated(\n        organization_id=organization_id,\n        limit=limit,\n        after=after,\n        order_by=order_by,\n        direction=direction\n    )\n\n    return result\n'})}),"\n",(0,i.jsx)(n.h3,{id:"response-schema",children:"Response Schema"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# app/schemas/pagination.py\nfrom typing import Generic, TypeVar, List\nfrom pydantic import BaseModel\n\nT = TypeVar('T')\n\nclass PageInfo(BaseModel):\n    has_next_page: bool\n    has_previous_page: bool\n    start_cursor: Optional[str]\n    end_cursor: Optional[str]\n\nclass PaginatedResponse(BaseModel, Generic[T]):\n    data: List[T]\n    page_info: PageInfo\n"})}),"\n",(0,i.jsx)(n.h2,{id:"ejemplo-de-uso",children:"Ejemplo de Uso"}),"\n",(0,i.jsx)(n.h3,{id:"requestresponse",children:"Request/Response"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Primera p\xe1gina\nGET /api/v1/products?limit=50\n\n{\n  "data": [\n    {\n      "id": "prod-1",\n      "name": "Camiseta A",\n      "created_at": "2025-11-23T10:00:00Z"\n    },\n    // ... 49 more\n  ],\n  "page_info": {\n    "has_next_page": true,\n    "has_previous_page": false,\n    "start_cursor": "eyJpZCI6InByb2QtMSIsImNyZWF0ZWRfYXQiOiIyMDI1LTExLTIzVDEwOjAwOjAwWiJ9",\n    "end_cursor": "eyJpZCI6InByb2QtNTAiLCJjcmVhdGVkX2F0IjoiMjAyNS0xMS0yM1QwOTowMDowMFoifQ=="\n  }\n}\n\n# Siguiente p\xe1gina\nGET /api/v1/products?limit=50&after=eyJpZCI6InByb2QtNTAiLCJjcmVhdGVkX2F0IjoiMjAyNS0xMS0yM1QwOTowMDowMFoifQ==\n\n{\n  "data": [...],  // Productos 51-100\n  "page_info": {\n    "has_next_page": true,\n    "has_previous_page": true,\n    "start_cursor": "...",\n    "end_cursor": "..."\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"revisi\xf3n-futura",children:"Revisi\xf3n Futura"}),"\n",(0,i.jsx)(n.p,{children:"Este ADR debe revisarse si:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Performance de cursor pagination supera 100ms p99"}),"\n",(0,i.jsx)(n.li,{children:'Usuarios demandan "saltar a p\xe1gina N" (considerar hybrid approach)'}),"\n",(0,i.jsx)(n.li,{children:"Sorting requirements se vuelven muy complejos"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Fecha de pr\xf3xima revisi\xf3n"}),": 2026-11-23 (1 a\xf1o)"]}),"\n",(0,i.jsx)(n.h2,{id:"referencias",children:"Referencias"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://shopify.dev/api/usage/pagination-graphql",children:"Shopify API Pagination"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://relay.dev/graphql/connections.htm",children:"GraphQL Relay Cursor Connections"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/functions-comparisons.html#ROW-WISE-COMPARISON",children:"Postgres Row Comparison"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/catalog-service/paginacion-cursor",children:"Catalog Service - Paginaci\xf3n"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/catalog-service/api-products",children:"Catalog Service - API Products"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>t});var s=r(6540);const i={},a=s.createContext(i);function o(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);