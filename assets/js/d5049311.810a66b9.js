"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[2864],{4680:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"adrs/adr-004-grpc-internal","title":"ADR-004: gRPC para Comunicaci\xf3n Interna","description":"Estado: Aceptado","source":"@site/docs/03-adrs/adr-004-grpc-internal.md","sourceDirName":"03-adrs","slug":"/adrs/adr-004-grpc-internal","permalink":"/zenlogic/adrs/adr-004-grpc-internal","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-adrs/adr-004-grpc-internal.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"docs","previous":{"title":"ADR-003: Arquitectura Event-Driven","permalink":"/zenlogic/adrs/adr-003-event-driven"},"next":{"title":"ADR-005: RBAC Multi-nivel","permalink":"/zenlogic/adrs/adr-005-rbac-multinivel"}}');var s=r(4848),a=r(8453);const l={sidebar_position:5},c="ADR-004: gRPC para Comunicaci\xf3n Interna",t={},o=[{value:"Contexto",id:"contexto",level:2},{value:"Casos de Uso S\xedncronos",id:"casos-de-uso-s\xedncronos",level:3},{value:"Requisitos",id:"requisitos",level:3},{value:"Decisi\xf3n",id:"decisi\xf3n",level:2},{value:"Hybrid Approach",id:"hybrid-approach",level:3},{value:"Alternativas Consideradas",id:"alternativas-consideradas",level:2},{value:"1. REST Interno",id:"1-rest-interno",level:3},{value:"2. GraphQL Federation",id:"2-graphql-federation",level:3},{value:"3. Apache Thrift",id:"3-apache-thrift",level:3},{value:"4. Eventos S\xedncronos (Request-Reply Pattern en RabbitMQ)",id:"4-eventos-s\xedncronos-request-reply-pattern-en-rabbitmq",level:3},{value:"Consecuencias",id:"consecuencias",level:2},{value:"Positivas",id:"positivas",level:3},{value:"Negativas",id:"negativas",level:3},{value:"Riesgos",id:"riesgos",level:3},{value:"Implementaci\xf3n",id:"implementaci\xf3n",level:2},{value:"Proto File",id:"proto-file",level:3},{value:"Server (Auth Service)",id:"server-auth-service",level:3},{value:"Client (Catalog Service)",id:"client-catalog-service",level:3},{value:"Circuit Breaker Pattern",id:"circuit-breaker-pattern",level:3},{value:"Protobuf Best Practices",id:"protobuf-best-practices",level:2},{value:"1. Nunca Reusar Field Numbers",id:"1-nunca-reusar-field-numbers",level:3},{value:"2. Usar Enums para Estados",id:"2-usar-enums-para-estados",level:3},{value:"3. Versionado de Servicios",id:"3-versionado-de-servicios",level:3},{value:"Monitoreo",id:"monitoreo",level:2},{value:"Revisi\xf3n Futura",id:"revisi\xf3n-futura",level:2},{value:"Referencias",id:"referencias",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"adr-004-grpc-para-comunicaci\xf3n-interna",children:"ADR-004: gRPC para Comunicaci\xf3n Interna"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Estado"}),": Aceptado\n",(0,s.jsx)(n.strong,{children:"Fecha"}),": 2025-11-23\n",(0,s.jsx)(n.strong,{children:"Decisores"}),": Equipo de Arquitectura zenLogic"]}),"\n",(0,s.jsx)(n.h2,{id:"contexto",children:"Contexto"}),"\n",(0,s.jsxs)(n.p,{children:["Aunque zenLogic usa arquitectura Event-Driven para la mayor\xeda de comunicaciones, existen casos donde necesitamos ",(0,s.jsx)(n.strong,{children:"comunicaci\xf3n s\xedncrona"})," entre microservicios:"]}),"\n",(0,s.jsx)(n.h3,{id:"casos-de-uso-s\xedncronos",children:"Casos de Uso S\xedncronos"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Validaci\xf3n en tiempo real"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Catalog Service necesita validar que un ",(0,s.jsx)(n.code,{children:"local_id"})," existe en Auth Service"]}),"\n",(0,s.jsx)(n.li,{children:"No puede esperar 50-100ms de eventual consistency de eventos"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Autenticaci\xf3n/Autorizaci\xf3n"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"API Gateway necesita verificar token JWT con Auth Service"}),"\n",(0,s.jsxs)(n.li,{children:["Latencia cr\xedtica: debe ser ",(0,s.jsx)(n.code,{children:"<10ms"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Queries entre servicios"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Order Service (futuro) consulta stock en Catalog Service"}),"\n",(0,s.jsx)(n.li,{children:"Necesita respuesta inmediata"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"requisitos",children:"Requisitos"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Latencia ",(0,s.jsx)(n.code,{children:"<10ms"})," (90% de requests)"]}),"\n",(0,s.jsx)(n.li,{children:"Type safety (schema expl\xedcito)"}),"\n",(0,s.jsx)(n.li,{children:"Bidirectional streaming (para casos avanzados)"}),"\n",(0,s.jsx)(n.li,{children:"Compatible con service mesh (Istio, Linkerd)"}),"\n",(0,s.jsx)(n.li,{children:"Mejor performance que REST"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"decisi\xf3n",children:"Decisi\xf3n"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Usaremos gRPC"})," para comunicaci\xf3n s\xedncrona entre microservicios internos."]}),"\n",(0,s.jsx)(n.h3,{id:"hybrid-approach",children:"Hybrid Approach"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"REST (HTTP/JSON):\n  Uso: Clientes externos (web, mobile)\n  Puerto: 8001-8010\n  Docs: OpenAPI/Swagger\n\ngRPC (HTTP/2):\n  Uso: Comunicaci\xf3n interna entre microservicios\n  Puerto: 50051-50060\n  Schema: Protocol Buffers (.proto)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"alternativas-consideradas",children:"Alternativas Consideradas"}),"\n",(0,s.jsx)(n.h3,{id:"1-rest-interno",children:"1. REST Interno"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Mismo protocolo para todo (consistencia)"}),"\n",(0,s.jsx)(n.li,{children:"F\xe1cil debugging (curl, Postman)"}),"\n",(0,s.jsx)(n.li,{children:"OpenAPI docs existentes"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Latencia mayor"}),": JSON serialization + HTTP/1.1 overhead"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"No type safety"}),": Schema en runtime, no compile-time"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"No streaming"}),": Request/response \xfanicamente"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"M\xe1s bandwidth"}),": JSON verboso vs Protobuf binario"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Benchmark"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"REST (JSON): 8-12ms latency\ngRPC (Protobuf): 2-5ms latency\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Latencia y type safety son cr\xedticos para internal calls."]}),"\n",(0,s.jsx)(n.h3,{id:"2-graphql-federation",children:"2. GraphQL Federation"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Query language flexible"}),"\n",(0,s.jsx)(n.li,{children:"Schema stitching entre servicios"}),"\n",(0,s.jsx)(n.li,{children:"Reduce over-fetching"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Overhead complejo"})," para simple validations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Latencia mayor"})," que gRPC (parsing GraphQL)"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"No streaming bidireccional"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Over-engineering"})," para internal APIs"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": GraphQL es excelente para external API aggregation, no para microservices internos."]}),"\n",(0,s.jsx)(n.h3,{id:"3-apache-thrift",children:"3. Apache Thrift"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Similar a gRPC (IDL, binario)"}),"\n",(0,s.jsx)(n.li,{children:"Performance comparable"}),"\n",(0,s.jsx)(n.li,{children:"Multi-language"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Ecosistema menor"})," que gRPC"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Menos integraci\xf3n"})," con Cloud Native tools (Istio, Envoy)"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"No HTTP/2 nativo"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Documentaci\xf3n inferior"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": gRPC tiene mejor soporte y comunidad."]}),"\n",(0,s.jsx)(n.h3,{id:"4-eventos-s\xedncronos-request-reply-pattern-en-rabbitmq",children:"4. Eventos S\xedncronos (Request-Reply Pattern en RabbitMQ)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Reutiliza infraestructura RabbitMQ existente"}),"\n",(0,s.jsx)(n.li,{children:"Message broker como intermediario"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Latencia alta"})," (",(0,s.jsx)(n.code,{children:">50ms"})," t\xedpicamente)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Complejidad"}),": correlation IDs, reply queues"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"No type safety"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Anti-pattern"}),": RabbitMQ dise\xf1ado para async"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Latencia inaceptable para validaciones cr\xedticas."]}),"\n",(0,s.jsx)(n.h2,{id:"consecuencias",children:"Consecuencias"}),"\n",(0,s.jsx)(n.h3,{id:"positivas",children:"Positivas"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Performance Excelente"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Benchmark (validaci\xf3n local_id):\nREST:  8-12ms latency\ngRPC:  2-5ms latency\n\nThroughput:\nREST:  2,000 req/s\ngRPC:  8,000 req/s\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Type Safety en Compile-Time"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:'// auth.proto\nsyntax = "proto3";\n\nservice AuthService {\n    rpc ValidateLocal(ValidateLocalRequest) returns (ValidateLocalResponse);\n    rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse);\n}\n\nmessage ValidateLocalRequest {\n    string user_id = 1;\n    string organization_id = 2;\n    string local_id = 3;\n}\n\nmessage ValidateLocalResponse {\n    bool is_valid = 1;\n    string local_name = 2;\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# Code generation autom\xe1tico\n$ python -m grpc_tools.protoc --python_out=. --grpc_python_out=. auth.proto\n\n# Type hints autom\xe1ticos en Python\nresponse: ValidateLocalResponse = await auth_client.ValidateLocal(\n    ValidateLocalRequest(\n        user_id="user-uuid",\n        organization_id="org-uuid",\n        local_id="local-uuid"\n    )\n)\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"HTTP/2 Benefits"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Multiplexing: m\xfaltiples requests en una conexi\xf3n"}),"\n",(0,s.jsx)(n.li,{children:"Header compression (HPACK)"}),"\n",(0,s.jsx)(n.li,{children:"Server push (para streaming)"}),"\n",(0,s.jsx)(n.li,{children:"Bidirectional streaming"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Streaming Support"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:"service InventoryService {\n    // Server streaming: enviar stock updates en tiempo real\n    rpc WatchStock(WatchStockRequest) returns (stream StockUpdate);\n\n    // Client streaming: bulk upload\n    rpc BulkImport(stream Product) returns (ImportSummary);\n\n    // Bidirectional: chat, real-time sync\n    rpc Sync(stream SyncRequest) returns (stream SyncResponse);\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Protobuf Compacto"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'// JSON (REST): 156 bytes\n{\n    "user_id": "550e8400-e29b-41d4-a716-446655440000",\n    "organization_id": "660e8400-e29b-41d4-a716-446655440001",\n    "local_id": "770e8400-e29b-41d4-a716-446655440002"\n}\n\n// Protobuf (gRPC): 68 bytes\n// ~56% reduction\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Service Mesh Integration"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# Istio VirtualService\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: auth-service-grpc\nspec:\n  hosts:\n  - auth-service\n  http:\n  - match:\n    - port: 50051\n    route:\n    - destination:\n        host: auth-service\n        port:\n          number: 50051\n      weight: 90\n    - destination:\n        host: auth-service-v2\n        port:\n          number: 50051\n      weight: 10  # Canary deployment\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"negativas",children:"Negativas"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Dos Protocolos en Sistema"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"REST para external APIs"}),"\n",(0,s.jsx)(n.li,{children:"gRPC para internal APIs"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Separaci\xf3n clara: external REST (8001), internal gRPC (50051)"}),"\n",(0,s.jsx)(n.li,{children:"Docs claras sobre cu\xe1ndo usar cada uno"}),"\n",(0,s.jsx)(n.li,{children:"API Gateway maneja REST\u2192gRPC translation si es necesario"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Debugging M\xe1s Dif\xedcil"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["No puedes hacer ",(0,s.jsx)(n.code,{children:"curl"})," a gRPC"]}),"\n",(0,s.jsx)(n.li,{children:"Protobuf binario no es human-readable"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["grpcurl: curl-like para gRPC","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'grpcurl -plaintext -d \'{"user_id": "..."}\' \\\n  localhost:50051 auth.AuthService/ValidateLocal\n'})}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Postman soporta gRPC (versi\xf3n 9+)"}),"\n",(0,s.jsx)(n.li,{children:"BloomRPC: GUI client para gRPC"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Code Generation Required"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:".proto"})," \u2192 generar c\xf3digo Python"]}),"\n",(0,s.jsxs)(n.li,{children:["Cambio en ",(0,s.jsx)(n.code,{children:".proto"})," \u2192 regenerar c\xf3digo"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Script de generaci\xf3n automatizado","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# scripts/generate_protos.sh\npython -m grpc_tools.protoc \\\n  --proto_path=./protos \\\n  --python_out=./app/grpc_generated \\\n  --grpc_python_out=./app/grpc_generated \\\n  ./protos/*.proto\n"})}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"CI/CD genera c\xf3digo autom\xe1ticamente"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Compatibilidad Browser Limitada"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Browsers no soportan gRPC nativamente (HTTP/2 binario)"}),"\n",(0,s.jsx)(n.li,{children:"Necesita gRPC-Web + proxy (Envoy)"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),": No usamos gRPC para browser\u2192backend, solo internal"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"riesgos",children:"Riesgos"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Breaking Changes en .proto"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Cambiar ",(0,s.jsx)(n.code,{children:"message"})," puede romper clientes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Versionado de servicios (AuthServiceV1, AuthServiceV2)"}),"\n",(0,s.jsx)(n.li,{children:"Nunca reusar field numbers"}),"\n",(0,s.jsxs)(n.li,{children:["Usar ",(0,s.jsx)(n.code,{children:"reserved"})," para campos removidos","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:'message User {\n    reserved 2, 15, 9 to 11;\n    reserved "old_field", "deprecated_field";\n    string name = 1;\n}\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Load Balancing HTTP/2"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"gRPC usa conexi\xf3n persistente HTTP/2"}),"\n",(0,s.jsx)(n.li,{children:"L4 load balancer (TCP) no distribuye bien requests"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Usar L7 load balancer (Envoy, Linkerd)"}),"\n",(0,s.jsxs)(n.li,{children:["gRPC client-side load balancing","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"channel = grpc.aio.insecure_channel(\n    'dns:///auth-service:50051',\n    options=[('grpc.lb_policy_name', 'round_robin')]\n)\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Connection Starvation"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Un servicio lento puede saturar connection pool"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Timeouts agresivos (5-10s)"}),"\n",(0,s.jsx)(n.li,{children:"Circuit breaker pattern"}),"\n",(0,s.jsx)(n.li,{children:"Max connections configurado"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"implementaci\xf3n",children:"Implementaci\xf3n"}),"\n",(0,s.jsx)(n.h3,{id:"proto-file",children:"Proto File"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:'// protos/auth.proto\nsyntax = "proto3";\n\npackage auth;\n\nservice AuthService {\n    // Validar si usuario tiene acceso a un local\n    rpc ValidateLocal(ValidateLocalRequest) returns (ValidateLocalResponse);\n\n    // Verificar token JWT\n    rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse);\n\n    // Obtener permisos de usuario\n    rpc GetUserPermissions(GetUserPermissionsRequest) returns (GetUserPermissionsResponse);\n}\n\nmessage ValidateLocalRequest {\n    string user_id = 1;\n    string organization_id = 2;\n    string local_id = 3;\n}\n\nmessage ValidateLocalResponse {\n    bool is_valid = 1;\n    string local_name = 2;\n    string error_message = 3;\n}\n\nmessage VerifyTokenRequest {\n    string token = 1;\n}\n\nmessage VerifyTokenResponse {\n    bool is_valid = 1;\n    string user_id = 2;\n    string organization_id = 3;\n    repeated string permissions = 4;\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"server-auth-service",children:"Server (Auth Service)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# app/grpc_server/auth_service.py\nimport grpc\nfrom app.grpc_generated import auth_pb2, auth_pb2_grpc\nfrom app.services.auth_service import AuthService\n\nclass AuthServicer(auth_pb2_grpc.AuthServiceServicer):\n    def __init__(self, auth_service: AuthService):\n        self.auth_service = auth_service\n\n    async def ValidateLocal(\n        self,\n        request: auth_pb2.ValidateLocalRequest,\n        context: grpc.aio.ServicerContext\n    ) -> auth_pb2.ValidateLocalResponse:\n        try:\n            is_valid, local_name = await self.auth_service.validate_local(\n                user_id=request.user_id,\n                organization_id=request.organization_id,\n                local_id=request.local_id\n            )\n            return auth_pb2.ValidateLocalResponse(\n                is_valid=is_valid,\n                local_name=local_name\n            )\n        except Exception as e:\n            logger.error(f"ValidateLocal error: {e}")\n            return auth_pb2.ValidateLocalResponse(\n                is_valid=False,\n                error_message=str(e)\n            )\n\nasync def serve():\n    server = grpc.aio.server()\n    auth_pb2_grpc.add_AuthServiceServicer_to_server(\n        AuthServicer(auth_service),\n        server\n    )\n    server.add_insecure_port(\'[::]:50051\')\n    await server.start()\n    logger.info("gRPC server started on port 50051")\n    await server.wait_for_termination()\n'})}),"\n",(0,s.jsx)(n.h3,{id:"client-catalog-service",children:"Client (Catalog Service)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"# app/clients/auth_client.py\nimport grpc\nfrom app.grpc_generated import auth_pb2, auth_pb2_grpc\nfrom app.config import settings\n\nclass AuthClient:\n    def __init__(self):\n        self.channel = grpc.aio.insecure_channel(\n            settings.auth_grpc_url,  # \"auth-service:50051\"\n            options=[\n                ('grpc.lb_policy_name', 'round_robin'),\n                ('grpc.keepalive_time_ms', 10000),\n                ('grpc.keepalive_timeout_ms', 5000)\n            ]\n        )\n        self.stub = auth_pb2_grpc.AuthServiceStub(self.channel)\n\n    async def validate_local(\n        self,\n        user_id: str,\n        organization_id: str,\n        local_id: str\n    ) -> bool:\n        try:\n            request = auth_pb2.ValidateLocalRequest(\n                user_id=user_id,\n                organization_id=organization_id,\n                local_id=local_id\n            )\n            response = await self.stub.ValidateLocal(\n                request,\n                timeout=5.0  # 5s timeout\n            )\n            return response.is_valid\n        except grpc.RpcError as e:\n            logger.error(f\"gRPC error: {e.code()} - {e.details()}\")\n            return False\n\n    async def close(self):\n        await self.channel.close()\n"})}),"\n",(0,s.jsx)(n.h3,{id:"circuit-breaker-pattern",children:"Circuit Breaker Pattern"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# app/clients/auth_client_with_circuit_breaker.py\nfrom circuitbreaker import CircuitBreaker, CircuitBreakerError\n\nclass AuthClientWithCircuitBreaker:\n    def __init__(self, grpc_client: AuthClient, rest_client: AuthRestClient):\n        self.grpc_client = grpc_client\n        self.rest_client = rest_client\n        self.circuit_breaker = CircuitBreaker(\n            failure_threshold=5,\n            recovery_timeout=60,\n            expected_exception=grpc.RpcError\n        )\n\n    async def validate_local(self, user_id: str, org_id: str, local_id: str) -> bool:\n        try:\n            return await self._validate_local_grpc(user_id, org_id, local_id)\n        except CircuitBreakerError:\n            # Fallback a REST si gRPC est\xe1 ca\xeddo\n            logger.warning("gRPC circuit breaker open, falling back to REST")\n            return await self._validate_local_rest(user_id, org_id, local_id)\n\n    @CircuitBreaker(failure_threshold=5)\n    async def _validate_local_grpc(self, user_id, org_id, local_id):\n        return await self.grpc_client.validate_local(user_id, org_id, local_id)\n\n    async def _validate_local_rest(self, user_id, org_id, local_id):\n        # Fallback HTTP\n        response = await self.rest_client.get(\n            f"/api/v1/locals/{local_id}/validate",\n            params={"user_id": user_id, "organization_id": org_id}\n        )\n        return response.json()["is_valid"]\n'})}),"\n",(0,s.jsx)(n.h2,{id:"protobuf-best-practices",children:"Protobuf Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"1-nunca-reusar-field-numbers",children:"1. Nunca Reusar Field Numbers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:"message User {\n    string name = 1;\n    // int32 age = 2;  // \u274c REMOVED - NO REUSAR #2\n\n    reserved 2;  // \u2705 Reservar n\xfamero\n    string email = 3;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-usar-enums-para-estados",children:"2. Usar Enums para Estados"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:"enum OrderStatus {\n    ORDER_STATUS_UNSPECIFIED = 0;  // Siempre valor 0 por defecto\n    ORDER_STATUS_PENDING = 1;\n    ORDER_STATUS_PROCESSING = 2;\n    ORDER_STATUS_COMPLETED = 3;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-versionado-de-servicios",children:"3. Versionado de Servicios"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-protobuf",children:"service AuthServiceV1 {\n    rpc ValidateLocal(ValidateLocalRequest) returns (ValidateLocalResponse);\n}\n\nservice AuthServiceV2 {\n    rpc ValidateLocal(ValidateLocalRequestV2) returns (ValidateLocalResponseV2);\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"monitoreo",children:"Monitoreo"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"from prometheus_client import Histogram, Counter\n\ngrpc_request_duration = Histogram(\n    'grpc_request_duration_seconds',\n    'gRPC request duration',\n    ['service', 'method']\n)\n\ngrpc_requests_total = Counter(\n    'grpc_requests_total',\n    'Total gRPC requests',\n    ['service', 'method', 'status']\n)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"revisi\xf3n-futura",children:"Revisi\xf3n Futura"}),"\n",(0,s.jsx)(n.p,{children:"Este ADR debe revisarse si:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Latencia gRPC supera 20ms (investigar causes)"}),"\n",(0,s.jsx)(n.li,{children:"Debugging se vuelve muy complejo (considerar herramientas mejores)"}),"\n",(0,s.jsx)(n.li,{children:"Necesitamos browser\u2192backend directo con gRPC-Web"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Fecha de pr\xf3xima revisi\xf3n"}),": 2026-11-23 (1 a\xf1o)"]}),"\n",(0,s.jsx)(n.h2,{id:"referencias",children:"Referencias"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://grpc.io/docs/",children:"gRPC Official Documentation"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://developers.google.com/protocol-buffers/docs/proto3",children:"Protocol Buffers Language Guide"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://grpc.io/docs/languages/python/quickstart/",children:"gRPC Python Quickstart"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/catalog-service/auth-client-grpc",children:"Catalog Service - Auth Client gRPC"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/microservicios/auth-service/grpc-server",children:"Auth Service - gRPC Server"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/arquitectura/comunicacion-microservicios",children:"Comunicaci\xf3n entre Microservicios"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>c});var i=r(6540);const s={},a=i.createContext(s);function l(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);