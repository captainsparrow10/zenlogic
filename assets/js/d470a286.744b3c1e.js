"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[6869],{6325:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"microservicios/order-service/state-machine","title":"M\xe1quina de Estados de Orden","description":"Definici\xf3n completa de la m\xe1quina de estados del Order Service con transiciones, validaciones y eventos.","source":"@site/docs/02-microservicios/order-service/16-state-machine.md","sourceDirName":"02-microservicios/order-service","slug":"/microservicios/order-service/state-machine","permalink":"/zenlogic/microservicios/order-service/state-machine","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/order-service/16-state-machine.md","tags":[],"version":"current","sidebarPosition":16,"frontMatter":{"sidebar_position":16},"sidebar":"docs","previous":{"title":"API: Cart","permalink":"/zenlogic/microservicios/order-service/api-cart"},"next":{"title":"Eventos Publicados","permalink":"/zenlogic/microservicios/order-service/eventos-publicados"}}');var i=r(4848),d=r(8453);const t={sidebar_position:16},c="M\xe1quina de Estados de Orden",l={},a=[{value:"Diagrama de Estados",id:"diagrama-de-estados",level:2},{value:"Estados Definidos",id:"estados-definidos",level:2},{value:"1. cart",id:"1-cart",level:3},{value:"2. pending",id:"2-pending",level:3},{value:"3. payment_pending",id:"3-payment_pending",level:3},{value:"4. payment_failed",id:"4-payment_failed",level:3},{value:"5. confirmed",id:"5-confirmed",level:3},{value:"6. processing",id:"6-processing",level:3},{value:"7. ready_to_ship",id:"7-ready_to_ship",level:3},{value:"8. shipped",id:"8-shipped",level:3},{value:"9. delivered",id:"9-delivered",level:3},{value:"10. return_requested",id:"10-return_requested",level:3},{value:"11. returned",id:"11-returned",level:3},{value:"12. refunded",id:"12-refunded",level:3},{value:"13. cancelled",id:"13-cancelled",level:3},{value:"Matriz de Transiciones",id:"matriz-de-transiciones",level:2},{value:"Implementaci\xf3n en C\xf3digo",id:"implementaci\xf3n-en-c\xf3digo",level:2},{value:"State Machine Class",id:"state-machine-class",level:3},{value:"Usage Examples",id:"usage-examples",level:3},{value:"Validaciones por Estado",id:"validaciones-por-estado",level:2},{value:"Confirmed \u2192 Cancelled",id:"confirmed--cancelled",level:3},{value:"Processing \u2192 Cancelled",id:"processing--cancelled",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"m\xe1quina-de-estados-de-orden",children:"M\xe1quina de Estados de Orden"})}),"\n",(0,i.jsx)(n.p,{children:"Definici\xf3n completa de la m\xe1quina de estados del Order Service con transiciones, validaciones y eventos."}),"\n",(0,i.jsx)(n.h2,{id:"diagrama-de-estados",children:"Diagrama de Estados"}),"\n",(0,i.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e cart: add_to_cart\n    cart --\x3e pending: checkout\n    pending --\x3e payment_pending: create_order\n\n    payment_pending --\x3e payment_failed: payment_fails\n    payment_pending --\x3e confirmed: payment_succeeds\n\n    payment_failed --\x3e cancelled: timeout_or_cancel\n    payment_failed --\x3e payment_pending: retry_payment\n\n    confirmed --\x3e processing: start_fulfillment\n    confirmed --\x3e cancelled: cancel_before_processing\n\n    processing --\x3e ready_to_ship: picking_complete\n    processing --\x3e cancelled: cancel_with_approval\n\n    ready_to_ship --\x3e shipped: dispatch\n    shipped --\x3e delivered: confirm_delivery\n\n    delivered --\x3e return_requested: request_return\n    return_requested --\x3e returned: receive_return\n    returned --\x3e refunded: process_refund\n\n    cancelled --\x3e [*]\n    refunded --\x3e [*]\n    delivered --\x3e [*]"}),"\n",(0,i.jsx)(n.h2,{id:"estados-definidos",children:"Estados Definidos"}),"\n",(0,i.jsx)(n.h3,{id:"1-cart",children:"1. cart"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Productos agregados al carrito, a\xfan no convertido a orden."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Agregar productos"}),"\n",(0,i.jsx)(n.li,{children:"Remover productos"}),"\n",(0,i.jsx)(n.li,{children:"Actualizar cantidades"}),"\n",(0,i.jsx)(n.li,{children:"Aplicar cupones"}),"\n",(0,i.jsx)(n.li,{children:"Proceder a checkout"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"cart.item_added"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"cart.item_removed"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"cart.updated"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Usuario hace checkout \u2192 ",(0,i.jsx)(n.code,{children:"pending"})]}),"\n",(0,i.jsxs)(n.li,{children:["Carrito expira (30 d\xedas) \u2192 ",(0,i.jsx)(n.code,{children:"abandoned"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"2-pending",children:"2. pending"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Orden creada, esperando confirmaci\xf3n del usuario para procesar pago."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Proceder a pago"}),"\n",(0,i.jsx)(n.li,{children:"Cancelar orden"}),"\n",(0,i.jsx)(n.li,{children:"Actualizar direcci\xf3n de env\xedo"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.created"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Usuario confirma y procede a pago \u2192 ",(0,i.jsx)(n.code,{children:"payment_pending"})]}),"\n",(0,i.jsxs)(n.li,{children:["Usuario cancela \u2192 ",(0,i.jsx)(n.code,{children:"cancelled"})]}),"\n",(0,i.jsxs)(n.li,{children:["Timeout (15 min) \u2192 ",(0,i.jsx)(n.code,{children:"cancelled"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"3-payment_pending",children:"3. payment_pending"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Procesando pago con el gateway."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Esperar resultado del pago"}),"\n",(0,i.jsx)(n.li,{children:"Cancelar (antes de que se procese)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"payment.pending"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Pago exitoso \u2192 ",(0,i.jsx)(n.code,{children:"confirmed"})]}),"\n",(0,i.jsxs)(n.li,{children:["Pago fallido \u2192 ",(0,i.jsx)(n.code,{children:"payment_failed"})]}),"\n",(0,i.jsxs)(n.li,{children:["Pago requiere 3D Secure \u2192 ",(0,i.jsx)(n.code,{children:"payment_action_required"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Timeout:"})," 5 minutos"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"4-payment_failed",children:"4. payment_failed"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," El pago fue rechazado por el gateway o banco."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Reintentar con otro m\xe9todo de pago"}),"\n",(0,i.jsx)(n.li,{children:"Actualizar informaci\xf3n de pago"}),"\n",(0,i.jsx)(n.li,{children:"Cancelar orden"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"payment.failed"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Reintenta pago \u2192 ",(0,i.jsx)(n.code,{children:"payment_pending"})]}),"\n",(0,i.jsxs)(n.li,{children:["Usuario cancela \u2192 ",(0,i.jsx)(n.code,{children:"cancelled"})]}),"\n",(0,i.jsxs)(n.li,{children:["Timeout (24 horas) \u2192 ",(0,i.jsx)(n.code,{children:"cancelled"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Reintentos M\xe1ximos:"})," 3"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"5-confirmed",children:"5. confirmed"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Pago confirmado, orden lista para fulfillment."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Asignar a bodega"}),"\n",(0,i.jsx)(n.li,{children:"Iniciar fulfillment"}),"\n",(0,i.jsx)(n.li,{children:"Cancelar (con pol\xedticas)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.confirmed"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.payment_confirmed"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Fulfillment inicia \u2192 ",(0,i.jsx)(n.code,{children:"processing"})]}),"\n",(0,i.jsxs)(n.li,{children:["Usuario cancela (dentro de ventana) \u2192 ",(0,i.jsx)(n.code,{children:"cancelled"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Ventana de Cancelaci\xf3n:"})," 2 horas despu\xe9s de confirmaci\xf3n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"6-processing",children:"6. processing"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Orden en proceso de picking y packing."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Actualizar estado de picking"}),"\n",(0,i.jsx)(n.li,{children:"Marcar items como pickeados"}),"\n",(0,i.jsx)(n.li,{children:"Cancelar (requiere aprobaci\xf3n de manager)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.processing"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"fulfillment.started"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"fulfillment.item_picked"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Picking completo \u2192 ",(0,i.jsx)(n.code,{children:"ready_to_ship"})]}),"\n",(0,i.jsxs)(n.li,{children:["Cancelaci\xf3n aprobada \u2192 ",(0,i.jsx)(n.code,{children:"cancelled"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"7-ready_to_ship",children:"7. ready_to_ship"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Orden empacada y lista para despacho."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Generar etiqueta de env\xedo"}),"\n",(0,i.jsx)(n.li,{children:"Asignar a carrier"}),"\n",(0,i.jsx)(n.li,{children:"Despachar"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.ready_to_ship"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"shipment.label_created"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Despachada \u2192 ",(0,i.jsx)(n.code,{children:"shipped"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"8-shipped",children:"8. shipped"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Orden despachada, en tr\xe1nsito al cliente."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Actualizar tracking"}),"\n",(0,i.jsx)(n.li,{children:"Confirmar entrega"}),"\n",(0,i.jsx)(n.li,{children:"Reportar problema de entrega"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.shipped"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"shipment.dispatched"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"shipment.in_transit"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"shipment.out_for_delivery"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Entrega confirmada \u2192 ",(0,i.jsx)(n.code,{children:"delivered"})]}),"\n",(0,i.jsxs)(n.li,{children:["Entrega fallida (3 intentos) \u2192 ",(0,i.jsx)(n.code,{children:"shipment_failed"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"9-delivered",children:"9. delivered"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Orden entregada exitosamente al cliente."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Solicitar devoluci\xf3n (dentro de ventana)"}),"\n",(0,i.jsx)(n.li,{children:"Dejar rese\xf1a"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.delivered"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"shipment.delivered"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Solicita devoluci\xf3n \u2192 ",(0,i.jsx)(n.code,{children:"return_requested"})]}),"\n",(0,i.jsx)(n.li,{children:"Orden completada \u2192 Estado final"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Ventana de Devoluci\xf3n:"})," 30 d\xedas"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"10-return_requested",children:"10. return_requested"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Cliente solicit\xf3 devoluci\xf3n de productos."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Aprobar devoluci\xf3n"}),"\n",(0,i.jsx)(n.li,{children:"Rechazar devoluci\xf3n"}),"\n",(0,i.jsx)(n.li,{children:"Solicitar m\xe1s informaci\xf3n"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"return.requested"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Aprobada y recibida \u2192 ",(0,i.jsx)(n.code,{children:"returned"})]}),"\n",(0,i.jsxs)(n.li,{children:["Rechazada \u2192 ",(0,i.jsx)(n.code,{children:"delivered"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"11-returned",children:"11. returned"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Productos devueltos y recibidos en bodega."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Inspeccionar productos"}),"\n",(0,i.jsx)(n.li,{children:"Procesar reembolso"}),"\n",(0,i.jsx)(n.li,{children:"Reabastecer inventario"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"return.received"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"return.inspected"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Condiciones de Salida:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Reembolso procesado \u2192 ",(0,i.jsx)(n.code,{children:"refunded"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"12-refunded",children:"12. refunded"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Reembolso completado. Estado final."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Ver historial"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"return.refunded"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.refunded"})}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"13-cancelled",children:"13. cancelled"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Descripci\xf3n:"})," Orden cancelada. Estado final."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Acciones Permitidas:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Ver historial"}),"\n",(0,i.jsx)(n.li,{children:"Crear nueva orden"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"order.cancelled"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Motivos de Cancelaci\xf3n:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"customer_request"})," - Cliente cancel\xf3"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"payment_failed"})," - Pago fallido"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"timeout"})," - Expir\xf3 tiempo de pago"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"fraud_detected"})," - Fraude detectado"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"out_of_stock"})," - Sin stock disponible"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"admin_action"})," - Cancelado por admin"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"matriz-de-transiciones",children:"Matriz de Transiciones"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Estado Actual"}),(0,i.jsx)(n.th,{children:"Acci\xf3n"}),(0,i.jsx)(n.th,{children:"Estado Siguiente"}),(0,i.jsx)(n.th,{children:"Requiere Aprobaci\xf3n"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"cart"}),(0,i.jsx)(n.td,{children:"checkout"}),(0,i.jsx)(n.td,{children:"pending"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"pending"}),(0,i.jsx)(n.td,{children:"create_order"}),(0,i.jsx)(n.td,{children:"payment_pending"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"payment_pending"}),(0,i.jsx)(n.td,{children:"payment_success"}),(0,i.jsx)(n.td,{children:"confirmed"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"payment_pending"}),(0,i.jsx)(n.td,{children:"payment_failure"}),(0,i.jsx)(n.td,{children:"payment_failed"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"payment_failed"}),(0,i.jsx)(n.td,{children:"retry_payment"}),(0,i.jsx)(n.td,{children:"payment_pending"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"payment_failed"}),(0,i.jsx)(n.td,{children:"cancel"}),(0,i.jsx)(n.td,{children:"cancelled"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"confirmed"}),(0,i.jsx)(n.td,{children:"start_fulfillment"}),(0,i.jsx)(n.td,{children:"processing"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"confirmed"}),(0,i.jsx)(n.td,{children:"cancel"}),(0,i.jsx)(n.td,{children:"cancelled"}),(0,i.jsx)(n.td,{children:"S\xed (dentro de 2h)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"processing"}),(0,i.jsx)(n.td,{children:"picking_complete"}),(0,i.jsx)(n.td,{children:"ready_to_ship"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"processing"}),(0,i.jsx)(n.td,{children:"cancel"}),(0,i.jsx)(n.td,{children:"cancelled"}),(0,i.jsx)(n.td,{children:"S\xed (Manager)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"ready_to_ship"}),(0,i.jsx)(n.td,{children:"dispatch"}),(0,i.jsx)(n.td,{children:"shipped"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"shipped"}),(0,i.jsx)(n.td,{children:"confirm_delivery"}),(0,i.jsx)(n.td,{children:"delivered"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"delivered"}),(0,i.jsx)(n.td,{children:"request_return"}),(0,i.jsx)(n.td,{children:"return_requested"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"return_requested"}),(0,i.jsx)(n.td,{children:"approve_return"}),(0,i.jsx)(n.td,{children:"returned"}),(0,i.jsx)(n.td,{children:"S\xed"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"return_requested"}),(0,i.jsx)(n.td,{children:"reject_return"}),(0,i.jsx)(n.td,{children:"delivered"}),(0,i.jsx)(n.td,{children:"S\xed"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"returned"}),(0,i.jsx)(n.td,{children:"process_refund"}),(0,i.jsx)(n.td,{children:"refunded"}),(0,i.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"implementaci\xf3n-en-c\xf3digo",children:"Implementaci\xf3n en C\xf3digo"}),"\n",(0,i.jsx)(n.h3,{id:"state-machine-class",children:"State Machine Class"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# services/order_state_machine.py\nfrom enum import Enum\nfrom typing import Optional, Dict, Any\nfrom datetime import datetime, timedelta\n\nclass OrderStatus(str, Enum):\n    CART = 'cart'\n    PENDING = 'pending'\n    PAYMENT_PENDING = 'payment_pending'\n    PAYMENT_FAILED = 'payment_failed'\n    CONFIRMED = 'confirmed'\n    PROCESSING = 'processing'\n    READY_TO_SHIP = 'ready_to_ship'\n    SHIPPED = 'shipped'\n    DELIVERED = 'delivered'\n    RETURN_REQUESTED = 'return_requested'\n    RETURNED = 'returned'\n    REFUNDED = 'refunded'\n    CANCELLED = 'cancelled'\n\nclass OrderStateMachine:\n    \"\"\"State machine for order status transitions.\"\"\"\n\n    # Define valid transitions\n    TRANSITIONS = {\n        OrderStatus.CART: [OrderStatus.PENDING],\n        OrderStatus.PENDING: [OrderStatus.PAYMENT_PENDING, OrderStatus.CANCELLED],\n        OrderStatus.PAYMENT_PENDING: [\n            OrderStatus.CONFIRMED,\n            OrderStatus.PAYMENT_FAILED\n        ],\n        OrderStatus.PAYMENT_FAILED: [\n            OrderStatus.PAYMENT_PENDING,\n            OrderStatus.CANCELLED\n        ],\n        OrderStatus.CONFIRMED: [OrderStatus.PROCESSING, OrderStatus.CANCELLED],\n        OrderStatus.PROCESSING: [\n            OrderStatus.READY_TO_SHIP,\n            OrderStatus.CANCELLED\n        ],\n        OrderStatus.READY_TO_SHIP: [OrderStatus.SHIPPED],\n        OrderStatus.SHIPPED: [OrderStatus.DELIVERED],\n        OrderStatus.DELIVERED: [OrderStatus.RETURN_REQUESTED],\n        OrderStatus.RETURN_REQUESTED: [\n            OrderStatus.RETURNED,\n            OrderStatus.DELIVERED\n        ],\n        OrderStatus.RETURNED: [OrderStatus.REFUNDED],\n    }\n\n    # Define which transitions require approval\n    REQUIRES_APPROVAL = {\n        (OrderStatus.CONFIRMED, OrderStatus.CANCELLED): True,\n        (OrderStatus.PROCESSING, OrderStatus.CANCELLED): True,\n    }\n\n    @classmethod\n    def can_transition(\n        cls,\n        from_status: OrderStatus,\n        to_status: OrderStatus\n    ) -> bool:\n        \"\"\"Check if transition is valid.\"\"\"\n        valid_next_states = cls.TRANSITIONS.get(from_status, [])\n        return to_status in valid_next_states\n\n    @classmethod\n    def requires_approval(\n        cls,\n        from_status: OrderStatus,\n        to_status: OrderStatus\n    ) -> bool:\n        \"\"\"Check if transition requires approval.\"\"\"\n        return cls.REQUIRES_APPROVAL.get(\n            (from_status, to_status),\n            False\n        )\n\n    @classmethod\n    async def transition(\n        cls,\n        order: 'Order',\n        to_status: OrderStatus,\n        **kwargs\n    ) -> 'Order':\n        \"\"\"\n        Execute state transition with validations.\n        \"\"\"\n        from_status = OrderStatus(order.status)\n\n        # Validate transition\n        if not cls.can_transition(from_status, to_status):\n            raise InvalidTransitionError(\n                f\"Cannot transition from {from_status} to {to_status}\"\n            )\n\n        # Check approval requirement\n        if cls.requires_approval(from_status, to_status):\n            approved_by = kwargs.get('approved_by')\n            if not approved_by:\n                raise ApprovalRequiredError(\n                    f\"Transition {from_status} -> {to_status} requires approval\"\n                )\n\n        # Execute pre-transition actions\n        await cls._execute_pre_transition(order, from_status, to_status, **kwargs)\n\n        # Update status\n        order.status = to_status.value\n        order.updated_at = datetime.utcnow()\n\n        # Set specific timestamps\n        if to_status == OrderStatus.CONFIRMED:\n            order.confirmed_at = datetime.utcnow()\n        elif to_status == OrderStatus.CANCELLED:\n            order.cancelled_at = datetime.utcnow()\n\n        # Execute post-transition actions\n        await cls._execute_post_transition(order, from_status, to_status, **kwargs)\n\n        # Publish event\n        await cls._publish_transition_event(order, from_status, to_status)\n\n        return order\n\n    @classmethod\n    async def _execute_pre_transition(\n        cls,\n        order: 'Order',\n        from_status: OrderStatus,\n        to_status: OrderStatus,\n        **kwargs\n    ) -> None:\n        \"\"\"Execute actions before transition.\"\"\"\n\n        # Confirm \u2192 Cancelled: Release stock reservation\n        if from_status == OrderStatus.CONFIRMED and to_status == OrderStatus.CANCELLED:\n            await cls._release_stock_reservation(order)\n\n        # Processing \u2192 Cancelled: Return picked items\n        if from_status == OrderStatus.PROCESSING and to_status == OrderStatus.CANCELLED:\n            await cls._return_picked_items(order)\n\n    @classmethod\n    async def _execute_post_transition(\n        cls,\n        order: 'Order',\n        from_status: OrderStatus,\n        to_status: OrderStatus,\n        **kwargs\n    ) -> None:\n        \"\"\"Execute actions after transition.\"\"\"\n\n        # Payment Pending \u2192 Confirmed: Confirm stock reservation\n        if to_status == OrderStatus.CONFIRMED:\n            await cls._confirm_stock_reservation(order)\n\n        # Ready to Ship \u2192 Shipped: Create tracking\n        if to_status == OrderStatus.SHIPPED:\n            await cls._create_shipment_tracking(order, **kwargs)\n\n    @classmethod\n    async def _publish_transition_event(\n        cls,\n        order: 'Order',\n        from_status: OrderStatus,\n        to_status: OrderStatus\n    ) -> None:\n        \"\"\"Publish event for state transition.\"\"\"\n        event_type = f\"order.status_changed.{to_status.value}\"\n\n        await event_publisher.publish(event_type, {\n            'order_id': order.order_id,\n            'order_number': order.order_number,\n            'from_status': from_status.value,\n            'to_status': to_status.value,\n            'timestamp': datetime.utcnow().isoformat()\n        })\n"})}),"\n",(0,i.jsx)(n.h3,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Example 1: Confirm payment\norder = await order_service.get_order(order_id)\norder = await OrderStateMachine.transition(\n    order,\n    OrderStatus.CONFIRMED,\n    payment_id='pay_123'\n)\nawait db.commit()\n\n# Example 2: Cancel with approval\norder = await OrderStateMachine.transition(\n    order,\n    OrderStatus.CANCELLED,\n    approved_by='user_manager_456',\n    cancellation_reason='customer_request'\n)\nawait db.commit()\n\n# Example 3: Invalid transition (raises error)\ntry:\n    order = await OrderStateMachine.transition(\n        order,\n        OrderStatus.DELIVERED  # From 'confirmed' - invalid\n    )\nexcept InvalidTransitionError as e:\n    print(f\"Error: {e}\")\n"})}),"\n",(0,i.jsx)(n.h2,{id:"validaciones-por-estado",children:"Validaciones por Estado"}),"\n",(0,i.jsx)(n.h3,{id:"confirmed--cancelled",children:"Confirmed \u2192 Cancelled"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def validate_confirmed_to_cancelled(order: Order) -> None:\n    """Validate cancellation of confirmed order."""\n\n    # Check cancellation window (2 hours)\n    if order.confirmed_at:\n        elapsed = datetime.utcnow() - order.confirmed_at\n        if elapsed > timedelta(hours=2):\n            raise CancellationWindowExpiredError(\n                "Cannot cancel order after 2 hours of confirmation"\n            )\n\n    # Check if fulfillment started\n    if order.fulfillment_status != \'pending\':\n        raise FulfillmentAlreadyStartedError(\n            "Cannot cancel order with started fulfillment"\n        )\n'})}),"\n",(0,i.jsx)(n.h3,{id:"processing--cancelled",children:"Processing \u2192 Cancelled"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def validate_processing_to_cancelled(order: Order, approved_by: str) -> None:\n    """Validate cancellation of processing order."""\n\n    # Requires manager approval\n    user = await user_service.get_user(approved_by)\n    if \'order.manager\' not in user.roles:\n        raise InsufficientPermissionsError(\n            "Only managers can cancel orders in processing"\n        )\n\n    # Check picking progress\n    picked_items = await fulfillment_service.get_picked_items(order.order_id)\n    if picked_items:\n        # Create return task for picked items\n        await fulfillment_service.create_return_task(order.order_id, picked_items)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./api-orders",children:"API: Orders"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./flujos-negocio",children:"Flujos de Negocio"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./eventos-publicados",children:"Eventos Publicados"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>c});var s=r(6540);const i={},d=s.createContext(i);function t(e){const n=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);