"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[2616],{6439:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"adrs/adr-005-rbac-multinivel","title":"ADR-005: RBAC Multi-nivel","description":"Estado: Aceptado","source":"@site/docs/03-adrs/adr-005-rbac-multinivel.md","sourceDirName":"03-adrs","slug":"/adrs/adr-005-rbac-multinivel","permalink":"/zenlogic/adrs/adr-005-rbac-multinivel","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-adrs/adr-005-rbac-multinivel.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docs","previous":{"title":"ADR-004: gRPC para Comunicaci\xf3n Interna","permalink":"/zenlogic/adrs/adr-004-grpc-internal"},"next":{"title":"ADR-006: PostgreSQL Row-Level Security para Multi-tenancy","permalink":"/zenlogic/adrs/adr-006-postgresql-multi-tenant"}}');var i=s(4848),a=s(8453);const o={sidebar_position:6},l="ADR-005: RBAC Multi-nivel",c={},d=[{value:"Contexto",id:"contexto",level:2},{value:"Requisitos",id:"requisitos",level:3},{value:"Ejemplo Casos de Uso",id:"ejemplo-casos-de-uso",level:3},{value:"Decisi\xf3n",id:"decisi\xf3n",level:2},{value:"Modelo de 3 Niveles",id:"modelo-de-3-niveles",level:3},{value:"Estructura de Permisos",id:"estructura-de-permisos",level:3},{value:"Alternativas Consideradas",id:"alternativas-consideradas",level:2},{value:"1. ABAC (Attribute-Based Access Control)",id:"1-abac-attribute-based-access-control",level:3},{value:"2. ACL (Access Control Lists)",id:"2-acl-access-control-lists",level:3},{value:"3. Simple User Groups",id:"3-simple-user-groups",level:3},{value:"Consecuencias",id:"consecuencias",level:2},{value:"Positivas",id:"positivas",level:3},{value:"Negativas",id:"negativas",level:3},{value:"Riesgos",id:"riesgos",level:3},{value:"Ejemplo Completo",id:"ejemplo-completo",level:2},{value:"Crear Usuario con Roles",id:"crear-usuario-con-roles",level:3},{value:"Verificar Acceso en Request",id:"verificar-acceso-en-request",level:3},{value:"Monitoreo",id:"monitoreo",level:2},{value:"Revisi\xf3n Futura",id:"revisi\xf3n-futura",level:2},{value:"Referencias",id:"referencias",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function t(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"adr-005-rbac-multi-nivel",children:"ADR-005: RBAC Multi-nivel"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Estado"}),": Aceptado\n",(0,i.jsx)(n.strong,{children:"Fecha"}),": 2025-11-23\n",(0,i.jsx)(n.strong,{children:"Decisores"}),": Equipo de Arquitectura zenLogic"]}),"\n",(0,i.jsx)(n.h2,{id:"contexto",children:"Contexto"}),"\n",(0,i.jsx)(n.p,{children:"zenLogic es un ERP multi-tenant donde cada organizaci\xf3n puede tener m\xfaltiples locales (tiendas, sucursales, bodegas). Los requisitos de control de acceso son:"}),"\n",(0,i.jsx)(n.h3,{id:"requisitos",children:"Requisitos"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Multi-tenancy"}),": Aislamiento total entre organizaciones"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Multi-local"}),": Usuarios pueden tener acceso a algunos locales, no todos"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Roles Granulares"}),": Diferentes permisos por m\xf3dulo (catalog, orders, inventory)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Jerarqu\xeda de Permisos"}),": Admin > Manager > Staff > Viewer"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Facilidad de Gesti\xf3n"}),": Asignar roles, no permisos individuales"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Auditor\xeda"}),": Registrar qui\xe9n hizo qu\xe9 y d\xf3nde"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ejemplo-casos-de-uso",children:"Ejemplo Casos de Uso"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'Organizaci\xf3n: "Retail Corp" (3 locales)\n- Local A (Sucursal Centro)\n- Local B (Sucursal Norte)\n- Local C (Bodega)\n\nUsuarios:\n1. Juan (CEO): Acceso ADMIN a todos los locales\n2. Mar\xeda (Manager Sucursal Centro): Acceso MANAGER solo a Local A\n3. Pedro (Vendedor Local A y B): Acceso STAFF a Local A y Local B\n4. Ana (Bodeguera): Acceso STAFF solo a Local C\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Desaf\xedo"}),": \xbfC\xf3mo modelar esto de forma escalable y auditable?"]}),"\n",(0,i.jsx)(n.h2,{id:"decisi\xf3n",children:"Decisi\xf3n"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Implementaremos RBAC (Role-Based Access Control) multi-nivel"})," con las siguientes caracter\xedsticas:"]}),"\n",(0,i.jsx)(n.h3,{id:"modelo-de-3-niveles",children:"Modelo de 3 Niveles"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'Nivel 1: Organization (Tenant)\n  - Aislamiento total entre organizaciones\n  - Implementado con RLS (Row-Level Security)\n\nNivel 2: Local (Store/Branch)\n  - Usuarios tienen acceso a subset de locales\n  - Tabla: user_locals (many-to-many)\n\nNivel 3: Role + Permissions\n  - Roles con permisos granulares\n  - Formato: "module:action" (catalog:read, orders:write)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"estructura-de-permisos",children:"Estructura de Permisos"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'Permission: "module:action"\nExamples:\n  - catalog:read\n  - catalog:write\n  - orders:create\n  - orders:update\n  - inventory:read\n  - inventory:adjust\n  - users:manage\n\nRole: Conjunto de permissions\nExamples:\n  - admin: ["*:*"]  (wildcard: todos los permisos)\n  - manager: ["catalog:*", "orders:*", "inventory:read"]\n  - staff: ["catalog:read", "orders:create", "orders:read"]\n  - viewer: ["catalog:read", "orders:read"]\n\nUser \u2192 Roles (many-to-many)\nUser \u2192 Locals (many-to-many)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"alternativas-consideradas",children:"Alternativas Consideradas"}),"\n",(0,i.jsx)(n.h3,{id:"1-abac-attribute-based-access-control",children:"1. ABAC (Attribute-Based Access Control)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Modelo"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Pol\xedticas basadas en atributos\nallow if:\n  user.role == "manager" AND\n  user.department == resource.department AND\n  time.hour >= 9 AND time.hour <= 18\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Extremadamente flexible"}),"\n",(0,i.jsx)(n.li,{children:"Pol\xedticas complejas (horarios, ubicaci\xf3n, contexto)"}),"\n",(0,i.jsx)(n.li,{children:"No necesita pre-definir todos los roles"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Complejidad alta"}),": Dif\xedcil de entender y debuggear"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance"}),": Evaluar pol\xedticas en runtime es costoso"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Over-engineering"}),": No necesitamos tanta flexibilidad"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Auditor\xeda dif\xedcil"}),': "\xbfPor qu\xe9 este usuario tiene acceso?" es complejo de responder']}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Over-engineering. RBAC es suficiente para ERP."]}),"\n",(0,i.jsx)(n.h3,{id:"2-acl-access-control-lists",children:"2. ACL (Access Control Lists)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Modelo"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# ACL por recurso\nProduct A:\n  - User Juan: read, write\n  - User Mar\xeda: read\n  - User Pedro: read\n\nProduct B:\n  - User Juan: read, write\n  - User Ana: read\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Control granular por recurso"}),"\n",(0,i.jsx)(n.li,{children:"F\xe1cil de entender"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No escala"}),": Con 10k productos, ACLs son inmanejables"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Gesti\xf3n pesadilla"}),": Cambiar permisos de 1 usuario = modificar miles de ACLs"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No hay concepto de Role"}),": Repetir permisos para cada usuario"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": No escala para ERP con miles de recursos."]}),"\n",(0,i.jsx)(n.h3,{id:"3-simple-user-groups",children:"3. Simple User Groups"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Modelo"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Grupos planos\nGroups:\n  - admins\n  - managers\n  - staff\n\nUser \u2192 Group (one-to-many)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"S\xfaper simple"}),"\n",(0,i.jsx)(n.li,{children:"F\xe1cil de implementar"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No granularidad"}),': No puedes tener "catalog manager" y "orders viewer"']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No composici\xf3n"}),": Usuario necesita m\xfaltiples permisos = m\xfaltiples grupos"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No jerarqu\xeda"}),": No hay concepto de permisos heredados"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Insuficiente para ERP complejo."]}),"\n",(0,i.jsx)(n.h2,{id:"consecuencias",children:"Consecuencias"}),"\n",(0,i.jsx)(n.h3,{id:"positivas",children:"Positivas"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Modelo de Datos Claro"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:'-- Tabla: roles\nCREATE TABLE roles (\n    id UUID PRIMARY KEY,\n    organization_id UUID NOT NULL REFERENCES organizations(id),\n    name VARCHAR(100) NOT NULL,\n    description TEXT,\n    is_system_role BOOLEAN DEFAULT FALSE,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    UNIQUE(organization_id, name)\n);\n\n-- Tabla: permissions (predefinidos)\nCREATE TABLE permissions (\n    id UUID PRIMARY KEY,\n    name VARCHAR(100) UNIQUE NOT NULL,  -- "catalog:read"\n    module VARCHAR(50) NOT NULL,        -- "catalog"\n    action VARCHAR(50) NOT NULL,        -- "read"\n    description TEXT\n);\n\n-- Tabla: role_permissions\nCREATE TABLE role_permissions (\n    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,\n    permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,\n    PRIMARY KEY (role_id, permission_id)\n);\n\n-- Tabla: user_roles\nCREATE TABLE user_roles (\n    user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,\n    PRIMARY KEY (user_id, role_id)\n);\n\n-- Tabla: user_locals (multi-local)\nCREATE TABLE user_locals (\n    user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n    local_id UUID REFERENCES locals(id) ON DELETE CASCADE,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    PRIMARY KEY (user_id, local_id)\n);\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Verificaci\xf3n Eficiente"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/services/authorization.py\nfrom typing import Set\n\nclass AuthorizationService:\n    async def check_permission(\n        self,\n        user_id: str,\n        organization_id: str,\n        local_id: str,\n        required_permission: str  # "catalog:write"\n    ) -> bool:\n        # 1. Verificar que usuario pertenece a organizaci\xf3n\n        user = await self.user_repo.get_by_id(user_id)\n        if user.organization_id != organization_id:\n            return False\n\n        # 2. Verificar acceso al local\n        has_local_access = await self.user_repo.has_local_access(\n            user_id, local_id\n        )\n        if not has_local_access:\n            return False\n\n        # 3. Verificar permiso\n        user_permissions = await self.get_user_permissions(user_id)\n\n        # Wildcard support: "catalog:*" matches "catalog:write"\n        module, action = required_permission.split(\':\')\n\n        if "*:*" in user_permissions:  # Admin\n            return True\n        if f"{module}:*" in user_permissions:\n            return True\n        if required_permission in user_permissions:\n            return True\n\n        return False\n\n    async def get_user_permissions(self, user_id: str) -> Set[str]:\n        """Obtener todos los permisos del usuario (union de sus roles)."""\n        query = """\n        SELECT DISTINCT p.name\n        FROM permissions p\n        JOIN role_permissions rp ON p.id = rp.permission_id\n        JOIN roles r ON rp.role_id = r.id\n        JOIN user_roles ur ON r.id = ur.role_id\n        WHERE ur.user_id = :user_id\n        """\n        result = await db.execute(query, {"user_id": user_id})\n        return {row["name"] for row in result}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Middleware de Autorizaci\xf3n"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/middleware/authorization.py\nfrom fastapi import Request, HTTPException, Depends\n\nasync def require_permission(\n    required_permission: str,\n    request: Request,\n    current_user: dict = Depends(get_current_user),\n    auth_service: AuthorizationService = Depends()\n):\n    """Middleware para verificar permisos."""\n\n    # Extraer local_id del request\n    local_id = request.headers.get("X-Local-ID")\n    if not local_id:\n        raise HTTPException(400, "X-Local-ID header required")\n\n    # Verificar permiso\n    has_permission = await auth_service.check_permission(\n        user_id=current_user["user_id"],\n        organization_id=current_user["organization_id"],\n        local_id=local_id,\n        required_permission=required_permission\n    )\n\n    if not has_permission:\n        raise HTTPException(\n            403,\n            f"Permission denied: {required_permission}"\n        )\n\n# Uso en endpoints\n@router.post("/products")\nasync def create_product(\n    product: ProductCreate,\n    _: None = Depends(require_permission("catalog:write"))\n):\n    # Usuario ya fue autorizado por middleware\n    ...\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Roles Predefinidos"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/seeds/default_roles.py\n\nDEFAULT_PERMISSIONS = [\n    ("catalog:read", "catalog", "read", "View products"),\n    ("catalog:write", "catalog", "write", "Create/update products"),\n    ("catalog:delete", "catalog", "delete", "Delete products"),\n    ("orders:read", "orders", "read", "View orders"),\n    ("orders:create", "orders", "create", "Create orders"),\n    ("orders:update", "orders", "update", "Update order status"),\n    ("inventory:read", "inventory", "read", "View inventory"),\n    ("inventory:adjust", "inventory", "adjust", "Adjust stock levels"),\n    ("users:manage", "users", "manage", "Manage users and roles"),\n]\n\nDEFAULT_ROLES = {\n    "admin": {\n        "description": "Full system access",\n        "permissions": ["*:*"]\n    },\n    "manager": {\n        "description": "Manage catalog and orders",\n        "permissions": [\n            "catalog:*",\n            "orders:*",\n            "inventory:read",\n            "inventory:adjust"\n        ]\n    },\n    "staff": {\n        "description": "Create orders and view catalog",\n        "permissions": [\n            "catalog:read",\n            "orders:create",\n            "orders:read",\n            "inventory:read"\n        ]\n    },\n    "viewer": {\n        "description": "Read-only access",\n        "permissions": [\n            "catalog:read",\n            "orders:read",\n            "inventory:read"\n        ]\n    }\n}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Cache de Permisos"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# app/cache/permissions_cache.py\nfrom app.cache.redis_cache import RedisCache\n\nclass PermissionsCache:\n    def __init__(self, redis: RedisCache):\n        self.redis = redis\n        self.ttl = 300  # 5 minutos\n\n    async def get_user_permissions(self, user_id: str) -> Optional[Set[str]]:\n        """Get cached permissions."""\n        key = f"permissions:{user_id}"\n        cached = await self.redis.get(key)\n        if cached:\n            return set(cached)\n        return None\n\n    async def set_user_permissions(self, user_id: str, permissions: Set[str]):\n        """Cache permissions."""\n        key = f"permissions:{user_id}"\n        await self.redis.set(key, list(permissions), ttl=self.ttl)\n\n    async def invalidate_user_permissions(self, user_id: str):\n        """Invalidate cache when roles change."""\n        key = f"permissions:{user_id}"\n        await self.redis.delete(key)\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"6",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Auditor\xeda de Permisos"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Evento publicado cuando cambian permisos\nawait event_publisher.publish(\n    "auth.role.permissions_changed",\n    {\n        "role_id": role_id,\n        "role_name": role.name,\n        "organization_id": org_id,\n        "changes": {\n            "added": ["catalog:write"],\n            "removed": ["orders:delete"]\n        },\n        "modified_by": current_user_id\n    }\n)\n\n# Audit Service registra evento\n# Timeline muestra qui\xe9n cambi\xf3 qu\xe9 permisos y cu\xe1ndo\n'})}),"\n",(0,i.jsx)(n.h3,{id:"negativas",children:"Negativas"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"N+1 Queries sin Cache"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Verificar permisos = query a DB"}),"\n",(0,i.jsx)(n.li,{children:"Con 1000 req/s, muchas queries"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Cache Redis con TTL 5min"}),"\n",(0,i.jsx)(n.li,{children:"Lazy loading de permisos en JWT"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Incluir permisos en JWT (refresh cuando expira)\naccess_token_payload = {\n    "user_id": user.id,\n    "organization_id": user.organization_id,\n    "permissions": await get_user_permissions(user.id),\n    "locals": await get_user_locals(user.id)\n}\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Cambios en Roles No Son Inmediatos"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Admin cambia permisos de rol "manager"'}),"\n",(0,i.jsx)(n.li,{children:"Usuarios con ese rol tienen cache"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Invalidar cache cuando cambian roles"}),"\n",(0,i.jsx)(n.li,{children:"TTL corto (5min) limita inconsistencia"}),"\n",(0,i.jsx)(n.li,{children:"JWT expira cada 15min (refresh forzado)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Wildcard Evaluation Overhead"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Verificar "catalog:*" requiere string matching'}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),": Minimal, modern CPUs son r\xe1pidos","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Benchmark: 100k permission checks\n# Sin wildcard: 0.5s\n# Con wildcard: 0.7s\n# Overhead: 40% pero absolutamente aceptable\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"riesgos",children:"Riesgos"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Privilege Escalation si Hay Bugs"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Bug en ",(0,i.jsx)(n.code,{children:"check_permission()"})," podr\xeda dar acceso indebido"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Tests comprehensivos de autorizaci\xf3n"}),"\n",(0,i.jsx)(n.li,{children:'Principio de "deny by default"'}),"\n",(0,i.jsx)(n.li,{children:"Auditor\xeda de todos los cambios de permisos"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Gesti\xf3n de Roles Complicada para Admins"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Con 50 permisos, crear roles custom es tedioso"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Roles predefinidos cubren 90% casos"}),"\n",(0,i.jsx)(n.li,{children:"UI de gesti\xf3n de roles en frontend"}),"\n",(0,i.jsx)(n.li,{children:"Templates de roles por industria"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"ejemplo-completo",children:"Ejemplo Completo"}),"\n",(0,i.jsx)(n.h3,{id:"crear-usuario-con-roles",children:"Crear Usuario con Roles"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# 1. Crear usuario\nuser = await user_service.create_user(\n    email="maria@example.com",\n    organization_id=org_id\n)\n\n# 2. Asignar rol "manager"\nmanager_role = await role_repo.get_by_name(org_id, "manager")\nawait user_repo.assign_role(user.id, manager_role.id)\n\n# 3. Asignar acceso a locales espec\xedficos\nawait user_repo.assign_local(user.id, local_a_id)\nawait user_repo.assign_local(user.id, local_b_id)\n\n# Resultado:\n# Mar\xeda tiene permisos de "manager" (catalog:*, orders:*)\n# Solo en Local A y Local B\n# No tiene acceso a Local C\n'})}),"\n",(0,i.jsx)(n.h3,{id:"verificar-acceso-en-request",children:"Verificar Acceso en Request"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'@router.post("/products", dependencies=[Depends(require_permission("catalog:write"))])\nasync def create_product(\n    product: ProductCreate,\n    local_id: str = Header(..., alias="X-Local-ID"),\n    current_user: dict = Depends(get_current_user)\n):\n    # Middleware ya verific\xf3:\n    # 1. User pertenece a organizaci\xf3n\n    # 2. User tiene acceso a local_id\n    # 3. User tiene permiso "catalog:write"\n\n    # Crear producto en local espec\xedfico\n    new_product = await product_service.create(\n        product_data=product,\n        organization_id=current_user["organization_id"],\n        local_id=local_id,\n        created_by=current_user["user_id"]\n    )\n\n    return new_product\n'})}),"\n",(0,i.jsx)(n.h2,{id:"monitoreo",children:"Monitoreo"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from prometheus_client import Counter, Histogram\n\nauthorization_checks = Counter(\n    "authorization_checks_total",\n    "Total authorization checks",\n    ["permission", "result"]\n)\n\nauthorization_duration = Histogram(\n    "authorization_check_seconds",\n    "Authorization check duration",\n    ["permission"]\n)\n\n# Uso\nwith authorization_duration.labels(permission="catalog:write").time():\n    result = await check_permission(...)\n    authorization_checks.labels(\n        permission="catalog:write",\n        result="allowed" if result else "denied"\n    ).inc()\n'})}),"\n",(0,i.jsx)(n.h2,{id:"revisi\xf3n-futura",children:"Revisi\xf3n Futura"}),"\n",(0,i.jsx)(n.p,{children:"Este ADR debe revisarse si:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Performance de autorizaci\xf3n supera 10ms p99"}),"\n",(0,i.jsx)(n.li,{children:"Necesitamos pol\xedticas m\xe1s complejas (ABAC)"}),"\n",(0,i.jsxs)(n.li,{children:["Gesti\xf3n de roles se vuelve inmanejable (",(0,i.jsx)(n.code,{children:">100 roles custom"}),")"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Fecha de pr\xf3xima revisi\xf3n"}),": 2026-11-23 (1 a\xf1o)"]}),"\n",(0,i.jsx)(n.h2,{id:"referencias",children:"Referencias"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://csrc.nist.gov/projects/role-based-access-control",children:"NIST RBAC Model"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html",children:"OWASP Authorization Cheat Sheet"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.osohq.com/post/rbac-vs-abac",children:"Authz: RBAC vs ABAC"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/auth-service/overview",children:"Auth Service - RBAC"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/auth-service/api-roles",children:"Auth Service - API Roles"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/auth-service/api-permissions",children:"Auth Service - API Permissions"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/arquitectura/seguridad-rbac",children:"Seguridad y RBAC"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(t,{...e})}):t(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var r=s(6540);const i={},a=r.createContext(i);function o(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);