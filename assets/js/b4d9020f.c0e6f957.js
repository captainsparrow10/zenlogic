"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[2696],{6643:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"microservicios/auth-service/grpc-server","title":"gRPC Server","description":"Auth Service expone un servidor gRPC para comunicaci\xf3n interna con otros microservicios.","source":"@site/docs/02-microservicios/auth-service/06-grpc-server.md","sourceDirName":"02-microservicios/auth-service","slug":"/microservicios/auth-service/grpc-server","permalink":"/zenlogic/microservicios/auth-service/grpc-server","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/auth-service/06-grpc-server.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"docs","previous":{"title":"Eventos Publicados","permalink":"/zenlogic/microservicios/auth-service/eventos-publicados"},"next":{"title":"API - Autenticaci\xf3n","permalink":"/zenlogic/microservicios/auth-service/api-auth"}}');var i=r(4848),t=r(8453);const o={sidebar_position:7},c="gRPC Server",a={},d=[{value:"Puerto",id:"puerto",level:2},{value:"Proto Definition",id:"proto-definition",level:2},{value:"Implementaci\xf3n del Servidor",id:"implementaci\xf3n-del-servidor",level:2},{value:"Cliente gRPC (Catalog Service)",id:"cliente-grpc-catalog-service",level:2},{value:"Uso en Catalog Service",id:"uso-en-catalog-service",level:2},{value:"C\xf3digos de Estado gRPC",id:"c\xf3digos-de-estado-grpc",level:2},{value:"Performance",id:"performance",level:2},{value:"Latencia T\xedpica",id:"latencia-t\xedpica",level:3},{value:"Cache",id:"cache",level:3},{value:"Circuit Breaker",id:"circuit-breaker",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"grpc-server",children:"gRPC Server"})}),"\n",(0,i.jsx)(n.p,{children:"Auth Service expone un servidor gRPC para comunicaci\xf3n interna con otros microservicios."}),"\n",(0,i.jsx)(n.h2,{id:"puerto",children:"Puerto"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"grpc://localhost:50051\n"})}),"\n",(0,i.jsx)(n.h2,{id:"proto-definition",children:"Proto Definition"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Archivo"}),": ",(0,i.jsx)(n.code,{children:"src/api/grpc/auth_service.proto"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-protobuf",children:'syntax = "proto3";\n\npackage auth;\n\nservice AuthService {\n  // Verificar token y obtener informaci\xf3n del usuario\n  rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse);\n\n  // Obtener permisos de un usuario\n  rpc GetUserPermissions(GetUserPermissionsRequest) returns (GetUserPermissionsResponse);\n\n  // Validar si usuario tiene un permiso espec\xedfico\n  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);\n\n  // Obtener informaci\xf3n de organizaci\xf3n\n  rpc GetOrganization(GetOrganizationRequest) returns (GetOrganizationResponse);\n}\n\n// VerifyToken\nmessage VerifyTokenRequest {\n  string token = 1;\n}\n\nmessage VerifyTokenResponse {\n  string user_id = 1;\n  string organization_id = 2;\n  string email = 3;\n  repeated string permissions = 4;\n  repeated string locals = 5;\n  bool active = 6;\n  string first_name = 7;\n  string last_name = 8;\n}\n\n// GetUserPermissions\nmessage GetUserPermissionsRequest {\n  string user_id = 1;\n  string organization_id = 2;\n}\n\nmessage GetUserPermissionsResponse {\n  repeated string permissions = 1;\n  repeated string locals = 2;\n}\n\n// CheckPermission\nmessage CheckPermissionRequest {\n  string user_id = 1;\n  string organization_id = 2;\n  string permission = 3;\n}\n\nmessage CheckPermissionResponse {\n  bool has_permission = 1;\n}\n\n// GetOrganization\nmessage GetOrganizationRequest {\n  string organization_id = 1;\n}\n\nmessage GetOrganizationResponse {\n  string id = 1;\n  string name = 2;\n  string plan = 3;\n  string status = 4;\n  repeated string modules_enabled = 5;\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"implementaci\xf3n-del-servidor",children:"Implementaci\xf3n del Servidor"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Archivo"}),": ",(0,i.jsx)(n.code,{children:"src/api/grpc/server.py"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import grpc\nfrom concurrent import futures\nimport auth_pb2\nimport auth_pb2_grpc\nfrom src.services.token_service import TokenService\nfrom src.services.user_service import UserService\nfrom src.services.organization_service import OrganizationService\n\nclass AuthServicer(auth_pb2_grpc.AuthServiceServicer):\n    def __init__(\n        self,\n        token_service: TokenService,\n        user_service: UserService,\n        org_service: OrganizationService\n    ):\n        self.token_service = token_service\n        self.user_service = user_service\n        self.org_service = org_service\n\n    async def VerifyToken(self, request, context):\n        """Verificar token y retornar info del usuario"""\n        try:\n            user = await self.token_service.verify_token(request.token)\n\n            return auth_pb2.VerifyTokenResponse(\n                user_id=user.id,\n                organization_id=user.organization_id,\n                email=user.email,\n                permissions=user.get_permissions(),\n                locals=user.get_locals(),\n                active=user.active,\n                first_name=user.first_name or "",\n                last_name=user.last_name or ""\n            )\n        except Exception as e:\n            context.set_code(grpc.StatusCode.UNAUTHENTICATED)\n            context.set_details(str(e))\n            return auth_pb2.VerifyTokenResponse()\n\n    async def GetUserPermissions(self, request, context):\n        """Obtener permisos de un usuario"""\n        try:\n            user = await self.user_service.get_user(\n                request.user_id,\n                request.organization_id\n            )\n\n            return auth_pb2.GetUserPermissionsResponse(\n                permissions=user.get_permissions(),\n                locals=user.get_locals()\n            )\n        except Exception as e:\n            context.set_code(grpc.StatusCode.NOT_FOUND)\n            context.set_details(str(e))\n            return auth_pb2.GetUserPermissionsResponse()\n\n    async def CheckPermission(self, request, context):\n        """Verificar si usuario tiene un permiso"""\n        try:\n            has_permission = await self.user_service.check_permission(\n                request.user_id,\n                request.organization_id,\n                request.permission\n            )\n\n            return auth_pb2.CheckPermissionResponse(\n                has_permission=has_permission\n            )\n        except Exception as e:\n            context.set_code(grpc.StatusCode.INTERNAL)\n            context.set_details(str(e))\n            return auth_pb2.CheckPermissionResponse(has_permission=False)\n\n    async def GetOrganization(self, request, context):\n        """Obtener informaci\xf3n de organizaci\xf3n"""\n        try:\n            org = await self.org_service.get_organization(\n                request.organization_id\n            )\n\n            return auth_pb2.GetOrganizationResponse(\n                id=org.id,\n                name=org.name,\n                plan=org.plan,\n                status=org.status,\n                modules_enabled=org.get_modules()\n            )\n        except Exception as e:\n            context.set_code(grpc.StatusCode.NOT_FOUND)\n            context.set_details(str(e))\n            return auth_pb2.GetOrganizationResponse()\n\n\nasync def serve():\n    """Iniciar servidor gRPC"""\n    server = grpc.aio.server(\n        futures.ThreadPoolExecutor(max_workers=10),\n        options=[\n            (\'grpc.max_send_message_length\', 50 * 1024 * 1024),\n            (\'grpc.max_receive_message_length\', 50 * 1024 * 1024),\n        ]\n    )\n\n    auth_pb2_grpc.add_AuthServiceServicer_to_server(\n        AuthServicer(token_service, user_service, org_service),\n        server\n    )\n\n    server.add_insecure_port(\'[::]:50051\')\n    await server.start()\n    logger.info("gRPC server started on port 50051")\n    await server.wait_for_termination()\n'})}),"\n",(0,i.jsx)(n.h2,{id:"cliente-grpc-catalog-service",children:"Cliente gRPC (Catalog Service)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Archivo"}),": ",(0,i.jsx)(n.code,{children:"catalog-service/src/clients/auth_client.py"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import grpc\nimport auth_pb2\nimport auth_pb2_grpc\nfrom src.config.settings import settings\n\nclass AuthClient:\n    def __init__(self):\n        self.channel = grpc.aio.insecure_channel(settings.AUTH_GRPC_URL)\n        self.stub = auth_pb2_grpc.AuthServiceStub(self.channel)\n\n    async def verify_token(self, token: str):\n        """Verificar token"""\n        request = auth_pb2.VerifyTokenRequest(token=token)\n\n        try:\n            response = await self.stub.VerifyToken(request, timeout=5.0)\n            return {\n                "user_id": response.user_id,\n                "organization_id": response.organization_id,\n                "email": response.email,\n                "permissions": list(response.permissions),\n                "locals": list(response.locals),\n                "active": response.active\n            }\n        except grpc.RpcError as e:\n            if e.code() == grpc.StatusCode.UNAUTHENTICATED:\n                raise UnauthorizedError("Token inv\xe1lido")\n            raise\n\n    async def check_permission(\n        self,\n        user_id: str,\n        organization_id: str,\n        permission: str\n    ) -> bool:\n        """Verificar si usuario tiene permiso"""\n        request = auth_pb2.CheckPermissionRequest(\n            user_id=user_id,\n            organization_id=organization_id,\n            permission=permission\n        )\n\n        try:\n            response = await self.stub.CheckPermission(request, timeout=5.0)\n            return response.has_permission\n        except grpc.RpcError:\n            return False\n\n    async def close(self):\n        """Cerrar canal"""\n        await self.channel.close()\n'})}),"\n",(0,i.jsx)(n.h2,{id:"uso-en-catalog-service",children:"Uso en Catalog Service"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from src.clients.auth_client import AuthClient\n\nasync def get_current_user(token: str):\n    """Dependency para obtener usuario desde Auth Service"""\n    auth_client = AuthClient()\n    try:\n        user_data = await auth_client.verify_token(token)\n        return user_data\n    finally:\n        await auth_client.close()\n\n@router.get("/products")\nasync def list_products(\n    user = Depends(get_current_user)\n):\n    # user ya viene validado desde Auth Service\n    products = await product_service.list_products(user["organization_id"])\n    return products\n'})}),"\n",(0,i.jsx)(n.h2,{id:"c\xf3digos-de-estado-grpc",children:"C\xf3digos de Estado gRPC"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"C\xf3digo"}),(0,i.jsx)(n.th,{children:"Descripci\xf3n"}),(0,i.jsx)(n.th,{children:"Uso"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OK"})}),(0,i.jsx)(n.td,{children:"\xc9xito"}),(0,i.jsx)(n.td,{children:"Token v\xe1lido"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNAUTHENTICATED"})}),(0,i.jsx)(n.td,{children:"No autenticado"}),(0,i.jsx)(n.td,{children:"Token inv\xe1lido/expirado"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NOT_FOUND"})}),(0,i.jsx)(n.td,{children:"No encontrado"}),(0,i.jsx)(n.td,{children:"Usuario no existe"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"PERMISSION_DENIED"})}),(0,i.jsx)(n.td,{children:"Permiso denegado"}),(0,i.jsx)(n.td,{children:"Usuario sin permiso"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"INTERNAL"})}),(0,i.jsx)(n.td,{children:"Error interno"}),(0,i.jsx)(n.td,{children:"Error del servidor"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DEADLINE_EXCEEDED"})}),(0,i.jsx)(n.td,{children:"Timeout"}),(0,i.jsx)(n.td,{children:"Request muy lento"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"performance",children:"Performance"}),"\n",(0,i.jsx)(n.h3,{id:"latencia-t\xedpica",children:"Latencia T\xedpica"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"VerifyToken: 5-15ms\nCheckPermission: 3-10ms\nGetOrganization: 8-20ms\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cache",children:"Cache"}),"\n",(0,i.jsx)(n.p,{children:"gRPC responses se cachean en Redis:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def verify_token_cached(token: str):\n    cache_key = f"grpc:verify:{token}"\n\n    # Intentar obtener de cache\n    cached = await redis.get(cache_key)\n    if cached:\n        return json.loads(cached)\n\n    # Si no existe, llamar a gRPC\n    result = await auth_client.verify_token(token)\n\n    # Cachear por 5 minutos\n    await redis.setex(cache_key, 300, json.dumps(result))\n\n    return result\n'})}),"\n",(0,i.jsx)(n.h2,{id:"circuit-breaker",children:"Circuit Breaker"}),"\n",(0,i.jsx)(n.p,{children:"Para prevenir cascading failures:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from pybreaker import CircuitBreaker\n\nauth_breaker = CircuitBreaker(\n    fail_max=5,\n    timeout_duration=60\n)\n\n@auth_breaker\nasync def verify_token_with_breaker(token: str):\n    return await auth_client.verify_token(token)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/microservicios/auth-service/api-auth",children:"API Auth"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/arquitectura/comunicacion-microservicios",children:"Comunicaci\xf3n Microservicios"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var s=r(6540);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);