"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[1938],{275:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"microservicios/inventory-service/flujos-negocio","title":"Flujos de Negocio","description":"Diagramas de secuencia que ilustran los flujos de negocio principales del Inventory Service.","source":"@site/docs/02-microservicios/inventory-service/18-flujos-negocio.md","sourceDirName":"02-microservicios/inventory-service","slug":"/microservicios/inventory-service/flujos-negocio","permalink":"/zenlogic/microservicios/inventory-service/flujos-negocio","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/inventory-service/18-flujos-negocio.md","tags":[],"version":"current","sidebarPosition":18,"frontMatter":{"sidebar_position":18},"sidebar":"docs","previous":{"title":"Errores Comunes","permalink":"/zenlogic/microservicios/inventory-service/errores-comunes"},"next":{"title":"Order Service - Overview","permalink":"/zenlogic/microservicios/order-service/overview"}}');var a=r(4848),t=r(8453);const s={sidebar_position:18},o="Flujos de Negocio",c={},d=[{value:"1. Flujo de Ingreso de Mercanc\xeda (Purchase Order)",id:"1-flujo-de-ingreso-de-mercanc\xeda-purchase-order",level:2},{value:"2. Flujo de Reserva y Venta (E-commerce)",id:"2-flujo-de-reserva-y-venta-e-commerce",level:2},{value:"3. Flujo de Transferencia entre Bodegas",id:"3-flujo-de-transferencia-entre-bodegas",level:2},{value:"4. Flujo de Ajuste de Inventario (Physical Count)",id:"4-flujo-de-ajuste-de-inventario-physical-count",level:2},{value:"5. Flujo de Stock Bajo M\xednimo (Low Stock Alert)",id:"5-flujo-de-stock-bajo-m\xednimo-low-stock-alert",level:2},{value:"6. Flujo de Devoluci\xf3n de Cliente",id:"6-flujo-de-devoluci\xf3n-de-cliente",level:2},{value:"7. Flujo de Trazabilidad de Lote (Lot Tracking)",id:"7-flujo-de-trazabilidad-de-lote-lot-tracking",level:2},{value:"8. Flujo de Sincronizaci\xf3n Multi-Servicio",id:"8-flujo-de-sincronizaci\xf3n-multi-servicio",level:2},{value:"Mejores Pr\xe1cticas",id:"mejores-pr\xe1cticas",level:2},{value:"1. Manejo de Concurrencia",id:"1-manejo-de-concurrencia",level:3},{value:"2. Event Idempotency",id:"2-event-idempotency",level:3},{value:"3. Transacciones Distribuidas (Saga Pattern)",id:"3-transacciones-distribuidas-saga-pattern",level:3},{value:"4. Monitoring de Flujos",id:"4-monitoring-de-flujos",level:3},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"flujos-de-negocio",children:"Flujos de Negocio"})}),"\n",(0,a.jsx)(n.p,{children:"Diagramas de secuencia que ilustran los flujos de negocio principales del Inventory Service."}),"\n",(0,a.jsx)(n.h2,{id:"1-flujo-de-ingreso-de-mercanc\xeda-purchase-order",children:"1. Flujo de Ingreso de Mercanc\xeda (Purchase Order)"}),"\n",(0,a.jsx)(n.p,{children:"Proceso completo desde que llega una orden de compra hasta el registro en inventario."}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant PO as Purchase Order\n    participant WH as Warehouse Staff\n    participant IS as Inventory Service\n    participant DB as Database\n    participant RMQ as RabbitMQ\n    participant CS as Catalog Service\n    participant NOTIF as Notification Service\n\n    PO->>WH: Mercanc\xeda llega a bodega\n    WH->>WH: Inspecci\xf3n de calidad\n\n    alt Quality OK\n        WH->>IS: POST /movements/in\n        Note over WH,IS: {variant_id, warehouse_id,<br/>quantity, lot_number, expiry_date}\n\n        IS->>CS: gRPC: ValidateVariant\n        CS--\x3e>IS: Variant valid\n\n        IS->>DB: BEGIN TRANSACTION\n\n        IS->>DB: INSERT INTO stock_movement\n        DB--\x3e>IS: Movement created\n\n        IS->>DB: UPDATE stock<br/>SET total += quantity,<br/>available += quantity\n        DB--\x3e>IS: Stock updated\n\n        IS->>DB: COMMIT TRANSACTION\n\n        IS->>RMQ: Publish movement.in\n        IS->>RMQ: Publish stock.updated\n\n        RMQ->>CS: Notify stock change\n        RMQ->>NOTIF: Notify receiving complete\n\n        IS--\x3e>WH: 201 Created<br/>{movement_id, new_stock}\n\n    else Quality Issues\n        WH->>IS: POST /movements/in<br/>+ damage_category: "damaged"\n        IS->>DB: UPDATE stock<br/>SET damaged += quantity\n        IS->>RMQ: Publish stock.damaged\n        RMQ->>NOTIF: Notify quality issue\n    end'}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Validaciones:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Variante existe y est\xe1 activa"}),"\n",(0,a.jsx)(n.li,{children:"Bodega existe y est\xe1 activa"}),"\n",(0,a.jsx)(n.li,{children:"N\xfamero de lote \xfanico si se proporciona"}),"\n",(0,a.jsx)(n.li,{children:"Fecha de vencimiento futura (si aplica)"}),"\n",(0,a.jsx)(n.li,{children:"Capacidad de bodega no excedida"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Eventos Publicados:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"inventory.movement.in"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"inventory.stock.updated"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"inventory.stock.damaged"})," (si hay productos da\xf1ados)"]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"2-flujo-de-reserva-y-venta-e-commerce",children:"2. Flujo de Reserva y Venta (E-commerce)"}),"\n",(0,a.jsx)(n.p,{children:"Proceso desde que un cliente hace una orden online hasta el despacho."}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant C as Customer\n    participant OS as Order Service\n    participant IS as Inventory Service\n    participant PS as Payment Service\n    participant RMQ as RabbitMQ\n    participant WH as Warehouse\n\n    C->>OS: Add to cart<br/>+ Click checkout\n    OS->>IS: gRPC: CheckAvailability<br/>(variant_id, quantity)\n\n    alt Stock Available\n        IS--\x3e>OS: Available: true<br/>warehouse_id\n        OS->>IS: gRPC: ReserveStock<br/>ttl=15min\n\n        IS->>IS: Create reservation\n        IS->>IS: Update stock<br/>(available -> reserved)\n        IS--\x3e>OS: Reservation ID<br/>expires_at\n\n        OS--\x3e>C: Order created<br/>Payment pending\n\n        Note over C,PS: Customer has 15 min to pay\n\n        alt Payment Success\n            C->>PS: Complete payment\n            PS->>RMQ: Publish payment.success\n            RMQ->>OS: Consume event\n\n            OS->>IS: gRPC: ConfirmReservation\n            IS->>IS: Remove TTL<br/>Mark permanent\n            IS--\x3e>OS: Confirmed\n\n            OS->>RMQ: Publish order.confirmed\n\n            Note over WH: Warehouse picks order\n\n            WH->>OS: Mark as shipped\n            OS->>RMQ: Publish order.shipped\n\n            RMQ->>IS: Consume event\n            IS->>IS: Create movement OUT\n            IS->>IS: Update stock<br/>(reserved -> decrease total)\n            IS->>RMQ: Publish movement.out\n\n        else Payment Failed/Timeout\n            Note over IS: TTL expires (15 min)\n            IS->>IS: Auto-release reservation\n            IS->>IS: Update stock<br/>(reserved -> available)\n            IS->>RMQ: Publish reservation.expired\n            RMQ->>OS: Notify expiration\n            OS->>OS: Cancel order\n        end\n\n    else Stock Not Available\n        IS--\x3e>OS: Available: false<br/>current_stock: X\n        OS--\x3e>C: Product out of stock\n    end"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Configuraci\xf3n:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"TTL Reserva:"})," 15 minutos (configurable)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Auto-release:"})," Autom\xe1tico al expirar TTL"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Estrategia:"})," FIFO para selecci\xf3n de lote"]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"3-flujo-de-transferencia-entre-bodegas",children:"3. Flujo de Transferencia entre Bodegas"}),"\n",(0,a.jsx)(n.p,{children:"Transferencia de mercanc\xeda de una bodega a otra con seguimiento completo."}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant MG as Manager\n    participant IS as Inventory Service\n    participant DB as Database\n    participant RMQ as RabbitMQ\n    participant WH_FROM as Warehouse Origin\n    participant WH_TO as Warehouse Destination\n    participant NOTIF as Notification Service\n\n    MG->>IS: POST /transfers\n    Note over MG,IS: {from: wh_1, to: wh_2,<br/>items: [{variant_id, qty}]}\n\n    IS->>IS: Validate stock in origin\n\n    alt Sufficient Stock\n        IS->>DB: INSERT transfer (status: pending)\n        IS->>DB: UPDATE stock_origin<br/>(available -> in_transit)\n\n        IS->>RMQ: Publish transfer.created\n        RMQ->>NOTIF: Notify warehouse managers\n\n        IS--\x3e>MG: 201 Created<br/>{transfer_id, status: pending}\n\n        Note over MG: Review and approve\n\n        MG->>IS: POST /transfers/{id}/approve\n        IS->>DB: UPDATE status = approved\n        IS->>RMQ: Publish transfer.approved\n\n        IS--\x3e>MG: Approved\n\n        Note over WH_FROM: Prepare shipment\n\n        WH_FROM->>IS: POST /transfers/{id}/ship\n        IS->>DB: UPDATE status = in_transit<br/>shipped_at = NOW()\n        IS->>RMQ: Publish transfer.in_transit\n        RMQ->>NOTIF: Notify destination\n        RMQ->>WH_TO: Expect arrival\n\n        Note over WH_FROM,WH_TO: Goods in transit\n\n        WH_TO->>IS: POST /transfers/{id}/receive<br/>{received_items: [...]}\n\n        alt No Discrepancies\n            IS->>DB: UPDATE status = received\n            IS->>DB: UPDATE stock_destination<br/>(increase available)\n            IS->>DB: UPDATE stock_origin<br/>(decrease in_transit)\n            IS->>DB: INSERT movements (OUT origin, IN destination)\n\n            IS->>RMQ: Publish transfer.received\n            IS--\x3e>WH_TO: Transfer complete\n\n        else Discrepancies Found\n            IS->>DB: UPDATE with discrepancies\n            IS->>RMQ: Publish transfer.discrepancy\n            RMQ->>NOTIF: Alert managers<br/>Investigation required\n\n            Note over MG: Review discrepancy\n\n            MG->>IS: POST /adjustments<br/>(resolve discrepancy)\n            IS->>DB: Apply adjustment\n            IS->>DB: UPDATE transfer status = received\n        end\n\n    else Insufficient Stock\n        IS--\x3e>MG: 400 Bad Request<br/>TRANSFER_INSUFFICIENT_STOCK\n    end"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Estados de Transferencia:"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"pending"})," - Creada, esperando aprobaci\xf3n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"approved"})," - Aprobada, lista para env\xedo"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"in_transit"})," - En camino"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"received"})," - Recibida en destino"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"cancelled"})," - Cancelada"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Reglas de Negocio:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Transferencias mayores a $1000 requieren aprobaci\xf3n"}),"\n",(0,a.jsx)(n.li,{children:"Discrepancias mayores a 5% requieren investigaci\xf3n"}),"\n",(0,a.jsx)(n.li,{children:'Stock se marca como "in_transit" durante el traslado'}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"4-flujo-de-ajuste-de-inventario-physical-count",children:"4. Flujo de Ajuste de Inventario (Physical Count)"}),"\n",(0,a.jsx)(n.p,{children:"Ajuste manual despu\xe9s de un conteo f\xedsico de inventario."}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant OP as Operator\n    participant IS as Inventory Service\n    participant DB as Database\n    participant MG as Manager\n    participant RMQ as RabbitMQ\n    participant NOTIF as Notification Service\n\n    Note over OP: Physical inventory count\n\n    OP->>IS: GET /stock?warehouse_id=wh_1\n    IS--\x3e>OP: Current stock levels\n\n    OP->>OP: Count physical stock<br/>Compare with system\n\n    alt Small Adjustment (< 10%)\n        OP->>IS: POST /adjustments\n        Note over OP,IS: {variant_id, warehouse_id,<br/>quantity_change: -5,<br/>reason: "audit"}\n\n        IS->>DB: INSERT adjustment<br/>status: pending\n        IS->>IS: Calculate percentage<br/>change = 5%\n\n        Note over IS: Auto-approve if < 10%\n\n        IS->>DB: UPDATE status = approved\n        IS->>DB: UPDATE status = applied\n        IS->>DB: UPDATE stock quantities\n        IS->>DB: INSERT stock_movement\n\n        IS->>RMQ: Publish adjustment.applied\n        IS--\x3e>OP: Adjustment complete\n\n    else Large Adjustment (\u2265 10%)\n        OP->>IS: POST /adjustments\n        Note over OP,IS: {quantity_change: -50,<br/>reason: "audit",<br/>notes: "Discrepancia en conteo"}\n\n        IS->>DB: INSERT adjustment<br/>status: pending\n        IS->>IS: Calculate percentage<br/>change = 25%\n\n        Note over IS: Requires approval\n\n        IS->>RMQ: Publish adjustment.approval_required\n        RMQ->>NOTIF: Notify manager\n\n        IS--\x3e>OP: Created (pending approval)\n\n        Note over MG: Review adjustment\n\n        alt Manager Approves\n            MG->>IS: POST /adjustments/{id}/approve\n            IS->>DB: UPDATE status = approved\n            IS->>DB: UPDATE status = applied\n            IS->>DB: UPDATE stock quantities\n            IS->>DB: INSERT stock_movement\n\n            IS->>RMQ: Publish adjustment.approved\n            IS->>RMQ: Publish adjustment.applied\n            IS--\x3e>MG: Applied successfully\n\n        else Manager Rejects\n            MG->>IS: POST /adjustments/{id}/reject<br/>{reason: "Falta evidencia"}\n            IS->>DB: UPDATE status = rejected\n            IS->>RMQ: Publish adjustment.rejected\n            RMQ->>NOTIF: Notify operator\n            IS--\x3e>MG: Rejected\n        end\n    end'}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Umbrales de Aprobaci\xf3n:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Auto-aprobado:"})," Cambio menor a 10% o menos de 10 unidades"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Requiere aprobaci\xf3n:"})," Cambio mayor a 10% o m\xe1s de 10 unidades"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Requiere doble aprobaci\xf3n:"})," Cambio mayor a 50% o m\xe1s de 100 unidades"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Motivos V\xe1lidos:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"audit"})," - Conteo f\xedsico"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"damaged"})," - Productos da\xf1ados"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"expired"})," - Productos vencidos"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"lost"})," - P\xe9rdida/robo"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"found"})," - Encontrado (ajuste positivo)"]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"5-flujo-de-stock-bajo-m\xednimo-low-stock-alert",children:"5. Flujo de Stock Bajo M\xednimo (Low Stock Alert)"}),"\n",(0,a.jsx)(n.p,{children:"Detecci\xf3n autom\xe1tica y notificaci\xf3n cuando el stock llega al nivel m\xednimo."}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant IS as Inventory Service\n    participant DB as Database\n    participant RMQ as RabbitMQ\n    participant NOTIF as Notification Service\n    participant PURCH as Purchasing Service\n    participant MG as Manager\n\n    Note over IS: Stock movement occurs\n\n    IS->>DB: UPDATE stock quantities\n    IS->>IS: Check if available \u2264 min_stock\n\n    alt Stock Below Minimum\n        IS->>DB: SELECT stock WHERE<br/>available \u2264 min_stock\n\n        IS->>RMQ: Publish stock.low_level\n        Note over IS,RMQ: {variant_id, warehouse_id,<br/>available: 15, min_stock: 20,<br/>reorder_point: 30,<br/>alert_level: "warning"}\n\n        RMQ->>NOTIF: Consume event\n        NOTIF->>MG: Send email alert<br/>"Stock bajo para SKU-123"\n        NOTIF->>MG: In-app notification\n\n        alt Stock \u2264 Reorder Point\n            IS->>RMQ: Publish stock.reorder_needed\n            Note over IS,RMQ: {suggested_quantity: 200,<br/>last_supplier_id,<br/>avg_lead_time: 7 days}\n\n            RMQ->>PURCH: Auto-create draft PO\n            PURCH->>PURCH: Calculate order quantity<br/>(max_stock - current_stock)\n            PURCH->>PURCH: Select preferred supplier\n            PURCH--\x3e>MG: Draft PO created<br/>Pending review\n\n        else Stock > Reorder Point\n            Note over NOTIF: Only alert, no auto-order\n        end\n\n        alt Stock Completely Depleted\n            IS->>IS: Check if available = 0\n            IS->>RMQ: Publish stock.depleted\n            RMQ->>NOTIF: Send critical alert\n            NOTIF->>MG: SMS + Email<br/>"CRITICAL: Out of stock"\n\n            RMQ->>IS: Update catalog\n            Note over IS: Mark product unavailable<br/>on website\n        end\n    end'}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Niveles de Alerta:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Normal:"})," ",(0,a.jsx)(n.code,{children:"available > min_stock"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Warning:"})," ",(0,a.jsx)(n.code,{children:"min_stock \u2265 available > reorder_point"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Critical:"})," ",(0,a.jsx)(n.code,{children:"reorder_point \u2265 available > 0"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Depleted:"})," ",(0,a.jsx)(n.code,{children:"available = 0"})]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Configuraci\xf3n:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"stock_config = {\n    'min_stock': 20,           # Nivel m\xednimo\n    'reorder_point': 30,       # Punto de reorden autom\xe1tico\n    'max_stock': 200,          # Nivel m\xe1ximo\n    'auto_reorder': True,      # Activar reorden autom\xe1tico\n    'preferred_supplier_id': 'sup_123'\n}\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"6-flujo-de-devoluci\xf3n-de-cliente",children:"6. Flujo de Devoluci\xf3n de Cliente"}),"\n",(0,a.jsx)(n.p,{children:"Proceso completo de devoluci\xf3n desde el cliente hasta reingreso a inventario."}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant C as Customer\n    participant OS as Order Service\n    participant RET as Returns Service\n    participant IS as Inventory Service\n    participant WH as Warehouse\n    participant QC as Quality Control\n    participant DB as Database\n    participant RMQ as RabbitMQ\n\n    C->>OS: Request return<br/>order_id + items\n    OS->>RET: Create return request\n    RET->>RET: Generate RMA number\n    RET--\x3e>C: RMA-12345<br/>Return label\n\n    Note over C,WH: Customer ships back\n\n    WH->>RET: Scan RMA-12345\n    RET--\x3e>WH: Return details\n\n    WH->>QC: Send for inspection\n\n    QC->>QC: Inspect items\n\n    alt Item in Good Condition\n        QC->>IS: POST /movements/in\n        Note over QC,IS: {variant_id, warehouse_id,<br/>quantity: 1,<br/>reason: "customer_return",<br/>condition: "good",<br/>reference_id: RMA-12345}\n\n        IS->>DB: UPDATE stock<br/>available += 1\n        IS->>DB: INSERT movement\n\n        IS->>RMQ: Publish movement.in\n        IS->>RMQ: Publish stock.updated\n\n        RMQ->>OS: Stock available again\n\n        IS--\x3e>QC: Return processed<br/>Stock updated\n\n    else Item Damaged\n        QC->>IS: POST /movements/in<br/>condition: "damaged"\n\n        IS->>DB: UPDATE stock<br/>damaged += 1\n        IS->>DB: INSERT movement\n\n        IS->>RMQ: Publish stock.damaged\n\n        IS--\x3e>QC: Damaged stock recorded\n\n    else Item Defective/Expired\n        QC->>IS: POST /movements/in<br/>condition: "defective"\n\n        IS->>DB: Do not add to available\n        IS->>DB: INSERT movement (for audit)\n        IS->>DB: Mark for disposal\n\n        IS--\x3e>QC: Marked for disposal\n    end\n\n    RET->>OS: Update return status\n    OS->>C: Refund processed'}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Condiciones de Retorno:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"good"})," - Se devuelve a stock disponible"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"damaged"})," - Se marca como da\xf1ado"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"defective"})," - Se marca para disposal"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"expired"})," - No se reingresa"]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"7-flujo-de-trazabilidad-de-lote-lot-tracking",children:"7. Flujo de Trazabilidad de Lote (Lot Tracking)"}),"\n",(0,a.jsx)(n.p,{children:"Seguimiento completo de un lote desde ingreso hasta venta."}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant SUP as Supplier\n    participant WH as Warehouse\n    participant IS as Inventory Service\n    participant DB as Database\n    participant C as Customer\n    participant OS as Order Service\n\n    SUP->>WH: Deliver goods<br/>LOT-2025-001\n\n    WH->>IS: POST /movements/in\n    Note over WH,IS: {variant_id, quantity: 100,<br/>lot_number: "LOT-2025-001",<br/>expiry_date: "2026-12-31",<br/>supplier_id: "sup_456"}\n\n    IS->>DB: INSERT INTO stock_movement\n    Note over IS,DB: Store lot metadata\n\n    IS->>DB: UPDATE stock<br/>available += 100\n\n    IS--\x3e>WH: Lot registered\n\n    Note over IS: Time passes...\n\n    C->>OS: Place order (variant)\n    OS->>IS: gRPC: ReserveStock\n\n    IS->>DB: SELECT stock WHERE<br/>variant_id = X<br/>ORDER BY expiry_date ASC<br/>LIMIT 1\n    Note over IS,DB: FEFO Strategy\n\n    IS->>DB: Reserve from LOT-2025-001\n    IS--\x3e>OS: Reserved (lot_number)\n\n    OS->>IS: Order shipped\n\n    IS->>DB: INSERT movement OUT<br/>lot_number: "LOT-2025-001"\n    IS->>DB: UPDATE stock -= 1\n\n    Note over IS: Later - Recall scenario\n\n    alt Product Recall\n        SUP->>WH: Recall LOT-2025-001\n\n        WH->>IS: GET /movements/lot/LOT-2025-001\n\n        IS->>DB: SELECT * FROM stock_movement<br/>WHERE lot_number = "LOT-2025-001"\n\n        IS--\x3e>WH: Complete traceability\n        Note over IS,WH: - Received: 100 units<br/>- Sold: 65 units<br/>- Remaining: 35 units<br/>- Customers: [list]\n\n        WH->>IS: Create adjustment<br/>Remove remaining stock\n\n        IS->>DB: UPDATE stock -= 35\n        IS->>DB: INSERT movement<br/>reason: "recall"\n\n        WH->>OS: Notify affected customers\n    end'}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Estrategias de Selecci\xf3n:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"FIFO"})," (First In, First Out) - Por defecto"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"LIFO"})," (Last In, First Out) - Casos espec\xedficos"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"FEFO"})," (First Expired, First Out) - Productos perecederos"]}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"8-flujo-de-sincronizaci\xf3n-multi-servicio",children:"8. Flujo de Sincronizaci\xf3n Multi-Servicio"}),"\n",(0,a.jsx)(n.p,{children:"Coordinaci\xf3n entre Inventory, Catalog y Order services."}),"\n",(0,a.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant CS as Catalog Service\n    participant RMQ as RabbitMQ\n    participant IS as Inventory Service\n    participant OS as Order Service\n    participant DB as Inventory DB\n\n    Note over CS: New variant created\n\n    CS->>RMQ: Publish variant.created\n    Note over CS,RMQ: {variant_id: "var_new_789",<br/>track_inventory: true,<br/>default_min_stock: 10}\n\n    RMQ->>IS: Consume event\n\n    IS->>DB: SELECT active_warehouses\n    DB--\x3e>IS: [wh_1, wh_2, wh_3]\n\n    loop For each warehouse\n        IS->>DB: INSERT INTO stock\n        Note over IS,DB: {variant_id, warehouse_id,<br/>total: 0, available: 0,<br/>min_stock: 10}\n    end\n\n    IS->>RMQ: Publish stock.initialized\n    RMQ->>CS: Confirm initialization\n\n    Note over IS: Stock arrives\n\n    IS->>IS: POST /movements/in<br/>quantity: 100\n    IS->>DB: UPDATE stock<br/>available = 100\n\n    IS->>RMQ: Publish stock.updated\n    Note over IS,RMQ: {variant_id, warehouse_id,<br/>available: 100}\n\n    RMQ->>CS: Update product availability\n    CS->>CS: Mark as "In Stock"<br/>on website\n\n    RMQ->>OS: Stock available for orders\n\n    Note over OS: Customer orders\n\n    OS->>IS: gRPC: CheckAvailability\n    IS--\x3e>OS: Available: true\n\n    OS->>IS: gRPC: ReserveStock\n    IS->>DB: available -= 10<br/>reserved += 10\n    IS--\x3e>OS: Reserved\n\n    IS->>RMQ: Publish stock.reserved\n    RMQ->>CS: Update available qty display\n\n    Note over OS: Order confirmed & shipped\n\n    OS->>RMQ: Publish order.shipped\n    RMQ->>IS: Consume event\n\n    IS->>DB: total -= 10<br/>reserved -= 10\n    IS->>RMQ: Publish stock.updated\n\n    RMQ->>CS: Sync final stock count\n    CS->>CS: Update product page<br/>"90 available"'}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"mejores-pr\xe1cticas",children:"Mejores Pr\xe1cticas"}),"\n",(0,a.jsx)(n.h3,{id:"1-manejo-de-concurrencia",children:"1. Manejo de Concurrencia"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# Optimistic locking para actualizaciones de stock\nasync def update_stock_with_version(\n    stock_id: str,\n    quantity_change: int,\n    expected_version: int\n) -> Stock:\n    """\n    Update stock with optimistic locking to prevent race conditions.\n    """\n    result = await db.execute(\n        """\n        UPDATE stock\n        SET available_quantity = available_quantity + :qty_change,\n            version = version + 1,\n            updated_at = NOW()\n        WHERE stock_id = :stock_id\n        AND version = :expected_version\n        RETURNING *\n        """,\n        {\n            \'stock_id\': stock_id,\n            \'qty_change\': quantity_change,\n            \'expected_version\': expected_version\n        }\n    )\n\n    if not result:\n        raise ConcurrentModificationError(\n            f"Stock {stock_id} was modified by another transaction"\n        )\n\n    return result\n'})}),"\n",(0,a.jsx)(n.h3,{id:"2-event-idempotency",children:"2. Event Idempotency"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'async def handle_order_shipped(event: Dict[str, Any]) -> None:\n    """\n    Handle order.shipped event idempotently.\n    """\n    event_id = event[\'event_id\']\n\n    # Check if already processed\n    if await event_log.exists(event_id):\n        logger.info(f"Event {event_id} already processed")\n        return\n\n    try:\n        # Process event\n        await process_shipment(event[\'data\'])\n\n        # Mark as processed\n        await event_log.mark_processed(event_id)\n\n    except Exception as e:\n        await event_log.mark_failed(event_id, error=str(e))\n        raise\n'})}),"\n",(0,a.jsx)(n.h3,{id:"3-transacciones-distribuidas-saga-pattern",children:"3. Transacciones Distribuidas (Saga Pattern)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# Saga for transfer between warehouses\nclass TransferSaga:\n    async def execute(self, transfer_id: str):\n        """Execute transfer saga with compensating actions."""\n        try:\n            # Step 1: Reserve in origin\n            await self.reserve_stock_origin(transfer_id)\n\n            # Step 2: Ship\n            await self.mark_as_shipped(transfer_id)\n\n            # Step 3: Receive in destination\n            await self.receive_stock_destination(transfer_id)\n\n            # Step 4: Complete\n            await self.complete_transfer(transfer_id)\n\n        except Exception as e:\n            # Compensate\n            await self.compensate(transfer_id, failed_step=e.step)\n            raise\n\n    async def compensate(self, transfer_id: str, failed_step: str):\n        """Rollback changes on failure."""\n        if failed_step in [\'reserve\', \'ship\']:\n            # Release reserved stock\n            await self.release_reservation(transfer_id)\n'})}),"\n",(0,a.jsx)(n.h3,{id:"4-monitoring-de-flujos",children:"4. Monitoring de Flujos"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"# Prometheus metrics for business flows\ntransfer_duration = Histogram(\n    'inventory_transfer_duration_seconds',\n    'Time to complete transfer',\n    ['from_warehouse', 'to_warehouse']\n)\n\nreservation_expiry_rate = Counter(\n    'inventory_reservation_expired_total',\n    'Number of expired reservations',\n    ['warehouse']\n)\n\nstock_alert_frequency = Gauge(\n    'inventory_low_stock_alerts_active',\n    'Number of active low stock alerts',\n    ['warehouse', 'alert_level']\n)\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"./arquitectura",children:"Arquitectura"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"./errores-comunes",children:"Errores Comunes"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"./eventos-publicados",children:"Eventos Publicados"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>o});var i=r(6540);const a={},t=i.createContext(a);function s(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);