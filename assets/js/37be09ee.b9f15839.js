"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[785],{2460:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>l,frontMatter:()=>o,metadata:()=>t,toc:()=>u});const t=JSON.parse('{"id":"flujos-negocio/flujo-devoluciones","title":"Flujo de Devoluciones (Returns)","description":"Flujo completo de devoluci\xf3n de productos desde la solicitud del cliente hasta el re-stock en inventario.","source":"@site/docs/03-flujos-negocio/02-flujo-devoluciones.md","sourceDirName":"03-flujos-negocio","slug":"/flujos-negocio/flujo-devoluciones","permalink":"/zenlogic/flujos-negocio/flujo-devoluciones","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-flujos-negocio/02-flujo-devoluciones.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2}}');var i=r(4848),a=r(8453);const o={sidebar_position:2},s="Flujo de Devoluciones (Returns)",d={},u=[{value:"Diagram de Secuencia",id:"diagram-de-secuencia",level:2},{value:"Fases del Flujo",id:"fases-del-flujo",level:2},{value:"Fase 1: Solicitar Devoluci\xf3n",id:"fase-1-solicitar-devoluci\xf3n",level:3},{value:"Fase 2: Aprobar Devoluci\xf3n",id:"fase-2-aprobar-devoluci\xf3n",level:3},{value:"Fase 3: Rastrear Env\xedo de Devoluci\xf3n",id:"fase-3-rastrear-env\xedo-de-devoluci\xf3n",level:3},{value:"Fase 4: Recibir en Warehouse",id:"fase-4-recibir-en-warehouse",level:3},{value:"Fase 5: Inspeccionar Items",id:"fase-5-inspeccionar-items",level:3},{value:"Fase 6: Re-stock en Inventory",id:"fase-6-re-stock-en-inventory",level:3},{value:"Fase 7: Procesar Reembolso",id:"fase-7-procesar-reembolso",level:3},{value:"Escenarios Especiales",id:"escenarios-especiales",level:2},{value:"1. Devoluci\xf3n Parcial",id:"1-devoluci\xf3n-parcial",level:3},{value:"2. Items Da\xf1ados",id:"2-items-da\xf1ados",level:3},{value:"3. Restocking Fee",id:"3-restocking-fee",level:3},{value:"4. Exchange en lugar de Refund",id:"4-exchange-en-lugar-de-refund",level:3},{value:"Pol\xedticas de Devoluci\xf3n",id:"pol\xedticas-de-devoluci\xf3n",level:2},{value:"Ventana de Devoluci\xf3n",id:"ventana-de-devoluci\xf3n",level:3},{value:"Condiciones Aceptables",id:"condiciones-aceptables",level:3},{value:"M\xe9tricas",id:"m\xe9tricas",level:2},{value:"SLAs",id:"slas",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"flujo-de-devoluciones-returns",children:"Flujo de Devoluciones (Returns)"})}),"\n",(0,i.jsx)(n.p,{children:"Flujo completo de devoluci\xf3n de productos desde la solicitud del cliente hasta el re-stock en inventario."}),"\n",(0,i.jsx)(n.h2,{id:"diagram-de-secuencia",children:"Diagram de Secuencia"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Customer\n    participant OrderService\n    participant InventoryService\n    participant PaymentGateway\n    participant RabbitMQ\n    participant AuditService\n\n    %% Fase 1: Solicitar Devoluci\xf3n\n    Customer->>OrderService: POST /api/orders/{id}/returns\n    OrderService->>OrderService: Validar orden (delivered, dentro de ventana)\n    OrderService->>OrderService: Crear return (status=pending)\n    OrderService->>OrderService: Generar RMA number\n    OrderService->>RabbitMQ: Publicar return.requested\n    RabbitMQ->>AuditService: Consumir return.requested\n    OrderService--\x3e>Customer: 201 {return_id, rma_number}\n\n    %% Fase 2: Aprobar Devoluci\xf3n\n    Note over OrderService: Customer Service Review\n    OrderService->>OrderService: Actualizar return (status=approved)\n    OrderService->>OrderService: Generar return shipping label\n    OrderService->>RabbitMQ: Publicar return.approved\n    RabbitMQ->>AuditService: Consumir return.approved\n    OrderService--\x3e>Customer: Email: Return approved + shipping label\n\n    %% Fase 3: Cliente Env\xeda Producto\n    Customer->>Customer: Ship product back\n    Note over OrderService: Carrier picks up package\n\n    OrderService->>OrderService: Crear tracking event (in_transit)\n    OrderService->>RabbitMQ: Publicar return.in_transit\n\n    %% Fase 4: Recibir en Warehouse\n    Note over OrderService: Warehouse receives package\n    OrderService->>OrderService: Actualizar return (status=received)\n    OrderService->>RabbitMQ: Publicar return.received\n    RabbitMQ->>InventoryService: Consumir return.received\n    RabbitMQ->>AuditService: Consumir return.received\n\n    %% Fase 5: Inspeccionar Items\n    OrderService->>OrderService: Inspeccionar condici\xf3n de items\n    OrderService->>OrderService: Actualizar return_items (condition)\n\n    %% Fase 6: Re-stock en Inventory\n    InventoryService->>InventoryService: Validar items recibidos\n    InventoryService->>InventoryService: Incrementar stock\n    InventoryService->>InventoryService: Crear stock_movement (type=in, reason=return)\n    InventoryService->>RabbitMQ: Publicar inventory.stock.restocked\n    RabbitMQ->>AuditService: Consumir stock.restocked\n    InventoryService--\x3e>OrderService: Stock actualizado\n\n    %% Fase 7: Procesar Reembolso\n    OrderService->>PaymentGateway: Create refund\n    PaymentGateway--\x3e>OrderService: Refund created\n    OrderService->>OrderService: Crear payment (type=refund)\n    OrderService->>RabbitMQ: Publicar payment.refunded\n\n    PaymentGateway--\x3e>OrderService: Webhook: refund.succeeded\n    OrderService->>OrderService: Actualizar return (status=refunded)\n    OrderService->>RabbitMQ: Publicar return.refunded\n    RabbitMQ->>AuditService: Consumir return.refunded\n    OrderService--\x3e>Customer: Email: Refund processed"}),"\n",(0,i.jsx)(n.h2,{id:"fases-del-flujo",children:"Fases del Flujo"}),"\n",(0,i.jsx)(n.h3,{id:"fase-1-solicitar-devoluci\xf3n",children:"Fase 1: Solicitar Devoluci\xf3n"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Endpoint"}),": ",(0,i.jsx)(n.code,{children:"POST /api/v1/orders/{order_id}/returns"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "items": [\n    {\n      "order_item_id": "item_789",\n      "variant_id": "var_123",\n      "quantity": 1,\n      "reason": "wrong_size",\n      "notes": "El producto es m\xe1s peque\xf1o de lo esperado"\n    }\n  ],\n  "return_reason": "wrong_size",\n  "preferred_resolution": "refund"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Validaciones"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def create_return(order_id: str, return_request: ReturnCreate):\n    """Crear solicitud de devoluci\xf3n."""\n    order = await order_repo.get_by_id(order_id)\n\n    # Validar estado de orden\n    if order.status != \'delivered\':\n        raise HTTPException(\n            status_code=400,\n            detail="Order must be delivered to request return"\n        )\n\n    # Validar ventana de devoluci\xf3n (ej: 30 d\xedas)\n    days_since_delivery = (datetime.utcnow() - order.delivered_at).days\n    if days_since_delivery > 30:\n        raise HTTPException(\n            status_code=400,\n            detail=f"Return window expired. Order delivered {days_since_delivery} days ago."\n        )\n\n    # Validar que items pertenecen a la orden\n    order_item_ids = {str(item.order_item_id) for item in order.items}\n    for item in return_request.items:\n        if item.order_item_id not in order_item_ids:\n            raise HTTPException(\n                status_code=400,\n                detail=f"Item {item.order_item_id} does not belong to order"\n            )\n\n    # Crear return\n    return_obj = await return_repo.create(\n        order_id=order.order_id,\n        customer_id=order.customer_id,\n        rma_number=generate_rma_number(),  # RMA-2025-0001\n        status=\'pending\',\n        return_reason=return_request.return_reason,\n        preferred_resolution=return_request.preferred_resolution\n    )\n\n    # Crear return items\n    for item in return_request.items:\n        await return_item_repo.create(\n            return_id=return_obj.return_id,\n            order_item_id=item.order_item_id,\n            variant_id=item.variant_id,\n            quantity=item.quantity,\n            reason=item.reason\n        )\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="return.requested",\n        data={\n            "return_id": str(return_obj.return_id),\n            "order_id": str(order.order_id),\n            "rma_number": return_obj.rma_number,\n            "reason": return_request.return_reason,\n            "items": [\n                {\n                    "order_item_id": str(item.order_item_id),\n                    "variant_id": str(item.variant_id),\n                    "quantity": item.quantity\n                }\n                for item in return_request.items\n            ],\n            "requested_at": return_obj.created_at.isoformat()\n        }\n    )\n\n    return return_obj\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "return_id": "ret_123",\n  "rma_number": "RMA-2025-0001",\n  "status": "pending",\n  "items": [\n    {\n      "return_item_id": "ret_item_456",\n      "variant_id": "var_123",\n      "quantity": 1,\n      "reason": "wrong_size"\n    }\n  ],\n  "created_at": "2025-11-27T09:00:00Z",\n  "message": "Return request submitted. You will receive an email when approved."\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"fase-2-aprobar-devoluci\xf3n",children:"Fase 2: Aprobar Devoluci\xf3n"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Endpoint"}),": ",(0,i.jsx)(n.code,{children:"PUT /api/v1/returns/{return_id}/approve"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "approved_by": "user_manager",\n  "notes": "Return approved. Customer will receive prepaid label.",\n  "refund_amount": 50.00\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Proceso"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def approve_return(return_id: str, approval: ReturnApproval):\n    """Aprobar devoluci\xf3n."""\n    return_obj = await return_repo.get_by_id(return_id)\n\n    if return_obj.status != \'pending\':\n        raise HTTPException(\n            status_code=400,\n            detail=f"Return must be pending. Current status: {return_obj.status}"\n        )\n\n    # Generar shipping label para devoluci\xf3n\n    label = await shipping_client.create_return_label(\n        from_address=return_obj.order.shipping_address,\n        to_address=warehouse.address,\n        weight=estimate_weight(return_obj.items),\n        carrier=\'fedex\'\n    )\n\n    # Actualizar return\n    return_obj.status = \'approved\'\n    return_obj.approved_by = approval.approved_by\n    return_obj.approved_at = datetime.utcnow()\n    return_obj.return_shipping_label_url = label.label_url\n    return_obj.return_tracking_number = label.tracking_number\n    return_obj.refund_amount = approval.refund_amount\n\n    await return_repo.update(return_obj)\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="return.approved",\n        data={\n            "return_id": str(return_obj.return_id),\n            "rma_number": return_obj.rma_number,\n            "approved_by": approval.approved_by,\n            "return_shipping_label_url": label.label_url,\n            "refund_amount": float(approval.refund_amount)\n        }\n    )\n\n    # Enviar email al cliente con label\n    await notification_service.send_email(\n        to=return_obj.order.customer_email,\n        template="return_approved",\n        data={\n            "rma_number": return_obj.rma_number,\n            "label_url": label.label_url,\n            "instructions": "Print the label and attach it to the package"\n        }\n    )\n\n    return return_obj\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "return_id": "ret_123",\n  "status": "approved",\n  "return_shipping_label_url": "https://shipping.example.com/labels/ret_123.pdf",\n  "return_tracking_number": "RET-987654321",\n  "refund_amount": 50.00,\n  "approved_at": "2025-11-27T10:00:00Z"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"fase-3-rastrear-env\xedo-de-devoluci\xf3n",children:"Fase 3: Rastrear Env\xedo de Devoluci\xf3n"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Webhook de Carrier"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"@app.post(\"/webhooks/fedex/returns\")\nasync def fedex_return_tracking(request: Request):\n    \"\"\"Recibir eventos de tracking de devoluciones.\"\"\"\n    payload = await request.json()\n\n    return_obj = await return_repo.get_by_tracking(\n        payload['tracking_number']\n    )\n\n    # Crear tracking event\n    await return_tracking_repo.create(\n        return_id=return_obj.return_id,\n        status=payload['status'],\n        location=payload['location'],\n        event_timestamp=payload['timestamp']\n    )\n\n    if payload['status'] == 'in_transit':\n        return_obj.status = 'in_transit'\n        await return_repo.update(return_obj)\n\n        await event_publisher.publish(\n            event_type=\"return.in_transit\",\n            data={\n                \"return_id\": str(return_obj.return_id),\n                \"tracking_number\": return_obj.return_tracking_number\n            }\n        )\n"})}),"\n",(0,i.jsx)(n.h3,{id:"fase-4-recibir-en-warehouse",children:"Fase 4: Recibir en Warehouse"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Endpoint"}),": ",(0,i.jsx)(n.code,{children:"POST /api/v1/returns/{return_id}/receive"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "received_by": "warehouse_user_123",\n  "warehouse_id": "wh_101",\n  "notes": "Package received in good condition"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Proceso"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def receive_return(return_id: str, receipt: ReturnReceipt):\n    """Marcar devoluci\xf3n como recibida en warehouse."""\n    return_obj = await return_repo.get_by_id(return_id)\n\n    if return_obj.status not in [\'approved\', \'in_transit\']:\n        raise HTTPException(\n            status_code=400,\n            detail="Return must be approved or in transit"\n        )\n\n    # Actualizar return\n    return_obj.status = \'received\'\n    return_obj.received_at = datetime.utcnow()\n    return_obj.received_by = receipt.received_by\n    return_obj.warehouse_id = receipt.warehouse_id\n\n    await return_repo.update(return_obj)\n\n    # Publicar evento (Inventory lo consumir\xe1)\n    await event_publisher.publish(\n        event_type="return.received",\n        data={\n            "return_id": str(return_obj.return_id),\n            "order_id": str(return_obj.order_id),\n            "rma_number": return_obj.rma_number,\n            "received_at": return_obj.received_at.isoformat(),\n            "warehouse_id": str(receipt.warehouse_id),\n            "returned_items": [\n                {\n                    "variant_id": str(item.variant_id),\n                    "quantity": item.quantity,\n                    "condition": item.condition or "pending_inspection",\n                    "return_reason": item.reason\n                }\n                for item in return_obj.items\n            ]\n        }\n    )\n\n    return return_obj\n'})}),"\n",(0,i.jsx)(n.h3,{id:"fase-5-inspeccionar-items",children:"Fase 5: Inspeccionar Items"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Endpoint"}),": ",(0,i.jsx)(n.code,{children:"POST /api/v1/returns/{return_id}/inspect"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "items": [\n    {\n      "return_item_id": "ret_item_456",\n      "inspected_quantity": 1,\n      "approved_quantity": 1,\n      "rejected_quantity": 0,\n      "condition": "good",\n      "inspection_notes": "Item in perfect condition, original packaging"\n    }\n  ],\n  "inspected_by": "qc_user_789"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Proceso"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def inspect_return(return_id: str, inspection: ReturnInspection):\n    """Inspeccionar items de devoluci\xf3n."""\n    return_obj = await return_repo.get_by_id(return_id)\n\n    if return_obj.status != \'received\':\n        raise HTTPException(\n            status_code=400,\n            detail="Return must be received before inspection"\n        )\n\n    # Actualizar cada item\n    for item_inspection in inspection.items:\n        item = await return_item_repo.get_by_id(item_inspection.return_item_id)\n\n        item.inspected_quantity = item_inspection.inspected_quantity\n        item.approved_quantity = item_inspection.approved_quantity\n        item.rejected_quantity = item_inspection.rejected_quantity\n        item.condition = item_inspection.condition\n        item.inspection_notes = item_inspection.inspection_notes\n\n        await return_item_repo.update(item)\n\n    # Marcar como inspeccionado\n    return_obj.status = \'inspected\'\n    return_obj.inspected_at = datetime.utcnow()\n    return_obj.inspected_by = inspection.inspected_by\n\n    await return_repo.update(return_obj)\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="return.inspected",\n        data={\n            "return_id": str(return_obj.return_id),\n            "items": [\n                {\n                    "variant_id": str(item.variant_id),\n                    "approved_quantity": item.approved_quantity,\n                    "rejected_quantity": item.rejected_quantity,\n                    "condition": item.condition\n                }\n                for item in return_obj.items\n            ]\n        }\n    )\n\n    return return_obj\n'})}),"\n",(0,i.jsx)(n.h3,{id:"fase-6-re-stock-en-inventory",children:"Fase 6: Re-stock en Inventory"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["Inventory Service consume ",(0,i.jsx)(n.code,{children:"return.received"})]}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"async def handle_return_received(event):\n    \"\"\"Re-stock items de devoluci\xf3n.\"\"\"\n    returned_items = event['data']['returned_items']\n    warehouse_id = event['data']['warehouse_id']\n    organization_id = event['organization_id']\n\n    for item in returned_items:\n        # Solo re-stock si est\xe1 en buena condici\xf3n\n        if item['condition'] not in ['good', 'like_new']:\n            logger.warning(\n                f\"Skipping restock for damaged item\",\n                extra={\n                    \"variant_id\": item['variant_id'],\n                    \"condition\": item['condition']\n                }\n            )\n            continue\n\n        # Obtener stock\n        stock = await stock_repo.get_by_variant_warehouse(\n            variant_id=item['variant_id'],\n            warehouse_id=warehouse_id,\n            organization_id=organization_id\n        )\n\n        if not stock:\n            # Crear stock si no existe\n            stock = await stock_repo.create(\n                variant_id=item['variant_id'],\n                warehouse_id=warehouse_id,\n                organization_id=organization_id,\n                total_quantity=0,\n                available_quantity=0\n            )\n\n        # Incrementar stock\n        quantity_before = stock.total_quantity\n        stock.total_quantity += item['quantity']\n        stock.available_quantity += item['quantity']\n        stock.version += 1\n        stock.last_movement_at = datetime.utcnow()\n\n        await stock_repo.update(stock)\n\n        # Crear movimiento\n        await movement_repo.create(\n            stock_id=stock.stock_id,\n            organization_id=organization_id,\n            type='in',\n            quantity_before=quantity_before,\n            quantity_after=stock.total_quantity,\n            quantity_change=item['quantity'],\n            reason='return',\n            reference_id=event['data']['return_id'],\n            reference_type='return'\n        )\n\n        logger.info(\n            f\"Stock restocked from return\",\n            extra={\n                \"variant_id\": item['variant_id'],\n                \"quantity\": item['quantity'],\n                \"warehouse_id\": warehouse_id,\n                \"new_total\": stock.total_quantity\n            }\n        )\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type=\"inventory.stock.restocked\",\n        data={\n            \"return_id\": event['data']['return_id'],\n            \"warehouse_id\": warehouse_id,\n            \"items\": returned_items\n        }\n    )\n"})}),"\n",(0,i.jsx)(n.h3,{id:"fase-7-procesar-reembolso",children:"Fase 7: Procesar Reembolso"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Proceso Autom\xe1tico"})," (despu\xe9s de inspecci\xf3n):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'async def process_return_refund(return_id: str):\n    """Procesar reembolso de devoluci\xf3n."""\n    return_obj = await return_repo.get_by_id(return_id)\n\n    if return_obj.status != \'inspected\':\n        raise ValueError("Return must be inspected before refund")\n\n    # Obtener pago original\n    original_payment = await payment_repo.get_by_order(return_obj.order_id)\n\n    # Calcular monto a reembolsar (basado en items aprobados)\n    refund_amount = calculate_refund_amount(return_obj.items)\n\n    # Crear refund en Stripe\n    refund = stripe.Refund.create(\n        payment_intent=original_payment.gateway_payment_id,\n        amount=int(refund_amount * 100),  # centavos\n        reason=\'requested_by_customer\',\n        metadata={\n            \'return_id\': str(return_obj.return_id),\n            \'rma_number\': return_obj.rma_number\n        }\n    )\n\n    # Crear payment de tipo refund\n    refund_payment = await payment_repo.create(\n        order_id=return_obj.order_id,\n        payment_type=\'refund\',\n        amount=refund_amount,\n        status=\'pending\',\n        payment_method=original_payment.payment_method,\n        gateway_payment_id=refund.id\n    )\n\n    # Publicar evento\n    await event_publisher.publish(\n        event_type="payment.refunded",\n        data={\n            "payment_id": str(refund_payment.payment_id),\n            "order_id": str(return_obj.order_id),\n            "return_id": str(return_obj.return_id),\n            "refund_amount": float(refund_amount),\n            "refund_reason": "customer_return",\n            "refunded_at": datetime.utcnow().isoformat()\n        }\n    )\n\n    return refund_payment\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Webhook de Stripe"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'@app.post("/webhooks/stripe")\nasync def stripe_webhook(request: Request):\n    event = stripe.Webhook.construct_event(...)\n\n    if event[\'type\'] == \'charge.refunded\':\n        refund = event[\'data\'][\'object\'][\'refunds\'][\'data\'][0]\n        return_id = refund[\'metadata\'][\'return_id\']\n\n        # Actualizar return\n        return_obj = await return_repo.get_by_id(return_id)\n        return_obj.status = \'refunded\'\n        return_obj.refunded_at = datetime.utcnow()\n        await return_repo.update(return_obj)\n\n        # Publicar evento\n        await event_publisher.publish(\n            event_type="return.refunded",\n            data={\n                "return_id": str(return_obj.return_id),\n                "refund_amount": float(return_obj.refund_amount),\n                "refund_method": "original_payment",\n                "refunded_at": return_obj.refunded_at.isoformat()\n            }\n        )\n\n        # Notificar cliente\n        await notification_service.send_email(\n            to=return_obj.order.customer_email,\n            template="refund_processed",\n            data={\n                "rma_number": return_obj.rma_number,\n                "refund_amount": float(return_obj.refund_amount)\n            }\n        )\n'})}),"\n",(0,i.jsx)(n.h2,{id:"escenarios-especiales",children:"Escenarios Especiales"}),"\n",(0,i.jsx)(n.h3,{id:"1-devoluci\xf3n-parcial",children:"1. Devoluci\xf3n Parcial"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Cliente solo devuelve algunos items de la orden\nreturn_request = {\n    "items": [\n        {"order_item_id": "item_1", "quantity": 1},\n        # item_2 no se devuelve\n    ]\n}\n\n# Refund solo por items devueltos\nrefund_amount = sum(\n    item.unit_price * item.approved_quantity\n    for item in return_obj.items\n)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"2-items-da\xf1ados",children:"2. Items Da\xf1ados"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Durante inspecci\xf3n\nif item.condition == \'damaged\':\n    item.approved_quantity = 0\n    item.rejected_quantity = item.inspected_quantity\n\n    # NO re-stock items da\xf1ados\n    # NO reembolsar items da\xf1ados\n\n    # Notificar cliente\n    await notification_service.send_email(\n        to=customer_email,\n        template="return_rejected",\n        data={\n            "reason": "Item received damaged",\n            "variant_id": item.variant_id\n        }\n    )\n'})}),"\n",(0,i.jsx)(n.h3,{id:"3-restocking-fee",children:"3. Restocking Fee"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Aplicar fee de re-stocking (ej: 15%)\nRESTOCKING_FEE_PERCENT = 0.15\n\nrefund_amount = original_amount * (1 - RESTOCKING_FEE_PERCENT)\n\nawait notification_service.send_email(\n    template="refund_with_restocking_fee",\n    data={\n        "original_amount": original_amount,\n        "restocking_fee": original_amount * RESTOCKING_FEE_PERCENT,\n        "refund_amount": refund_amount\n    }\n)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"4-exchange-en-lugar-de-refund",children:"4. Exchange en lugar de Refund"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"if return_obj.preferred_resolution == 'exchange':\n    # Crear nueva orden para item de reemplazo\n    exchange_order = await order_repo.create(\n        customer_id=return_obj.customer_id,\n        order_type='exchange',\n        original_order_id=return_obj.order_id,\n        # ... items del exchange\n    )\n\n    # NO procesar refund\n    # Reservar stock para nuevo item\n    # ...\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pol\xedticas-de-devoluci\xf3n",children:"Pol\xedticas de Devoluci\xf3n"}),"\n",(0,i.jsx)(n.h3,{id:"ventana-de-devoluci\xf3n",children:"Ventana de Devoluci\xf3n"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"RETURN_WINDOW_DAYS = {\n    'clothing': 30,\n    'electronics': 15,\n    'food': 7,\n    'custom': 0  # No returnable\n}\n\ndef get_return_window(product_type: str) -> int:\n    \"\"\"Obtener ventana de devoluci\xf3n por tipo de producto.\"\"\"\n    return RETURN_WINDOW_DAYS.get(product_type, 30)  # default 30 d\xedas\n"})}),"\n",(0,i.jsx)(n.h3,{id:"condiciones-aceptables",children:"Condiciones Aceptables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"ACCEPTABLE_CONDITIONS = ['good', 'like_new', 'unopened']\nREJECTABLE_CONDITIONS = ['damaged', 'used', 'missing_parts']\n\ndef can_restock(condition: str) -> bool:\n    \"\"\"Determinar si item puede ser re-stockeado.\"\"\"\n    return condition in ACCEPTABLE_CONDITIONS\n"})}),"\n",(0,i.jsx)(n.h2,{id:"m\xe9tricas",children:"M\xe9tricas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Return rate\nreturn_rate = Gauge('return_rate', 'Percentage of orders returned')\n\n# Refund processing time\nrefund_processing_duration = Histogram(\n    'refund_processing_duration_seconds',\n    'Time to process refund'\n)\n\n# Restocking success rate\nrestock_success_rate = Gauge(\n    'restock_success_rate',\n    'Percentage of returned items restocked'\n)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"slas",children:"SLAs"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Aprobaci\xf3n de Devoluci\xf3n"}),": < 24 horas"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Procesamiento de Reembolso"}),": < 3-5 d\xedas h\xe1biles"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Re-stock en Inventario"}),": < 2 horas (despu\xe9s de recepci\xf3n)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./flujo-venta-completo",children:"Flujo de Venta Completo"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./flujo-transferencias",children:"Flujo de Transferencias de Stock"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"./compensaciones",children:"Compensaciones y Rollbacks"})}),"\n"]})]})}function l(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>s});var t=r(6540);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);