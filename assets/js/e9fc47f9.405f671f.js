"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[5176],{7869:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>l,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"microservicios/audit-service/configuracion","title":"Configuraci\xf3n - Audit Service","description":"Configuraci\xf3n completa de variables de entorno, puertos, y dependencias del Audit Service.","source":"@site/docs/02-microservicios/audit-service/04-configuracion.md","sourceDirName":"02-microservicios/audit-service","slug":"/microservicios/audit-service/configuracion","permalink":"/zenlogic/microservicios/audit-service/configuracion","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/02-microservicios/audit-service/04-configuracion.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4}}');var r=i(4848),o=i(8453);const a={sidebar_position:4},s="Configuraci\xf3n - Audit Service",d={},c=[{value:"Variables de Entorno",id:"variables-de-entorno",level:2},{value:"Base de Datos",id:"base-de-datos",level:3},{value:"Puertos",id:"puertos",level:3},{value:"Redis",id:"redis",level:3},{value:"RabbitMQ",id:"rabbitmq",level:3},{value:"L\xf3gica de Negocio",id:"l\xf3gica-de-negocio",level:3},{value:"Logging",id:"logging",level:3},{value:"Seguridad",id:"seguridad",level:3},{value:"Compliance",id:"compliance",level:3},{value:"Docker Compose - Audit Service",id:"docker-compose---audit-service",level:2},{value:"Archivo .env de Ejemplo",id:"archivo-env-de-ejemplo",level:2},{value:"Configuraci\xf3n por Ambiente",id:"configuraci\xf3n-por-ambiente",level:2},{value:"Development",id:"development",level:3},{value:"Staging",id:"staging",level:3},{value:"Production",id:"production",level:3},{value:"Validaci\xf3n de Configuraci\xf3n",id:"validaci\xf3n-de-configuraci\xf3n",level:2},{value:"Event Consumer Configuration",id:"event-consumer-configuration",level:2},{value:"Partition Management Script",id:"partition-management-script",level:2},{value:"Monitoring Configuration",id:"monitoring-configuration",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function _(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"configuraci\xf3n---audit-service",children:"Configuraci\xf3n - Audit Service"})}),"\n",(0,r.jsx)(n.p,{children:"Configuraci\xf3n completa de variables de entorno, puertos, y dependencias del Audit Service."}),"\n",(0,r.jsx)(n.h2,{id:"variables-de-entorno",children:"Variables de Entorno"}),"\n",(0,r.jsx)(n.h3,{id:"base-de-datos",children:"Base de Datos"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# PostgreSQL Configuration\nDATABASE_URL=postgresql://user:password@localhost:5432/audit_db\nDATABASE_POOL_SIZE=50  # Mayor pool para escritura intensiva\nDATABASE_MAX_OVERFLOW=100\nDATABASE_ECHO=false  # Set to true for SQL debugging\n"})}),"\n",(0,r.jsx)(n.h3,{id:"puertos",children:"Puertos"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# HTTP REST API\nHTTP_PORT=8005\nHTTP_HOST=0.0.0.0\n\n# No gRPC Server (Audit Service solo expone REST API)\n\n# Health Check\nHEALTH_CHECK_PATH=/health\nMETRICS_PATH=/metrics\n"})}),"\n",(0,r.jsx)(n.h3,{id:"redis",children:"Redis"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Redis NO es requerido para Audit Service\n# Audit Service no usa cache debido a que todos los datos son hist\xf3ricos\n"})}),"\n",(0,r.jsx)(n.h3,{id:"rabbitmq",children:"RabbitMQ"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# RabbitMQ Connection\nRABBITMQ_URL=amqp://guest:guest@localhost:5672/\nRABBITMQ_HEARTBEAT=60\nRABBITMQ_CONNECTION_TIMEOUT=30\n\n# Exchange Subscriptions (consume de TODOS los exchanges)\nRABBITMQ_EXCHANGE_AUTH=auth_events\nRABBITMQ_EXCHANGE_CATALOG=catalog_events\nRABBITMQ_EXCHANGE_INVENTORY=inventory_events\nRABBITMQ_EXCHANGE_ORDER=order_events\n\n# Queue Configuration\nRABBITMQ_QUEUE_AUDIT_CONSUMER=audit_event_consumer\n\n# Consumer Settings\nRABBITMQ_PREFETCH_COUNT=50\nRABBITMQ_AUTO_ACK=false\n\n# Routing Keys (consume todos los eventos)\nRABBITMQ_ROUTING_KEY_AUTH=auth.#\nRABBITMQ_ROUTING_KEY_CATALOG=catalog.#\nRABBITMQ_ROUTING_KEY_INVENTORY=inventory.#\nRABBITMQ_ROUTING_KEY_ORDER=order.#\n"})}),"\n",(0,r.jsx)(n.h3,{id:"l\xf3gica-de-negocio",children:"L\xf3gica de Negocio"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Event Processing\nBATCH_SIZE=100\nBATCH_TIMEOUT_SECONDS=1  # Reducido a 1 segundo para cumplir SLA de 2 segundos\nMAX_RETRY_ATTEMPTS=3\nRETRY_DELAY_SECONDS=5\n\n# Data Retention\nRETENTION_POLICY_DAYS=2555  # 7 a\xf1os para compliance (7 * 365 = 2555 d\xedas)\nPARTITION_BY_MONTH=true\nAUTO_CREATE_PARTITIONS=true\nPARTITION_RETENTION_MONTHS=84  # 7 a\xf1os en meses\n\n# Idempotency\nENABLE_IDEMPOTENCY_CHECK=true\nIDEMPOTENCY_CACHE_SIZE=10000  # \xdaltimos 10k event_ids en memoria\n\n# Performance\nENABLE_ASYNC_INSERT=true\nINSERT_BATCH_SIZE=100\nINSERT_FLUSH_INTERVAL_MS=500\n"})}),"\n",(0,r.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Log Configuration\nLOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL\nLOG_FORMAT=json\nLOG_FILE_PATH=/var/log/audit-service/app.log\nLOG_MAX_BYTES=10485760  # 10MB\nLOG_BACKUP_COUNT=10  # M\xe1s backups por ser servicio de auditor\xeda\n\n# Audit of Audit (meta-logging)\nLOG_FAILED_EVENTS=true\nFAILED_EVENTS_LOG_PATH=/var/log/audit-service/failed_events.log\n"})}),"\n",(0,r.jsx)(n.h3,{id:"seguridad",children:"Seguridad"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Multi-tenancy\nENFORCE_ORGANIZATION_ISOLATION=true\n\n# API Rate Limiting\nRATE_LIMIT_ENABLED=true\nRATE_LIMIT_PER_MINUTE=500  # Mayor que otros servicios (queries de compliance)\nRATE_LIMIT_PER_HOUR=30000\n\n# API Access\nENABLE_PUBLIC_API=false  # Audit API solo para usuarios autorizados\nREQUIRE_ADMIN_ROLE=true\n"})}),"\n",(0,r.jsx)(n.h3,{id:"compliance",children:"Compliance"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Regulatory Compliance\nENABLE_COMPLIANCE_MODE=true\nIMMUTABLE_LOGS=true  # No permite UPDATE/DELETE en audit_logs\nENABLE_ENCRYPTION_AT_REST=true\n\n# Export Configuration\nENABLE_AUDIT_EXPORT=true\nEXPORT_FORMAT=csv,json\nMAX_EXPORT_ROWS=1000000\n"})}),"\n",(0,r.jsx)(n.h2,{id:"docker-compose---audit-service",children:"Docker Compose - Audit Service"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'version: \'3.8\'\n\nservices:\n  audit-service:\n    build:\n      context: ./audit-service\n      dockerfile: Dockerfile\n    container_name: erp-audit-service\n    ports:\n      - "8005:8005"   # HTTP REST API only\n    environment:\n      # Database\n      DATABASE_URL: postgresql://postgres:postgres@audit-db:5432/audit_db\n      DATABASE_POOL_SIZE: 50\n      DATABASE_MAX_OVERFLOW: 100\n\n      # No Redis (Audit Service no usa cache)\n\n      # RabbitMQ - Consume de TODOS los exchanges\n      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/\n      RABBITMQ_EXCHANGE_AUTH: auth_events\n      RABBITMQ_EXCHANGE_CATALOG: catalog_events\n      RABBITMQ_EXCHANGE_INVENTORY: inventory_events\n      RABBITMQ_EXCHANGE_ORDER: order_events\n      RABBITMQ_PREFETCH_COUNT: 50\n\n      # Event Processing\n      BATCH_SIZE: 100\n      BATCH_TIMEOUT_SECONDS: 1\n      MAX_RETRY_ATTEMPTS: 3\n\n      # Data Retention\n      RETENTION_POLICY_DAYS: 2555  # 7 a\xf1os\n      PARTITION_BY_MONTH: true\n      AUTO_CREATE_PARTITIONS: true\n\n      # Compliance\n      ENABLE_COMPLIANCE_MODE: true\n      IMMUTABLE_LOGS: true\n\n      # Logging\n      LOG_LEVEL: INFO\n      LOG_FORMAT: json\n      LOG_FAILED_EVENTS: true\n    depends_on:\n      - audit-db\n      - rabbitmq\n    networks:\n      - erp-network\n    restart: unless-stopped\n    healthcheck:\n      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n    volumes:\n      - audit-logs:/var/log/audit-service\n\n  audit-db:\n    image: postgres:15-alpine\n    container_name: erp-audit-db\n    environment:\n      POSTGRES_DB: audit_db\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n    ports:\n      - "5437:5432"  # Puerto externo diferente\n    volumes:\n      - audit-db-data:/var/lib/postgresql/data\n      - ./audit-service/init.sql:/docker-entrypoint-initdb.d/init.sql\n    networks:\n      - erp-network\n    restart: unless-stopped\n    # Configuraci\xf3n especial para audit DB (mayor capacidad)\n    command: >\n      postgres\n      -c max_connections=200\n      -c shared_buffers=256MB\n      -c effective_cache_size=1GB\n      -c maintenance_work_mem=64MB\n      -c checkpoint_completion_target=0.9\n      -c wal_buffers=16MB\n      -c default_statistics_target=100\n\nvolumes:\n  audit-db-data:\n    driver: local\n  audit-logs:\n    driver: local\n\nnetworks:\n  erp-network:\n    external: true\n'})}),"\n",(0,r.jsx)(n.h2,{id:"archivo-env-de-ejemplo",children:"Archivo .env de Ejemplo"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# .env.audit-service\n\n# Database\nDATABASE_URL=postgresql://postgres:postgres@localhost:5432/audit_db\nDATABASE_POOL_SIZE=50\n\n# Ports\nHTTP_PORT=8005\n\n# RabbitMQ - Consume de TODOS los exchanges\nRABBITMQ_URL=amqp://guest:guest@localhost:5672/\nRABBITMQ_EXCHANGE_AUTH=auth_events\nRABBITMQ_EXCHANGE_CATALOG=catalog_events\nRABBITMQ_EXCHANGE_INVENTORY=inventory_events\nRABBITMQ_EXCHANGE_ORDER=order_events\nRABBITMQ_PREFETCH_COUNT=50\n\n# Event Processing\nBATCH_SIZE=100\nBATCH_TIMEOUT_SECONDS=1\nMAX_RETRY_ATTEMPTS=3\nENABLE_IDEMPOTENCY_CHECK=true\n\n# Data Retention\nRETENTION_POLICY_DAYS=2555  # 7 a\xf1os\nPARTITION_BY_MONTH=true\nAUTO_CREATE_PARTITIONS=true\n\n# Compliance\nENABLE_COMPLIANCE_MODE=true\nIMMUTABLE_LOGS=true\nREQUIRE_ADMIN_ROLE=true\n\n# Logging\nLOG_LEVEL=INFO\nLOG_FORMAT=json\nLOG_FAILED_EVENTS=true\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configuraci\xf3n-por-ambiente",children:"Configuraci\xf3n por Ambiente"}),"\n",(0,r.jsx)(n.h3,{id:"development",children:"Development"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"DATABASE_URL=postgresql://dev:dev@localhost:5432/audit_db_dev\nLOG_LEVEL=DEBUG\nDATABASE_ECHO=true\nRATE_LIMIT_ENABLED=false\nRETENTION_POLICY_DAYS=30  # Solo 30 d\xedas en dev\nENABLE_COMPLIANCE_MODE=false\nIMMUTABLE_LOGS=false\n"})}),"\n",(0,r.jsx)(n.h3,{id:"staging",children:"Staging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"DATABASE_URL=postgresql://staging_user:staging_pass@staging-db:5432/audit_db_staging\nLOG_LEVEL=INFO\nRATE_LIMIT_ENABLED=true\nRETENTION_POLICY_DAYS=365  # 1 a\xf1o en staging\nENABLE_COMPLIANCE_MODE=true\nIMMUTABLE_LOGS=true\n"})}),"\n",(0,r.jsx)(n.h3,{id:"production",children:"Production"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"DATABASE_URL=postgresql://prod_user:secure_password@prod-db:5432/audit_db\nLOG_LEVEL=WARNING\nDATABASE_ECHO=false\nRATE_LIMIT_ENABLED=true\nRETENTION_POLICY_DAYS=2555  # 7 a\xf1os en producci\xf3n\nENABLE_COMPLIANCE_MODE=true\nIMMUTABLE_LOGS=true\nREQUIRE_ADMIN_ROLE=true\nENABLE_ENCRYPTION_AT_REST=true\n"})}),"\n",(0,r.jsx)(n.h2,{id:"validaci\xf3n-de-configuraci\xf3n",children:"Validaci\xf3n de Configuraci\xf3n"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pydantic import BaseSettings, Field, validator\n\nclass Settings(BaseSettings):\n    \"\"\"Audit Service Configuration.\"\"\"\n\n    # Database\n    database_url: str = Field(..., env='DATABASE_URL')\n    database_pool_size: int = Field(50, env='DATABASE_POOL_SIZE')\n\n    # Ports\n    http_port: int = Field(8005, env='HTTP_PORT')\n\n    # RabbitMQ - Todos los exchanges\n    rabbitmq_url: str = Field(..., env='RABBITMQ_URL')\n    rabbitmq_exchange_auth: str = Field('auth_events', env='RABBITMQ_EXCHANGE_AUTH')\n    rabbitmq_exchange_catalog: str = Field('catalog_events', env='RABBITMQ_EXCHANGE_CATALOG')\n    rabbitmq_exchange_inventory: str = Field('inventory_events', env='RABBITMQ_EXCHANGE_INVENTORY')\n    rabbitmq_exchange_order: str = Field('order_events', env='RABBITMQ_EXCHANGE_ORDER')\n    rabbitmq_prefetch_count: int = Field(50, env='RABBITMQ_PREFETCH_COUNT')\n\n    # Event Processing\n    batch_size: int = Field(100, env='BATCH_SIZE')\n    batch_timeout_seconds: int = Field(1, env='BATCH_TIMEOUT_SECONDS')\n    max_retry_attempts: int = Field(3, env='MAX_RETRY_ATTEMPTS')\n    enable_idempotency_check: bool = Field(True, env='ENABLE_IDEMPOTENCY_CHECK')\n\n    # Data Retention\n    retention_policy_days: int = Field(2555, env='RETENTION_POLICY_DAYS')\n    partition_by_month: bool = Field(True, env='PARTITION_BY_MONTH')\n    auto_create_partitions: bool = Field(True, env='AUTO_CREATE_PARTITIONS')\n\n    # Compliance\n    enable_compliance_mode: bool = Field(True, env='ENABLE_COMPLIANCE_MODE')\n    immutable_logs: bool = Field(True, env='IMMUTABLE_LOGS')\n    require_admin_role: bool = Field(True, env='REQUIRE_ADMIN_ROLE')\n\n    # Logging\n    log_level: str = Field('INFO', env='LOG_LEVEL')\n    log_format: str = Field('json', env='LOG_FORMAT')\n    log_failed_events: bool = Field(True, env='LOG_FAILED_EVENTS')\n\n    @validator('http_port')\n    def validate_http_port(cls, v):\n        if v != 8005:\n            raise ValueError('HTTP port must be 8005 for Audit Service')\n        return v\n\n    @validator('batch_timeout_seconds')\n    def validate_batch_timeout(cls, v):\n        if v > 2:\n            raise ValueError('Batch timeout must be <= 2 seconds to meet SLA')\n        return v\n\n    @validator('retention_policy_days')\n    def validate_retention(cls, v):\n        if v < 365:\n            raise ValueError('Retention policy must be at least 1 year for compliance')\n        return v\n\n    @validator('rabbitmq_prefetch_count')\n    def validate_prefetch_count(cls, v):\n        if v != 50:\n            raise ValueError('Prefetch count should be 50 for Audit Service')\n        return v\n\n    class Config:\n        env_file = '.env'\n        case_sensitive = False\n\n# Usage\nsettings = Settings()\n"})}),"\n",(0,r.jsx)(n.h2,{id:"event-consumer-configuration",children:"Event Consumer Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# Configuraci\xf3n de bindings para consumir de todos los exchanges\n\nEVENT_CONSUMER_CONFIG = {\n    'exchanges': [\n        {\n            'name': 'auth_events',\n            'type': 'topic',\n            'routing_keys': ['auth.#']  # Todos los eventos de auth\n        },\n        {\n            'name': 'catalog_events',\n            'type': 'topic',\n            'routing_keys': ['catalog.#']  # Todos los eventos de catalog\n        },\n        {\n            'name': 'inventory_events',\n            'type': 'topic',\n            'routing_keys': ['inventory.#']  # Todos los eventos de inventory\n        },\n        {\n            'name': 'order_events',\n            'type': 'topic',\n            'routing_keys': ['order.#']  # Todos los eventos de order\n        }\n    ],\n    'queue': 'audit_event_consumer',\n    'prefetch_count': 50,\n    'auto_ack': False\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"partition-management-script",children:"Partition Management Script"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# create_audit_partitions.sh\n\n# Crea particiones para los pr\xf3ximos 12 meses\n\nYEAR=$(date +%Y)\nMONTH=$(date +%m)\n\nfor i in {0..12}; do\n    PARTITION_DATE=$(date -d "$YEAR-$MONTH-01 +$i months" +%Y-%m)\n    PARTITION_NAME="audit_logs_${PARTITION_DATE//-/_}"\n    RANGE_START="${PARTITION_DATE}-01"\n    RANGE_END=$(date -d "$RANGE_START +1 month" +%Y-%m-%d)\n\n    psql -U postgres -d audit_db -c "\n    CREATE TABLE IF NOT EXISTS ${PARTITION_NAME}\n    PARTITION OF audit_logs\n    FOR VALUES FROM (\'${RANGE_START}\') TO (\'${RANGE_END}\');\n    "\ndone\n'})}),"\n",(0,r.jsx)(n.h2,{id:"monitoring-configuration",children:"Monitoring Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Prometheus Metrics\nENABLE_PROMETHEUS=true\nPROMETHEUS_PORT=9090\n\n# Metrics to track\nMETRIC_EVENTS_PROCESSED_TOTAL=true\nMETRIC_EVENTS_FAILED_TOTAL=true\nMETRIC_PROCESSING_DURATION_SECONDS=true\nMETRIC_BATCH_SIZE_CURRENT=true\nMETRIC_QUEUE_SIZE_CURRENT=true\n"})}),"\n",(0,r.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./modelo-datos",children:"Modelo de Datos"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./event-consumer",children:"Event Consumer"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./api-logs",children:"API: Audit Logs"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./arquitectura",children:"Arquitectura"})}),"\n"]})]})}function l(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(_,{...e})}):_(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>s});var t=i(6540);const r={},o=t.createContext(r);function a(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);