"use strict";(globalThis.webpackChunkerp_docs=globalThis.webpackChunkerp_docs||[]).push([[5637],{3045:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"adrs/adr-003-event-driven","title":"ADR-003: Arquitectura Event-Driven","description":"Estado: Aceptado","source":"@site/docs/03-adrs/adr-003-event-driven.md","sourceDirName":"03-adrs","slug":"/adrs/adr-003-event-driven","permalink":"/zenlogic/adrs/adr-003-event-driven","draft":false,"unlisted":false,"editUrl":"https://github.com/your-repo/edit/main/docs/03-adrs/adr-003-event-driven.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docs","previous":{"title":"ADR-002: PostgreSQL como Base de Datos Principal","permalink":"/zenlogic/adrs/adr-002-postgresql"},"next":{"title":"ADR-004: gRPC para Comunicaci\xf3n Interna","permalink":"/zenlogic/adrs/adr-004-grpc-internal"}}');var r=s(4848),a=s(8453);const l={sidebar_position:4},c="ADR-003: Arquitectura Event-Driven",t={},o=[{value:"Contexto",id:"contexto",level:2},{value:"Desaf\xedos",id:"desaf\xedos",level:3},{value:"Requisitos",id:"requisitos",level:3},{value:"Decisi\xf3n",id:"decisi\xf3n",level:2},{value:"Patr\xf3n: Topic Exchange",id:"patr\xf3n-topic-exchange",level:3},{value:"Modelo de Comunicaci\xf3n",id:"modelo-de-comunicaci\xf3n",level:3},{value:"Alternativas Consideradas",id:"alternativas-consideradas",level:2},{value:"1. Comunicaci\xf3n REST S\xedncrona",id:"1-comunicaci\xf3n-rest-s\xedncrona",level:3},{value:"2. Apache Kafka",id:"2-apache-kafka",level:3},{value:"3. AWS SNS/SQS",id:"3-aws-snssqs",level:3},{value:"4. Redis Pub/Sub",id:"4-redis-pubsub",level:3},{value:"Consecuencias",id:"consecuencias",level:2},{value:"Positivas",id:"positivas",level:3},{value:"Negativas",id:"negativas",level:3},{value:"Riesgos",id:"riesgos",level:3},{value:"Implementaci\xf3n",id:"implementaci\xf3n",level:2},{value:"Publisher",id:"publisher",level:3},{value:"Consumer",id:"consumer",level:3},{value:"Patr\xf3n de Eventos",id:"patr\xf3n-de-eventos",level:2},{value:"Estructura de Evento",id:"estructura-de-evento",level:3},{value:"Eventos por Servicio",id:"eventos-por-servicio",level:3},{value:"Monitoreo",id:"monitoreo",level:2},{value:"Revisi\xf3n Futura",id:"revisi\xf3n-futura",level:2},{value:"Referencias",id:"referencias",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"adr-003-arquitectura-event-driven",children:"ADR-003: Arquitectura Event-Driven"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Estado"}),": Aceptado\n",(0,r.jsx)(n.strong,{children:"Fecha"}),": 2025-11-23\n",(0,r.jsx)(n.strong,{children:"Decisores"}),": Equipo de Arquitectura zenLogic"]}),"\n",(0,r.jsx)(n.h2,{id:"contexto",children:"Contexto"}),"\n",(0,r.jsx)(n.p,{children:"zenLogic tiene m\xfaltiples microservicios que necesitan comunicarse entre s\xed:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Auth Service"})," publica eventos cuando se crea/desactiva un usuario"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Catalog Service"})," necesita reaccionar a cambios en locales (Auth)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Audit Service"})," registra todos los eventos del sistema"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Order Service"})," (futuro) necesita validar productos del Catalog"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"desaf\xedos",children:"Desaf\xedos"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Acoplamiento"}),": Llamadas s\xedncronas crean dependencias fuertes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Disponibilidad"}),": Si Catalog Service cae, \xbfAuth Service puede seguir funcionando?"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Escalabilidad"}),": Picos de tr\xe1fico en un servicio no deben afectar otros"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Auditor\xeda"}),": Necesitamos registrar todos los eventos de negocio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Eventual Consistency"}),": Algunos casos aceptan consistencia eventual"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"requisitos",children:"Requisitos"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Desacoplamiento entre servicios"}),"\n",(0,r.jsx)(n.li,{children:"Entrega garantizada de mensajes (at-least-once)"}),"\n",(0,r.jsx)(n.li,{children:"Orden de mensajes por entidad"}),"\n",(0,r.jsx)(n.li,{children:"Dead Letter Queue para errores"}),"\n",(0,r.jsx)(n.li,{children:"Replay de eventos hist\xf3ricos"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"decisi\xf3n",children:"Decisi\xf3n"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Implementaremos arquitectura Event-Driven usando RabbitMQ"})," como message broker principal."]}),"\n",(0,r.jsx)(n.h3,{id:"patr\xf3n-topic-exchange",children:"Patr\xf3n: Topic Exchange"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"Exchange: erp.events (topic)\nRouting Key Format: {service}.{entity}.{action}\nExamples:\n  - auth.user.created\n  - auth.user.deactivated\n  - catalog.product.created\n  - catalog.product.updated\n  - catalog.product.deleted\n"})}),"\n",(0,r.jsx)(n.h3,{id:"modelo-de-comunicaci\xf3n",children:"Modelo de Comunicaci\xf3n"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph LR\n    Auth[Auth Service] --\x3e|publish| MQ[RabbitMQ<br/>erp.events]\n    Catalog[Catalog Service] --\x3e|publish| MQ\n\n    MQ --\x3e|subscribe| Audit[Audit Service]\n    MQ --\x3e|subscribe| Catalog\n    MQ --\x3e|subscribe| Notification[Notification Service]"}),"\n",(0,r.jsx)(n.h2,{id:"alternativas-consideradas",children:"Alternativas Consideradas"}),"\n",(0,r.jsx)(n.h3,{id:"1-comunicaci\xf3n-rest-s\xedncrona",children:"1. Comunicaci\xf3n REST S\xedncrona"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Simple de implementar"}),"\n",(0,r.jsx)(n.li,{children:"Request/response directo"}),"\n",(0,r.jsx)(n.li,{children:"F\xe1cil debugging"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Acoplamiento fuerte"}),": Si Catalog cae, Auth no puede publicar eventos relacionados"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cascading failures"}),": Falla en un servicio propaga a todos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No retry autom\xe1tico"}),": Necesitas implementar retry logic"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No escalabilidad de consumers"}),": Un solo endpoint procesa todo"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Crea dependencias fuertes que violan microservices principles."]}),"\n",(0,r.jsx)(n.h3,{id:"2-apache-kafka",children:"2. Apache Kafka"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Throughput masivo (millones msg/s)"}),"\n",(0,r.jsx)(n.li,{children:"Retention persistente (d\xedas/semanas)"}),"\n",(0,r.jsx)(n.li,{children:"Replay de eventos f\xe1cil"}),"\n",(0,r.jsx)(n.li,{children:"Particionamiento para paralelismo"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Complejidad operacional alta"}),": ZooKeeper (o KRaft), partitions, rebalancing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Overkill para nuestro caso"}),": No necesitamos millones msg/s"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Latencia mayor que RabbitMQ"})," (optimizado para throughput, no latency)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"M\xe1s recursos"}),": RAM y disk considerables"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Over-engineering. RabbitMQ es suficiente para nuestro volumen (",(0,r.jsx)(n.code,{children:"<10k msg/s"}),")."]}),"\n",(0,r.jsx)(n.h3,{id:"3-aws-snssqs",children:"3. AWS SNS/SQS"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Managed service, no ops"}),"\n",(0,r.jsx)(n.li,{children:"Escalabilidad autom\xe1tica"}),"\n",(0,r.jsx)(n.li,{children:"Integraci\xf3n nativa AWS"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Vendor lock-in"}),": Dif\xedcil migrar a on-premise"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Costo"}),": Pay-per-message puede ser alto"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Latencia"}),": Mayor que RabbitMQ on-premise"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No topic exchange nativo"}),": SNS\u2192SQS menos flexible"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Queremos evitar vendor lock-in. RabbitMQ es cloud-agnostic."]}),"\n",(0,r.jsx)(n.h3,{id:"4-redis-pubsub",children:"4. Redis Pub/Sub"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Extremadamente r\xe1pido (latencia ",(0,r.jsx)(n.code,{children:"<1ms"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"Simple de configurar"}),"\n",(0,r.jsx)(n.li,{children:"Ya usamos Redis para cache"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Contras"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No persistencia"}),": Si Redis cae, mensajes se pierden"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No garant\xeda de entrega"}),": Fire-and-forget"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"No Dead Letter Queue"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"No message acknowledgment"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Raz\xf3n de rechazo"}),": Cr\xedtico que mensajes no se pierdan. Redis Pub/Sub no es confiable."]}),"\n",(0,r.jsx)(n.h2,{id:"consecuencias",children:"Consecuencias"}),"\n",(0,r.jsx)(n.h3,{id:"positivas",children:"Positivas"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Desacoplamiento Total"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Auth Service publica evento sin saber qui\xe9n lo consume\nawait event_publisher.publish(\n    event_type="auth.user.deactivated",\n    payload={\n        "user_id": user_id,\n        "email": user.email,\n        "organization_id": org_id\n    }\n)\n# Catalog, Audit, Notification consumen independientemente\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Entrega Garantizada (At-Least-Once)"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# Consumer ACK despu\xe9s de procesar\nasync def process_message(message):\n    try:\n        await handle_event(message.body)\n        await message.ack()  # Solo ACK si \xe9xito\n    except Exception:\n        await message.nack(requeue=True)  # Reintenta\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Dead Letter Queue Autom\xe1tico"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Configuraci\xf3n de queue con DLQ\nawait channel.declare_queue(\n    "catalog.events",\n    arguments={\n        "x-dead-letter-exchange": "dlx.events",\n        "x-message-ttl": 3600000,  # 1 hora\n        "x-max-retries": 3\n    }\n)\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Escalabilidad de Consumers"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# M\xfaltiples consumers de la misma queue\n# RabbitMQ distribuye mensajes (round-robin)\nkubectl scale deployment audit-service --replicas=5\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Routing Flexible"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Audit Service: todos los eventos\nawait queue.bind("erp.events", routing_key="#")\n\n# Catalog Service: solo eventos de auth.user y auth.local\nawait queue.bind("erp.events", routing_key="auth.user.*")\nawait queue.bind("erp.events", routing_key="auth.local.*")\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Event Sourcing Simplificado"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Audit Service registra todos los eventos"}),"\n",(0,r.jsx)(n.li,{children:"Puede reconstruir estado reproduciendo eventos"}),"\n",(0,r.jsx)(n.li,{children:"Timeline completo de cada entidad"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"negativas",children:"Negativas"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Eventual Consistency"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Evento publicado \u2192 consumer procesa despu\xe9s (10-100ms)"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Ejemplo problem\xe1tico"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# Auth Service desactiva usuario\nuser.is_active = False\nawait db.commit()\nawait publish("auth.user.deactivated", user_id)\n\n# 50ms despu\xe9s, request a Catalog Service\n# Catalog a\xfan no proces\xf3 el evento \u2192 ve usuario activo\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Para casos cr\xedticos: validaci\xf3n s\xedncrona v\xeda gRPC"}),"\n",(0,r.jsx)(n.li,{children:"Cache con TTL corto (5-10s)"}),"\n",(0,r.jsx)(n.li,{children:'UI indica "cambios proces\xe1ndose"'}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Debugging M\xe1s Complejo"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tracing distribuido requerido"}),"\n",(0,r.jsx)(n.li,{children:"No hay stack trace \xfanico"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Correlation ID en todos los eventos"}),"\n",(0,r.jsx)(n.li,{children:"Distributed tracing (Jaeger/Zipkin)"}),"\n",(0,r.jsx)(n.li,{children:"Logs estructurados con correlation_id"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Orden de Mensajes No Garantizado (entre queues)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Usuario creado \u2192 Usuario actualizado"}),"\n",(0,r.jsx)(n.li,{children:"Si van a queues diferentes, pueden procesarse fuera de orden"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Usar routing key consistente por entidad"}),"\n",(0,r.jsx)(n.li,{children:"Versioning en eventos (version field)"}),"\n",(0,r.jsx)(n.li,{children:"Idempotencia en consumers"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Requiere Message Broker Operacional"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"RabbitMQ debe estar siempre disponible"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"RabbitMQ cluster (3 nodos)"}),"\n",(0,r.jsx)(n.li,{children:"Health checks y auto-restart"}),"\n",(0,r.jsx)(n.li,{children:"Mirrored queues para HA"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"riesgos",children:"Riesgos"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Message Broker SPOF (Single Point of Failure)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Si RabbitMQ cae, eventos no se publican"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"RabbitMQ cluster con mirrored queues"}),"\n",(0,r.jsx)(n.li,{children:"Fallback: escribir eventos en tabla local, replay posterior"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'try:\n    await rabbitmq.publish(event)\nexcept RabbitMQUnavailable:\n    await db.execute("INSERT INTO outbox_events ...")\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Message Loss en Crash"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Publicador publica evento \u2192 crash antes de ACK"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Persistent messages (delivery_mode=2)"}),"\n",(0,r.jsx)(n.li,{children:"Publisher confirms"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'await channel.confirm_delivery()\nawait channel.basic_publish(\n    exchange="erp.events",\n    routing_key="auth.user.created",\n    body=json.dumps(event),\n    properties=pika.BasicProperties(delivery_mode=2)  # Persistent\n)\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Duplicate Messages (At-Least-Once)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Consumer procesa mensaje \u2192 crash antes de ACK \u2192 redelivery"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),": Idempotencia","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'async def handle_event(event):\n    # Verificar si ya procesamos este event_id\n    if await db.exists("processed_events", event["event_id"]):\n        logger.info(f"Event {event[\'event_id\']} already processed")\n        return\n\n    # Procesar\n    await process(event)\n\n    # Registrar como procesado\n    await db.insert("processed_events", {"event_id": event["event_id"]})\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Poison Messages"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Mensaje mal formado causa excepci\xf3n \u2192 requeue infinito"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mitigaci\xf3n"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Max retries (x-max-retries: 3)"}),"\n",(0,r.jsx)(n.li,{children:"Dead Letter Queue"}),"\n",(0,r.jsx)(n.li,{children:"Alertas en DLQ no vac\xeda"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"implementaci\xf3n",children:"Implementaci\xf3n"}),"\n",(0,r.jsx)(n.h3,{id:"publisher",children:"Publisher"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# app/events/publisher.py\nimport aio_pika\nimport json\nfrom datetime import datetime\nfrom app.config import settings\n\nclass EventPublisher:\n    def __init__(self):\n        self.connection = None\n        self.channel = None\n        self.exchange = None\n\n    async def connect(self):\n        self.connection = await aio_pika.connect_robust(settings.rabbitmq_url)\n        self.channel = await self.connection.channel()\n        self.exchange = await self.channel.declare_exchange(\n            "erp.events",\n            aio_pika.ExchangeType.TOPIC,\n            durable=True\n        )\n\n    async def publish(self, event_type: str, payload: dict):\n        event = {\n            "event_id": str(uuid4()),\n            "event_type": event_type,\n            "timestamp": datetime.utcnow().isoformat(),\n            "service": settings.service_name,\n            "version": "1.0",\n            "payload": payload\n        }\n\n        message = aio_pika.Message(\n            body=json.dumps(event).encode(),\n            delivery_mode=aio_pika.DeliveryMode.PERSISTENT,\n            content_type="application/json"\n        )\n\n        await self.exchange.publish(\n            message,\n            routing_key=event_type\n        )\n\n        logger.info(f"Published event: {event_type}", extra={"event": event})\n'})}),"\n",(0,r.jsx)(n.h3,{id:"consumer",children:"Consumer"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# app/events/consumer.py\nimport aio_pika\nimport json\nfrom app.handlers import event_handlers\n\nclass EventConsumer:\n    def __init__(self, queue_name: str, routing_keys: list):\n        self.queue_name = queue_name\n        self.routing_keys = routing_keys\n\n    async def start(self):\n        connection = await aio_pika.connect_robust(settings.rabbitmq_url)\n        channel = await connection.channel()\n        await channel.set_qos(prefetch_count=10)\n\n        exchange = await channel.declare_exchange(\n            "erp.events",\n            aio_pika.ExchangeType.TOPIC\n        )\n\n        queue = await channel.declare_queue(\n            self.queue_name,\n            durable=True,\n            arguments={\n                "x-dead-letter-exchange": "dlx.events",\n                "x-message-ttl": 3600000\n            }\n        )\n\n        for routing_key in self.routing_keys:\n            await queue.bind(exchange, routing_key=routing_key)\n\n        await queue.consume(self.process_message)\n        logger.info(f"Consumer started: {self.queue_name}")\n\n    async def process_message(self, message: aio_pika.IncomingMessage):\n        async with message.process():\n            event = json.loads(message.body.decode())\n            event_type = event["event_type"]\n\n            handler = event_handlers.get(event_type)\n            if handler:\n                await handler(event)\n            else:\n                logger.warning(f"No handler for event: {event_type}")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"patr\xf3n-de-eventos",children:"Patr\xf3n de Eventos"}),"\n",(0,r.jsx)(n.h3,{id:"estructura-de-evento",children:"Estructura de Evento"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "event_id": "550e8400-e29b-41d4-a716-446655440000",\n  "event_type": "catalog.product.created",\n  "timestamp": "2025-11-23T10:30:00Z",\n  "service": "catalog-service",\n  "version": "1.0",\n  "payload": {\n    "product_id": "prod-uuid",\n    "organization_id": "org-uuid",\n    "name": "Camiseta B\xe1sica",\n    "sku": "CAM-001",\n    "base_price": 19.99,\n    "created_by": "user-uuid"\n  },\n  "metadata": {\n    "correlation_id": "req-12345",\n    "user_id": "user-uuid",\n    "ip_address": "192.168.1.100"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"eventos-por-servicio",children:"Eventos por Servicio"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Auth Service"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"auth.user.created"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"auth.user.updated"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"auth.user.deactivated"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"auth.local.created"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"auth.local.deactivated"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"auth.role.permissions_changed"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Catalog Service"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog.product.created"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog.product.updated"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog.product.deleted"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog.variant.created"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"catalog.variant.updated"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"monitoreo",children:"Monitoreo"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from prometheus_client import Counter, Histogram\n\n# M\xe9tricas\nevents_published = Counter(\n    "events_published_total",\n    "Total events published",\n    ["service", "event_type"]\n)\n\nevents_consumed = Counter(\n    "events_consumed_total",\n    "Total events consumed",\n    ["service", "event_type", "status"]\n)\n\nevent_processing_time = Histogram(\n    "event_processing_seconds",\n    "Event processing time",\n    ["service", "event_type"]\n)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"revisi\xf3n-futura",children:"Revisi\xf3n Futura"}),"\n",(0,r.jsx)(n.p,{children:"Este ADR debe revisarse si:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Throughput supera 50k msg/s (considerar Kafka)"}),"\n",(0,r.jsx)(n.li,{children:"Necesitamos strong consistency (considerar Saga pattern)"}),"\n",(0,r.jsx)(n.li,{children:"RabbitMQ ops se vuelve complejo (considerar managed service)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fecha de pr\xf3xima revisi\xf3n"}),": 2026-11-23 (1 a\xf1o)"]}),"\n",(0,r.jsx)(n.h2,{id:"referencias",children:"Referencias"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.rabbitmq.com/documentation.html",children:"RabbitMQ Documentation"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.enterpriseintegrationpatterns.com/",children:"Enterprise Integration Patterns"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://martinfowler.com/articles/201701-event-driven.html",children:"Martin Fowler - Event-Driven Architecture"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/arquitectura/arquitectura-event-driven",children:"Arquitectura Event-Driven"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/catalog-service/eventos-publicados",children:"Catalog Service - Eventos Publicados"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/microservicios/catalog-service/eventos-consumidos",children:"Catalog Service - Eventos Consumidos"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var i=s(6540);const r={},a=i.createContext(r);function l(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);